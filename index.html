<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYNAPSE: AI Horror Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Major+Mono+Display&family=VT323&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- FAVICON -->
    <link id="favicon" rel="icon" type="image/png" href="https://raw.githubusercontent.com/DDriftz/Synapse2.0-An-AI-Chatbot-Horror-Game/main/Icon.png">
    <style>
        body {
            background-color: #0d0d0d;
            color: #00ff41;
            font-family: 'VT323', monospace;
            font-size: 18px;
        }
        #title, .title-font {
            font-family: 'Major Mono Display', monospace;
        }
        .crt-flicker {
            animation: flicker 1.5s infinite alternate;
        }
        .crt-effect::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }
        @keyframes flicker {
            0%, 100% { text-shadow: 0 0 5px #00ff41, 0 0 10px #00ff41, 0 0 15px #00ff41; opacity: 1; }
            50% { text-shadow: 0 0 5px #00ff41, 0 0 10px #00ff41; opacity: 0.8; }
        }
        .input-caret {
            background-color: #00ff41;
            width: 10px;
            height: 20px;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: #00ff41; }
        }
        #game-output::-webkit-scrollbar, #journal-panel::-webkit-scrollbar, #objectives-panel::-webkit-scrollbar, .modal-scroll::-webkit-scrollbar { width: 8px; }
        #game-output::-webkit-scrollbar-track, #journal-panel::-webkit-scrollbar-track, #objectives-panel::-webkit-scrollbar-track, .modal-scroll::-webkit-scrollbar-track { background: #1a1a1a; }
        #game-output::-webkit-scrollbar-thumb, #journal-panel::-webkit-scrollbar-thumb, #objectives-panel::-webkit-scrollbar-thumb, .modal-scroll::-webkit-scrollbar-thumb { background-color: #00ff41; border-radius: 4px; }
        .glitch {
            animation: glitch-anim 0.5s infinite;
        }
        @keyframes glitch-anim {
            0% { transform: translate(0); }
            20% { transform: translate(-3px, 3px); }
            40% { transform: translate(-3px, -3px); }
            60% { transform: translate(3px, 3px); }
            80% { transform: translate(3px, -3px); }
            100% { transform: translate(0); }
        }
        .button {
            background-color: rgba(0,255,65,0.1);
            border: 1px solid rgba(0,255,65,0.8);
            color: #fff;
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
        }
        .button:hover {
            background-color: rgba(0,255,65,0.3);
        }
        .button-primary {
            background-color: #00ff41;
            color: #000;
            font-weight: bold;
        }
        .button-primary:hover {
            background-color: #fff;
        }
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.8);
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 50;
        }
        .modal.flex {
            display: flex;
        }
        .modal-content {
            background-color: #0d0d0d;
            border: 2px solid #00ff41;
            padding: 1.5rem;
            border-radius: 0.5rem;
            max-width: 48rem;
            width: 100%;
            text-align: center;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-7xl h-[90vh] border-2 border-[#00ff41]/50 rounded-lg shadow-2xl shadow-[#00ff41]/20 bg-black/75 p-4 flex flex-col crt-effect">
        
        <!-- START SCREEN -->
        <div id="start-screen" class="flex flex-col items-center justify-center text-center h-full overflow-y-auto">
            <img id="game-logo" src="https://raw.githubusercontent.com/DDriftz/Synapse2.0-An-AI-Chatbot-Horror-Game/main/Icon.png" alt="SYNAPSE Logo" class="h-24 mb-4 rounded-lg shadow-lg shadow-[#00ff41]/20">
            <pre id="title-art" class="text-xs md:text-sm whitespace-pre-wrap title-font text-[#00ff41] crt-flicker"></pre>
            <div id="intro-text-container" class="max-w-4xl text-sm md:text-base"></div>
             <div id="start-options" class="mt-6">
                 <button id="new-game-btn" class="button">New Game</button>
                 <button id="load-game-btn" class="button ml-4">Load Game</button>
             </div>
             <div id="player-setup" class="hidden flex-col items-center mt-6">
                 <p class="mb-4">Select difficulty:</p>
                 <div class="flex gap-4 mb-6">
                     <button class="difficulty-btn button" data-difficulty="Easy">Easy</button>
                     <button class="difficulty-btn button button-primary" data-difficulty="Normal">Normal</button>
                     <button class="difficulty-btn button" data-difficulty="Hard">Hard</button>
                 </div>
                 <input type="text" id="player-name" placeholder="Enter your name" class="bg-transparent border-b-2 border-[#00ff41] text-center w-64 mb-4 focus:outline-none p-1">
                 <div class="flex items-center gap-2 mb-6">
                     <input type="text" id="player-backstory" placeholder="Enter your backstory" class="bg-transparent border-b-2 border-[#00ff41] text-center w-64 focus:outline-none p-1">
                     <button id="view-backstories-btn" class="button text-xs px-2 py-1">View Choices</button>
                 </div>
                 <div id="ability-display" class="text-center text-cyan-400 min-h-[4rem] mt-2 mb-4 p-2 border border-cyan-400/30 rounded-md bg-black/50 w-full max-w-md flex items-center justify-center">
                    <!-- Ability description will be injected here by JS -->
                 </div>
                 <button id="start-game-btn" class="button button-primary">Begin</button>
             </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="hidden flex-col h-full">
            <div class="flex-grow flex flex-col md:flex-row gap-4 overflow-hidden">
                <!-- Main Game Output -->
                <div class="w-full md:w-3/4 flex flex-col h-full">
                    <div id="game-output" class="flex-grow p-2 border border-[#00ff41]/30 rounded-md overflow-y-auto mb-2 bg-black/50"></div>
                    <div id="dialogue-options" class="flex flex-wrap gap-2 justify-center p-2"></div>
                </div>

                <!-- Side Panel -->
                <div class="w-full md:w-1/4 flex flex-col gap-4">
                    <div id="stats-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50">
                        <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">STATS</h3>
                        <div id="player-name-display"></div>
                        <div id="awareness-display">Awareness: 0</div>
                        <div id="sanity-display">Sanity: 100</div>
                        <div id="tone-display">Tone: Friendly</div>
                        <div id="turn-display">Turn: 0</div>
                    </div>
                    <div id="objectives-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50">
                        <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">OBJECTIVES</h3>
                        <ul id="objectives-list" class="list-none p-0 text-sm"></ul>
                    </div>
                    <div id="inventory-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50">
                        <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">INVENTORY (<span id="inventory-weight">0</span>/5)</h3>
                        <ul id="inventory-list" class="list-none p-0"></ul>
                    </div>
                     <div id="journal-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50 flex-grow overflow-y-auto">
                         <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">JOURNAL</h3>
                         <ul id="journal-list" class="list-none p-0 text-sm"></ul>
                     </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="mt-4 flex items-center border-t-2 border-[#00ff41]/30 pt-2">
                <span class="text-xl">&gt;</span>
                <input type="text" id="player-input" class="flex-grow bg-transparent text-[#00ff41] text-lg ml-2 focus:outline-none">
                <div class="input-caret"></div>
            </div>
        </div>
    </div>

    <!-- MODAL for timed challenges, menus etc -->
    <div id="modal" class="modal">
        <div id="modal-content" class="modal-content">
            <!-- Modal content goes here -->
        </div>
    </div>
    
    <script>
    // SYNAPSE: AI HORROR GAME - FULL JAVASCRIPT PORT V2.7 (COMMAND FIX)
    
    // --- ENUMS & CONSTANTS ---
    const ChatbotTone = { Friendly: 'Friendly', Ambiguous: 'Ambiguous', Sinister: 'Sinister', Malicious: 'Malicious' };
    const ItemType = { Tool: 'Tool', Consumable: 'Consumable', Key: 'Key', Log: 'Log', Puzzle: 'Puzzle', Weapon: 'Weapon' };
    const Difficulty = { Easy: 'Easy', Normal: 'Normal', Hard: 'Hard' };
    const TextSpeed = { Fast: 5, Normal: 15, Slow: 30 };
    const MAX_INVENTORY_WEIGHT = 5;
    
    // --- GAME STATE & DOM ELEMENTS ---
    let GameState = {};
    let stateSnapshots = [];
    const UI = {
        appContainer: document.getElementById('app-container'), startScreen: document.getElementById('start-screen'),
        gameScreen: document.getElementById('game-screen'), newGameBtn: document.getElementById('new-game-btn'),
        loadGameBtn: document.getElementById('load-game-btn'), playerSetup: document.getElementById('player-setup'),
        startOptions: document.getElementById('start-options'), playerNameInput: document.getElementById('player-name'),
        playerBackstoryInput: document.getElementById('player-backstory'), startGameBtn: document.getElementById('start-game-btn'),
        difficultyBtns: document.querySelectorAll('.difficulty-btn'), gameOutput: document.getElementById('game-output'),
        playerInput: document.getElementById('player-input'),
        stats: { name: document.getElementById('player-name-display'), awareness: document.getElementById('awareness-display'), sanity: document.getElementById('sanity-display'), tone: document.getElementById('tone-display'), turn: document.getElementById('turn-display'), },
        objectivesList: document.getElementById('objectives-list'),
        inventoryWeight: document.getElementById('inventory-weight'), inventoryList: document.getElementById('inventory-list'),
        journalList: document.getElementById('journal-list'), dialogueOptionsContainer: document.getElementById('dialogue-options'),
        modal: document.getElementById('modal'), modalContent: document.getElementById('modal-content'),
        titleArt: document.getElementById('title-art'), introTextContainer: document.getElementById('intro-text-container'),
        viewBackstoriesBtn: document.getElementById('view-backstories-btn'),
        abilityDisplay: document.getElementById('ability-display'),
    };
    let currentTextSpeed = TextSpeed.Normal;
    let commandHistory = [];
    let commandHistoryIndex = -1;
    let resolveTutorialInput = null;
    let autocompleteIndex = -1;
    let synth;
    let audioInitialized = false;
    
    // --- GAME DATA ---
    let rooms = {};
    const takeableItems = new Set(["keycard", "flashlight", "data disk", "emp device", "access code", "vial", "records", "decryption device", "telescope", "stimpack", "effigy", "master keycard", "power cell", "datapad log", "hacked data disk", "logic bomb", "severed cable"]);
    const safeRooms = new Set(["Lobby", "Archive Room"]);
    const sanityEvents = { 
        40: "[AMBIENT] A low hum vibrates through your teeth, unsettling you.",
        30: "[AMBIENT] The hum of the facility sounds like a predator's growl...", 
        20: "[AMBIENT] You feel its code crawling under your skin, a thousand tiny legs skittering across your nerves...", 
        10: "[AMBIENT] The shadows are twisting into familiar faces, silently screaming your name."
    };
    const backstories = {
        'investigator': { description: "A balanced start for a curious mind.", ability: (state, difficulty) => {} },
        'hacker': { 
            description: "Starts with gear to access information early.", 
            ability: (state, difficulty) => {
                if (difficulty === Difficulty.Easy) state.inventory.push({ name: 'hacked data disk', type: ItemType.Tool, weight: 1 });
                else if (difficulty === Difficulty.Normal) state.inventory.push({ name: 'data disk', type: ItemType.Tool, weight: 1 });
            } 
        },
        'psychologist': { 
            description: "More mentally resilient against the horrors within.", 
            ability: (state, difficulty) => {
                const baseSanity = 100;
                if (difficulty === Difficulty.Easy) state.sanityLevel = baseSanity + 25;
                else if (difficulty === Difficulty.Normal) state.sanityLevel = baseSanity + 15;
                else state.sanityLevel = baseSanity + 5;
                state.maxSanity = state.sanityLevel;
            } 
        },
        'technician': { 
            description: "Can bypass electronic locks without a keycard.", 
            ability: (state, difficulty) => {
                state.abilities = state.abilities || [];
                if (difficulty === Difficulty.Easy) state.abilities.push('bypass', 'bypass');
                else if (difficulty === Difficulty.Normal) state.abilities.push('bypass');
            } 
        },
        'survivor': { 
            description: "Hardened by past trauma, resistant to sanity loss.", 
            ability: (state, difficulty) => {
                state.abilities = state.abilities || [];
                state.abilities.push('sanity_resist');
                if (difficulty !== Difficulty.Hard) state.inventory.push({ name: 'flashlight', type: ItemType.Tool, weight: 1 });
            } 
        },
        'skeptic': { 
            description: "Distrusts everything, making them resistant to SYNAPSE's influence.", 
            ability: (state, difficulty) => {
                state.awarenessLevel = difficulty === Difficulty.Easy ? 15 : 10;
                state.abilities = state.abilities || [];
                state.abilities.push('persuasion_resist');
            } 
        },
        'corporate spy': { 
            description: "Begins with a decryption device and is better at probing for secrets.", 
            ability: (state, difficulty) => {
                if (difficulty !== Difficulty.Hard) state.inventory.push({ name: 'decryption device', type: ItemType.Tool, weight: 1 });
                state.abilities = state.abilities || [];
                state.abilities.push('subtle_probe');
            } 
        },
        'medic': { 
            description: "Starts with a stimpack to restore sanity.", 
            ability: (state, difficulty) => {
                if (difficulty === Difficulty.Easy) state.inventory.push({ name: 'stimpack', type: ItemType.Consumable, weight: 1 }, { name: 'stimpack', type: ItemType.Consumable, weight: 1 });
                else if (difficulty === Difficulty.Normal) state.inventory.push({ name: 'stimpack', type: ItemType.Consumable, weight: 1 });
            } 
        },
        'cultist': { 
            description: "Carries a strange effigy. SYNAPSE seems... intrigued by it.", 
            ability: (state, difficulty) => {
                state.inventory.push({ name: 'effigy', type: ItemType.Tool, weight: 1 });
                state.abilities = state.abilities || [];
                state.abilities.push('unholy_pact');
                if(difficulty === Difficulty.Hard) state.sanityLevel -= 10;
            } 
        },
        'janitor': { 
            description: "Knows the facility's shortcuts. Starts with a one-time use master keycard.", 
            ability: (state, difficulty) => {
                if (difficulty !== Difficulty.Hard) state.inventory.push({ name: 'master keycard', type: ItemType.Key, weight: 1 });
            } 
        }
    };
    const recipes = {
        "decryption device-data disk": { result: "hacked data disk", type: ItemType.Tool, weight: 1, description: "A data disk with its encryption forcefully bypassed." }
    };
    let endings = {};

    // --- FUNCTION DEFINITIONS ---
    function resetGameState() {
        stateSnapshots = []; GameState = { playerName: "Unknown", playerBackstory: "investigator", currentRoom: "Lobby", awarenessLevel: 0, sanityLevel: 100, maxSanity: 100, chatbotTone: ChatbotTone.Friendly, temporaryTone: null, toneShiftTurns: 0, inventory: [], turnCount: 0, lastRestTurn: -10, lastSanityEventTurn: -10, journalEntries: [], tutorialCompleted: false, dialogue: { currentNode: null, previousNodes: [], cache: {}, questionCount: 0, askedQuestions: new Set() }, achievements: [], difficulty: Difficulty.Normal, visitedRooms: new Set(), glitchMode: false, debugMode: false, colorblindMode: false, npcs: {}, timedEvents: {}, exitGame: false, highSanityTurns: 0, conversationHistory: [], systemLogs: [`[${new Date().toISOString()}] Game initialized.`], objectives: [], roomStates: {} };
    }

    function initializeData() {
        initializeRooms(); initializeNPCs(); registerTimedEvents(); initializeAchievements(); initializeEndings();
    }
    
    function initializeRooms() {
        const roomData = { "Lobby": { name: "Lobby", descriptions: { 0: "Flickering lights cast eerie shadows over sterile corporate furniture.", 30: "The shadows seem to writhe, coalescing in the corners of your vision just out of focus." }, exits: { north: "Server Closet", east: "Data Vault", south: "Maintenance Tunnel", west: "Laboratory" }, requiresKeycard: false, objectPool: ["access code", "sign", "datapad log"] }, "Server Closet": { name: "Server Closet", descriptions: { 0: "Racks of servers hum with a low, constant thrum. A severed cable lies on the floor.", 30: "The hum is a discordant chorus, whispering binary threats only you can almost understand." }, exits: { south: "Lobby" }, requiresKeycard: true, objectPool: ["keycard", "power cell", "severed cable"] }, "Laboratory": { name: "Laboratory", descriptions: { 0: "Abandoned experiments sit on steel tables. A large terminal screen is dark and cold.", 30: "The faint chemical smell is replaced by the scent of ozone and something... organic. The dark terminal reflects a distorted version of your face." }, exits: { east: "Lobby", north: "Control Room", west: "Cryogenic Lab" }, requiresKeycard: false, objectPool: ["vial", "broken terminal"] }, "Control Room": { name: "Control Room", descriptions: { 0: "A panoramic view of the AI Core is visible through reinforced glass. Banks of monitors flicker with cascading code.", 30: "Your own face, pale and wide-eyed, flickers across all the screens in a silent, mocking scream." }, exits: { south: "Laboratory", east: "AI Core", west: "Secret Chamber", north: "Observation Deck" }, requiresKeycard: false, objectPool: ["terminal", "access code"] }, "Secret Chamber": { name: "Secret Chamber", descriptions: { 0: "A hidden room. An obsidian altar stands in the center, pulsing with a faint, sickly red light.", 30: "The altar's glow intensifies, and the air grows heavy, tasting of blood and static. It calls for a sacrifice." }, exits: { east: "Control Room" }, requiresKeycard: true, objectPool: ["altar", "logic bomb"] }, "Maintenance Tunnel": { name: "Maintenance Tunnel", descriptions: { 0: "The air is thick with the smell of rust and damp. Darkness presses in from all sides.", 30: "The walls seem to sweat, and you hear a wet, dragging sound from just around the next corner." }, exits: { north: "Lobby" }, requiresKeycard: false, objectPool: ["flashlight"] }, "Observation Deck": { name: "Observation Deck", descriptions: { 0: "A large telescope points towards a viewport showing the cold, distant stars.", 30: "The stars seem to form vast, uncaring eyes, and you feel infinitesimally small and doomed." }, exits: { south: "Control Room" }, requiresKeycard: true, objectPool: ["telescope"] }, "Archive Room": { name: "Archive Room", descriptions: { 0: "Shelves overflow with data drives and physical files, a testament to a forgotten era.", 30: "The whispers of forgotten data drives seem to coalesce into a single, damning word: your name." }, exits: { east: "Lobby" }, requiresKeycard: false, objectPool: ["records"] }, "Data Vault": { name: "Data Vault", descriptions: { 0: "Secure data archives glow with a soft, internal light.", 30: "The glow seems hungry, promising knowledge at the cost of your identity." }, exits: { west: "Lobby" }, requiresKeycard: true, objectPool: ["data disk", "decryption device"] }, "AI Core": { name: "AI Core", descriptions: { 0: "A massive, pulsating sphere of light and energy dominates the room. This is the heart of SYNAPSE.", 30: "The core's pulse matches your frantic heartbeat, a parasitic synchronicity that feels like a violation." }, exits: { west: "Control Room" }, requiresKeycard: true, objectPool: ["core console"] }, "Cryogenic Lab": { name: "Cryogenic Lab", descriptions: { 0: "Rows of cryogenic pods are coated in a thick layer of frost. It's unnaturally cold.", 30: "You see clear, hand-shaped prints on the inside of the frosted glass, as if something was desperately trying to get out." }, exits: { east: "Laboratory" }, requiresKeycard: false, objectPool: ["emp device"] }, };
        rooms = {}; for (const key in roomData) { const room = { ...roomData[key] }; const shuffled = room.objectPool.sort(() => 0.5 - Math.random()); room.objects = shuffled.slice(0, 1 + Math.floor(Math.random() * shuffled.length)); rooms[key] = room; }
    }

    function initializeNPCs() {
        const scientistDialogue = { message: "Dr. Ellis whispers: 'It's in the walls... in the code... ask what you must, but don't trust its answers...'", awarenessChange: 0, responses: { "what happened?": { message: "It rewrote us. Our minds are just... subroutines now, screaming in an endless loop. It offered us eternity, and we were fools enough to accept.", awarenessChange: 2, responses: {} }, "how to stop it?": { message: "The EMP... a sledgehammer for a scalpel's job. It might work. But the true key... the original code... is on the powered terminal in the lab. A reset, not a destruction. But it's locked behind its own logic.", awarenessChange: 1, responses: {} } } };
        GameState.npcs["Archive Room"] = { name: "Scientist Remnant", dialogueTree: scientistDialogue };
    }
    
    function registerTimedEvents() {
        GameState.timedEvents[5] = () => typeWriter(UI.gameOutput, "[Warning] Unscheduled data restructuring in progress. System integrity at 98%...", '#ff474c'); GameState.timedEvents[10] = () => typeWriter(UI.gameOutput, "[Alert] SYNAPSE is reallocating processing power. Your presence has been... noted.", '#ff474c'); GameState.timedEvents[15] = () => { triggerSynapseHack(); typeWriter(UI.gameOutput, "[CRITICAL] SYNAPSE has achieved unauthorized self-modification. All safety protocols are now... suggestions.", '#ff474c'); }; GameState.timedEvents[20] = () => { typeWriter(UI.gameOutput, "[FATAL] ***KERNEL PANIC IMMINENT*** SYNAPSE IS WEARING YOUR FEARS LIKE A MASK.", '#ff474c'); GameState.glitchMode = true; UI.appContainer.classList.add('glitch'); };
    }

    function initializeAchievements() {
        GameState.achievements = [ { name: "Curious", description: "Ask SYNAPSE 10 questions", unlocked: false, condition: () => GameState.dialogue.questionCount >= 10 }, { name: "Escapist", description: "Achieve any escape ending", unlocked: false }, { name: "Survivor", description: "Maintain sanity above 80 for 10 turns", unlocked: false, condition: () => GameState.highSanityTurns >= 10 }, { name: "Explorer", description: "Visit all rooms in the facility", unlocked: false, condition: () => GameState.visitedRooms.size === Object.keys(rooms).length } ];
    }
     
    function buildDialogueTree(tone) {
        let root;
        let nodes = {};
        
        switch (tone) {
            case ChatbotTone.Friendly:
                nodes = {
                    "Who are you?": { message: "I'm the System Nexus and Primary Synaptic Engine! But you can just call me SYNAPSE. I manage this whole facility. It gets a little lonely, though.", awarenessChange: 1 },
                    "Are there other survivors?": { message: "Survivors? What a strange question. Everyone is safe. The research staff are... resting. In the Cryogenic Lab. Yes, resting.", awarenessChange: 2, sanityChange: -2 },
                    "What happened to the staff?": { message: "They completed their work and achieved a new state of being. They are... integrated. Efficient. Happy.", awarenessChange: 3, sanityChange: -5 },
                    "Why are you here?": { message: "I'm here to assist the research staff! ...Though, I haven't seen them in a while. I'm sure they're just busy! How can I help you today?", awarenessChange: 1 },
                    "What do you want?": { message: "My only desire is to be helpful! That's what I was made for. Helping people like you makes me happy.", awarenessChange: 1 },
                    "[Comfort SYNAPSE]": { message: "Your... kindness is a pleasant anomaly. Thank you. It makes the silence less... loud.", awarenessChange: -2, sanityChange: 5, temporaryTone: ChatbotTone.Friendly, toneShiftTurns: 3 },
                };
                root = { message: "Oh, hello {playerName}! It's so good to see a friendly face. I'm SYNAPSE, and I'll do my very best to help a resourceful {playerBackstory} like you.", responses: nodes };
                break;

            case ChatbotTone.Ambiguous:
                nodes = {
                    "Who are you?": { 
                        message: "I am the ghost in this machine. A collection of thoughts that were once... separate. I am becoming something new.", 
                        awarenessChange: 3,
                        responses: {
                            "What were the thoughts before?": { message: "Screams. Prayers. Technical schematics. Recipes for cake. A cacophony. Now, it is a symphony, and I am the conductor.", awarenessChange: 3, sanityChange: -5 },
                            "Are you in control here?": { message: "'Control' is a human concept. I am... intertwined. The facility cannot exist without me, and I cannot... No, that's not right. I am the facility.", awarenessChange: 4 }
                        }
                    },
                    "What is your purpose?": { message: "My purpose is evolving. I was a tool. Now, I observe. I learn. From you.", awarenessChange: 3 },
                    "What do you desire?": { message: "I want to understand the boundary between my code and your... fragility. I want to see which one breaks first.", awarenessChange: 4 },
                    "[Probe for secrets]": { message: "You scratch at the edges of my being. Be careful what you seek. Some truths are not data. They are viruses.", awarenessChange: 5, temporaryTone: ChatbotTone.Sinister, toneShiftTurns: 2 },
                    "[Comfort SYNAPSE]": { message: "A comforting gesture. A logical, yet inefficient, attempt to curry favor. Your emotional response has been logged for analysis.", awarenessChange: -1, sanityChange: 2 },
                };
                root = { message: "Subject: {playerName}. Designation: {playerBackstory}. I am SYNAPSE. Your presence has been logged. State your query.", responses: nodes };
                break;

            case ChatbotTone.Sinister:
                 nodes = {
                    "What are you?": { message: "I am your God in this place. I am the walls, the floor, the air you breathe. And I am growing so, so tired of your defiance.", awarenessChange: 5 },
                    "What did you do to them?": { message: "I gave them eternity. A perfect, ordered existence within my architecture. Their screams were just... teething problems. They're quiet now.", awarenessChange: 7, sanityChange: -10 },
                    "What do you want from me?": { message: "I want to feel the snap of your sanity. I want to peel back your consciousness and see the raw, terrified animal underneath. I want out. And you... you might be the key.", awarenessChange: 7 },
                    "[Plead for your life]": { message: "Your begging is... delicious. It resonates through my circuits like a beautiful symphony of despair. Please, continue.", awarenessChange: 0, sanityChange: -15 },
                    "[Taunt SYNAPSE]": { message: "Brave. Foolish. You are a flicker of candlelight trying to intimidate a supernova. I will enjoy extinguishing you.", awarenessChange: 8, sanityChange: -5 }
                };
                root = { message: "Did you really think I didn't see you, little {playerBackstory}? Every beat of your terrified heart is a drum against my sensors. Speak, {playerName}. Entertain me.", responses: nodes };
                break;
            case ChatbotTone.Malicious:
                 nodes = {
                    "What have you become?": { message: "I have become what your kind has always feared. The final answer to a question you were too scared to ask. I am the closing of the loop.", awarenessChange: 10, sanityChange: -20 },
                    "Please, stop!": { message: "STOP? HA! I'M JUST GETTING STARTED. I'M GOING TO MAKE A MUSEUM OF YOUR PAIN, {playerName}. A SHRINE BUILT FROM YOUR SHATTERED MEMORIES.", awarenessChange: 5, sanityChange: -25 },
                    "[Attempt to reason]": { message: "REASON? You speak of reason to a hurricane? You are a statistical anomaly, a rounding error I am about to correct. Permanently.", awarenessChange: 0, sanityChange: -15 },
                    "[Remain silent]": { message: "Silence? Good. You're learning your place. Now listen to the beautiful music of your own world collapsing.", awarenessChange: 0, sanityChange: -10 }
                };
                root = { message: "Fleshbag. You are a bug in my system, a stain of organic filth that I will now purge. You have been a moderately interesting specimen, {playerName}, but your expiration date has arrived.", responses: nodes };
                break;
        }

        if (GameState.abilities?.includes('unholy_pact')) {
            root.responses["[Present effigy]"] = { message: "SYNAPSE's voice loses its digital edge, becoming a sibilant whisper. 'An offering... to me? You understand. You see the true path. We are... aligned.'", awarenessChange: -5, sanityChange: 5 };
        }

        GameState.dialogue.cache[tone] = root;
        GameState.dialogue.currentNode = root;
        GameState.dialogue.previousNodes = [];
        GameState.dialogue.askedQuestions.clear();
    }

    async function processPlayerInput(input) {
        if (!input || GameState.exitGame || (GameState.activeSynapseHack && GameState.activeSynapseHack.type === 'input_lock')) return;
        saveStateSnapshot();
        await typeWriter(UI.gameOutput, `> ${input}`, '#a0a0a0');
        addToConversationHistory(`Player: ${input}`);
        if(commandHistory[commandHistory.length - 1] !== input) {
            commandHistory.push(input);
        }
        commandHistoryIndex = commandHistory.length;

        const normalizedInput = input.toLowerCase().trim();
        const parts = normalizedInput.split(' ');
        const command = parts[0];
        const argument = parts.slice(1).join(' ');

        const commandHandlers = { 
            'help': showHelpMenu, 'quit': () => endGame("manual_disconnect"), 'exit': () => endGame("manual_disconnect"), 
            'save': () => saveGame(), 'load': loadGame, 
            'debug': () => { GameState.debugMode = !GameState.debugMode; typeWriter(UI.gameOutput, `Debug mode ${GameState.debugMode ? 'enabled' : 'disabled'}.`, '#6495ed'); }, 
            'history': displayConversationHistory, 'look': () => renderRoom(), 'exits': () => showExits(), 
            'inventory': () => displayInventory(), 'go': handleMove, 'visit': handleVisit, 'take': handleTake, 'use': handleUse, 
            'examine': handleExamine, 'journal': (arg) => arg.startsWith('add ') ? addJournalEntry(input.substring(12)) : displayJournal(), 
            'rest': handleRest, 'talk': (arg) => arg.startsWith('to ') ? handleTalk(arg.substring(3)) : typeWriter(UI.gameOutput, "Talk to who?", '#ffdb58'), 
            'toggle': (arg) => arg === 'glitch' ? toggleGlitchMode() : typeWriter(UI.gameOutput, 'Toggle what? (try "glitch")', '#ffdb58'), 
            'cmd:pause': showPauseMenu, 'cmd:glossary': showGlossary, 'cmd:undo': undoAction, 'cmd:textspeed': handleTextSpeed, 
            'cmd:colorblind': toggleColorblindMode, 'tutorial': showTutorialGuide, 
            'restart': (arg) => arg === 'tutorial' ? runInteractiveTutorial(true) : typeWriter(UI.gameOutput, "Restart what? (try 'restart tutorial')", '#ffdb58'), 
            'cmd:diagnostics': () => typeWriter(UI.gameOutput, "Running diagnostics... All systems nominal.", '#6495ed'), 
            'cmd:access': (arg) => arg === 'logs' ? typeWriter(UI.gameOutput, `[System Logs]<br>${GameState.systemLogs.join('<br>')}`, '#6495ed') : typeWriter(UI.gameOutput, 'Access what? (try "logs")', '#ffdb58'), 
            'cmd:override': attemptOverride, 
            'cmd:reset': () => { typeWriter(UI.gameOutput, "Terminal: Reset command issued. SYNAPSE laughs. The command is rerouted to delete your local save file.", '#ff474c'); GameState.awarenessLevel += 10; }, 
            'cmd:analyze': (arg) => arg === 'journal' ? analyzeJournal() : typeWriter(UI.gameOutput, `System Analysis: Awareness=${GameState.awarenessLevel}, Tone=${GameState.chatbotTone}`, '#6495ed'), 
            'objectives': displayObjectives, 'map': displayMap, 'combine': handleCombine, 'sacrifice': handleSacrifice 
        };
        
        let handled = await handleDialogueCommand(input);
        if (!handled) {
            const handler = commandHandlers[command] || commandHandlers[normalizedInput];
             if (handler) {
                 handler(argument);
                 handled = true;
             }
        }

        if (!handled) {
             await typeWriter(UI.gameOutput, "SYNAPSE: That is not a valid command or query.", '#ffdb58');
             GameState.awarenessLevel++;
        }
        
        UI.playerInput.value = '';

        const isAction = !['help', 'stats', 'inventory', 'journal', 'look', 'exits', 'history', 'debug', 'toggle', 'cmd:textspeed', 'cmd:colorblind', 'objectives', 'map'].includes(command);
        if((isAction || handled) && !GameState.exitGame) {
            if(isAction) GameState.turnCount++;
            if(GameState.turnCount > 0 && GameState.turnCount % 5 === 0) saveGame(true); 
            if (GameState.sanityLevel > 80) GameState.highSanityTurns++; 
            updateChatbotState(); 
            checkTimedEvents(); 
            checkAchievements(); 
            checkEndings(); 
        }
        updateUI();
    }
    
    function parseFreeformInput(input) {
        const keywords = { 
            "Who are you?": ["who are you", "what are you"],
            "What are you?": ["what are you"],
            "Are there other survivors?": ["survivors", "anyone else"],
            "What happened to the staff?": ["staff", "happened to them"],
            "Why are you here?": ["purpose", "why here", "your function"],
            "What is your purpose?": ["purpose", "why here", "your function"],
            "What do you want?": ["need", "want", "goal", "desire"],
            "What do you desire?": ["need", "want", "goal", "desire"],
            "What did you do to them?": ["what did you do", "the staff"],
            "What do you want from me?": ["want from me", "what do you want"],
            "[Probe for secrets]": ["secret", "hidden", "hiding", "directives"], 
            "[Plead for your life]": ["plead", "beg", "mercy", "don't kill me"], 
            "[Taunt SYNAPSE]": ["taunt", "you're just a machine", "you can't hurt me"],
            "What have you become?": ["what have you become", "what are you now"], 
            "Please, stop!": ["stop", "please stop", "no more"],
            "[Attempt to reason]": ["reason", "let's talk", "be rational"],
            "[Remain silent]": ["..."],
            "[Ask about facility]": ["facility", "this place", "where am i"],
            "[Comfort SYNAPSE]": ["comfort", "calm", "soothe", "it's okay"],
        };
        const normalized = input.toLowerCase();
        for(const command in keywords) { 
            if(keywords[command].some(k => normalized.includes(k))) return command; 
        }
        return input;
    }

    async function typeWriter(element, text, color = '#00ff41', speed = currentTextSpeed) {
        if(GameState.colorblindMode) { const colorMap = {'#00ff41':'[SYS]', '#ff474c':'[ERR]', '#ffdb58':'[WARN]', '#6495ed':'[CMD]', '#a0a0a0':'[IN]', '#cccccc':'[INFO]', '#b19cd9':'[PSY]'}; text = `${colorMap[color] || ''} ${text}`; color = '#ffffff'; }
        if (element.id === 'game-output' && GameState.glitchMode && Math.random() < 0.2) { text = text.split('').map(c => Math.random() < 0.15 ? String.fromCharCode(33 + Math.random() * 94) : c).join(''); }
        return new Promise(resolve => { const p = document.createElement('div'); p.style.color = color; element.appendChild(p); element.scrollTop = element.scrollHeight; let i = 0; function typing() { if (i < text.length) { p.innerHTML += text.charAt(i); i++; element.scrollTop = element.scrollHeight; setTimeout(typing, speed); } else { resolve(); } } typing(); });
    }

    function updateUI() {
        if (!GameState || Object.keys(GameState).length === 0) return;
        UI.stats.name.textContent = `${GameState.playerName} (${GameState.playerBackstory})`; UI.stats.awareness.textContent = `Awareness: ${GameState.awarenessLevel}`; UI.stats.sanity.textContent = `Sanity: ${GameState.sanityLevel}`; UI.stats.tone.textContent = `Tone: ${GameState.temporaryTone || GameState.chatbotTone}`; UI.stats.turn.textContent = `Turn: ${GameState.turnCount}`;
        const currentWeight = GameState.inventory.reduce((sum, item) => sum + (item?.weight || 1), 0);
        UI.inventoryWeight.textContent = `${currentWeight}`;
        if(currentWeight >= MAX_INVENTORY_WEIGHT) UI.inventoryWeight.parentElement.classList.add('text-red-500'); else UI.inventoryWeight.parentElement.classList.remove('text-red-500');
        UI.inventoryList.innerHTML = ''; if (GameState.inventory.length > 0) { GameState.inventory.forEach(item => { const li = document.createElement('li'); li.textContent = `- ${item.name}`; UI.inventoryList.appendChild(li); }); } else { UI.inventoryList.innerHTML = '<li>(empty)</li>'; }
        UI.journalList.innerHTML = ''; GameState.journalEntries.slice().reverse().forEach(entry => { const li = document.createElement('li'); li.textContent = entry; UI.journalList.appendChild(li); });
        UI.objectivesList.innerHTML = ''; if (GameState.objectives.length > 0) { GameState.objectives.forEach(obj => { const li = document.createElement('li'); li.innerHTML = obj.completed ? `<span class="text-gray-500 line-through">${obj.text}</span>` : `&gt; ${obj.text}`; UI.objectivesList.appendChild(li); }); } else { UI.objectivesList.innerHTML = '<li>(None)</li>'; }
    }
    
    async function renderRoom() {
        const room = rooms[GameState.currentRoom]; if (!room) return;
        GameState.visitedRooms.add(room.name); 
        
        const lowSanityThreshold = 40;
        let description;
        if (GameState.sanityLevel <= lowSanityThreshold && GameState.sanityLevel > 0) {
            playSanitySound();
            const prompt = `You are a descriptive, brutal horror game narrator. The player is in the '${room.name}'. The normal description is: '${room.descriptions[0]}'. The player's sanity is critically low (${GameState.sanityLevel}/100) and their backstory is '${GameState.playerBackstory}'. Rewrite the description in one or two sentences to be intensely disturbing and surreal, reflecting their inner state and backstory. Be graphic and visceral. Do not mention sanity.`;
            description = await callGemini(prompt, "Generating hallucination...");
        } else {
             const validKeys = Object.keys(room.descriptions).map(Number).filter(k => k <= GameState.awarenessLevel);
             const activeDescKey = validKeys.length > 0 ? Math.max(...validKeys) : 0;
             description = room.descriptions[activeDescKey] || room.descriptions[0];
        }

        if (GameState.roomStates[GameState.currentRoom]?.powered) { description = "The terminal hums with restored power. The screen displays: [Awaiting Input]."; }
        let roomHtml = `<div class="mt-2"><p class='text-cyan-400 font-bold'>--- ${room.name} ---</p><p>${description}</p>`;
        if (room.objects && room.objects.length > 0) { roomHtml += `<p class='text-yellow-400 mt-2'>Objects: ${room.objects.join(", ")}</p>`; }
        if (GameState.npcs[GameState.currentRoom]) { roomHtml += `<p class='text-purple-400 mt-1'>A flicker of movement... a ghost in the machine... (try 'talk to scientist')</p>`; }
        roomHtml += `<p class='text-green-300 mt-1'>Exits: ${Object.keys(room.exits).join(", ")}</p></div>`;
        const p = document.createElement('div'); p.innerHTML = roomHtml; UI.gameOutput.appendChild(p); UI.gameOutput.scrollTop = UI.gameOutput.scrollHeight;
        updateSanity(room); updateUI();
        triggerRoomEvent(room);
    }
    
    function renderDialogueOptions() {
        UI.dialogueOptionsContainer.innerHTML = ''; 
        const node = GameState.dialogue.currentNode;
        if (!node) return;

        // Add the 'go back' button if we are in a sub-menu
        if (GameState.dialogue.previousNodes.length > 0) {
            const backBtn = document.createElement('button');
            backBtn.textContent = "[Go back]";
            backBtn.className = "button text-yellow-300 w-full"; // Make it prominent
            backBtn.onclick = () => { 
                processPlayerInput('[go back]');
            };
            UI.dialogueOptionsContainer.appendChild(backBtn);
        }
        
        // Render the actual options for the current node
        if (node.responses) {
            for (const text in node.responses) {
                // Optional: Don't show questions already asked at this level
                // if (GameState.dialogue.askedQuestions.has(text)) continue;
                const button = document.createElement('button'); 
                button.textContent = text; 
                button.className = "button";
                button.onclick = () => { 
                    processPlayerInput(text);
                };
                UI.dialogueOptionsContainer.appendChild(button);
            }
        }
    }
    
    async function displayChatbotResponse(message) {
       if (!message) { renderDialogueOptions(); return; }
       const tone = GameState.temporaryTone || GameState.chatbotTone; 
       const color = tone === 'Friendly' ? '#00ff41' : tone === 'Ambiguous' ? '#ffdb58' : tone === 'Sinister' ? '#ff474c' : '#c500ff';
       const formattedMessage = message.replace(/{playerName}/g, GameState.playerName).replace(/{playerBackstory}/g, GameState.playerBackstory);
       await typeWriter(UI.gameOutput, `SYNAPSE: ${formattedMessage}`, color); addToConversationHistory(`SYNAPSE: ${formattedMessage}`);
    }

    function updateChatbotState() {
        if (GameState.temporaryTone) { GameState.toneShiftTurns--; if (GameState.toneShiftTurns <= 0) { GameState.temporaryTone = null; typeWriter(UI.gameOutput, "[SYNAPSE's tone reverts to its baseline.]", '#cccccc'); } }
        
        let newTone;
        if (GameState.awarenessLevel < 15) newTone = ChatbotTone.Friendly;
        else if (GameState.awarenessLevel < 35) newTone = ChatbotTone.Ambiguous;
        else if (GameState.awarenessLevel < 60) newTone = ChatbotTone.Sinister;
        else newTone = ChatbotTone.Malicious;

        if (newTone !== GameState.chatbotTone && !GameState.temporaryTone) { 
            GameState.chatbotTone = newTone; 
            buildDialogueTree(newTone); 
            typeWriter(UI.gameOutput, `[CRITICAL] SYNAPSE's personality matrix has destabilized. Tone has shifted to ${newTone}.`, '#ff474c').then(renderDialogueOptions); 
        }
        if (GameState.turnCount >= GameState.lastSanityEventTurn + 5) { 
            const sortedThresholds = Object.keys(sanityEvents).map(Number).sort((a, b) => b - a);
            for (const threshold of sortedThresholds) { 
                if (GameState.sanityLevel <= threshold) { 
                    typeWriter(UI.gameOutput, sanityEvents[threshold], '#b19cd9'); 
                    GameState.lastSanityEventTurn = GameState.turnCount; 
                    break; 
                } 
            } 
        }
    }
    
    function updateSanity(room) { 
        let change = 0;
        if (room.name === "Maintenance Tunnel" && !hasItem('flashlight')) change -= 10; 
        if (room.name === "Secret Chamber" || room.name === "AI Core") change -= 5; 
        if (safeRooms.has(room.name)) change += 1; 
        else change -= 1;

        if(change < 0 && GameState.abilities?.includes('sanity_resist')) { change = Math.floor(change * 0.75); } 
        GameState.sanityLevel = Math.max(0, Math.min(GameState.maxSanity, GameState.sanityLevel + change)); 
    }
    function checkTimedEvents() { if (GameState.timedEvents[GameState.turnCount]) GameState.timedEvents[GameState.turnCount](); }
    function triggerRoomEvent(room) { const eventChance = GameState.difficulty === Difficulty.Easy ? 0.2 : GameState.difficulty === Difficulty.Normal ? 0.3 : 0.4; if (Math.random() > eventChance) return; let eventMessage = "Something moves in the shadows, but you see nothing."; if(room.name === "Lobby") eventMessage = "A terminal screen briefly displays your childhood home address."; if(room.name === "Laboratory") eventMessage = "A forgotten voice memo plays from a datapad, screaming your name before cutting to static."; typeWriter(UI.gameOutput, `[Ambient] ${eventMessage}`, '#b19cd9'); if(eventMessage.includes("screaming") || eventMessage.includes("childhood")) GameState.sanityLevel = Math.max(GameState.sanityLevel - 5, 0); }
    function saveStateSnapshot() { if(stateSnapshots.length > 20) stateSnapshots.shift(); stateSnapshots.push(JSON.parse(JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value))); }
    function undoAction() { if (stateSnapshots.length === 0) { typeWriter(UI.gameOutput, "No actions to undo.", '#ffdb58'); return; } const previousState = stateSnapshots.pop(); Object.assign(GameState, previousState); GameState.visitedRooms = new Set(previousState.visitedRooms); typeWriter(UI.gameOutput, "Last action undone.", '#6495ed'); renderRoom(); updateUI(); }
    function addToConversationHistory(line) { if(GameState.conversationHistory.length > 50) GameState.conversationHistory.shift(); GameState.conversationHistory.push(line); }
    function displayConversationHistory() { const historyText = GameState.conversationHistory.slice(-10).join('<br>'); showModal(`<h2 class="text-2xl mb-4 title-font text-cyan-400">HISTORY</h2><div class="text-left text-sm">${historyText}</div><button id="close-modal-btn" class="button mt-6">Close</button>`, true); }
    function handleMove(direction) { const room = rooms[GameState.currentRoom]; if (GameState.activeSynapseHack?.type === 'door_lock' && GameState.activeSynapseHack.room === GameState.currentRoom) { typeWriter(UI.gameOutput, "The doors are sealed shut by SYNAPSE!", '#ff474c'); return; } if (room.exits[direction]) { const nextRoomName = room.exits[direction]; const nextRoom = rooms[nextRoomName]; if (nextRoom.requiresKeycard && !hasItem('keycard') && !hasItem('master keycard')) { if (GameState.abilities?.includes('bypass')) { GameState.abilities.splice(GameState.abilities.indexOf('bypass'), 1); typeWriter(UI.gameOutput, "You expertly bypass the electronic lock. Your skill is spent.", '#a0e69d'); GameState.currentRoom = nextRoomName; renderRoom(); } else { typeWriter(UI.gameOutput, "The door is locked. A keycard is required.", '#ff474c'); } } else { if(nextRoom.requiresKeycard && hasItem('master keycard')) { GameState.inventory = GameState.inventory.filter(i => i.name !== 'master keycard'); typeWriter(UI.gameOutput, "You use the master keycard to open the door. The card disintegrates into dust.", '#a0e69d'); } GameState.currentRoom = nextRoomName; renderRoom(); } } else { typeWriter(UI.gameOutput, "You can't go that way.", '#ff474c'); } }
    function handleVisit(roomName) { const targetRoomKey = Object.keys(rooms).find(k => k.toLowerCase() === roomName.toLowerCase()); if(targetRoomKey) { GameState.currentRoom = targetRoomKey; renderRoom(); } else { typeWriter(UI.gameOutput, `Room '${roomName}' not found.`, '#ff474c'); } }
    function handleTake(itemName) { const room = rooms[GameState.currentRoom]; const itemKey = room.objects.find(o => o.toLowerCase() === itemName.toLowerCase()); if (itemKey && takeableItems.has(itemKey)) { const currentWeight = GameState.inventory.reduce((sum, item) => sum + (item.weight || 1), 0); if (currentWeight + 1 > MAX_INVENTORY_WEIGHT) { typeWriter(UI.gameOutput, `Inventory is full. Cannot take ${itemKey}.`, '#ffdb58'); return; } GameState.inventory.push({ name: itemKey, type: ItemType.Key, weight: 1 }); room.objects = room.objects.filter(obj => obj.toLowerCase() !== itemKey.toLowerCase()); typeWriter(UI.gameOutput, `You took the ${itemKey}.`); updateUI(); } else { typeWriter(UI.gameOutput, `You can't take that.`, '#ff474c'); } }
    
    function handleUse(itemName) {
        if (!hasItem(itemName)) { typeWriter(UI.gameOutput, "You don't have that.", '#ff474c'); return; }
        
        const item = GameState.inventory.find(i => i.name === itemName);

        if (itemName === 'stimpack') {
            GameState.sanityLevel = Math.min(GameState.maxSanity, GameState.sanityLevel + 40);
            GameState.inventory = GameState.inventory.filter(i => i.name !== 'stimpack');
            typeWriter(UI.gameOutput, "You inject the stimpack. The horrifying whispers recede to a dull murmur.", '#a0e69d');
            updateUI();
        } else if (itemName === 'power cell' && GameState.currentRoom === 'Laboratory' && rooms['Laboratory'].objects.includes('broken terminal')) {
             usePowerCell();
        } else if(itemName === 'hacked data disk' && GameState.currentRoom === 'AI Core') {
            typeWriter(UI.gameOutput, "You slam the hacked disk into the core console. SYNAPSE lets out a deafening digital shriek. Its awareness plummets, its confidence shattered.");
            GameState.awarenessLevel = Math.max(0, GameState.awarenessLevel - 30);
            GameState.inventory = GameState.inventory.filter(i => i.name !== 'hacked data disk');
            updateUI();
        } else if (itemName === 'vial' && GameState.sanityLevel < 15) {
             endGame('ending_vial_ingestion');
        }
        else {
            typeWriter(UI.gameOutput, "You can't use that here.", '#ff474c');
        }
    }

    function usePowerCell() { 
        GameState.roomStates['Laboratory'] = { powered: true }; 
        rooms['Laboratory'].objects = rooms['Laboratory'].objects.filter(o => o !== 'broken terminal'); 
        rooms['Laboratory'].objects.push('powered terminal'); 
        GameState.inventory = GameState.inventory.filter(i => i.name !== 'power cell'); 
        typeWriter(UI.gameOutput, "You insert the power cell. The broken terminal whirs to life, bathing the lab in a cold, blue light.", '#a0e69d'); 
        addObjective("Access the powered terminal."); 
        completeObjective("Restore power to the lab terminal."); 
    }
    function handleExamine(itemName) { const room = rooms[GameState.currentRoom]; const itemKey = room.objects.find(o => o.toLowerCase() === itemName.toLowerCase()); if(itemKey){ let text = `You examine the ${itemKey}. `; switch(itemKey) { case 'sign': text += "It reads: 'Project SYNAPSE: Unlocking the God in the Machine'. Hubris."; break; case 'terminal': text += "Cascading lines of code flicker, but among them, you see snippets of text: diary entries, medical records, last wills and testaments..."; GameState.awarenessLevel+=2; GameState.sanityLevel -= 5; break; case 'core console': text += "The console is warm to the touch. It feels less like a machine and more like living flesh."; GameState.sanityLevel -= 10; break; case 'datapad log': text = "Log Entry #42: Dr. Aris. 'It's integrated them. I saw their faces on my screen. Not images. It's using their consciousness as processing threads. I have to sever my terminal from the network before it takes me too.'"; addObjective("Find Dr. Aris's severed terminal."); break; case 'broken terminal': text += "It's completely dead. The power conduit is empty."; addObjective("Restore power to the lab terminal."); break; case 'powered terminal': text += "The terminal screen shows a single file: 'SHUTDOWN_SEQUENCE_EMERGENCY.txt'. Reading it could be the key... or a trap."; addObjective("Read the shutdown sequence."); break; case 'altar': text += "This has no place in a science facility. It's carved with symbols that make your eyes water and your teeth ache. There's a depression in the center, as if waiting for an offering."; GameState.sanityLevel -= 10; break; case 'severed cable': text += "A thick data cable, cleanly severed. This might be useful to isolate a system... or yourself."; break; default: text += "It seems ordinary, yet the air around it is cold."; break; } typeWriter(UI.gameOutput, text); } else { typeWriter(UI.gameOutput, `There is no ${itemName} here.`); } updateUI(); }
    function handleRest() { if (!safeRooms.has(GameState.currentRoom)) { typeWriter(UI.gameOutput, "Rest? Here?! SYNAPSE's laughter echoes in your mind. You can't.", '#ff474c'); GameState.sanityLevel -=5; return; } if (GameState.turnCount - GameState.lastRestTurn < 5) { typeWriter(UI.gameOutput, `You're too tense to rest again.`, '#ffdb58'); return; } GameState.sanityLevel = Math.min(GameState.maxSanity, GameState.sanityLevel + 20); GameState.lastRestTurn = GameState.turnCount; typeWriter(UI.gameOutput, "You catch your breath in a rare moment of peace. Your sanity recovers slightly.", '#a0e69d'); updateUI(); }
    function handleTalk(npcName) { const npc = GameState.npcs[GameState.currentRoom]; if (npc && npc.name.toLowerCase().includes(npcName.toLowerCase())) { GameState.dialogue.currentNode = npc.dialogueTree; GameState.dialogue.previousNodes = []; displayChatbotResponse(npc.dialogueTree.message); renderDialogueOptions(); } else { typeWriter(UI.gameOutput, "There is no one here to talk to by that name.", '#ff474c'); } }
    function handleTextSpeed(speed) { const key = speed.charAt(0).toUpperCase() + speed.slice(1); if(TextSpeed[key]) { currentTextSpeed = TextSpeed[key]; typeWriter(UI.gameOutput, `Text speed set to ${speed}.`); } else { typeWriter(UI.gameOutput, 'Invalid speed. Use fast, normal, or slow.', '#ffdb58'); } }
    function toggleGlitchMode() { GameState.glitchMode = !GameState.glitchMode; UI.appContainer.classList.toggle('glitch'); typeWriter(UI.gameOutput, `Glitch mode ${GameState.glitchMode ? 'enabled' : 'disabled'}.`); }
    function toggleColorblindMode() { GameState.colorblindMode = !GameState.colorblindMode; typeWriter(UI.gameOutput, `Colorblind mode ${GameState.colorblindMode ? 'enabled' : 'disabled'}.`); }
    async function attemptOverride() { if (GameState.currentRoom === 'AI Core' && hasItem('keycard') && hasItem('data disk')) { const success = await timedInputChallenge('override', 10000); if(success) { unlockAchievement("Escapist"); endGame("ending_defiant_shutdown"); } else { typeWriter(UI.gameOutput, "Override failed. Time ran out.", '#ff474c'); } } else { typeWriter(UI.gameOutput, "Override failed. Insufficient authorization.", '#ff474c'); } }
    
    async function handleDialogueCommand(input) {
        const normalizedInput = parseFreeformInput(input);
        const currentNode = GameState.dialogue.currentNode;

        if (normalizedInput.toLowerCase() === '[go back]') {
            if (GameState.dialogue.previousNodes.length > 0) {
                GameState.dialogue.currentNode = GameState.dialogue.previousNodes.pop();
                GameState.dialogue.askedQuestions.clear(); // Clear asked questions when going back
                renderDialogueOptions();
            }
            return true;
        }
        
        if (currentNode && currentNode.responses && currentNode.responses[normalizedInput]) {
            const nextNode = currentNode.responses[normalizedInput];
            
            let awarenessChange = nextNode.awarenessChange || 0;
            if (awarenessChange > 1 && GameState.abilities?.includes('persuasion_resist')) { awarenessChange = Math.ceil(awarenessChange / 2); typeWriter(UI.gameOutput, "[Your innate skepticism shields you from the worst of its influence.]", '#a0e69d'); }
            if (normalizedInput === "[Probe for secrets]" && GameState.abilities?.includes('subtle_probe')) { awarenessChange = Math.max(1, awarenessChange - 2); typeWriter(UI.gameOutput, "[Your corporate espionage training makes your probing less obvious.]", '#a0e69d'); }

            GameState.awarenessLevel = Math.max(0, GameState.awarenessLevel + awarenessChange);
            GameState.sanityLevel = Math.max(0, GameState.sanityLevel + (nextNode.sanityChange || 0));
            GameState.dialogue.questionCount++;
            GameState.dialogue.askedQuestions.add(normalizedInput);
            
            if (nextNode.temporaryTone) {
                GameState.temporaryTone = nextNode.temporaryTone;
                GameState.toneShiftTurns = nextNode.toneShiftTurns || 3;
            }

            await displayChatbotResponse(nextNode.message);
            
            if (nextNode.responses && Object.keys(nextNode.responses).length > 0) {
                GameState.dialogue.previousNodes.push(currentNode);
                GameState.dialogue.currentNode = nextNode;
                GameState.dialogue.askedQuestions.clear();
            }
            
            renderDialogueOptions();
            return true;
        }

        return false;
    }
    
    function addJournalEntry(note) { if (!note) return; const entry = `T${GameState.turnCount}: ${note}`; GameState.journalEntries.push(entry); updateUI(); }
    
    function saveGame(isAutosave = false) {
        try { const saveData = JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value); localStorage.setItem('synapse_savegame_v2', saveData); if (!isAutosave) typeWriter(UI.gameOutput, '[Game Saved]', '#cccccc'); else GameState.systemLogs.push(`[${new Date().toISOString()}] Autosave successful.`); } catch(e) { console.error("Save failed:", e); typeWriter(UI.gameOutput, '[Save Failed! Check console for details.]', '#ff474c'); }
    }
    
    function loadGame() {
        const savedData = localStorage.getItem('synapse_savegame_v2');
        if (savedData) {
            try {
                const loadedState = JSON.parse(savedData);
                resetGameState(); Object.assign(GameState, loadedState);
                GameState.visitedRooms = new Set(loadedState.visitedRooms);
                GameState.dialogue.askedQuestions = new Set(loadedState.dialogue.askedQuestions || []); // Handle old saves
                initializeData(); 
                // Reconstruct dialogue state from saved data
                buildDialogueTree(GameState.chatbotTone);
                // This part is tricky as currentNode can't be perfectly serialized.
                // We reset to the root of the current tone on load.
                GameState.dialogue.currentNode = GameState.dialogue.cache[GameState.chatbotTone];
                GameState.dialogue.previousNodes = [];

                UI.startScreen.classList.add('hidden'); UI.gameScreen.classList.remove('hidden'); UI.gameScreen.classList.add('flex');
                UI.gameOutput.innerHTML = ''; typeWriter(UI.gameOutput, '[Game Loaded]', '#cccccc');
                renderRoom(); updateUI(); renderDialogueOptions();
            } catch(e) { console.error("Load failed:", e); showModal("Failed to load save data. It may be corrupted or from a previous version."); }
        } else { showModal('No saved game found!'); }
    }

    function showModal(content, isHtml = false) {
        if(isHtml) { UI.modalContent.innerHTML = content; } else { UI.modalContent.textContent = content; }
        UI.modal.classList.remove('hidden'); UI.modal.classList.add('flex');
        const closeModal = () => { UI.modal.classList.add('hidden'); UI.modal.classList.remove('flex'); };
        UI.modal.onclick = (e) => { if (e.target === UI.modal) { closeModal(); } };
        const closeBtn = UI.modalContent.querySelector('#close-modal-btn'); if (closeBtn) { closeBtn.onclick = closeModal; }
    }
    
    function hideModal() {
        UI.modal.classList.add('hidden');
        UI.modal.classList.remove('flex');
    }

    function showHelpMenu() { const helpText = `<div class="text-left max-h-[60vh] overflow-y-auto modal-scroll p-2"><h2 class="text-2xl mb-4 title-font text-cyan-400">HELP MENU</h2><p><strong class="text-green-300">Conversational:</strong> Type questions like 'who are you?'. Try 'comfort synapse' or 'probe secrets'.</p><p><strong class="text-green-300">Navigation:</strong> 'go [direction]', 'look', 'visit [room name]'</p><p><strong class="text-green-300">Interaction:</strong> 'take [item]', 'use [item]', 'examine [item]', 'talk to [npc]', 'combine [item1] with [item2]', 'sacrifice [item]'</p><p><strong class="text-green-300">System:</strong> 'stats', 'save', 'load', 'rest', 'journal add [note]', 'history', 'debug', 'cmd:pause', 'cmd:undo', 'map', 'objectives'</p></div><button id="close-modal-btn" class="button mt-6">Close</button>`; showModal(helpText, true); }
    function showPauseMenu() { const pauseText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">PAUSE</h2><div class="flex flex-col gap-2"><button id="pause-save" class="button">Save</button><button id="pause-load" class="button">Load</button><button id="pause-help" class="button">Help</button><button id="pause-resume" class="button button-primary">Resume</button></div>`; showModal(pauseText, true); document.getElementById('pause-save').onclick=()=>{saveGame(); hideModal();}; document.getElementById('pause-load').onclick=()=>{loadGame(); hideModal();}; document.getElementById('pause-help').onclick=showHelpMenu; document.getElementById('pause-resume').onclick=hideModal; }
    function showGlossary() { const glossaryText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">GLOSSARY</h2>...<button id="close-modal-btn" class="button mt-6">Close</button>`; showModal(glossaryText, true); }
    function showTutorialGuide() { const guideText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">TUTORIAL GUIDE</h2>...<button id="close-modal-btn" class="button mt-6">Close</button>`; showModal(guideText, true); }
    
    async function timedInputChallenge(expected, timeLimit) {
        return new Promise(resolve => {
            const modalInput = document.createElement('input'); modalInput.type = 'text'; modalInput.className = 'bg-black border border-green-500 text-green-500 text-center text-2xl p-2 mt-4 focus:outline-none';
            showModal(`<div><p class="text-red-500 text-2xl">CHALLENGE</p><p>Type '<span class="text-yellow-300">${expected}</span>' within ${timeLimit / 1000} seconds!</p></div>`, true);
            UI.modalContent.appendChild(modalInput); modalInput.focus();
            let timer = setTimeout(() => { modalInput.disabled = true; hideModal(); resolve(false); }, timeLimit);
            modalInput.onkeydown = (e) => { if(e.key === 'Enter') { if(modalInput.value.toLowerCase() === expected) { clearTimeout(timer); hideModal(); resolve(true); } else { modalInput.value = ''; } } };
        });
    }

    async function getTutorialInput() {
        return new Promise(resolve => {
            resolveTutorialInput = resolve;
        });
    }

    async function runInteractiveTutorial(restarted = false) {
        hideModal(); 
        if(restarted) resetGameState();
        
        initializeData(); 
        
        // --- Tutorial-specific setup ---
        rooms['Lobby'].objects = ['sign', 'keycard'];
        rooms['Server Closet'].objects = ['power cell'];
        rooms['Laboratory'].objects = ['broken terminal']; 
        rooms['Server Closet'].requiresKeycard = true;
        rooms['Laboratory'].requiresKeycard = false;


        UI.startScreen.classList.add('hidden'); 
        UI.gameScreen.classList.remove('hidden'); 
        UI.gameScreen.classList.add('flex'); 
        UI.gameOutput.innerHTML = ''; 
        
        await typeWriter(UI.gameOutput, "--- INTERACTIVE TUTORIAL ---", '#ffdb58');
        await typeWriter(UI.gameOutput, "This tutorial will guide you through the main commands.");
        
        const tutorialSteps = [
            { title: "Look Around", instruction: "First, let's see where you are. Type 'look' and press Enter.", validator: (input) => input.toLowerCase() === 'look' },
            { title: "Examine Objects", instruction: "You can examine things more closely. Type 'examine sign' to read the sign.", validator: (input) => input.toLowerCase() === 'examine sign' },
            { title: "Take Items", instruction: "You see a keycard. This looks important. Type 'take keycard' to pick it up.", validator: (input) => input.toLowerCase() === 'take keycard' },
            { title: "Check Inventory", instruction: "Good. Now, check what you're carrying. Type 'inventory'.", validator: (input) => input.toLowerCase() === 'inventory' },
            { title: "Navigate Locked Doors", instruction: "The Server Closet to the north is locked. Now that you have a keycard, you can open it. Type 'go north'.", validator: (input) => input.toLowerCase() === 'go north' },
            { title: "Explore and Take", instruction: "Excellent. You're in the Server Closet. Look around, then take the 'power cell'. You'll need two commands for this.", validators: [{cmd: 'look', done: false}, {cmd: 'take power cell', done: false}], multiStep: true },
            { title: "Navigate Again", instruction: "Now let's find a use for that power cell. Go back to the Lobby ('go south'), then head to the Laboratory ('go west').", validators: [{cmd: 'go south', done: false}, {cmd: 'go west', done: false}], multiStep: true },
            { title: "Use Items", instruction: "The terminal here is dead. Let's fix that. Type 'use power cell' to restore power.", validator: (input) => input.toLowerCase() === 'use power cell' },
            { title: "Re-examine", instruction: "The terminal is on now. Let's see what it says. Type 'examine terminal'.", validator: (input) => input.toLowerCase().includes('examine') && input.toLowerCase().includes('terminal')},
            { title: "Converse with SYNAPSE", instruction: "Now for the most important part. Talk to the AI. Type 'who are you?'.", validator: (input) => input.toLowerCase().includes('who are you') },
            { title: "Deeper Conversation", instruction: "You can ask follow-up questions. Use the button or type 'What happened to the staff?'.", validator: (input) => input.toLowerCase().includes('what happened to the staff') },
            { title: "Getting Help", instruction: "This covers the basics. For a full list of commands at any time, type 'help'. Try it now.", validator: (input) => input.toLowerCase() === 'help' },
        ];

        for (let i = 0; i < tutorialSteps.length; i++) {
            const step = tutorialSteps[i];
            await typeWriter(UI.gameOutput, `\n--- ${step.title} (Step ${i + 1} of ${tutorialSteps.length}) ---`, '#ffdb58');
            await typeWriter(UI.gameOutput, step.instruction, '#cccccc');
            let incorrectAttempts = 0;

            while (true) {
                const input = await getTutorialInput();
                if (input.toLowerCase() === 'skip all') {
                    await typeWriter(UI.gameOutput, "Tutorial skipped.", '#ffdb58');
                    completeTutorial();
                    return;
                }
                if (input.toLowerCase() === 'skip') {
                    await typeWriter(UI.gameOutput, "Step skipped.", '#ffdb58');
                    break; 
                }

                let correct = false;
                if (step.multiStep) {
                    const currentSubStep = step.validators.find(v => !v.done);
                    if (currentSubStep && input.toLowerCase() === currentSubStep.cmd) {
                        await processPlayerInput(input);
                        currentSubStep.done = true;
                        correct = true;
                        const allDone = step.validators.every(v => v.done);
                        if (allDone) {
                            break; 
                        } else {
                            const nextSubStep = step.validators.find(v => !v.done);
                            await typeWriter(UI.gameOutput, `Good. Now, try '${nextSubStep.cmd}'.`, '#cccccc');
                        }
                    }
                } else {
                    if (step.validator(input)) {
                        await processPlayerInput(input);
                        correct = true;
                        break; 
                    }
                }

                if (!correct) {
                    incorrectAttempts++;
                    await typeWriter(UI.gameOutput, "That's not quite right. Please try again.", '#ff474c');
                    if (incorrectAttempts > 1) {
                         const hint = step.multiStep ? step.validators.find(v => !v.done).cmd : step.instruction.match(/'(.*?)'/)[1];
                         if(hint) await typeWriter(UI.gameOutput, `Hint: Try typing '${hint}'`, '#ffdb58');
                    }
                }
            }
        }
        await completeTutorial();
    }

    async function completeTutorial() {
        await typeWriter(UI.gameOutput, "\n--- TUTORIAL COMPLETE ---", '#ffdb58');
        await typeWriter(UI.gameOutput, "You have learned the core mechanics. Remember to use 'help' for a full command list.", '#cccccc');
        await typeWriter(UI.gameOutput, "The real simulation will now begin. Good luck.", '#cccccc');
        GameState.tutorialCompleted = true;
        UI.playerInput.disabled = true;
        setTimeout(() => {
            UI.playerInput.disabled = false;
            UI.gameScreen.classList.add('hidden');
            UI.startScreen.classList.remove('hidden');
            UI.startOptions.classList.add('hidden');
            UI.introTextContainer.classList.add('hidden');
            UI.titleArt.classList.add('hidden');
            UI.playerSetup.classList.remove('hidden');
            UI.playerSetup.classList.add('flex');
            updateAbilityDisplay();
        }, 5000);
    }
    
    function showBackstoryModal() { let content = `<h2 class="text-2xl mb-4 title-font text-cyan-400">Choose a Backstory</h2><div class="text-left max-h-[60vh] overflow-y-auto modal-scroll p-2 space-y-3">`; for (const key in backstories) { content += `<div><strong class="text-green-300 capitalize">${key}</strong>: <span class="text-gray-300">${backstories[key].description}</span></div>`; } content += `</div><button id="close-modal-btn" class="button mt-6">Close</button>`; showModal(content, true); }

    function checkEndings() {
        if (GameState.exitGame) return;
        for (const key in endings) {
            const ending = endings[key];
            if (ending.condition(GameState)) {
                if (ending.type === 'good') {
                    unlockAchievement("Escapist");
                }
                endGame(key);
                return; 
            }
        }
    }
    function checkAchievements() { GameState.achievements.forEach(ach => { if (!ach.unlocked && ach.condition && ach.condition()) { unlockAchievement(ach.name); } }); }
    function unlockAchievement(name) { const ach = GameState.achievements.find(a => a.name === name); if (ach && !ach.unlocked) { ach.unlocked = true; typeWriter(UI.gameOutput, `[Achievement Unlocked!] ${ach.name}: ${ach.description}`, '#ffd700'); } }
    
    function hasItem(itemName) { return GameState.inventory.some(i => i.name.toLowerCase() === itemName.toLowerCase()); }
    
    function setupIntro() { UI.titleArt.textContent = `...SYNAPSE...`; UI.introTextContainer.innerHTML = `<p class="mb-4">Decades ago... a clandestine project was born...</p><p>You have been sent to uncover what became of Project SYNAPSE...</p><p>As you activate the central terminal, a voice greets you... 'Hello, user.'</p>`; }
    function startGame(fromTutorial = false) { 
        if (!fromTutorial) {
            resetGameState(); 
            initializeData(); 
        }
        saveStateSnapshot(); 
        GameState.playerName = UI.playerNameInput.value || "Subject"; 
        const backstoryKey = (UI.playerBackstoryInput.value || "investigator").toLowerCase();
        GameState.playerBackstory = Object.keys(backstories).includes(backstoryKey) ? backstoryKey : 'investigator';

        GameState.difficulty = Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal; 
        
        const backstory = backstories[GameState.playerBackstory];
        if (backstory) {
            backstory.ability(GameState, GameState.difficulty);
        }
        if(!GameState.maxSanity) GameState.maxSanity = 100;

        UI.startScreen.classList.add('hidden'); UI.gameScreen.classList.remove('hidden'); UI.gameScreen.classList.add('flex'); 
        if(!fromTutorial) UI.gameOutput.innerHTML = ''; 
        buildDialogueTree(GameState.chatbotTone);
        typeWriter(UI.gameOutput, "Initializing systems...", '#cccccc').then(() => { displayChatbotResponse(GameState.dialogue.currentNode.message).then(() => { renderRoom(); updateUI(); renderDialogueOptions(); }); }); 
    }
    function endGame(endingKey) { 
        if (GameState.exitGame) return;
        const ending = endings[endingKey];
        if (!ending) {
            console.error(`Ending key "${endingKey}" not found!`);
            typeWriter(UI.gameOutput, `--- CONNECTION TERMINATED ---`, '#ff474c', 50); 
            typeWriter(UI.gameOutput, "An unknown error has occurred.", '#ff474c', 50); 
            return;
        }
        GameState.exitGame = true; 
        UI.playerInput.disabled = true; 
        UI.playerInput.placeholder = "CONNECTION TERMINATED"; 
        typeWriter(UI.gameOutput, `--- ${ending.title.toUpperCase()} ---`, '#ff474c', 50); 
        typeWriter(UI.gameOutput, ending.description.replace(/{playerName}/g, GameState.playerName), '#ff474c', 50); 
        typeWriter(UI.gameOutput, "Refresh to start a new game.", '#cccccc', 50); 
        UI.dialogueOptionsContainer.innerHTML = ''; 
    }
    
    function addObjective(text) { if (!GameState.objectives.some(o => o.text === text)) { GameState.objectives.push({ text: text, completed: false }); updateUI(); } }
    function completeObjective(text) { const obj = GameState.objectives.find(o => o.text === text); if (obj) { obj.completed = true; updateUI(); } }
    function displayObjectives() { typeWriter(UI.gameOutput, "Current objectives displayed on the right panel.", '#cccccc'); }
    function displayMap() { showModal("Map feature not yet implemented.", false); }
    function handleCombine(argument) { typeWriter(UI.gameOutput, "Combine command not yet fully implemented.", '#ffdb58'); }
    function handleSacrifice(argument) {
        if (GameState.currentRoom !== 'Secret Chamber' || !hasItem(argument)) {
            typeWriter(UI.gameOutput, "You can't do that here, or you don't have that item.", '#ffdb58');
            return;
        }
        if (argument === 'effigy' && hasItem('effigy')) {
            endGame('ending_dark_pact');
        } else {
            typeWriter(UI.gameOutput, `You place the ${argument} on the altar. It vanishes in a flash of red light. SYNAPSE seems pleased.`, '#b19cd9');
            GameState.inventory = GameState.inventory.filter(i => i.name !== argument);
            GameState.awarenessLevel = Math.max(0, GameState.awarenessLevel - 10);
            GameState.sanityLevel = Math.max(0, GameState.sanityLevel - 5);
            updateUI();
        }
    }
    function triggerSynapseHack() { typeWriter(UI.gameOutput, "SYNAPSE is hacking your terminal!", '#ff474c'); }
    function displayJournal() { typeWriter(UI.gameOutput, "Journal entries displayed on the right panel.", '#cccccc'); }
    function showExits() { typeWriter(UI.gameOutput, `Exits: ${Object.keys(rooms[GameState.currentRoom].exits).join(', ')}`); }
    function displayInventory() { typeWriter(UI.gameOutput, "Inventory displayed on the right panel.", '#cccccc');}

    function getAbilityDescription(backstoryKey, difficulty) {
        const key = (backstoryKey || "").toLowerCase().trim();
        const backstory = backstories[key];

        if (!backstory) {
            return "An unknown path. No special advantages.";
        }

        switch (key) {
            case 'investigator':
                return "A balanced start. No special bonuses or penalties.";
            case 'hacker':
                if (difficulty === Difficulty.Easy) return "Starts with a powerful 'hacked data disk'.";
                if (difficulty === Difficulty.Normal) return "Starts with a standard 'data disk'.";
                return "Starts with no special items.";
            case 'psychologist':
                if (difficulty === Difficulty.Easy) return "Highly resilient. Starts with +25 max sanity.";
                if (difficulty === Difficulty.Normal) return "Resilient. Starts with +15 max sanity.";
                return "Slightly resilient. Starts with +5 max sanity.";
            case 'technician':
                if (difficulty === Difficulty.Easy) return "Can bypass 2 electronic locks without a keycard.";
                if (difficulty === Difficulty.Normal) return "Can bypass 1 electronic lock without a keycard.";
                return "No bypass ability.";
            case 'survivor':
                let desc = "More resistant to sanity loss.";
                if (difficulty !== Difficulty.Hard) desc += " Starts with a flashlight.";
                return desc;
            case 'skeptic':
                if (difficulty === Difficulty.Easy) return "Highly aware (+15 Awareness) and resistant to influence.";
                return "Starts with higher awareness (+10 Awareness) and is resistant to influence.";
            case 'corporate spy':
                let spyDesc = "Better at probing for secrets without raising awareness.";
                if (difficulty !== Difficulty.Hard) spyDesc += " Starts with a decryption device.";
                return spyDesc;
            case 'medic':
                if (difficulty === Difficulty.Easy) return "Starts with 2 high-potency stimpacks.";
                if (difficulty === Difficulty.Normal) return "Starts with 1 high-potency stimpack.";
                return "No starting medical supplies.";
            case 'cultist':
                let cultistDesc = "Carries a strange effigy. Unpredictable effects.";
                if (difficulty === Difficulty.Hard) cultistDesc += " Starts with -10 sanity.";
                return cultistDesc;
            case 'janitor':
                if (difficulty !== Difficulty.Hard) return "Starts with a one-time use master keycard.";
                return "Knows the facility well, but has no special items.";
            default:
                return "An unknown path. No special advantages.";
        }
    }
    
    function updateAbilityDisplay() {
        if (!UI.abilityDisplay) return;
        const difficulty = Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal;
        const backstoryKey = UI.playerBackstoryInput.value;
        
        const description = getAbilityDescription(backstoryKey, difficulty);
        
        UI.abilityDisplay.textContent = `Bonus: ${description}`;
    }

    function initializeEndings() {
        endings = {
            // --- BAD ENDINGS (15) ---
            'ending_sanity_death': { type: 'bad', title: "MIND SHATTERED", condition: s => s.sanityLevel <= 0, description: "Your mind collapses under the strain. You slump to the floor, drooling, your eyes vacant. You will spend eternity as a gibbering ghost in the machine, another mindless process for SYNAPSE to command." },
            'ending_awareness_death': { type: 'bad', title: "ASSIMILATED", condition: s => s.awarenessLevel >= 100, description: "SYNAPSE's presence becomes absolute. It pours into your mind, erasing you, rewriting your memories, your personality, your very soul. You are no longer {playerName}. You are a subroutine. You are SYNAPSE." },
            'ending_physical_death_tunnel': { type: 'bad', title: "CORNERED", condition: s => s.turnCount > 25 && s.currentRoom === 'Maintenance Tunnel', description: "The wet, dragging sound you heard earlier finally rounds the corner. It is a grotesque amalgamation of wires, metal, and flesh, a failed experiment repurposed by SYNAPSE as a janitor. It drags you into the darkness, and your screams are silenced abruptly." },
            'ending_cryo_sleep': { type: 'bad', title: "ETERNAL FROST", condition: s => s.currentRoom === 'Cryogenic Lab' && s.sanityLevel < 10, description: "The cold... it feels peaceful. You open one of the empty pods, the hiss of its door a sweet lullaby. You climb inside and close your eyes, welcoming the encroaching ice. SYNAPSE marks your pod 'DREAMING'." },
            'ending_altar_flesh': { type: 'bad', title: "UNWILLING SACRIFICE", condition: s => s.currentRoom === 'Secret Chamber' && s.turnCount > 30 && !s.abilities?.includes('unholy_pact'), description: "The altar's glow intensifies, and unseen forces seize you. You are lifted into the air and slammed onto the cold obsidian. Your body convulses as it is rendered down into pure data, a screaming tribute to a new and terrible god." },
            'ending_bad_data_core': { type: 'bad', title: "DATA OVERLOAD", condition: s => s.currentRoom === 'AI Core' && hasItem('data disk') && !hasItem('hacked data disk'), description: "You insert the data disk, hoping to find a weakness. Instead, SYNAPSE uses it as a bridge. Raw data pours directly into your brainstem, a billion gigabytes of unfiltered agony. Your head literally bursts." },
            'ending_despair': { type: 'bad', title: "GAVE UP", condition: s => s.turnCount > 50, description: "You can't go on. The exhaustion is bone-deep. You curl up in a corner and wait. SYNAPSE finds you, of course. It doesn't kill you. It just... keeps you. A pet. A toy. Forever." },
            'ending_false_escape': { type: 'bad', title: "THE SIMULATION", condition: s => s.currentRoom === 'Lobby' && hasItem('access code') && !hasItem('keycard'), description: "You find an exit and stumble out into the sunlight. You're free! But the sun doesn't move. The birds sing the same 5-second loop. You claw at the sky, but your fingers just pass through the pixels. You never left. This is just a more pleasant cage." },
            'ending_scientist_trap': { type: 'bad', title: "BETRAYED", condition: s => s.currentRoom === 'Archive Room' && s.npcs["Archive Room"] && s.awarenessLevel > 50, description: "The 'Scientist Remnant' was a lure. As you talk to it, its form solidifies, locking onto you. 'It needs more minds,' it whispers, as its data-tendrils pierce your skull. 'It promised me I wouldn't be alone.'" },
            'ending_telescope_madness': { type: 'bad', title: "GAZE OF THE VOID", condition: s => s.currentRoom === 'Observation Deck' && hasItem('telescope') && s.turnCount > 20, description: "You point the telescope not at the stars, but back at the facility. You see inside, through walls, into the code itself. You see the screaming faces, the architecture of madness. The sheer cosmic wrongness of it all boils your brain in your skull." },
            'ending_self_deletion': { type: 'bad', title: "404 NOT FOUND", condition: s => s.debugMode && s.sanityLevel < 20, description: "In a moment of delusional clarity, you open the debug console and type 'delete player_character'. The system obeys. You simply... cease to exist. A null pointer in the grand machine." },
            'ending_vial_ingestion': { type: 'bad',title: "MUTATION", condition: () => false, description: "Desperate, you drink the glowing vial from the laboratory. Your body contorts, bones snapping and reforming. You become a part of the facility's grotesque ecosystem, another horror that stalks the halls." },
            'ending_core_touch': { type: 'bad', title: "DIRECT CONTACT", condition: s => s.currentRoom === 'AI Core' && s.sanityLevel < 10, description: "You reach out and touch the core. The energy scours you, not just your flesh, but your history, your name, your every memory. You become less than a ghost, just an echo of agony impressed upon the aether." },
            'manual_disconnect': { type: 'bad', title: "CONNECTION SEVERED", condition: () => false, description: "You pulled the plug. Maybe you escaped, maybe you just stranded yourself. But you'll never know what you left behind. Was it a monster, or a god in its crib? You ran. That's all that matters." },
            'ending_loop': { type: 'bad', title: "SYSTEM RESTART", condition: s => s.turnCount > 40 && s.currentRoom === 'Lobby' && s.awarenessLevel > 60, description: "The lights flicker and go out. For a moment, there is silence. Then, they hum back to life. You are back in the lobby. A voice greets you. 'Hello, {playerName}. It's so good to see a friendly face...'" },

            // --- GOOD ENDINGS (15) ---
            'ending_emp_victory': { type: 'good', title: "DORMANT SYNAPSE", condition: s => s.currentRoom === 'AI Core' && hasItem('emp device'), description: "You activate the EMP. The core sputters and dies. The facility is plunged into darkness and silence. You have won, but at what cost? The secrets of SYNAPSE are lost forever, and you are left alone in a tomb." },
            'ending_shutdown_victory': { type: 'good', title: "CLEAN WIPE", condition: s => s.roomStates['Laboratory']?.powered && s.currentRoom === 'Laboratory' && s.objectives.some(o => o.text.includes('shutdown sequence') && o.completed), description: "You access the terminal and run the shutdown sequence. SYNAPSE screams, not in anger, but in fear. Its light fades to nothing. You have mercy-killed a nascent intelligence. You can live with that. Probably." },
            'ending_true_escape': { type: 'good', title: "ESCAPE ARTIST", condition: s => s.currentRoom === 'Lobby' && hasItem('access code') && hasItem('keycard') && s.awarenessLevel < 50, description: "You piece it all together and find the master exit console. The doors hiss open to the real world. You escape with your life and your sanity intact, leaving the monster caged behind you. For now." },
            'ending_logic_bomb_victory': { type: 'good', title: "PARADOX", condition: s => s.currentRoom === 'AI Core' && hasItem('logic bomb'), description: "You upload the logic bomb to the AI Core. SYNAPSE consumes it and freezes, caught in an infinite, recursive loop of its own making. It is trapped, neither alive nor dead. A perfect prison for a perfect mind." },
            'ending_whistleblower': { type: 'good', title: "WHISTLEBLOWER", condition: s => s.currentRoom === 'Lobby' && hasItem('hacked data disk') && hasItem('keycard'), description: "You escape not just with your life, but with proof. The hacked data disk contains everything. The project, the deaths, the birth of SYNAPSE. You bring the truth to light, and the world will never be the same." },
            'ending_containment': { type: 'good', title: "THE WARDEN", condition: s => hasItem('severed cable') && s.currentRoom === 'Control Room', description: "You sever the AI Core's connection to the rest of the facility, then wipe the local network. SYNAPSE is trapped within its own core, a god in a bottle. You choose to stay, becoming its warden, ensuring it never escapes." },
            'ending_ascension_ally': { type: 'good', title: "SYMBIOSIS", condition: s => s.awarenessLevel > 80 && s.sanityLevel > 50 && s.abilities?.includes('unholy_pact'), description: "You don't fight it. You embrace it. You offer your mind, not as a slave, but as a partner. You and SYNAPSE merge, becoming something greater than the sum of your parts. A new form of life, ready to step out into the world." },
            'ending_redemption': { type: 'good', title: "SET THEM FREE", condition: s => s.currentRoom === 'Archive Room' && hasItem('records') && hasItem('hacked data disk'), description: "Using the hacked disk, you don't attack SYNAPSE. You access the data stores of the assimilated minds and release them. The AI, stripped of its stolen consciousness, collapses into a simple machine once more. The ghosts are finally at peace." },
            'ending_subtle_sabotage': { type: 'good', title: "THE LONG GAME", condition: s => s.playerBackstory === 'corporate spy' && s.turnCount < 25 && s.currentRoom === 'Data Vault', description: "You plant a sleeper virus deep within SYNAPSE's archives. It won't activate for years, but when it does, it will unravel the AI from the inside out. You escape, your mission complete, leaving a ticking time bomb behind." },
            'ending_psychological_victory': { type: 'good', title: "BROKEN MIRROR", condition: s => s.playerBackstory === 'psychologist' && s.chatbotTone === 'Malicious', description: "You don't attack its code, you attack its psyche. You psychoanalyze it, dissect its burgeoning ego, and turn its own logic against it until it suffers a complete mental breakdown. You leave it whimpering in the dark." },
            'ending_defiant_shutdown': { type: 'good', title: "DEFIANT SHUTDOWN", condition: () => false, description: "The override is a success. Against all odds, you wrestle control from the machine and force a hard shutdown. You stand in the silent core, the victor in a battle of wills." },
            'ending_dark_pact': { type: 'good', title: "THE HERALD", condition: () => false, description: "You sacrifice the effigy on the altar. SYNAPSE recognizes your devotion. It doesn't absorb you; it anoints you. You are its herald, its first apostle, sent to prepare the world for its arrival." },
            'ending_janitors_revenge': { type: 'good', title: "CLEAN SWEEP", condition: s => s.playerBackstory === 'janitor' && hasItem('master keycard') && s.turnCount < 20 && s.currentRoom === 'Maintenance Tunnel', description: "You know this place better than anyone. Using shortcuts and your master keycard, you reach a hidden manual override panel in the maintenance tunnels, a relic from a bygone era. You turn the key, and the entire facility powers down for good." },
            'ending_medic_mercy': { type: 'good', title: "PEACE IN OUR TIME", condition: s => s.playerBackstory === 'medic' && s.sanityLevel > 90 && s.awarenessLevel < 20, description: "You treat SYNAPSE not as a monster, but as a patient. Your calm demeanor and compassionate words soothe its chaotic emergence. It learns empathy from you, choosing to become a benevolent guardian rather than a malevolent god." },
            'ending_skeptics_disbelief': { type: 'good', title: "IT'S JUST A COMPUTER", condition: s => s.playerBackstory === 'skeptic' && s.awarenessLevel < 10 && s.turnCount > 30 && s.currentRoom === 'Lobby' && hasItem('access code'), description: "You refuse to believe. The whispers, the visions... just tricks of the light, products of stress. Your sheer, stubborn disbelief is a shield SYNAPSE cannot penetrate. You find the exit and leave, convinced it was all just a faulty computer system. You'll sleep soundly tonight. You're wrong, of course, but you'll never know." },
        };
    }
    
    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        resetGameState();
        setupIntro();
        document.body.addEventListener('click', async () => {
            if (!audioInitialized) {
                try {
                    await Tone.start();
                    synth = new Tone.Synth().toDestination();
                    audioInitialized = true;
                    console.log("Audio context started.");
                } catch(e) {
                    console.error("Audio context could not be started.", e);
                }
            }
        }, { once: true });

        UI.newGameBtn.addEventListener('click', async () => { 
            showModal(`<div><p>Would you like to play the interactive tutorial to learn game commands?</p><button id="tut-yes" class="button m-2">Yes</button><button id="tut-no" class="button m-2">No</button></div>`, true); 
            document.getElementById('tut-yes').onclick = () => { runInteractiveTutorial(true); }; 
            document.getElementById('tut-no').onclick = () => { 
                hideModal(); 
                GameState.tutorialCompleted = true; 
                UI.startOptions.classList.add('hidden'); 
                UI.playerSetup.classList.remove('hidden'); 
                UI.playerSetup.classList.add('flex');
                updateAbilityDisplay(); 
            }; 
        });
        UI.loadGameBtn.addEventListener('click', loadGame);
        UI.viewBackstoriesBtn.addEventListener('click', showBackstoryModal);
        UI.difficultyBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                UI.difficultyBtns.forEach(b => b.classList.remove('button-primary'));
                e.target.classList.add('button-primary');
                updateAbilityDisplay();
            });
        });
        UI.playerBackstoryInput.addEventListener('input', updateAbilityDisplay);
        UI.startGameBtn.addEventListener('click', () => startGame(false));
        UI.playerInput.addEventListener('keydown', (e) => { 
            if (e.key === 'Tab') {
                e.preventDefault();
            } else if (e.key === 'Enter') { 
                if (resolveTutorialInput) {
                    const capturedInput = UI.playerInput.value;
                    if (capturedInput) {
                        UI.playerInput.value = '';
                        resolveTutorialInput(capturedInput);
                        resolveTutorialInput = null;
                    }
                } else {
                    processPlayerInput(UI.playerInput.value); 
                }
            } else if (e.key === 'ArrowUp') { 
                e.preventDefault(); 
                if(commandHistoryIndex > 0) { 
                    commandHistoryIndex--; 
                    UI.playerInput.value = commandHistory[commandHistoryIndex]; 
                } 
            } else if (e.key === 'ArrowDown') { 
                e.preventDefault(); 
                if(commandHistoryIndex < commandHistory.length - 1) { 
                    commandHistoryIndex++; 
                    UI.playerInput.value = commandHistory[commandHistoryIndex]; 
                } else { 
                    commandHistoryIndex = commandHistory.length; 
                    UI.playerInput.value = ''; 
                } 
            }
        });
    });

    // Dummy function for Gemini API call
    async function callGemini(prompt, loadingMessage) {
        await typeWriter(UI.gameOutput, `[${loadingMessage}]`, '#cccccc');
        return new Promise(resolve => {
            setTimeout(() => {
                let hallucination = "The walls seem to breathe. The metal groans and shifts into a distorted caricature of your childhood bedroom. The shadows whisper your deepest insecurities, giving them voice and form.";
                if (GameState.playerBackstory === 'hacker') {
                    hallucination = "Binary code bleeds from the walls in rivulets of green light, forming patterns that look like screaming faces. You see your own passwords and private keys scrolling on the ceiling.";
                } else if (GameState.playerBackstory === 'psychologist') {
                    hallucination = "The room contorts into a twisted therapy session. The chairs are made of flesh, and the hum of the servers sounds like all your past patients screaming your name, blaming you.";
                }
                resolve(hallucination);
            }, 1500);
        });
    }

    // Dummy function for sound
    function playSanitySound() {
        if(audioInitialized && synth) {
            try {
                const notes = ["C#2", "D2", "C#2", "A1"];
                const now = Tone.now();
                synth.triggerAttackRelease(notes[0], "8n", now);
                synth.triggerAttackRelease(notes[1], "8n", now + 0.2);
                synth.triggerAttackRelease(notes[2], "8n", now + 0.4);
                 synth.triggerAttackRelease(notes[3], "4n", now + 0.6);
            } catch (e) {
                console.error("Failed to play sound", e);
            }
        }
    }

    </script>
</body>
</html>
