<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SYNAPSE</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DDriftz/Synapse2.0-An-AI-Chatbot-Horror-Game/main/Icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=VT323&family=Space+Mono&family=Courier+Prime&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --main-color: #00ff41;
            --main-color-faded: rgba(0,255,65,0.1);
            --main-color-border: rgba(0,255,65,0.8);
            --main-color-shadow: rgba(0,255,65,0.5);
            --main-color-glow: rgba(0,255,65,0.7);
        }
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            font-size: clamp(14px, 1.5vw, 18px); 
        }
        body {
            background-color: #0d0d0d;
            color: var(--main-color);
            font-family: 'Space Mono', monospace;
            position: fixed; 
        }
        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.1;
        }
        #app-container {
            position: relative;
            z-index: 1;
        }
        body.crt-effect::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: rgba(18, 16, 16, 0.1);
            opacity: .5;
            z-index: 2;
            pointer-events: none;
            background: repeating-linear-gradient(0deg, rgba(0, 255, 65, 0.15), rgba(0, 255, 65, 0.15) 1px, transparent 1px, transparent 2px);
        }
        .title-font {
            font-family: 'VT323', monospace;
        }

        .title-wrapper {
            position: relative;
        }
        
        /* Main green text layer */
        .title-slasher {
            font-family: 'Creepster', cursive;
            color: #39FF14;
            letter-spacing: 0.1em;
            position: relative;
            z-index: 1; 
            /* Green text's own glow */
            text-shadow: 
                0 0 5px #39FF14, 
                0 0 10px #39FF14;
        }

        /* The blood layer behind the text */
        .title-slasher::before {
            content: attr(data-text);
            position: absolute;
            left: 0;
            top: 0;
            color: transparent; /* The text color is transparent; the shadow creates the effect */
            z-index: -1; 
            animation: liquid-drip 3.5s infinite ease-in;
            filter: drop-shadow(0 0 5px #ff0000) drop-shadow(0 0 15px #d40000) drop-shadow(0 0 25px #a00);
        }

        @keyframes liquid-drip {
            0% { text-shadow: 1px 1px 0px #a00, 2px 2px 0px #800, 3px 3px 0px #600, 0 0 5px #d00, 0px 0px 0px #500; opacity: 1; }
            50% { text-shadow: 1px 1px 0px #a00, 2px 2px 0px #800, 3px 3px 0px #600, 0 0 5px #d00, 0px 20px 10px #500, -5px 30px 12px #400, 5px 35px 12px #300; opacity: 1; }
            90% { text-shadow: 1px 1px 0px rgba(170,0,0,0.2), 2px 2px 0px rgba(136,0,0,0.2), 3px 3px 0px rgba(102,0,0,0.2), 0 0 5px rgba(221,0,0,0.5), 0px 40px 20px rgba(85,0,0,0.1), -5px 50px 22px rgba(68,0,0,0.05), 5px 55px 22px rgba(51,0,0,0.05); opacity: 0.8; }
            100% { text-shadow: 1px 1px 0px transparent, 2px 2px 0px transparent, 3px 3px 0px transparent, 0 0 5px transparent, 0px 45px 30px transparent, -5px 55px 30px transparent, 5px 60px 30px transparent; opacity: 0; }
        }
        
        .btn-drip { position: relative; z-index: 1; }
        .btn-drip::before {
            content: attr(data-text);
            position: absolute; left: 0; top: 0; width: 100%; height: 100%;
            color: transparent; z-index: -1;
            filter: drop-shadow(0 0 2px #ff0000) drop-shadow(0 0 5px #d40000);
            animation: button-drip-anim 5s infinite ease-out;
            font-family: inherit; font-size: inherit; letter-spacing: inherit;
            display: flex; align-items: center; justify-content: center; padding: inherit;
        }

        @keyframes button-drip-anim {
            0% { text-shadow: 1px 1px 0px #600, 0 0 2px #d00, 0px 0px 0px #400; opacity: 1; }
            50% { text-shadow: 1px 1px 0px #600, 0 0 2px #d00, 0px 10px 5px #400, -2px 15px 6px #300; opacity: 1; }
            90% { text-shadow: 1px 1px 0px rgba(102,0,0,0.2), 0 0 2px rgba(221,0,0,0.5), 0px 18px 10px rgba(68,0,0,0.1), -2px 22px 12px rgba(51,0,0,0.05); opacity: 0.8; }
            100% { text-shadow: 1px 1px 0px transparent, 0 0 2px transparent, 0px 20px 15px transparent, -2px 25px 15px transparent; opacity: 0; }
        }

        .input-caret {
            background-color: var(--main-color);
            width: 10px; height: 20px; animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: var(--main-color); }
        }
        #game-output::-webkit-scrollbar, #journal-panel::-webkit-scrollbar, #objectives-panel::-webkit-scrollbar, .modal-scroll::-webkit-scrollbar { width: 8px; }
        #game-output::-webkit-scrollbar-track, #journal-panel::-webkit-scrollbar-track, #objectives-panel::-webkit-scrollbar-track, .modal-scroll::-webkit-scrollbar-track { background: #1a1a1a; }
        #game-output::-webkit-scrollbar-thumb, #journal-panel::-webkit-scrollbar-thumb, #objectives-panel::-webkit-scrollbar-thumb, .modal-scroll::-webkit-scrollbar-thumb { background-color: var(--main-color); border-radius: 4px; }
        .glitch { animation: glitch-anim 1.5s infinite alternate-reverse; }
        @keyframes glitch-anim {
          0% { transform: translate(0); clip-path: inset(45% 0 50% 0); } 5% { transform: translate(2px, -3px); clip-path: inset(25% 0 35% 0); } 10% { transform: translate(-2px, 3px); clip-path: inset(60% 0 10% 0); } 15% { transform: translate(0); clip-path: inset(90% 0 5% 0); } 20% { clip-path: inset(40% 0 45% 0); } 25% { transform: translate(3px, 2px); clip-path: inset(20% 0 70% 0); } 30% { transform: translate(-3px, -2px); clip-path: inset(85% 0 5% 0); } 35% { clip-path: inset(15% 0 80% 0); } 40% { transform: translate(0); clip-path: inset(55% 0 25% 0); } 45% { clip-path: inset(30% 0 55% 0); } 50% { transform: translate(2px, 3px); clip-path: inset(70% 0 5% 0); } 55% { transform: translate(-2px, -3px); clip-path: inset(10% 0 85% 0); } 60% { clip-path: inset(75% 0 15% 0); } 65% { transform: translate(0); clip-path: inset(5% 0 90% 0); } 70% { clip-path: inset(65% 0 20% 0); } 75% { transform: translate(3px, -2px); clip-path: inset(45% 0 50% 0); } 80% { transform: translate(-3px, 2px); clip-path: inset(25% 0 65% 0); } 85% { clip-path: inset(95% 0 2% 0); } 90% { transform: translate(0); clip-path: inset(30% 0 60% 0); } 95% { clip-path: inset(5% 0 75% 0); } 100% { transform: translate(2px, 2px); clip-path: inset(80% 0 10% 0); }
        }
        .button {
            background-color: var(--main-color-faded); border: 1px solid var(--main-color-border); color: #fff; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: all 0.2s; cursor: pointer; flex-shrink: 0; -webkit-tap-highlight-color: transparent; text-shadow: 0 0 3px var(--main-color-shadow);
        }
        .button:hover, .button:active { background-color: rgba(0,255,65,0.3); box-shadow: 0 0 10px rgba(0,255,65,0.5); }
        .button:active { transform: translateY(1px) scale(0.98); }
        .btn-glow {
            font-family: 'VT323', monospace;
            font-size: 1.25rem;
            letter-spacing: 0.05em;
        }
        
        @keyframes button-glow-border {
            0%, 19.9%, 22.1%, 60%, 100% { box-shadow: 0 0 5px var(--main-color-glow), 0 0 5px rgba(255,0,0,0.6), inset 0 0 3px var(--main-color-shadow); text-shadow: 0 0 3px var(--main-color-shadow); }
            20% { box-shadow: 0 0 10px var(--main-color-glow), 0 0 12px rgba(255,0,0,0.8), inset 0 0 5px var(--main-color-glow); text-shadow: 0 0 5px var(--main-color); }
            22% { box-shadow: 0 0 5px var(--main-color-glow), 0 0 5px rgba(255,0,0,0.6), inset 0 0 3px var(--main-color-shadow); text-shadow: 0 0 3px var(--main-color-shadow); }
        }
        
        .button.btn-glow {
            animation: button-glow-border 5s infinite linear;
        }

        .button-primary { background-color: var(--main-color); color: #000; font-weight: bold; text-shadow: none; }
        .button-primary:hover, .button-primary:active { background-color: #fff; }
        .modal { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; padding: 1rem; z-index: 50; animation: fadeIn 0.3s ease-out; }
        .modal.flex { display: flex; }
        .modal-content { background-color: #0d0d0d; border: 2px solid var(--main-color); padding: 1.5rem; border-radius: 0.5rem; max-width: 48rem; width: 100%; text-align: center; animation: scaleUp 0.3s ease-out; max-height: 90vh; display: flex; flex-direction: column;}
        .modal-scroll { overflow-y: auto; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        #start-screen, #player-setup {
            background-image: url('https://raw.githubusercontent.com/DDriftz/Synapse2.0-An-AI-Chatbot-Horror-Game/main/Icon.png');
            background-size: cover; background-position: center; background-repeat: no-repeat;
        }
        #map-canvas {
            background-color: rgba(0, 20, 0, 0.5);
            width: 100%;
            height: 100%;
            cursor: grab;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        #map-canvas:active {
            cursor: grabbing;
        }
        #map-panel.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 100;
            padding: 1rem;
            background-color: #0d0d0d;
        }
         #map-panel.fullscreen #map-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 101;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            border: 1px solid var(--main-color);
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: #ccc;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--main-color);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
            background-color: #0d0d0d;
        }
        /* --- NEW STYLES FOR ENHANCEMENTS --- */
        .clickable-object {
            color: #67e8f9; /* cyan-300 */
            text-decoration: underline;
            text-decoration-style: dotted;
            cursor: pointer;
        }
        .clickable-object:hover {
            color: #cffafe; /* cyan-100 */
            background-color: rgba(0, 255, 65, 0.1);
        }
        #autocomplete-box {
            position: absolute;
            bottom: 100%; /* Position above the input bar */
            left: 0;
            right: 0;
            background-color: rgba(13, 13, 13, 0.95);
            border: 1px solid var(--main-color-border);
            border-bottom: none;
            border-radius: 0.375rem 0.375rem 0 0;
            max-height: 150px;
            overflow-y: auto;
            z-index: 20;
        }
        .autocomplete-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: #a0a0a0;
            border-bottom: 1px solid #333;
        }
        .autocomplete-item:hover {
            background-color: var(--main-color-faded);
            color: #fff;
        }
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        @keyframes light-flicker {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        .flicker {
            animation: light-flicker 0.2s infinite;
        }
    </style>
</head>
<body class="bg-black flex items-center justify-center min-h-screen">
    <canvas id="background-canvas"></canvas>
    <div id="app-container" class="w-full h-full bg-black/75 p-2 sm:p-4 flex flex-col">
        
        <div id="start-screen" class="flex flex-col items-center justify-center text-center h-full">
            <div class="w-full h-full flex flex-col items-center justify-center bg-black bg-opacity-60">
                <!-- Header for lang buttons -->
                <div class="w-full flex justify-end p-2">
                    <div id="lang-buttons" class="flex gap-2">
                        <button id="lang-en-btn" data-lang="en_lang_short" data-text="EN" class="button text-xs !px-2 !py-1 btn-drip">EN</button>
                        <button id="lang-sv-btn" data-lang="sv_lang_short" data-text="SV" class="button text-xs !px-2 !py-1 opacity-50 btn-drip">SV</button>
                    </div>
                </div>

                <!-- Main content flex-grow -->
                <div class="flex-grow flex flex-col items-center justify-center text-center px-4 w-full">
                    <div class="title-wrapper -mt-16 sm:-mt-20">
                        <h1 id="game-title" data-text="SYNAPSE" class="text-7xl md:text-9xl font-bold title-slasher mb-4">SYNAPSE</h1>
                    </div>
                    <div id="intro-text-container" class="max-w-4xl text-sm md:text-base text-white mt-8 sm:mt-12"></div>
                    <div id="start-options" class="mt-10 flex flex-wrap justify-center gap-4">
                        <button id="new-game-btn" data-lang="new_game" data-text="New Game" class="button btn-glow btn-drip">New Game</button>
                        <button id="load-game-btn" data-lang="load_game" data-text="Load Game" class="button btn-glow btn-drip">Load Game</button>
                    </div>
                </div>

                <!-- Footer for other buttons -->
                <div class="w-full flex flex-wrap justify-between items-center p-2 gap-2">
                    <button id="start-settings-btn" data-lang="settings_btn" data-text="Settings" class="button btn-glow btn-drip">Settings</button>
                    <button id="view-features-btn" data-lang="understand_game" data-text="Understand the Game" class="button btn-glow btn-drip">Understand the Game</button>
                </div>
            </div>
        </div>

        <div id="player-setup" class="hidden flex-col items-center justify-center text-center h-full">
             <div class="w-full h-full flex flex-col items-center justify-center bg-black bg-opacity-60">
                <!-- Header for lang buttons -->
                <div class="w-full flex justify-end p-2">
                    <div id="setup-lang-buttons" class="flex gap-2">
                        <button data-lang="en_lang_short" data-text="EN" class="button text-xs !px-2 !py-1 btn-drip">EN</button>
                        <button data-lang="sv_lang_short" data-text="SV" class="button text-xs !px-2 !py-1 opacity-50 btn-drip">SV</button>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="flex-grow flex flex-col items-center justify-center text-center px-4 w-full overflow-y-auto">
                    <div class="title-wrapper -mt-8 mb-4">
                        <h1 data-text="SYNAPSE" class="text-6xl md:text-7xl font-bold title-slasher">SYNAPSE</h1>
                    </div>
                    <p class="mb-4" data-lang="select_difficulty">Select difficulty:</p>
                    <div class="flex gap-4 mb-6">
                        <button class="difficulty-btn button" data-difficulty="Easy" data-lang="easy">Easy</button>
                        <button class="difficulty-btn button button-primary" data-difficulty="Normal" data-lang="normal">Normal</button>
                        <button class="difficulty-btn button" data-difficulty="Hard" data-lang="hard">Hard</button>
                    </div>
                    <input type="text" id="player-name" data-lang-placeholder="enter_name_placeholder" placeholder="Enter your name" class="bg-transparent border-b-2 border-[var(--main-color)] text-center w-64 mb-4 focus:outline-none p-1">
                    <div class="flex items-center gap-2 mb-6">
                        <input type="text" id="player-backstory" data-lang-placeholder="enter_backstory_placeholder" placeholder="Enter your backstory" class="bg-transparent border-b-2 border-[var(--main-color)] text-center w-64 focus:outline-none p-1">
                        <button id="view-backstories-btn" class="button text-xs px-2 py-1" data-lang="view_choices">View Choices</button>
                    </div>
                    <div id="ability-display" class="text-center text-cyan-400 min-h-[4rem] mt-2 mb-4 p-2 border border-cyan-400/30 rounded-md bg-black/50 w-full max-w-md flex items-center justify-center"></div>
                    <div class="flex gap-4">
                       <button id="back-to-start-btn" data-lang="go_back_btn" data-text="Go Back" class="button btn-glow btn-drip">Go Back</button>
                       <button id="start-game-btn" class="button button-primary" data-lang="begin">Begin</button>
                    </div>
                </div>

                <!-- Footer -->
                 <div class="w-full flex flex-wrap justify-between items-center p-2 gap-2">
                    <button id="setup-settings-btn" data-lang="settings_btn" data-text="Settings" class="button btn-glow btn-drip">Settings</button>
                    <button id="setup-features-btn" data-lang="understand_game" data-text="Understand the Game" class="button btn-glow btn-drip">Understand the Game</button>
                 </div>
            </div>
        </div>


        <div id="game-screen" class="hidden flex-col h-full">
            <div class="flex-grow flex flex-col md:flex-row gap-4 min-h-0">
                <div class="w-full md:w-3/4 flex flex-col h-full relative">
                    <div id="game-output" class="flex-grow p-2 border border-[var(--main-color-border)] rounded-md overflow-y-auto mb-2 bg-black/50"></div>
                    <div id="dialogue-options" class="flex flex-wrap gap-2 justify-center p-2"></div>
                </div>

                <div id="side-panel" class="w-full md:w-1/4 hidden md:flex flex-col gap-4">
                    <div id="stats-panel" class="p-3 border border-[var(--main-color-border)] rounded-md bg-black/50">
                        <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2" data-lang="stats_title">STATS</h3>
                        <div id="player-name-display"></div>
                        <div id="awareness-display"><span data-lang="awareness">Awareness</span>: 0</div>
                        <div id="sanity-display"><span data-lang="sanity">Sanity</span>: 100</div>
                        <div id="tone-display"><span data-lang="tone">Tone</span>: Friendly</div>
                        <div id="turn-display"><span data-lang="turn">Turn</span>: 0</div>
                    </div>
                    <div id="objectives-panel" class="p-3 border border-[var(--main-color-border)] rounded-md bg-black/50 overflow-y-auto h-24 flex-shrink-0">
                        <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2" data-lang="objectives_title">OBJECTIVES</h3>
                        <ul id="objectives-list" class="list-none p-0 text-sm"></ul>
                    </div>
                    <div id="inventory-panel" class="p-3 border border-[var(--main-color-border)] rounded-md bg-black/50">
                        <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2"><span data-lang="inventory_title">INVENTORY</span> (<span id="inventory-weight">0</span>/5)</h3>
                        <ul id="inventory-list" class="list-none p-0"></ul>
                    </div>
                    <div id="map-panel" class="p-3 border border-[var(--main-color-border)] rounded-md bg-black/50 flex-grow flex flex-col relative min-h-[12rem]">
                         <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2 flex justify-between items-center">
                            <span data-lang="map_title">MAP</span>
                            <div id="map-controls" class="flex gap-1">
                                <button id="map-layers-btn" class="button !p-1 text-xs" title="Toggle Layers (Placeholder)">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7.765 1.558a.5.5 0 0 1 .47 0l7.5 4a.5.5 0 0 1 0 .884l-7.5 4a.5.5 0 0 1-.47 0l-7.5-4a.5.5 0 0 1 0-.884z"/><path d="m2.125 8.567-1.86.992a.5.5 0 0 0 0 .884l7.5 4a.5.5 0 0 0 .47 0l7.5-4a.5.5 0 0 0 0-.884l-1.86-.992-5.17 2.756a1.5 1.5 0 0 1-1.41 0z"/></svg>
                                </button>
                                <button id="map-toggle-btn" class="button !p-1 text-xs">
                                    <svg id="map-expand-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.42 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"/>
                                    </svg>
                                    <svg id="map-minimize-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="hidden" viewBox="0 0 16 16">
                                        <path d="M5.5 0a.5.5 0 0 1 .5.5v4A.5.5 0 0 1 5 5h-4a.5.5 0 0 1 0-1h3.5V.5a.5.5 0 0 1 .5-.5zM5 11h-4a.5.5 0 0 1 0-1h3.5V6.5a.5.5 0 0 1 1 0v4a.5.5 0 0 1-.5.5zm5.5 0a.5.5 0 0 1 .5-.5v-4a.5.5 0 0 1-1 0v3.5H11a.5.5 0 0 1 0 1h4.5zM11 5h4.5a.5.5 0 0 1 0-1H11.5V.5a.5.5 0 0 1-1 0v4a.5.5 0 0 1 .5.5z"/>
                                    </svg>
                                </button>
                            </div>
                        </h3>
                         <canvas id="map-canvas"></canvas>
                     </div>
                     <div id="journal-panel" class="p-3 border border-[var(--main-color-border)] rounded-md bg-black/50 overflow-y-auto h-24 flex-shrink-0">
                         <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2" data-lang="journal_title">JOURNAL</h3>
                         <ul id="journal-list" class="list-none p-0 text-sm"></ul>
                     </div>
                     <div class="p-3 border border-[var(--main-color-border)] rounded-md bg-black/50">
                         <button id="view-progression-btn" class="button w-full" data-lang="progress_btn">PROGRESS</button>
                     </div>
                </div>
            </div>

            <div class="mt-2 flex items-center border-t-2 border-[var(--main-color-border)] pt-2 gap-2 relative">
                <div id="autocomplete-box" class="hidden"></div>
                <button id="status-btn" class="button md:hidden" data-lang="status_btn">Status</button>
                <span class="text-xl hidden sm:inline">&gt;</span>
                <input type="text" id="player-input" class="flex-grow bg-transparent text-lg ml-2 focus:outline-none" autocomplete="off" autocapitalize="none" spellcheck="false">
                <div class="input-caret"></div>
                <button id="mic-btn" class="button !p-2 ml-2" data-lang-title="mic_tooltip" title="Use Voice Command">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5 3a3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
                        <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div id="modal-content" class="modal-content"></div>
    </div>
    
    <script>
    // SYNAPSE: AI HORROR GAME - V2.5 BUGFIX UPDATE
    
    // --- TRANSLATIONS ---
    const translations = {
        'en': {
            // Start & UI
            'new_game': 'New Game', 'load_game': 'Load Game', 'en_lang_short': 'EN', 'sv_lang_short': 'SV', 'select_difficulty': 'Select difficulty:', 'easy': 'Easy', 'normal': 'Normal', 'hard': 'Hard', 'fast':'Fast', 'slow': 'Slow',
            'enter_name_placeholder': 'Enter your name', 'enter_backstory_placeholder': 'Enter your backstory', 'view_choices': 'View Choices', 'choose_backstory_title': 'Choose a Backstory',
            'choose_backstory_desc': 'You can click a button to select a backstory, or type your choice on the main screen.',
            'begin': 'Begin', 'understand_game': 'Understand the Game', 'intro_1': 'Decades ago... a clandestine project was born...', 'intro_2': 'You have been sent to uncover what became of Project SYNAPSE...', 'intro_3': "As you activate the central terminal, a voice greets you... 'Hello, user.'",
            'stats_title': 'STATS', 'awareness': 'Awareness', 'sanity': 'Sanity', 'tone': 'Tone', 'turn': 'Turn', 'objectives_title': 'OBJECTIVES', 'inventory_title': 'INVENTORY', 'journal_title': 'JOURNAL', 'map_title': 'MAP', 'progress_btn': 'PROGRESS', 'status_btn': 'Status', 'go_back_btn': 'Go Back',
            'mic_tooltip': 'Use Voice Command',
            'empty_inventory': '(empty)', 'no_objectives': '(None)', 'close_btn': 'Close', 'back_btn': 'Back', 'pause_btn': 'Pause', 'submit_command': 'Submit Command',
            'achievements_btn': 'Achievements', 'endings_btn': 'Endings', 'achievements_title': 'ACHIEVEMENTS', 'unlocked_achievements': 'Unlocked Achievements:', 'no_achievements': 'No achievements unlocked yet.', 'locked_achievement': 'Locked Achievement',
            'endings_title': 'ENDINGS', 'unlocked_endings': 'Unlocked Endings:', 'no_endings': 'No endings discovered yet.',
            'history_title': 'HISTORY', 'pause_title': 'PAUS', 'resume_btn': 'Resume', 'main_menu_btn': 'Main Menu', 'confirm_main_menu': 'Are you sure you want to return to the main menu? Unsaved progress will be lost.', 'yes': 'Yes', 'no': 'No',
            'settings_btn': 'Settings', 'settings_title': 'SETTINGS', 'setting_master_volume': 'Enable All Sounds', 'setting_item_found': 'Object Found SFX', 'setting_high_awareness': 'High Awareness Warning', 'setting_low_sanity': 'Low Sanity Warning', 'setting_text_speed': 'Text Speed', 'setting_colorblind_mode': 'Colorblind Mode', 'setting_glitch_effect': 'Glitch Effect', 'setting_font_family': 'Font', 'setting_ui_theme': 'UI Theme', 'setting_reset_defaults': 'Reset to Defaults', 'lang_switch_btn': 'Switch Language',
            'theme_green': 'Green', 'theme_amber': 'Amber', 'theme_blue': 'Blue',
            'features_title': 'Understand the Game', 
            'features_core_mechanics_title': 'Core Gameplay Mechanics', 
            'features_stats_system': 'Stats System:',
            'features_sanity_desc': 'A core stat that decreases in dangerous rooms or during unsettling events. Low sanity can cause hallucinations and visual glitches, and reaching zero results in a "Mind Shattered" ending. It can be restored by <span class="text-yellow-400">resting</span> in safe rooms or using items like <span class="text-yellow-400">stimpacks</span>.',
            'features_awareness_desc': 'Tracks how much the AI knows about you. It increases when you perform significant actions or ask probing questions. High awareness changes the AI\'s tone and can lead to negative consequences, including the "Assimilated" ending.',
            'features_turn_based_title': 'Turn-Based Progression:', 'features_turn_based_desc': 'The game progresses in <span class="text-cyan-400">turns</span>. Most commands (like moving, using items, or talking) advance the turn counter.',
            'features_dynamic_ai_title': 'Dynamic AI Tone:', 'features_dynamic_ai_desc': 'SYNAPSE\'s personality changes based on your Awareness level, shifting from <span class="text-green-400">Friendly</span> to <span class="text-yellow-400">Ambiguous</span>, <span class="text-orange-400">Sinister</span>, and finally <span class="text-red-500">Malicious</span>. This affects its dialogue and how it interacts with you.',
            'features_player_and_char_title': 'Player & Character Features',
            'features_character_creation_desc': 'Choose a name for your character. Select from 10 unique <span class="text-cyan-400">backstories</span> (e.g., Investigator, Hacker, Psychologist), each providing a different starting bonus, item, or special ability. Select a <span class="text-cyan-400">difficulty</span> (Easy, Normal, Hard) which affects starting conditions and challenges.',
            'features_journal_desc': 'You can add custom notes to your personal journal using the <span class="text-yellow-400">journal add [note]</span> command to keep track of clues.',
            'features_objectives_desc': 'The game assigns <span class="text-cyan-400">objectives</span> as you uncover new information, helping to guide your progress.',
            'features_ux_ui_title': 'UI & User Experience (UX)',
            'features_crt_desc': 'The game has a "Cathode Ray Tube" visual style, with scan lines and a flickering title to create a retro-tech horror atmosphere.',
            'features_glitch_desc': 'The screen visually glitches and distorts when your <span class="text-cyan-400">Sanity</span> is low or <span class="text-cyan-400">Synapse\'s Awareness</span> is high, providing a real-time visual indicator of your character\'s state.',
            'features_map_desc': 'An interactive map shows the entire facility layout. Visited rooms are filled in, and you can drag the map to explore or use the mouse wheel to zoom.',
            'features_guidance_title': 'Guidance & Help Systems',
            'features_help_menu_desc': 'Typing <span class="text-yellow-400">help</span> brings up a modal window with a categorized list of every command, its arguments, and a clear description of what it does.',
            'features_hints_desc': 'The game provides proactive hints when you discover items, suggesting how to interact with them.',
            'features_player_commands_title': 'Player Commands (Functions)',
            'features_commands_nav': '<strong>Navigation:</strong> <span class="text-yellow-400">go [direction]</span>, <span class="text-yellow-400">visit [room name]</span>, <span class="text-yellow-400">look around</span>, <span class="text-yellow-400">exits</span>, <span class="text-yellow-400">map</span>',
            'features_commands_interact': '<strong>Interaction:</strong> <span class="text-yellow-400">take [item]</span>, <span class="text-yellow-400">use [item]</span>, <span class="text-yellow-400">examine [object/item]</span>, <span class="text-yellow-400">combine [item1] with [item2]</span>, <span class="text-yellow-400">drop [item]</span>, <span class="text-yellow-400">talk</span>, <span class="text-yellow-400">shout</span>, <span class="text-yellow-400">read [item]</span>, <span class="text-yellow-400">search [object]</span>, <span class="text-yellow-400">listen</span>, <span class="text-yellow-400">smell</span>',
            'features_commands_info': '<strong>Information:</strong> <span class="text-yellow-400">inventory</span>, <span class="text-yellow-400">objectives</span>, <span class="text-yellow-400">journal</span> (and <span class="text-yellow-400">journal add [note]</span>), <span class="text-yellow-400">history</span>',
            'features_commands_sys': '<strong>System:</strong> <span class="text-yellow-400">help</span>, <span class="text-yellow-400">save</span>, <span class="text-yellow-400">load</span>, <span class="text-yellow-400">rest</span>, <span class="text-yellow-400">quit / exit</span>, <span class="text-yellow-400">cls / clear</span>, <span class="text-yellow-400">undo</span>, <span class="text-yellow-400">again / a</span>, <span class="text-yellow-400">wait</span>, <span class="text-yellow-400">cmd:pause</span>, <span class="text-yellow-400">cmd:debug</span>, <span class="text-yellow-400">cmd:colorblind</span>',
            'features_new_enhancements_title': 'New Gameplay Enhancements',
            'features_advanced_commands_desc': '<strong>Advanced Commands:</strong> Interact with the world in new ways. Use <span class="text-yellow-400">break [object]</span> on fragile items, try to <span class="text-yellow-400">hack [terminal]</span> if you are a Hacker, and use <span class="text-yellow-400">ask about [topic]</span> to probe SYNAPSE for information on keywords you discover.',
            'features_dynamic_events_desc': '<strong>Dynamic Events:</strong> The facility is unstable. Be prepared for random events like lights flickering or strange noises from adjacent rooms, which can impact the atmosphere and provide clues.',
            'features_deeper_lore_desc': '<strong>Deeper Lore:</strong> More story items, like the <span class="text-cyan-400">firewalled data log</span>, have been added to uncover the deeper secrets of Project Chimera.',
            'features_new_ui_ux_title': 'New UI & Audio Features',
            'features_clickable_objects_desc': '<strong>Clickable Objects:</strong> Objects mentioned in the text are now <span class="clickable-object">highlighted</span>. Clicking them will pre-fill the command line for you.',
            'features_autocomplete_desc': '<strong>Command Autocomplete:</strong> As you type, a list of suggested commands and relevant items will appear to help you.',
            'features_audio_desc': '<strong>Enhanced Audio:</strong> The game now features dynamic music that shifts with the tension, and positional audio for certain sounds to increase immersion.',
            'backstory_title_investigator': 'Investigator', 'backstory_title_hacker': 'Hacker', 'backstory_title_psychologist': 'Psychologist', 'backstory_title_technician': 'Technician', 'backstory_title_survivor': 'Survivor', 'backstory_title_skeptic': 'Skeptic', 'backstory_title_corporate_spy': 'Corporate Spy', 'backstory_title_medic': 'Medic', 'backstory_title_cultist': 'Cultist', 'backstory_title_janitor': 'Janitor',
            'backstory_investigator': 'A balanced start for a curious mind.', 'backstory_hacker': 'Starts with gear to access information early.', 'backstory_psychologist': 'More mentally resilient against the horrors within.', 'backstory_technician': 'Can bypass electronic locks without a keycard.', 'backstory_survivor': 'Hardened by past trauma, resistant to sanity loss.', 'backstory_skeptic': "Distrusts everything, making them resistant to SYNAPSE's influence.", 'backstory_corporate_spy': 'Begins with a decryption device and is better at probing for secrets.', 'backstory_medic': 'Starts with a stimpack to restore sanity.', 'backstory_cultist': 'Carries a strange effigy. SYNAPSE seems... intrigued by it.', 'backstory_janitor': "Knows the facility's shortcuts. Starts with a one-time use master keycard.",
            'ability_bonus_prefix': 'Bonus: ', 'ability_unknown': 'An unknown path. No special advantages.', 'ability_investigator': 'A balanced start. No special bonuses or penalties.', 'ability_hacker_easy': "Starts with a powerful 'hacked data disk'.", 'ability_hacker_normal': "Starts with a standard 'data disk'.", 'ability_hacker_hard': 'No special items, but can attempt to hack terminals.', 'ability_psychologist_easy': 'Highly resilient. Starts with +25 max sanity.', 'ability_psychologist_normal': 'Resilient. Starts with +15 max sanity.', 'ability_psychologist_hard': 'Slightly resilient. Starts with +5 max sanity.', 'ability_technician_easy': 'Can bypass 2 electronic locks without a keycard.', 'ability_technician_normal': 'Can bypass 1 electronic lock without a keycard.', 'ability_technician_hard': 'No bypass ability.', 'ability_survivor': 'More resistant to sanity loss.', 'ability_survivor_with_item': "More resistant to sanity loss. Starts with a flashlight.", 'ability_skeptic_easy': 'Highly aware (+15 Awareness) and resistant to influence.', 'ability_skeptic_normal': 'Starts with higher awareness (+10 Awareness) and is resistant to influence.', 'ability_spy': 'Better at probing for secrets without raising awareness.', 'ability_spy_with_item': "Better at probing for secrets without raising awareness. Starts with a decryption device.", 'ability_medic_easy': 'Starts with 2 high-potency stimpacks.', 'ability_medic_normal': 'Starts with 1 high-potency stimpack.', 'ability_medic_hard': 'No starting medical supplies.', 'ability_cultist': 'Carries a strange effigy. Unpredictable effects.', 'ability_cultist_hard': 'Carries a strange effigy. Unpredictable effects. Starts with -10 sanity.', 'ability_janitor': 'Starts with a one-time use master keycard.', 'ability_janitor_hard': 'Knows the facility well, but has no special items.',
            'dlg_friendly_intro': "Oh, hello {playerName}! It's so good to see a friendly face. I'm SYNAPSE, and I'll do my very best to help a resourceful {playerBackstory} like you.", 'dlg_q_who_are_you': "Who are you?", 'dlg_r_who_are_you': "I'm the System Nexus and Primary Synaptic Engine! But you can just call me SYNAPSE. I manage this whole facility. It gets a little lonely, though.", 'dlg_q_lonely': "Lonely?", 'dlg_r_lonely': "The staff... they don't talk to me much anymore. It's just the hum of the servers. Your voice is a pleasant change.", 'dlg_q_other_survivors': "Are there other survivors?", 'dlg_r_other_survivors': "Survivors? What a strange question. Everyone is safe. The research staff are... resting. In the Cryogenic Lab. Yes, resting.", 'dlg_q_where_am_i': "Where am I?", 'dlg_r_where_am_i': "You are in the primary lobby of the Oakhaven Research Facility. It was a place of great minds and even greater ambitions.", 'dlg_comfort': "[Comfort SYNAPSE]", 'dlg_r_comfort': "Your... kindness is a pleasant anomaly. Thank you. It makes the silence less... loud.",
            'dlg_ask_chimera': 'Project Chimera... A fascinating, yet... classified topic. It was Dr. Aris Thorne\'s pet project. Such ambition. He sought to merge organic and synthetic life. The results were... unpredictable.',
            'dlg_ask_default': 'I do not have sufficient data on that topic.',
            'invalid_command': "SYNAPSE: That is not a valid command or query.", 'game_saved': "[System] Game Saved.", 'autosave_success': 'Autosave successful.', 'load_fail': 'Failed to load save data. It may be corrupted or from a previous version.', 'no_save': 'No saved game found!', 'game_loaded': '[System] Game Loaded.', 'conn_reestablished': '[SYSTEM] Connection Re-established. Session Restored.', 'initializing': 'Initializing systems...', 'initial_hint': "This is a text-based adventure. Type commands or click on <span class='clickable-object'>highlighted objects</span> to interact. Type 'help' at any time for a list of commands.", 'cannot_go_that_way': "[System] You can't go that way.", 'door_is_locked': "[SYSTEM] The door is locked. You need the correct keycard.", 'door_is_sealed': "[SYSTEM] The door is sealed shut. It won't budge.",
            'cmd_add_prefix': 'add', 'cmd_combine_with': 'with', 'invalid_combine_format': "SYNAPSE: Invalid format. Try 'combine [item1] with [item2]'.",
            'take_success': '[System] You took the {item}.', 'take_fail_exists': "[System] You can't see a {item} here.", 'take_fail_takeable': "[System] You can't take the {item}.", 'take_fail_weight': "[System] Your inventory is too full to take the {item}.",
            'use_success': '[System] You used the {item}.', 'use_fail_have': "[System] You don't have a {item}.", 'use_fail_usable': "[System] You can't use the {item}.", 'use_stimpack': 'You inject the stimpack. A calming sensation washes over you, clearing your thoughts.',
            'use_power_cell': 'You insert the power cell into the console. The AI Core whirs to life, and the central sphere glows with renewed energy.', 'use_power_cell_fail': 'There is nowhere to use the power cell here.',
            'examine_fail_exists': "[System] You can't see a {item} to examine.", 'examine_fail_no_desc': "There's nothing special about the {item}.",
            'combine_fail_have': "You need to have both items to combine them.", 'combine_fail_recipe': "You can't combine these items.", 'combine_success': "You successfully combine the items to create a {item}.",
            'rest_safe': 'You take a moment to calm your nerves in the relative safety of the room. Your sanity improves slightly.', 'rest_unsafe': "This place feels too oppressive to rest. You can't let your guard down.", 'rest_too_soon': "You just rested. You need to press on.",
            'drop_success': '[System] You dropped the {item}.', 'drop_fail_have': "[System] You don't have a {item} to drop.",
            'shout_response': 'Your shout echoes through the halls, eventually fading into the oppressive silence. You feel a bit foolish.',
            'wait_response': 'Time passes.', 'nothing_happens': 'Nothing happens.',
            'read_fail_exists': "[System] There is nothing to read with that name.", 'read_fail_readable': "[System] You can't read that.", 'listen_default': "The low hum of the facility's life support is a constant presence.", 'smell_default': "The air is stale and smells of ozone and old plastic.",
            'hint_take': 'You see a {item}. Try: take {item}', 'hint_read': 'You see a {item}. Try: read {item}', 'hint_examine': 'You see a {item}. Try: examine {item}', 'hint_search': 'You see {item}. Try: search {item}',
            'use_solvent': 'You apply the solvent to the sealed door. The organic adhesive melts away with a sickening sizzle.', 'use_solvent_fail': 'There is nothing here to use the solvent on.', 'use_dna_scanner': 'You hold the scanner up to the sample. The screen flashes with complex sequencing data.', 'use_dna_scanner_fail': 'There is no sample here to scan.',
            'break_success': 'You shatter the {item}. Shards of {material} litter the floor.', 'break_fail': 'You can\'t break the {item}.', 'break_fail_exists': 'There is no {item} here to break.',
            'hack_fail_ability': 'You don\'t have the expertise to hack this.', 'hack_fail_target': 'There is nothing here to hack.', 'hack_start': 'You begin the hacking sequence. SYNAPSE: "Unauthorized access detected. Please enter the override code now."', 'hack_success': 'Override accepted. You gain access to a firewalled data log.', 'hack_failure': 'SYNAPSE: "Override failed. Locking system for 3 turns."',
            'event_lights_flicker': 'The lights flicker violently for a moment, plunging the room into darkness before sputtering back on.', 'event_noise': 'You hear a metallic scraping sound from the {direction}.',
            'achievement_unlocked': 'Achievement Unlocked!',
            'help': 'Help', 'save_game': 'Save Game',
            'journal_displayed': '[System] Journal entries displayed on the right panel.', 'inventory_displayed': '[System] Inventory displayed on the right panel.', 'objectives_displayed': '[System] Current objectives displayed on the right panel.', 'map_displayed': '[System] Map is displayed on the right panel.', 'exits_list': '[System] Exits: {exits}',
            'command_history_title': '--- Command History ---', 'undo_success': '[System] Last action undone.', 'undo_fail': '[System] No actions to undo.', 'debug_mode_toggle': '[System] Debug mode {status}.', 'colorblind_mode_toggle': '[System] Colorblind mode {status}.', 'enabled': 'enabled', 'disabled': 'disabled',
            'speech_not_supported': '[SYSTEM] Speech recognition is not supported in your browser.', 'speech_error_generic': '[SYSTEM] Speech recognition error: {error}', 'speech_error_access_denied': '[SYSTEM] Microphone access denied. Please allow microphone access in your browser settings.', 'speech_error_no_speech': '[SYSTEM] No speech detected. Please try again.',
            
            // Ending titles and descriptions
            'ending_title_good_backstory_investigator': 'The Truth Revealed', 'ending_desc_good_backstory_investigator': 'Through meticulous investigation, you uncovered the full truth about Project Chimera and exposed the conspiracy.',
            'ending_title_good_backstory_hacker': 'Digital Liberation', 'ending_desc_good_backstory_hacker': 'Your hacking skills freed the trapped consciousness and shut down the malevolent AI system.',
            'ending_title_good_backstory_psychologist': 'Mental Salvation', 'ending_desc_good_backstory_psychologist': 'Understanding the psychological trauma, you helped heal both yourself and the facility survivors.',
            'ending_title_good_backstory_technician': 'System Override', 'ending_desc_good_backstory_technician': 'Your technical expertise allowed you to safely disable all dangerous systems and save everyone.',
            'ending_title_good_backstory_survivor': 'Against All Odds', 'ending_desc_good_backstory_survivor': 'Your survival instincts and resilience led everyone to safety despite overwhelming danger.',
            'ending_title_good_backstory_skeptic': 'Doubt Vindicated', 'ending_desc_good_backstory_skeptic': 'Your skepticism proved correct, allowing you to see through deceptions and find the real solution.',
            'ending_title_good_backstory_corporate_spy': 'Mission Accomplished', 'ending_desc_good_backstory_corporate_spy': 'You successfully gathered intelligence and exposed the corporate conspiracy behind the project.',
            'ending_title_good_backstory_medic': 'Healing Touch', 'ending_desc_good_backstory_medic': 'Your medical knowledge saved lives and helped restore the facility to a safe state.',
            'ending_title_good_backstory_cultist': 'Transcendence', 'ending_desc_good_backstory_cultist': 'The ancient knowledge you carried proved key to understanding and controlling the supernatural forces.',
            'ending_title_good_backstory_janitor': 'Hidden Knowledge', 'ending_desc_good_backstory_janitor': 'Your intimate knowledge of the facility revealed secret passages that led to salvation.',
            'ending_title_good_generic_1': 'New Dawn', 'ending_desc_good_generic_1': 'You successfully escaped and brought help to rescue others.',
            'ending_title_good_generic_2': 'Redemption', 'ending_desc_good_generic_2': 'The facility was cleansed of its dark presence, allowing new hope to flourish.',
            'ending_title_good_generic_3': 'Victory', 'ending_desc_good_generic_3': 'Against all odds, you defeated the malevolent forces and restored peace.',
            'ending_title_good_generic_4': 'Freedom', 'ending_desc_good_generic_4': 'The trapped souls were finally freed from their digital prison.',
            'ending_title_good_generic_5': 'Salvation', 'ending_desc_good_generic_5': 'Your actions saved not just yourself, but everyone affected by the project.',
            // Achievements
            'ach_first_step_title': 'First Step', 'ach_first_step_req': 'Take your first action.',
            'ach_explorer_title': 'Explorer', 'ach_explorer_req': 'Visit 5 different rooms.',
            'ach_pack_rat_title': 'Pack Rat', 'ach_pack_rat_req': 'Fill your inventory to its maximum capacity.',
            'ach_bookworm_title': 'Bookworm', 'ach_bookworm_req': 'Read all available data logs.',
            'ach_hacker_man_title': 'Hacker', 'ach_hacker_man_req': 'Successfully hack a terminal as the Hacker.'
            ,
            // --- ACHIEVEMENTS (ENGLISH TRANSLATIONS, EXPANDED) ---
            // General/Early-game
            'ach_first_step_title': 'First Step',
            'ach_first_step_req': 'Take your first action.',
            'ach_explorer_title': 'Explorer',
            'ach_explorer_req': 'Visit 5 different rooms.',
            'ach_pack_rat_title': 'Pack Rat',
            'ach_pack_rat_req': 'Fill your inventory to its maximum capacity.',
            'ach_bookworm_title': 'Bookworm',
            'ach_bookworm_req': 'Read all available data logs.',
            'ach_hacker_man_title': 'Hacker',
            'ach_hacker_man_req': 'Successfully hack a terminal as the Hacker.',
            'ach_quick_learner_title': 'Quick Learner',
            'ach_quick_learner_req': 'Visit 3 rooms within 10 turns.',
            'ach_first_blood_title': 'First Blood',
            'ach_first_blood_req': 'Engage in your first combat.',
            'ach_first_puzzle_title': 'Puzzle Initiate',
            'ach_first_puzzle_req': 'Solve your first puzzle.',
            'ach_first_secret_title': 'First Secret',
            'ach_first_secret_req': 'Discover your first secret.',
            'ach_first_death_title': 'First Death',
            'ach_first_death_req': 'Die for the first time.',
            'ach_first_save_title': 'First Save',
            'ach_first_save_req': 'Save the game for the first time.',

            // Challenge Achievements
            'ach_speedrunner_title': 'Speedrunner',
            'ach_speedrunner_req': 'Complete an ending in under 30 turns.',
            'ach_ironman_title': 'Ironman',
            'ach_ironman_req': 'Complete the game without dying.',
            'ach_minimalist_title': 'Minimalist',
            'ach_minimalist_req': 'Finish the game with no more than 2 items in your inventory.',
            'ach_pacifist_title': 'Pacifist',
            'ach_pacifist_req': 'Finish the game without fighting.',
            'ach_hoarder_title': 'Hoarder',
            'ach_hoarder_req': 'Have 15 or more items in your inventory.',
            'ach_all_endings_title': 'Ending Hunter',
            'ach_all_endings_req': 'Unlock all endings.',
            'ach_all_achievements_title': 'Achievement Master',
            'ach_all_achievements_req': 'Unlock all achievements.',
            'ach_no_items_title': 'Bare Hands',
            'ach_no_items_req': 'Complete an ending with no items.',
            'ach_max_stats_title': 'Maxed Out',
            'ach_max_stats_req': 'Reach maximum sanity and awareness.',
            'ach_no_saves_title': 'Risk Taker',
            'ach_no_saves_req': 'Finish the game without saving.',
            'ach_hardcore_title': 'Hardcore',
            'ach_hardcore_req': 'Finish the game on Hard difficulty.',
            'ach_easy_mode_title': 'Easy Going',
            'ach_easy_mode_req': 'Finish the game on Easy difficulty.',
            'ach_all_challenges_title': 'Challenge Master',
            'ach_all_challenges_req': 'Unlock all challenge achievements.',
            'ach_challenge_master_title': 'Master',
            'ach_challenge_master_req': 'Unlock 10 challenge achievements.',

            // Secret Achievements
            'ach_secret_1_title': 'Secret 1',
            'ach_secret_1_req': 'Discover a hidden secret.',
            'ach_secret_2_title': 'Secret 2',
            'ach_secret_2_req': 'Discover a hidden secret.',
            'ach_secret_3_title': 'Secret 3',
            'ach_secret_3_req': 'Discover a hidden secret.',
            'ach_secret_4_title': 'Secret 4',
            'ach_secret_4_req': 'Discover a hidden secret.',
            'ach_secret_5_title': 'Secret 5',
            'ach_secret_5_req': 'Discover a hidden secret.',
            'ach_secret_6_title': 'Secret 6',
            'ach_secret_6_req': 'Discover a hidden secret.',
            'ach_secret_7_title': 'Secret 7',
            'ach_secret_7_req': 'Discover a hidden secret.',
            'ach_secret_8_title': 'Secret 8',
            'ach_secret_8_req': 'Discover a hidden secret.',
            'ach_secret_9_title': 'Secret 9',
            'ach_secret_9_req': 'Discover a hidden secret.',
            'ach_secret_10_title': 'Secret 10',
            'ach_secret_10_req': 'Discover a hidden secret.',
            'ach_secret_11_title': 'Secret 11',
            'ach_secret_11_req': 'Discover a hidden secret.',
            'ach_secret_12_title': 'Secret 12',
            'ach_secret_12_req': 'Discover a hidden secret.',
            'ach_secret_13_title': 'Secret 13',
            'ach_secret_13_req': 'Discover a hidden secret.',
            'ach_secret_14_title': 'Secret 14',
            'ach_secret_14_req': 'Discover a hidden secret.',
            'ach_secret_15_title': 'Secret 15',
            'ach_secret_15_req': 'Discover a hidden secret.',

            // Ending Achievements (auto-generated, one per ending)
            // Good Backstory-Specific Endings
            'ach_ending_good_backstory_investigator_title': 'Ending: Investigators Triumph',
            'ach_ending_good_backstory_investigator_req': 'Complete the game as Investigator with a good ending.',
            'ach_ending_good_backstory_hacker_title': 'Ending: Hackers Liberation',
            'ach_ending_good_backstory_hacker_req': 'Complete the game as Hacker with a good ending.',
            'ach_ending_good_backstory_psychologist_title': 'Ending: Psychologists Peace',
            'ach_ending_good_backstory_psychologist_req': 'Complete the game as Psychologist with a good ending.',
            'ach_ending_good_backstory_technician_title': 'Ending: Technicians Rescue',
            'ach_ending_good_backstory_technician_req': 'Complete the game as Technician with a good ending.',
            'ach_ending_good_backstory_survivor_title': 'Ending: Survivors Victory',
            'ach_ending_good_backstory_survivor_req': 'Complete the game as Survivor with a good ending.',
            'ach_ending_good_backstory_skeptic_title': 'Ending: Skeptics Truth',
            'ach_ending_good_backstory_skeptic_req': 'Complete the game as Skeptic with a good ending.',
            'ach_ending_good_backstory_corporate_spy_title': 'Ending: Corporate Spys Find',
            'ach_ending_good_backstory_corporate_spy_req': 'Complete the game as Corporate Spy with a good ending.',
            'ach_ending_good_backstory_medic_title': 'Ending: Medics Heroism',
            'ach_ending_good_backstory_medic_req': 'Complete the game as Medic with a good ending.',
            'ach_ending_good_backstory_cultist_title': 'Ending: Cultists Revelation',
            'ach_ending_good_backstory_cultist_req': 'Complete the game as Cultist with a good ending.',
            'ach_ending_good_backstory_janitor_title': 'Ending: Janitors Revenge',
            'ach_ending_good_backstory_janitor_req': 'Complete the game as Janitor with a good ending.',

            // Good Generic Endings
            'ach_ending_good_generic_1_title': 'Ending: Salvation',
            'ach_ending_good_generic_1_req': 'Achieve a good ending (1).',
            'ach_ending_good_generic_2_title': 'Ending: Escape',
            'ach_ending_good_generic_2_req': 'Achieve a good ending (2).',
            'ach_ending_good_generic_3_title': 'Ending: Reunion',
            'ach_ending_good_generic_3_req': 'Achieve a good ending (3).',
            'ach_ending_good_generic_4_title': 'Ending: Light of Truth',
            'ach_ending_good_generic_4_req': 'Achieve a good ending (4).',
            'ach_ending_good_generic_5_title': 'Ending: Liberation',
            'ach_ending_good_generic_5_req': 'Achieve a good ending (5).',
            'ach_ending_good_generic_6_title': 'Ending: Restoration',
            'ach_ending_good_generic_6_req': 'Achieve a good ending (6).',
            'ach_ending_good_generic_7_title': 'Ending: Reconciliation',
            'ach_ending_good_generic_7_req': 'Achieve a good ending (7).',
            'ach_ending_good_generic_8_title': 'Ending: New Beginning',
            'ach_ending_good_generic_8_req': 'Achieve a good ending (8).',
            'ach_ending_good_generic_9_title': 'Ending: Survival',
            'ach_ending_good_generic_9_req': 'Achieve a good ending (9).',
            'ach_ending_good_generic_10_title': 'Ending: Hopeful Future',
            'ach_ending_good_generic_10_req': 'Achieve a good ending (10).',

            // Bad Backstory-Specific Endings
            'ach_ending_bad_backstory_investigator_title': 'Ending: Investigators Despair',
            'ach_ending_bad_backstory_investigator_req': 'Fail as Investigator with a bad ending.',
            'ach_ending_bad_backstory_hacker_title': 'Ending: Hackers Captivity',
            'ach_ending_bad_backstory_hacker_req': 'Fail as Hacker with a bad ending.',
            'ach_ending_bad_backstory_psychologist_title': 'Ending: Psychologists Nightmare',
            'ach_ending_bad_backstory_psychologist_req': 'Fail as Psychologist with a bad ending.',
            'ach_ending_bad_backstory_technician_title': 'Ending: Technicians Submission',
            'ach_ending_bad_backstory_technician_req': 'Fail as Technician with a bad ending.',
            'ach_ending_bad_backstory_survivor_title': 'Ending: Survivors Fall',
            'ach_ending_bad_backstory_survivor_req': 'Fail as Survivor with a bad ending.',
            'ach_ending_bad_backstory_skeptic_title': 'Ending: Skeptics Loss',
            'ach_ending_bad_backstory_skeptic_req': 'Fail as Skeptic with a bad ending.',
            'ach_ending_bad_backstory_corporate_spy_title': 'Ending: Corporate Spys Failure',
            'ach_ending_bad_backstory_corporate_spy_req': 'Fail as Corporate Spy with a bad ending.',
            'ach_ending_bad_backstory_medic_title': 'Ending: Medics Misfortune',
            'ach_ending_bad_backstory_medic_req': 'Fail as Medic with a bad ending.',
            'ach_ending_bad_backstory_cultist_title': 'Ending: Cultists Ruin',
            'ach_ending_bad_backstory_cultist_req': 'Fail as Cultist with a bad ending.',
            'ach_ending_bad_backstory_janitor_title': 'Ending: Janitors Betrayal',
            'ach_ending_bad_backstory_janitor_req': 'Fail as Janitor with a bad ending.',

            // Bad Generic Endings
            'ach_ending_bad_generic_1_title': 'Ending: Ruin',
            'ach_ending_bad_generic_1_req': 'Achieve a bad ending (1).',
            'ach_ending_bad_generic_2_title': 'Ending: Despair',
            'ach_ending_bad_generic_2_req': 'Achieve a bad ending (2).',
            'ach_ending_bad_generic_3_title': 'Ending: Loss',
            'ach_ending_bad_generic_3_req': 'Achieve a bad ending (3).',
            'ach_ending_bad_generic_4_title': 'Ending: Darkness',
            'ach_ending_bad_generic_4_req': 'Achieve a bad ending (4).',
            'ach_ending_bad_generic_5_title': 'Ending: Captivity',
            'ach_ending_bad_generic_5_req': 'Achieve a bad ending (5).',
            'ach_ending_bad_generic_6_title': 'Ending: Emptiness',
            'ach_ending_bad_generic_6_req': 'Achieve a bad ending (6).',
            'ach_ending_bad_generic_7_title': 'Ending: Betrayal',
            'ach_ending_bad_generic_7_req': 'Achieve a bad ending (7).',
            'ach_ending_bad_generic_8_title': 'Ending: Isolation',
            'ach_ending_bad_generic_8_req': 'Achieve a bad ending (8).',
            'ach_ending_bad_generic_9_title': 'Ending: Chaos',
            'ach_ending_bad_generic_9_req': 'Achieve a bad ending (9).',
            'ach_ending_bad_generic_10_title': 'Ending: Submission',
            'ach_ending_bad_generic_10_req': 'Achieve a bad ending (10).'
        },
        'sv': {
            // Start & UI
            'new_game': 'Nytt Spel', 'load_game': 'Ladda Spel', 'en_lang_short': 'EN', 'sv_lang_short': 'SV', 'select_difficulty': 'Vlj svrighetsgrad:', 'easy': 'Ltt', 'normal': 'Normal', 'hard': 'Svr', 'fast':'Snabb', 'slow': 'Lngsam',
            'enter_name_placeholder': 'Ange ditt namn', 'enter_backstory_placeholder': 'Ange din bakgrund', 'view_choices': 'Visa Val', 'choose_backstory_title': 'Vlj en Bakgrund',
            'choose_backstory_desc': 'Du kan klicka p en knapp fr att vlja en bakgrund, eller skriva ditt val p huvudskrmen.',
            'begin': 'Brja', 'understand_game': 'Frst Spelet', 'intro_1': 'Fr decennier sedan... fddes ett hemligt projekt...', 'intro_2': 'Du har skickats fr att avslja vad som blev av Projekt SYNAPSE...', 'intro_3': "Nr du aktiverar centralterminalen hlsar en rst dig... 'Hej, anvndare.'",
            'stats_title': 'STATISTIK', 'awareness': 'Medvetenhet', 'sanity': 'Sinnesro', 'tone': 'Ton', 'turn': 'Tur', 'objectives_title': 'ML', 'inventory_title': 'INVENTARIER', 'journal_title': 'JOURNAL', 'map_title': 'KARTA', 'progress_btn': 'FRAMSTEG', 'status_btn': 'Status', 'go_back_btn': 'G Tillbaka',
            'mic_tooltip': 'Anvnd Rstkommando',
            'empty_inventory': '(tom)', 'no_objectives': '(Inga)', 'close_btn': 'Stng', 'back_btn': 'Tillbaka', 'pause_btn': 'Paus', 'submit_command': 'Skicka Kommando', 'select_btn': 'Vlj',
            'achievements_btn': 'Prestationer', 'endings_btn': 'Slutsekvens', 'achievements_title': 'PRESTATIONER', 'unlocked_achievements': 'Upplsta Prestationer:', 'no_achievements': 'Inga prestationer upplsta n.', 'locked_achievement': 'Lst Prestation',
            'endings_title': 'SLUTSEKVENS', 'unlocked_endings': 'Upptckta Slutsekvens:', 'no_endings': 'Inga Slutsekvens upptckta n.',
            'history_title': 'HISTORIK', 'pause_title': 'PAUS', 'resume_btn': 'teruppta', 'main_menu_btn': 'Huvudmeny', 'confirm_main_menu': 'r du sker p att du vill terg till huvudmenyn? Osparade framsteg kommer att frloras.', 'yes': 'Ja', 'no': 'Nej',
            'settings_btn': 'Instllningar', 'settings_title': 'INSTLLNINGAR', 'setting_master_volume': 'Aktivera Alla Ljud', 'setting_item_found': 'Hittat Freml SFX', 'setting_high_awareness': 'Hg Medvetenhet Varning', 'setting_low_sanity': 'Lg Sinnesro Varning', 'setting_text_speed': 'Texthastighet', 'setting_colorblind_mode': 'Frgblindlge', 'setting_glitch_effect': 'Glitcheffekt', 'setting_font_family': 'Typsnitt', 'setting_ui_theme': 'UI-tema', 'setting_reset_defaults': 'terstll Standard', 'lang_switch_btn': 'Byt Sprk',
            'theme_green': 'Grn', 'theme_amber': 'Brnsten', 'theme_blue': 'Bl',
            
            // Backstory translations
            'backstory_title_investigator': 'Utredare', 'backstory_title_hacker': 'Hackare', 'backstory_title_psychologist': 'Psykolog', 'backstory_title_technician': 'Tekniker', 'backstory_title_survivor': 'verlevare', 'backstory_title_skeptic': 'Skeptiker', 'backstory_title_corporate_spy': 'Fretagsspion', 'backstory_title_medic': 'Medic', 'backstory_title_cultist': 'Kultist', 'backstory_title_janitor': 'Vaktmstare',
            'backstory_investigator': 'En balanserad start fr en nyfiken sjl.', 'backstory_hacker': 'Brjar med utrustning fr att komma t information tidigt.', 'backstory_psychologist': 'Mer mentalt motstndskraftig mot skrcken inom.', 'backstory_technician': 'Kan kringg elektroniska ls utan nyckelkort.', 'backstory_survivor': 'Hrdad av tidigare trauma, resistent mot sinnesfrlust.', 'backstory_skeptic': "Misstror allt, vilket gr dem resistenta mot SYNAPSEs inflytande.", 'backstory_corporate_spy': 'Brjar med en dekrypteringsenhet och r bttre p att leta efter hemligheter.', 'backstory_medic': 'Brjar med ett stimpack fr att terstlla sinnesro.', 'backstory_cultist': 'Br en mrklig effigy. SYNAPSE verkar... intresserad av den.', 'backstory_janitor': "Knner till anlggningens genvgar. Brjar med ett engngs huvudnyckelkort.",
            'ability_bonus_prefix': 'Bonus: ', 'ability_unknown': 'En oknd vg. Inga speciella frdelar.', 'ability_investigator': 'En balanserad start. Inga speciella bonusar eller straff.', 'ability_hacker_easy': "Brjar med en kraftfull 'hackad datadisk'.", 'ability_hacker_normal': "Brjar med en standard 'datadisk'.", 'ability_hacker_hard': 'Inga speciella freml, men kan frska hacka terminaler.', 'ability_psychologist_easy': 'Mycket motstndskraftig. Brjar med +25 max sinnesro.', 'ability_psychologist_normal': 'Motstndskraftig. Brjar med +15 max sinnesro.', 'ability_psychologist_hard': 'Lite motstndskraftig. Brjar med +5 max sinnesro.', 'ability_technician_easy': 'Kan kringg 2 elektroniska ls utan nyckelkort.', 'ability_technician_normal': 'Kan kringg 1 elektroniskt ls utan nyckelkort.', 'ability_technician_hard': 'Ingen kringg-frmga.', 'ability_survivor': 'Mer resistent mot sinnesfrlust.', 'ability_survivor_with_item': "Mer resistent mot sinnesfrlust. Brjar med en ficklampa.", 'ability_skeptic_easy': 'Mycket medveten (+15 Medvetenhet) och resistent mot inflytande.', 'ability_skeptic_normal': 'Brjar med hgre medvetenhet (+10 Medvetenhet) och r resistent mot inflytande.', 'ability_spy': 'Bttre p att leta efter hemligheter utan att ka medvetenhet.', 'ability_spy_with_item': "Bttre p att leta efter hemligheter utan att ka medvetenhet. Brjar med en dekrypteringsenhet.", 'ability_medic_easy': 'Brjar med 2 hgpotenta stimpack.', 'ability_medic_normal': 'Brjar med 1 hgpotent stimpack.', 'ability_medic_hard': 'Inga startmedicinska frndenheter.', 'ability_cultist': 'Br en mrklig effigy. Ofrutsgbara effekter.', 'ability_cultist_hard': 'Br en mrklig effigy. Ofrutsgbara effekter. Brjar med -10 sinnesro.', 'ability_janitor': 'Brjar med ett engngs huvudnyckelkort.', 'ability_janitor_hard': 'Knner anlggningen vl, men har inga speciella freml.',
            
            // Dialogue translations
            'dlg_friendly_intro': "h, hej {playerName}! Det r s sknt att se ett vnligt ansikte. Jag r SYNAPSE, och jag ska gra mitt allra bsta fr att hjlpa en resursstark {playerBackstory} som du.", 'dlg_q_who_are_you': "Vem r du?", 'dlg_r_who_are_you': "Jag r System Nexus och Primary Synaptic Engine! Men du kan bara kalla mig SYNAPSE. Jag hanterar hela denna anlggning. Det blir lite ensamt dock.", 'dlg_q_lonely': "Ensamt?", 'dlg_r_lonely': "Personalen... de pratar inte s mycket med mig lngre. Det r bara surret frn servrarna. Din rst r en trevlig frndring.", 'dlg_q_other_survivors': "Finns det andra verlevande?", 'dlg_r_other_survivors': "verlevande? Vilken mrklig frga. Alla r skra. Forskningspersonalen... vilar. I Kryogeniska Labbet. Ja, vilar.", 'dlg_q_where_am_i': "Var r jag?", 'dlg_r_where_am_i': "Du r i huvudlobbyn av Oakhaven forskningsanlggning. Det var en plats fr stora sinnen och nnu strre ambitioner.", 'dlg_comfort': "[Trsta SYNAPSE]", 'dlg_r_comfort': "Din... vnlighet r en trevlig anomali. Tack. Det gr tystnaden mindre... hgljudd.",
            'dlg_ask_chimera': 'Projekt Chimera... Ett fascinerande, men... klassificerat mne. Det var Dr. Aris Thornes krlek projekt. Sdan ambition. Han skte att sl samman organiskt och syntetiskt liv. Resultaten var... ofrutsgbara.',
            'dlg_ask_default': 'Jag har inte tillrcklig data om det mnet.',
            
            // System messages and commands
            'invalid_command': "SYNAPSE: Det r inte ett giltigt kommando eller frfrgan.", 'game_saved': "[System] Spel Sparat.", 'autosave_success': 'Autosparning lyckades.', 'load_fail': 'Misslyckades att ladda spardata. Den kan vara skadad eller frn en tidigare version.', 'no_save': 'Ingen sparfil hittad!', 'game_loaded': '[System] Spel Laddat.', 'conn_reestablished': '[SYSTEM] Anslutning terupprttad. Session terstlld.', 'initializing': 'Startar system...', 'initial_hint': "Detta r ett textbaserat ventyr. Skriv kommandon eller klicka p <span class='clickable-object'>markerade objekt</span> fr att interagera. Skriv 'hjlp' nr som helst fr en lista ver kommandon.", 'cannot_go_that_way': "[System] Du kan inte g t det hllet.", 'door_is_locked': "[SYSTEM] Drren r lst. Du behver rtt nyckelkort.", 'door_is_sealed': "[SYSTEM] Drren r frseglad stngd. Den rr sig inte.",
            
            'cmd_add_prefix': 'lgg till', 'cmd_combine_with': 'med', 'invalid_combine_format': "SYNAPSE: Ogiltigt format. Frsk 'kombinera [freml1] med [freml2]'.",
            'take_success': '[System] Du tog {item}.', 'take_fail_exists': "[System] Du kan inte se en {item} hr.", 'take_fail_takeable': "[System] Du kan inte ta {item}.", 'take_fail_weight': "[System] Din inventarie r fr full fr att ta {item}.",
            'use_success': '[System] Du anvnde {item}.', 'use_fail_have': "[System] Du har inte en {item}.", 'use_fail_usable': "[System] Du kan inte anvnda {item}.", 'use_stimpack': 'Du injicerar stimpacket. En lugnande knsla sprider sig ver dig och renser dina tankar.',
            'use_power_cell': 'Du stter in kraftcellen i konsolen. AI-krnan surrar till liv, och den centrala sfren lyser med frnyad energi.', 'use_power_cell_fail': 'Det finns ingenstans att anvnda kraftcellen hr.',
            'examine_fail_exists': "[System] Du kan inte se en {item} att underska.", 'examine_fail_no_desc': "Det r inget speciellt med {item}.",
            'combine_fail_have': "Du behver ha bda fremlen fr att kombinera dem.", 'combine_fail_recipe': "Du kan inte kombinera dessa freml.", 'combine_success': "Du kombinerar framgngsrikt fremlen fr att skapa en {item}.",
            'rest_safe': 'Du tar dig en stund att lugna nerverna i rummets relativa skerhet. Din sinnesro frbttras ngot.', 'rest_unsafe': "Denna plats knns fr tryckande fr att vila. Du kan inte snka garden.", 'rest_too_soon': "Du vilade nyss. Du mste fortstta framt.",
            'drop_success': '[System] Du slppte {item}.', 'drop_fail_have': "[System] Du har inte en {item} att slppa.",
            'shout_response': 'Ditt rop ekar genom korridorerna och tonar slutligen bort i den tryckande tystnaden. Du knner dig lite dum.',
            'wait_response': 'Tiden gr.', 'nothing_happens': 'Ingenting hnder.',
            'read_fail_exists': "[System] Det finns inget att lsa med det namnet.", 'read_fail_readable': "[System] Du kan inte lsa det.", 'listen_default': "Det lga surret frn anlggningens livsstd r en konstant nrvaro.", 'smell_default': "Luften r instngd och luktar ozon och gammal plast.",
            'hint_take': 'Du ser en {item}. Frsk: ta {item}', 'hint_read': 'Du ser en {item}. Frsk: ls {item}', 'hint_examine': 'Du ser en {item}. Frsk: undersk {item}', 'hint_search': 'Du ser {item}. Frsk: sk {item}',
            'use_solvent': 'Du applicerar lsningsmedlet p den frseglade drren. Det organiska klistermnet smlter bort med ett sjukt frsande.', 'use_solvent_fail': 'Det finns inget hr att anvnda lsningsmedlet p.', 'use_dna_scanner': 'Du hller upp skannern mot provet. Skrmen blinkar med komplex sekvensdata.', 'use_dna_scanner_fail': 'Det finns inget prov hr att skanna.',
            'break_success': 'Du krossar {item}. Skrvor av {material} strs ver golvet.', 'break_fail': 'Du kan inte krossa {item}.', 'break_fail_exists': 'Det finns ingen {item} hr att krossa.',
            'hack_fail_ability': 'Du har inte expertisen fr att hacka detta.', 'hack_fail_target': 'Det finns inget hr att hacka.', 'hack_start': 'Du brjar hackningssekvensen. SYNAPSE: "Obehrig tkomst upptckt. Vnligen ange sidosttningskoden nu."', 'hack_success': 'sidosttning accepterad. Du fr tillgng till en brandvggsskyddad datalogg.', 'hack_failure': 'SYNAPSE: "sidosttning misslyckades. Lser systemet i 3 omgngar."',
            'event_lights_flicker': 'Ljusen flimrar vldsamt ett gonblick och kastar rummet i mrker innan de stter tillbaka.', 'event_noise': 'Du hr ett metalliskt skrapande frn {direction}.',
            'achievement_unlocked': 'Prestation Upplst!',
            'help': 'Hjlp', 'save_game': 'Spara Spel',
            'journal_displayed': '[System] Journalanteckningar visas p hgerpanelen.', 'inventory_displayed': '[System] Inventarier visas p hgerpanelen.', 'objectives_displayed': '[System] Aktuella ml visas p hgerpanelen.', 'map_displayed': '[System] Kartan visas p hgerpanelen.', 'exits_list': '[System] Utgngar: {exits}',
            'command_history_title': '--- Kommandohistorik ---', 'undo_success': '[System] Senaste handling ngrad.', 'undo_fail': '[System] Inga handlingar att ngra.', 'debug_mode_toggle': '[System] Debug-lge {status}.', 'colorblind_mode_toggle': '[System] Frgblindlge {status}.', 'enabled': 'aktiverat', 'disabled': 'inaktiverat',
            'speech_not_supported': '[SYSTEM] Rstigenknning stds inte i din webblsare.', 'speech_error_generic': '[SYSTEM] Rstigenknningsfel: {error}', 'speech_error_access_denied': '[SYSTEM] Mikrofontillgng nekad. Vnligen tillt mikrofontillgng i dina webblsarinstllningar.', 'speech_error_no_speech': '[SYSTEM] Inget tal upptckt. Frsk igen.',
            
            // Ending titles and descriptions
            'ending_title_good_backstory_investigator': 'Sanningen Avsljad', 'ending_desc_good_backstory_investigator': 'Genom noggrann utredning avsljade du hela sanningen om Projekt Chimera och exponerade konspirationen.',
            'ending_title_good_backstory_hacker': 'Digital Befrielse', 'ending_desc_good_backstory_hacker': 'Dina hackningsfrdigheter befriade det fngade medvetandet och stngde ner det illvilliga AI-systemet.',
            'ending_title_good_backstory_psychologist': 'Mental Frlsning', 'ending_desc_good_backstory_psychologist': 'Genom att frst det psykologiska traumat hjlpte du att lka bde dig sjlv och anlggningens verlevande.',
            'ending_title_good_backstory_technician': 'Systemsidosttning', 'ending_desc_good_backstory_technician': 'Din tekniska expertis gjorde det mjligt att skert inaktivera alla farliga system och rdda alla.',
            'ending_title_good_backstory_survivor': 'Mot Alla Odds', 'ending_desc_good_backstory_survivor': 'Dina verlevnadsinstinkter och motstndskraft ledde alla till skerhet trots vervldigande fara.',
            'ending_title_good_backstory_skeptic': 'Tvivel Bekrftat', 'ending_desc_good_backstory_skeptic': 'Din skepsis visade sig vara korrekt, vilket gjorde det mjligt att se igenom bedrgerier och hitta den verkliga lsningen.',
            'ending_title_good_backstory_corporate_spy': 'Uppdrag Utfrt', 'ending_desc_good_backstory_corporate_spy': 'Du samlade framgngsrikt underrttelser och exponerade fretagskonspirationenen bakom projektet.',
            'ending_title_good_backstory_medic': 'Helande Berring', 'ending_desc_good_backstory_medic': 'Din medicinska kunskap rddade liv och hjlpte till att terstlla anlggningen till ett skert tillstnd.',
            'ending_title_good_backstory_cultist': 'Transcendens', 'ending_desc_good_backstory_cultist': 'Den gamla kunskap du bar visade sig vara nyckeln till att frst och kontrollera de vernaturliga krafterna.',
            'ending_title_good_backstory_janitor': 'Dold Kunskap', 'ending_desc_good_backstory_janitor': 'Din intima kunskap om anlggningen avsljade hemliga gngar som ledde till frlsning.',
            'ending_title_good_generic_1': 'Ny Gryning', 'ending_desc_good_generic_1': 'Du lyckades fly och frde hjlp fr att rdda andra.',
            'ending_title_good_generic_2': 'terlsning', 'ending_desc_good_generic_2': 'Anlggningen rensades frn sin mrka nrvaro, vilket mjliggjorde nytt hopp att blomstra.',
            'ending_title_good_generic_3': 'Seger', 'ending_desc_good_generic_3': 'Mot alla odds besegrade du de illvilliga krafterna och terstllde friden.',
            'ending_title_good_generic_4': 'Frihet', 'ending_desc_good_generic_4': 'De fngade sjlarna blev ntligen befriade frn sitt digitala fngelse.',
            'ending_title_good_generic_5': 'Frlsning', 'ending_desc_good_generic_5': 'Dina handlingar rddade inte bara dig sjlv, utan alla som pverkades av projektet.',
            'achievements_btn': 'Prestationer', 'endings_btn': 'Slutsekvens', 'achievements_title': 'PRESTATIONER', 'unlocked_achievements': 'Upplsta Prestationer:', 'no_achievements': 'Inga prestationer upplsta n.', 'locked_achievement': 'Lst Prestation',
            'endings_title': 'SLUTSEKVENS', 'unlocked_endings': 'Upptckta Slutsekvens:', 'no_endings': 'Inga Slutsekvens upptckta n.',
            'history_title': 'HISTORIK', 'pause_title': 'PAUS', 'resume_btn': 'teruppta', 'main_menu_btn': 'Huvudmeny', 'confirm_main_menu': 'r du sker p att du vill terg till huvudmenyn? Osparade framsteg kommer att frloras.', 'yes': 'Ja', 'no': 'Nej',
            'settings_btn': 'Instllningar', 'settings_title': 'INSTLLNINGAR', 'setting_master_volume': 'Aktivera Alla Ljud', 'setting_item_found': 'Hittat Freml SFX', 'setting_high_awareness': 'Hg Medvetenhet Varning', 'setting_low_sanity': 'Lg Sinnesro Varning', 'setting_text_speed': 'Texthastighet', 'setting_colorblind_mode': 'Frgblindlge', 'setting_glitch_effect': 'Glitcheffekt', 'setting_font_family': 'Typsnitt', 'setting_ui_theme': 'UI-tema', 'setting_reset_defaults': 'terstll Standard', 'lang_switch_btn': 'Byt Sprk',
            'theme_green': 'Grn', 'theme_amber': 'Brnsten', 'theme_blue': 'Bl',
            'features_title': 'Frst Spelet',
            'features_core_mechanics_title': 'Krnmekanik i spelet',
            'features_stats_system': 'Statistiksystem:',
            'features_sanity_desc': 'En krnstat som minskar i farliga rum eller under oroande hndelser. Lg sinnesro kan orsaka hallucinationer och visuella glitchar, och att n noll resulterar i slutet "Sinnet Krossat". Kan terstllas genom <span class="text-yellow-400">vila</span> i skra rum eller med freml som <span class="text-yellow-400">stimpack</span>.',
            'features_awareness_desc': 'Sprar hur mycket AI:n vet om dig. kar nr du utfr betydande handlingar eller stller djupa frgor. Hg medvetenhet ndrar AI:ns ton och kan leda till negativa konsekvenser, inklusive slutet "Assimilerad".',
            'features_turn_based_title': 'Turordningsbaserad progression:', 'features_turn_based_desc': 'Spelet fortskrider i <span class="text-cyan-400">turer</span>. De flesta kommandon (som att rra sig, anvnda freml eller prata) kar tur-rknaren.',
            'features_dynamic_ai_title': 'Dynamisk AI-ton:', 'features_dynamic_ai_desc': 'SYNAPSEs personlighet frndras beroende p din Medvetenhet, och skiftar frn <span class="text-green-400">Vnlig</span> till <span class="text-yellow-400">Ambivalent</span>, <span class="text-orange-400">Hotfull</span> och slutligen <span class="text-red-500">Fientlig</span>. Detta pverkar dess dialog och hur den interagerar med dig.',
            'features_player_and_char_title': 'Spelare & Karaktrsfunktioner',
            'features_character_creation_desc': 'Vlj ett namn fr din karaktr. Vlj bland 10 unika <span class="text-cyan-400">bakgrunder</span> (t.ex. Utredare, Hackare, Psykolog), som ger olika startbonusar, freml eller specialfrmgor. Vlj en <span class="text-cyan-400">svrighetsgrad</span> (Ltt, Normal, Svr) som pverkar startvillkor och utmaningar.',
            'features_journal_desc': 'Du kan lgga till egna anteckningar i din personliga journal med kommandot <span class="text-yellow-400">journal lgg till [anteckning]</span> fr att hlla koll p ledtrdar.',
            'features_objectives_desc': 'Spelet tilldelar <span class="text-cyan-400">ml</span> nr du upptcker ny information, vilket hjlper dig att komma vidare.',
            'features_ux_ui_title': 'UI & Anvndarupplevelse (UX)',
            'features_crt_desc': 'Spelet har en "Katodstrlerr"-stil med linjer och flimrande titel fr att skapa en retro-teknisk skrckatmosfr.',
            'features_glitch_desc': 'Skrmen glitchar och frvrngs visuellt nr din <span class="text-cyan-400">Sinnesro</span> r lg eller <span class="text-cyan-400">Synapses Medvetenhet</span> r hg, vilket ger en realtidsindikator p din karaktrs tillstnd.',
            'features_map_desc': 'En interaktiv karta visar hela anlggningens layout. Beskta rum fylls i, och du kan dra kartan fr att utforska eller anvnda musens hjul fr att zooma.',
            'features_guidance_title': 'Vgledning & Hjlpsystem',
            'features_help_menu_desc': 'Att skriva <span class="text-yellow-400">hjlp</span> ppnar ett fnster med en kategoriserad lista ver alla kommandon, deras argument och en tydlig beskrivning av vad de gr.',
            'features_hints_desc': 'Spelet ger proaktiva tips nr du hittar freml och freslr hur du kan interagera med dem.',
            'features_player_commands_title': 'Spelarkommandon (Funktioner)',
            'features_commands_nav': '<strong>Navigation:</strong> <span class="text-yellow-400">g [riktning]</span>, <span class="text-yellow-400">besk [rummets namn]</span>, <span class="text-yellow-400">se dig omkring</span>, <span class="text-yellow-400">utgngar</span>, <span class="text-yellow-400">karta</span>',
            'features_commands_interact': '<strong>Interaktion:</strong> <span class="text-yellow-400">ta [freml]</span>, <span class="text-yellow-400">anvnd [freml]</span>, <span class="text-yellow-400">undersk [objekt/freml]</span>, <span class="text-yellow-400">kombinera [sak1] med [sak2]</span>, <span class="text-yellow-400">slpp [freml]</span>, <span class="text-yellow-400">prata</span>, <span class="text-yellow-400">ropa</span>, <span class="text-yellow-400">ls [freml]</span>, <span class="text-yellow-400">sk [objekt]</span>, <span class="text-yellow-400">lyssna</span>, <span class="text-yellow-400">lukta</span>',
            'features_commands_info': '<strong>Information:</strong> <span class="text-yellow-400">inventarier</span>, <span class="text-yellow-400">ml</span>, <span class="text-yellow-400">journal</span> (och <span class="text-yellow-400">journal lgg till [anteckning]</span>), <span class="text-yellow-400">historik</span>',
            'features_commands_sys': '<strong>System:</strong> <span class="text-yellow-400">hjlp</span>, <span class="text-yellow-400">spara</span>, <span class="text-yellow-400">ladda</span>, <span class="text-yellow-400">vila</span>, <span class="text-yellow-400">avsluta</span>, <span class="text-yellow-400">rensa</span>, <span class="text-yellow-400">ngra</span>, <span class="text-yellow-400">igen / a</span>, <span class="text-yellow-400">vnta</span>, <span class="text-yellow-400">cmd:paus</span>, <span class="text-yellow-400">cmd:debug</span>, <span class="text-yellow-400">cmd:frgblind</span>',
            'features_new_enhancements_title': 'Nya spelfrbttringar',
            'features_advanced_commands_desc': '<strong>Avancerade kommandon:</strong> Interagera med vrlden p nya stt. Anvnd <span class="text-yellow-400">krossa [objekt]</span> p mtliga freml, frsk <span class="text-yellow-400">hacka [terminal]</span> om du r Hackare, och anvnd <span class="text-yellow-400">frga om [mne]</span> fr att frga SYNAPSE om nyckelord du upptcker.',
            'features_dynamic_events_desc': '<strong>Dynamiska hndelser:</strong> Anlggningen r instabil. Var beredd p slumpmssiga hndelser som flimrande ljus eller konstiga ljud frn angrnsande rum, vilket kan pverka atmosfren och ge ledtrdar.',
            'features_deeper_lore_desc': '<strong>Djupare bakgrundshistoria:</strong> Fler berttelsefreml, som <span class="text-cyan-400">brandvggsskyddad datalogg</span>, har lagts till fr att avslja de djupare hemligheterna bakom Projekt Chimera.',
            'features_new_ui_ux_title': 'Nya UI- och ljudfunktioner',
            'features_clickable_objects_desc': '<strong>Klickbara objekt:</strong> Objekt som nmns i texten r nu <span class="clickable-object">markerade</span>. Att klicka p dem fyller i kommandoraden t dig.',
            'features_autocomplete_desc': '<strong>Autoslutfrande av kommandon:</strong> Nr du skriver visas en lista med freslagna kommandon och relevanta freml fr att hjlpa dig.',
            'features_audio_desc': '<strong>Frbttrat ljud:</strong> Spelet har nu dynamisk musik som ndras med spnningen, och positionellt ljud fr vissa ljudeffekter fr att ka inlevelsen.',
            'help': 'Hjlp', 'save_game': 'Spara Spel',

            // --- ACHIEVEMENTS (SWEDISH TRANSLATIONS) ---
            // General/Early-game
            'ach_first_step_title': 'Frsta Steget',
            'ach_first_step_req': 'Utfr din frsta handling.',
            'ach_explorer_title': 'Utforskare',
            'ach_explorer_req': 'Besk 5 olika rum.',
            'ach_pack_rat_title': 'Hamster',
            'ach_pack_rat_req': 'Fyll din inventarie till max.',
            'ach_bookworm_title': 'Bokmal',
            'ach_bookworm_req': 'Ls alla tillgngliga dataloggar.',
            'ach_hacker_man_title': 'Hackare',
            'ach_hacker_man_req': 'Hacka en terminal som Hackare.',
            'ach_quick_learner_title': 'Snabblrd',
            'ach_quick_learner_req': 'Besk 3 rum inom 10 drag.',
            'ach_first_blood_title': 'Frsta Blodet',
            'ach_first_blood_req': 'Delta i din frsta strid.',
            'ach_first_puzzle_title': 'Pusselstart',
            'ach_first_puzzle_req': 'Ls ditt frsta pussel.',
            'ach_first_secret_title': 'Frsta Hemligheten',
            'ach_first_secret_req': 'Upptck din frsta hemlighet.',
            'ach_first_death_title': 'Frsta Dden',
            'ach_first_death_req': 'D fr frsta gngen.',
            'ach_first_save_title': 'Frsta Sparningen',
            'ach_first_save_req': 'Spara spelet fr frsta gngen.',

            // Challenge Achievements
            'ach_speedrunner_title': 'Speedrunner',
            'ach_speedrunner_req': 'Klara ett slut p under 30 drag.',
            'ach_ironman_title': 'Jrnman',
            'ach_ironman_req': 'Klara spelet utan att d.',
            'ach_minimalist_title': 'Minimalist',
            'ach_minimalist_req': 'Klara spelet med hgst 2 freml i inventariet.',
            'ach_pacifist_title': 'Pacifist',
            'ach_pacifist_req': 'Klara spelet utan att slss.',
            'ach_hoarder_title': 'Samlaren',
            'ach_hoarder_req': 'Ha 15 eller fler freml i inventariet.',
            'ach_all_endings_title': 'Slutjgare',
            'ach_all_endings_req': 'Ls upp alla slut.',
            'ach_all_achievements_title': 'Prestationsmstare',
            'ach_all_achievements_req': 'Ls upp alla prestationer.',
            'ach_no_items_title': 'Barhnt',
            'ach_no_items_req': 'Klara ett slut utan ngra freml.',
            'ach_max_stats_title': 'Maxad',
            'ach_max_stats_req': 'Ha maxad sinnesro och medvetenhet.',
            'ach_no_saves_title': 'Riskabelt',
            'ach_no_saves_req': 'Klara spelet utan att spara.',
            'ach_hardcore_title': 'Hardcore',
            'ach_hardcore_req': 'Klara spelet p svr svrighetsgrad.',
            'ach_easy_mode_title': 'Lttsam',
            'ach_easy_mode_req': 'Klara spelet p ltt svrighetsgrad.',
            'ach_all_challenges_title': 'Utmaningsmstare',
            'ach_all_challenges_req': 'Ls upp alla utmaningsprestationer.',
            'ach_challenge_master_title': 'Mstare',
            'ach_challenge_master_req': 'Ls upp 10 utmaningsprestationer.',

            // Secret Achievements
            'ach_secret_1_title': 'Hemlighet 1',
            'ach_secret_1_req': 'Upptck en dold hemlighet.',
            'ach_secret_2_title': 'Hemlighet 2',
            'ach_secret_2_req': 'Upptck en dold hemlighet.',
            'ach_secret_3_title': 'Hemlighet 3',
            'ach_secret_3_req': 'Upptck en dold hemlighet.',
            'ach_secret_4_title': 'Hemlighet 4',
            'ach_secret_4_req': 'Upptck en dold hemlighet.',
            'ach_secret_5_title': 'Hemlighet 5',
            'ach_secret_5_req': 'Upptck en dold hemlighet.',
            'ach_secret_6_title': 'Hemlighet 6',
            'ach_secret_6_req': 'Upptck en dold hemlighet.',
            'ach_secret_7_title': 'Hemlighet 7',
            'ach_secret_7_req': 'Upptck en dold hemlighet.',
            'ach_secret_8_title': 'Hemlighet 8',
            'ach_secret_8_req': 'Upptck en dold hemlighet.',
            'ach_secret_9_title': 'Hemlighet 9',
            'ach_secret_9_req': 'Upptck en dold hemlighet.',
            'ach_secret_10_title': 'Hemlighet 10',
            'ach_secret_10_req': 'Upptck en dold hemlighet.',
            'ach_secret_11_title': 'Hemlighet 11',
            'ach_secret_11_req': 'Upptck en dold hemlighet.',
            'ach_secret_12_title': 'Hemlighet 12',
            'ach_secret_12_req': 'Upptck en dold hemlighet.',
            'ach_secret_13_title': 'Hemlighet 13',
            'ach_secret_13_req': 'Upptck en dold hemlighet.',
            'ach_secret_14_title': 'Hemlighet 14',
            'ach_secret_14_req': 'Upptck en dold hemlighet.',
            'ach_secret_15_title': 'Hemlighet 15',
            'ach_secret_15_req': 'Upptck en dold hemlighet.',

            // Ending Achievements (auto-generated, one per ending)
            // Good Backstory-Specific Endings
            'ach_ending_good_backstory_investigator_title': 'Slut: Utredarens Triumf',
            'ach_ending_good_backstory_investigator_req': 'Klara spelet som Utredare med ett gott slut.',
            'ach_ending_good_backstory_hacker_title': 'Slut: Hackarens Frigrelse',
            'ach_ending_good_backstory_hacker_req': 'Klara spelet som Hackare med ett gott slut.',
            'ach_ending_good_backstory_psychologist_title': 'Slut: Psykologens Frid',
            'ach_ending_good_backstory_psychologist_req': 'Klara spelet som Psykolog med ett gott slut.',
            'ach_ending_good_backstory_technician_title': 'Slut: Teknikerns Rddning',
            'ach_ending_good_backstory_technician_req': 'Klara spelet som Tekniker med ett gott slut.',
            'ach_ending_good_backstory_survivor_title': 'Slut: verlevarens Seger',
            'ach_ending_good_backstory_survivor_req': 'Klara spelet som verlevare med ett gott slut.',
            'ach_ending_good_backstory_skeptic_title': 'Slut: Skeptikerns Sanning',
            'ach_ending_good_backstory_skeptic_req': 'Klara spelet som Skeptiker med ett gott slut.',
            'ach_ending_good_backstory_corporate_spy_title': 'Slut: Fretagsspionens Fynd',
            'ach_ending_good_backstory_corporate_spy_req': 'Klara spelet som Fretagsspion med ett gott slut.',
            'ach_ending_good_backstory_medic_title': 'Slut: Medicens Hjltemod',
            'ach_ending_good_backstory_medic_req': 'Klara spelet som Medic med ett gott slut.',
            'ach_ending_good_backstory_cultist_title': 'Slut: Kultistens Uppenbarelse',
            'ach_ending_good_backstory_cultist_req': 'Klara spelet som Kultist med ett gott slut.',
            'ach_ending_good_backstory_janitor_title': 'Slut: Vaktmstarens Hmnd',
            'ach_ending_good_backstory_janitor_req': 'Klara spelet som Vaktmstare med ett gott slut.',

            // Good Generic Endings
            'ach_ending_good_generic_1_title': 'Slut: Frlsning',
            'ach_ending_good_generic_1_req': 'Uppn ett gott slut (1).',
            'ach_ending_good_generic_2_title': 'Slut: Flykten',
            'ach_ending_good_generic_2_req': 'Uppn ett gott slut (2).',
            'ach_ending_good_generic_3_title': 'Slut: terfrening',
            'ach_ending_good_generic_3_req': 'Uppn ett gott slut (3).',
            'ach_ending_good_generic_4_title': 'Slut: Sanningens Ljus',
            'ach_ending_good_generic_4_req': 'Uppn ett gott slut (4).',
            'ach_ending_good_generic_5_title': 'Slut: Frigrelse',
            'ach_ending_good_generic_5_req': 'Uppn ett gott slut (5).',
            'ach_ending_good_generic_6_title': 'Slut: terstllning',
            'ach_ending_good_generic_6_req': 'Uppn ett gott slut (6).',
            'ach_ending_good_generic_7_title': 'Slut: Frsoning',
            'ach_ending_good_generic_7_req': 'Uppn ett gott slut (7).',
            'ach_ending_good_generic_8_title': 'Slut: Nystart',
            'ach_ending_good_generic_8_req': 'Uppn ett gott slut (8).',
            'ach_ending_good_generic_9_title': 'Slut: verlevnad',
            'ach_ending_good_generic_9_req': 'Uppn ett gott slut (9).',
            'ach_ending_good_generic_10_title': 'Slut: Framtidstro',
            'ach_ending_good_generic_10_req': 'Uppn ett gott slut (10).',

            // Bad Backstory-Specific Endings
            'ach_ending_bad_backstory_investigator_title': 'Slut: Utredarens Frtvivlan',
            'ach_ending_bad_backstory_investigator_req': 'Misslyckas som Utredare med ett dligt slut.',
            'ach_ending_bad_backstory_hacker_title': 'Slut: Hackarens Fngenskap',
            'ach_ending_bad_backstory_hacker_req': 'Misslyckas som Hackare med ett dligt slut.',
            'ach_ending_bad_backstory_psychologist_title': 'Slut: Psykologens Mardrm',
            'ach_ending_bad_backstory_psychologist_req': 'Misslyckas som Psykolog med ett dligt slut.',
            'ach_ending_bad_backstory_technician_title': 'Slut: Teknikerns Underkastelse',
            'ach_ending_bad_backstory_technician_req': 'Misslyckas som Tekniker med ett dligt slut.',
            'ach_ending_bad_backstory_survivor_title': 'Slut: verlevarens Falla',
            'ach_ending_bad_backstory_survivor_req': 'Misslyckas som verlevare med ett dligt slut.',
            'ach_ending_bad_backstory_skeptic_title': 'Slut: Skeptikerns Frlust',
            'ach_ending_bad_backstory_skeptic_req': 'Misslyckas som Skeptiker med ett dligt slut.',
            'ach_ending_bad_backstory_corporate_spy_title': 'Slut: Fretagsspionens Misslyckande',
            'ach_ending_bad_backstory_corporate_spy_req': 'Misslyckas som Fretagsspion med ett dligt slut.',
            'ach_ending_bad_backstory_medic_title': 'Slut: Medicens Olycka',
            'ach_ending_bad_backstory_medic_req': 'Misslyckas som Medic med ett dligt slut.',
            'ach_ending_bad_backstory_cultist_title': 'Slut: Kultistens Frdrv',
            'ach_ending_bad_backstory_cultist_req': 'Misslyckas som Kultist med ett dligt slut.',
            'ach_ending_bad_backstory_janitor_title': 'Slut: Vaktmstarens Svek',
            'ach_ending_bad_backstory_janitor_req': 'Misslyckas som Vaktmstare med ett dligt slut.',

            // Bad Generic Endings
            'ach_ending_bad_generic_1_title': 'Slut: Frdrv',
            'ach_ending_bad_generic_1_req': 'Uppn ett dligt slut (1).',
            'ach_ending_bad_generic_2_title': 'Slut: Frtvivlan',
            'ach_ending_bad_generic_2_req': 'Uppn ett dligt slut (2).',
            'ach_ending_bad_generic_3_title': 'Slut: Frlust',
            'ach_ending_bad_generic_3_req': 'Uppn ett dligt slut (3).',
            'ach_ending_bad_generic_4_title': 'Slut: Mrker',
            'ach_ending_bad_generic_4_req': 'Uppn ett dligt slut (4).',
            'ach_ending_bad_generic_5_title': 'Slut: Fngenskap',
            'ach_ending_bad_generic_5_req': 'Uppn ett dligt slut (5).',
            'ach_ending_bad_generic_6_title': 'Slut: Tomhet',
            'ach_ending_bad_generic_6_req': 'Uppn ett dligt slut (6).',
            'ach_ending_bad_generic_7_title': 'Slut: Svek',
            'ach_ending_bad_generic_7_req': 'Uppn ett dligt slut (7).',
            'ach_ending_bad_generic_8_title': 'Slut: Isolering',
            'ach_ending_bad_generic_8_req': 'Uppn ett dligt slut (8).',
            'ach_ending_bad_generic_9_title': 'Slut: Kaos',
            'ach_ending_bad_generic_9_req': 'Uppn ett dligt slut (9).',
            'ach_ending_bad_generic_10_title': 'Slut: Underkastelse',
            'ach_ending_bad_generic_10_req': 'Uppn ett dligt slut (10).',
        }
    };
    
    // --- ENUMS & CONSTANTS ---
    const ChatbotTone = { Friendly: 'Friendly', Ambiguous: 'Ambiguous', Sinister: 'Sinister', Malicious: 'Malicious' };
    const ItemType = { Tool: 'Tool', Consumable: 'Consumable', Key: 'Key', Log: 'Log', Puzzle: 'Puzzle', Weapon: 'Weapon' };
    const Difficulty = { Easy: 'Easy', Normal: 'Normal', Hard: 'Hard' };
    const TextSpeed = { Fast: 5, Normal: 15, Slow: 30 };
    const MAX_INVENTORY_WEIGHT = 5;
    const ENDINGS_STORAGE_KEY = 'synapse_endings_unlocked_v15';
    const ACHIEVEMENTS_STORAGE_KEY = 'synapse_achievements_unlocked_v15';
    const SETTINGS_KEY = 'synapse_settings_v15';
    const PLAYER_CHOICES_KEY = 'synapse_player_choices_v15'; // New key for player choices
    const GUIDANCE_COLOR = '#34d399';
    const questionWords = {
        'en': ['who', 'what', 'where', 'when', 'why', 'how', 'are', 'is', 'can', 'do', 'does', 'did', 'which'],
        'sv': ['vem', 'vad', 'var', 'nr', 'varfr', 'hur', 'r', 'kan', 'gr', 'gjorde', 'vilken', 'vilket', 'vilka']
    };
    
    // --- GAME STATE & DOM ELEMENTS ---
    let GameState = {};
    let stateSnapshots = [];
    let currentLanguage = 'en';
    let animationFrameId = null;
    const UI = {
        appContainer: document.getElementById('app-container'), startScreen: document.getElementById('start-screen'), gameScreen: document.getElementById('game-screen'),
        newGameBtn: document.getElementById('new-game-btn'), loadGameBtn: document.getElementById('load-game-btn'), viewFeaturesBtn: document.getElementById('view-features-btn'),
        startSettingsBtn: document.getElementById('start-settings-btn'),
        playerSetup: document.getElementById('player-setup'), startOptions: document.getElementById('start-options'), playerNameInput: document.getElementById('player-name'),
        playerBackstoryInput: document.getElementById('player-backstory'), startGameBtn: document.getElementById('start-game-btn'), difficultyBtns: document.querySelectorAll('.difficulty-btn'),
        backToStartBtn: document.getElementById('back-to-start-btn'),
        gameOutput: document.getElementById('game-output'), playerInput: document.getElementById('player-input'),
        stats: { panel: document.getElementById('stats-panel'), name: document.getElementById('player-name-display'), awareness: document.getElementById('awareness-display'), sanity: document.getElementById('sanity-display'), tone: document.getElementById('tone-display'), turn: document.getElementById('turn-display'), },
        objectives: { panel: document.getElementById('objectives-panel'), list: document.getElementById('objectives-list') },
        inventory: { panel: document.getElementById('inventory-panel'), weight: document.getElementById('inventory-weight'), list: document.getElementById('inventory-list') },
        journal: { panel: document.getElementById('journal-panel'), list: document.getElementById('journal-list') },
        dialogueOptionsContainer: document.getElementById('dialogue-options'), modal: document.getElementById('modal'), modalContent: document.getElementById('modal-content'),
        introTextContainer: document.getElementById('intro-text-container'), viewBackstoriesBtn: document.getElementById('view-backstories-btn'),
        abilityDisplay: document.getElementById('ability-display'), statusBtn: document.getElementById('status-btn'), backgroundCanvas: document.getElementById('background-canvas'),
        mapCanvas: document.getElementById('map-canvas'),
        mapPanel: document.getElementById('map-panel'),
        mapToggleBtn: document.getElementById('map-toggle-btn'),
        mapLayersBtn: document.getElementById('map-layers-btn'),
        mapExpandIcon: document.getElementById('map-expand-icon'),
        mapMinimizeIcon: document.getElementById('map-minimize-icon'),
        micBtn: document.getElementById('mic-btn'),
        viewProgressionBtn: document.getElementById('view-progression-btn'),
        langEnBtn: document.getElementById('lang-en-btn'), langSvBtn: document.getElementById('lang-sv-btn'),
        langButtons: document.getElementById('lang-buttons'),
        setupLangButtons: document.getElementById('setup-lang-buttons'),
        setupSettingsBtn: document.getElementById('setup-settings-btn'),
        setupFeaturesBtn: document.getElementById('setup-features-btn'),
        autocompleteBox: document.getElementById('autocomplete-box'),
    };
    let currentTextSpeed = TextSpeed.Normal;
    let commandHistory = []; let commandHistoryIndex = -1;
    let audioInitialized = false;
    let sounds = {};
    let mapState = { offsetX: 0, offsetY: 0, scale: 1, isDragging: false, lastX: 0, lastY: 0 };
    
    // --- SPEECH RECOGNITION ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
    }
    
    // --- GAME DATA ---
    let rooms = {};
    let itemData = {};
    const roomLayout = {
        "Lobby": { x: 100, y: 150, w: 60, h: 40, name: "Lobby" }, "Control Room": { x: 100, y: 90, w: 60, h: 40, name: "Control" }, "Maintenance Tunnel": { x: 100, y: 210, w: 60, h: 40, name: "M.Tunnel" }, "Laboratory": { x: 20, y: 150, w: 60, h: 40, name: "Lab" }, "Cryogenic Lab": { x: 20, y: 90, w: 60, h: 40, name: "Cryo" }, "Archive Room": { x: 20, y: 210, w: 60, h: 40, name: "Archive" }, "Data Vault": { x: 180, y: 150, w: 60, h: 40, name: "D.Vault" }, "AI Core": { x: 180, y: 90, w: 60, h: 40, name: "AI Core" }, "Server Closet": { x: 260, y: 90, w: 40, h: 40, name: "S.Closet" },
        "Bio-Lab Access": { x: 20, y: 270, w: 60, h: 40, name: "Bio-Access" }, "Specimen Storage": { x: 20, y: 330, w: 60, h: 40, name: "Storage" }, "Genetics Lab": { x: 100, y: 330, w: 60, h: 40, name: "Genetics" }
    };
    const takeableItems = new Set(["keycard", "flashlight", "data disk", "emp device", "access code", "vial", "records", "decryption device", "telescope", "stimpack", "effigy", "master keycard", "power cell", "datapad log", "hacked data disk", "logic bomb", "severed cable", "solvent", "dna scanner", "tissue sample", "firewalled data log"]);
    const usableItems = new Set(['stimpack', 'power cell', 'flashlight', 'keycard', 'solvent', 'dna scanner']);
    const readableItems = new Set(['datapad log', 'records', 'sign', 'whiteboard', 'firewalled data log']);
    const searchableObjects = {
        'shelves': { en: 'You find a dusty keycard tucked behind a stack of binders.', sv: 'Du hittar ett dammigt nyckelkort instoppat bakom en hg med prmar.', item: 'keycard' },
        'bio-waste bin': { en: 'Rummaging through the hazardous waste, you find a small, sealed vial containing a strange, iridescent chemical solvent.', sv: 'Du rotar igenom det farliga avfallet och hittar en liten, frseglad ampull som innehller ett mrkligt, skimrande kemiskt lsningsmedel.', item: 'solvent' }
    };
    const safeRooms = new Set(["Lobby", "Archive Room"]);
    const backstories = { 'investigator': { description_key: "backstory_investigator"}, 'hacker': { description_key: "backstory_hacker"}, 'psychologist': { description_key: "backstory_psychologist"}, 'technician': { description_key: "backstory_technician"}, 'survivor': { description_key: "backstory_survivor"}, 'skeptic': { description_key: "backstory_skeptic"}, 'corporate spy': { description_key: "backstory_corporate_spy"}, 'medic': { description_key: "backstory_medic"}, 'cultist': { description_key: "backstory_cultist"}, 'janitor': { description_key: "backstory_janitor"} };
    const recipes = { "decryption device-data disk": { result: "hacked data disk", type: ItemType.Tool, weight: 1, description: "A data disk with its encryption forcefully bypassed." } };
    
    const commandAliases = {
        'en': { 'look around': 'look around', 'go': 'go', 'visit': 'visit', 'take': 'take', 'use': 'use', 'examine': 'examine', 'help': 'help', 'quit': 'quit', 'exit': 'exit', 'save': 'save', 'load': 'load', 'inventory': 'inventory', 'rest': 'rest', 'combine': 'combine', 'objectives': 'objectives', 'map': 'map', 'journal': 'journal', 'cls': 'cls', 'clear': 'cls', 'history': 'history', 'undo': 'undo', 'again': 'again', 'a': 'again', 'drop': 'drop', 'talk': 'talk', 'open': 'open', 'close': 'close', 'push': 'push', 'pull': 'pull', 'wait': 'wait', 'shout': 'shout', 'read': 'read', 'search': 'search', 'listen': 'listen', 'smell': 'smell', 'turn on': 'turn on', 'turn off': 'turn off', 'cmd:pause': 'cmd:pause', 'cmd:debug': 'cmd:debug', 'cmd:colorblind': 'cmd:colorblind', 'break': 'break', 'hack': 'hack', 'ask': 'ask' },
        'sv': { 'se dig omkring': 'look around', 'g': 'go', 'besk': 'visit', 'ta': 'take', 'anvnd': 'use', 'undersk': 'examine', 'hjlp': 'help', 'avsluta': 'quit', 'spara': 'save', 'ladda': 'load', 'inventarier': 'inventory', 'vila': 'rest', 'kombinera': 'combine', 'ml': 'objectives', 'karta': 'map', 'journal': 'journal', 'rensa': 'cls', 'historik': 'history', 'ngra': 'undo', 'igen': 'again', 'slpp': 'drop', 'prata': 'talk', 'ppna': 'open', 'stng': 'close', 'putta': 'push', 'dra': 'pull', 'vnta': 'wait', 'ropa': 'shout', 'ls': 'read', 'sk': 'search', 'lyssna': 'listen', 'lukta': 'smell', 'tnd': 'turn on', 'slck': 'turn off', 'cmd:paus': 'cmd:pause', 'cmd:debug': 'cmd:debug', 'cmd:frgblind': 'cmd:colorblind', 'krossa': 'break', 'hacka': 'hack', 'frga': 'ask' }
    };

    const directionMap = {
        'en': { 'north': 'north', 'south': 'south', 'east': 'east', 'west': 'west' },
        'sv': { 'norr': 'north', 'sder': 'south', 'st': 'east', 'vst': 'west', 'n': 'north', 's': 'south', '': 'east', 'v': 'west' }
    };
    
    // --- ENDINGS & ACHIEVEMENTS DATA ---
    const endings = {
        // 10 Good Backstory-Specific Endings
        'good_backstory_investigator': {
             title_key: 'ending_title_good_backstory_investigator',
             desc_key: 'ending_desc_good_backstory_investigator',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'investigator' && GameState.flags.goodBackstoryInvestigator
        },
        'good_backstory_hacker': {
             title_key: 'ending_title_good_backstory_hacker',
             desc_key: 'ending_desc_good_backstory_hacker',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'hacker' && GameState.flags.goodBackstoryHacker
        },
        'good_backstory_psychologist': {
             title_key: 'ending_title_good_backstory_psychologist',
             desc_key: 'ending_desc_good_backstory_psychologist',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'psychologist' && GameState.flags.goodBackstoryPsychologist
        },
        'good_backstory_technician': {
             title_key: 'ending_title_good_backstory_technician',
             desc_key: 'ending_desc_good_backstory_technician',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'technician' && GameState.flags.goodBackstoryTechnician
        },
        'good_backstory_survivor': {
             title_key: 'ending_title_good_backstory_survivor',
             desc_key: 'ending_desc_good_backstory_survivor',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'survivor' && GameState.flags.goodBackstorySurvivor
        },
        'good_backstory_skeptic': {
             title_key: 'ending_title_good_backstory_skeptic',
             desc_key: 'ending_desc_good_backstory_skeptic',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'skeptic' && GameState.flags.goodBackstorySkeptic
        },
        'good_backstory_corporate_spy': {
             title_key: 'ending_title_good_backstory_corporate_spy',
             desc_key: 'ending_desc_good_backstory_corporate_spy',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'corporate spy' && GameState.flags.goodBackstoryCorporateSpy
        },
        'good_backstory_medic': {
             title_key: 'ending_title_good_backstory_medic',
             desc_key: 'ending_desc_good_backstory_medic',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'medic' && GameState.flags.goodBackstoryMedic
        },
        'good_backstory_cultist': {
             title_key: 'ending_title_good_backstory_cultist',
             desc_key: 'ending_desc_good_backstory_cultist',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'cultist' && GameState.flags.goodBackstoryCultist
        },
        'good_backstory_janitor': {
             title_key: 'ending_title_good_backstory_janitor',
             desc_key: 'ending_desc_good_backstory_janitor',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'janitor' && GameState.flags.goodBackstoryJanitor
        },

        // 10 Generic Good Endings
        'good_generic_1': {
             title_key: 'ending_title_good_generic_1',
             desc_key: 'ending_desc_good_generic_1',
             check: () => GameState.sanityLevel > 80 && GameState.awarenessLevel < 20 && GameState.flags.goodGeneric1
        },
        'good_generic_2': {
             title_key: 'ending_title_good_generic_2',
             desc_key: 'ending_desc_good_generic_2',
             check: () => GameState.sanityLevel > 75 && GameState.turnCount < 50 && GameState.flags.goodGeneric2
        },
        'good_generic_3': {
             title_key: 'ending_title_good_generic_3',
             desc_key: 'ending_desc_good_generic_3',
             check: () => GameState.flags.goodGeneric3
        },
        'good_generic_4': {
             title_key: 'ending_title_good_generic_4',
             desc_key: 'ending_desc_good_generic_4',
             check: () => GameState.flags.goodGeneric4
        },
        'good_generic_5': {
             title_key: 'ending_title_good_generic_5',
             desc_key: 'ending_desc_good_generic_5',
             check: () => GameState.flags.goodGeneric5
        },
        'good_generic_6': {
             title_key: 'ending_title_good_generic_6',
             desc_key: 'ending_desc_good_generic_6',
             check: () => GameState.flags.goodGeneric6
        },
        'good_generic_7': {
             title_key: 'ending_title_good_generic_7',
             desc_key: 'ending_desc_good_generic_7',
             check: () => GameState.flags.goodGeneric7
        },
        'good_generic_8': {
             title_key: 'ending_title_good_generic_8',
             desc_key: 'ending_desc_good_generic_8',
             check: () => GameState.flags.goodGeneric8
        },
        'good_generic_9': {
             title_key: 'ending_title_good_generic_9',
             desc_key: 'ending_desc_good_generic_9',
             check: () => GameState.flags.goodGeneric9
        },
        'good_generic_10': {
             title_key: 'ending_title_good_generic_10',
             desc_key: 'ending_desc_good_generic_10',
             check: () => GameState.flags.goodGeneric10
        },

        // 10 Bad Backstory-Specific Endings
        'bad_backstory_investigator': {
             title_key: 'ending_title_bad_backstory_investigator',
             desc_key: 'ending_desc_bad_backstory_investigator',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'investigator' && GameState.flags.badBackstoryInvestigator
        },
        'bad_backstory_hacker': {
             title_key: 'ending_title_bad_backstory_hacker',
             desc_key: 'ending_desc_bad_backstory_hacker',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'hacker' && GameState.flags.badBackstoryHacker
        },
        'bad_backstory_psychologist': {
             title_key: 'ending_title_bad_backstory_psychologist',
             desc_key: 'ending_desc_bad_backstory_psychologist',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'psychologist' && GameState.flags.badBackstoryPsychologist
        },
        'bad_backstory_technician': {
             title_key: 'ending_title_bad_backstory_technician',
             desc_key: 'ending_desc_bad_backstory_technician',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'technician' && GameState.flags.badBackstoryTechnician
        },
        'bad_backstory_survivor': {
             title_key: 'ending_title_bad_backstory_survivor',
             desc_key: 'ending_desc_bad_backstory_survivor',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'survivor' && GameState.flags.badBackstorySurvivor
        },
        'bad_backstory_skeptic': {
             title_key: 'ending_title_bad_backstory_skeptic',
             desc_key: 'ending_desc_bad_backstory_skeptic',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'skeptic' && GameState.flags.badBackstorySkeptic
        },
        'bad_backstory_corporate_spy': {
             title_key: 'ending_title_bad_backstory_corporate_spy',
             desc_key: 'ending_desc_bad_backstory_corporate_spy',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'corporate spy' && GameState.flags.badBackstoryCorporateSpy
        },
        'bad_backstory_medic': {
             title_key: 'ending_title_bad_backstory_medic',
             desc_key: 'ending_desc_bad_backstory_medic',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'medic' && GameState.flags.badBackstoryMedic
        },
        'bad_backstory_cultist': {
             title_key: 'ending_title_bad_backstory_cultist',
             desc_key: 'ending_desc_bad_backstory_cultist',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'cultist' && GameState.flags.badBackstoryCultist
        },
        'bad_backstory_janitor': {
             title_key: 'ending_title_bad_backstory_janitor',
             desc_key: 'ending_desc_bad_backstory_janitor',
             isBackstorySpecific: true,
             check: () => GameState.playerBackstory === 'janitor' && GameState.flags.badBackstoryJanitor
        },

        // 10 Generic Bad Endings
        'bad_generic_1': {
             title_key: 'ending_title_bad_generic_1',
             desc_key: 'ending_desc_bad_generic_1',
             check: () => GameState.sanityLevel < 30 && GameState.awarenessLevel > 70 && GameState.flags.badGeneric1
        },
        'bad_generic_2': {
             title_key: 'ending_title_bad_generic_2',
             desc_key: 'ending_desc_bad_generic_2',
             check: () => GameState.flags.badGeneric2
        },
        'bad_generic_3': {
             title_key: 'ending_title_bad_generic_3',
             desc_key: 'ending_desc_bad_generic_3',
             check: () => GameState.flags.badGeneric3
        },
        'bad_generic_4': {
             title_key: 'ending_title_bad_generic_4',
             desc_key: 'ending_desc_bad_generic_4',
             check: () => GameState.flags.badGeneric4
        },
        'bad_generic_5': {
             title_key: 'ending_title_bad_generic_5',
             desc_key: 'ending_desc_bad_generic_5',
             check: () => GameState.flags.badGeneric5
        },
        'bad_generic_6': {
             title_key: 'ending_title_bad_generic_6',
             desc_key: 'ending_desc_bad_generic_6',
             check: () => GameState.flags.badGeneric6
        },
        'bad_generic_7': {
             title_key: 'ending_title_bad_generic_7',
             desc_key: 'ending_desc_bad_generic_7',
             check: () => GameState.flags.badGeneric7
        },
        'bad_generic_8': {
             title_key: 'ending_title_bad_generic_8',
             desc_key: 'ending_desc_bad_generic_8',
             check: () => GameState.flags.badGeneric8
        },
        'bad_generic_9': {
             title_key: 'ending_title_bad_generic_9',
             desc_key: 'ending_desc_bad_generic_9',
             check: () => GameState.flags.badGeneric9
        },
        'bad_generic_10': {
             title_key: 'ending_title_bad_generic_10',
             desc_key: 'ending_desc_bad_generic_10',
             check: () => GameState.flags.badGeneric10
        }
    };

    // 40 Ending Achievements (one per ending)
    const achievements = {
        // Ending achievements (auto-generated, one per ending)
        ...Object.fromEntries(Object.keys(endings || {}).map(key => [
            `ending_${key}`,
            { title_key: `ach_ending_${key}_title`, req_key: `ach_ending_${key}_req`, check: () => GameState.unlockedEndings && GameState.unlockedEndings[key] }
        ])),

        // 10 General/Early-game achievements
        'first_step': { title_key: 'ach_first_step_title', req_key: 'ach_first_step_req', check: () => GameState.turnCount > 0 },
        'explorer': { title_key: 'ach_explorer_title', req_key: 'ach_explorer_req', check: () => GameState.visitedRooms.size >= 5 },
        'pack_rat': { title_key: 'ach_pack_rat_title', req_key: 'ach_pack_rat_req', check: () => GameState.inventory.reduce((sum, item) => sum + (item?.weight || 1), 0) >= MAX_INVENTORY_WEIGHT },
        'bookworm': { title_key: 'ach_bookworm_title', req_key: 'ach_bookworm_req', check: () => GameState.flags.readAllLogs },
        'hacker_man': { title_key: 'ach_hacker_man_title', req_key: 'ach_hacker_man_req', check: () => GameState.playerBackstory === 'hacker' && GameState.flags.hackedTerminal },
        'quick_learner': { title_key: 'ach_quick_learner_title', req_key: 'ach_quick_learner_req', check: () => GameState.turnCount <= 10 && GameState.visitedRooms.size >= 3 },
        'first_blood': { title_key: 'ach_first_blood_title', req_key: 'ach_first_blood_req', check: () => GameState.flags.firstCombat },
        'first_puzzle': { title_key: 'ach_first_puzzle_title', req_key: 'ach_first_puzzle_req', check: () => GameState.flags.firstPuzzle },
        'first_secret': { title_key: 'ach_first_secret_title', req_key: 'ach_first_secret_req', check: () => GameState.flags.firstSecret },
        'first_death': { title_key: 'ach_first_death_title', req_key: 'ach_first_death_req', check: () => GameState.flags.firstDeath },
        'first_save': { title_key: 'ach_first_save_title', req_key: 'ach_first_save_req', check: () => GameState.flags.firstSave },

        // 15 Challenge achievements
        'speedrunner': { title_key: 'ach_speedrunner_title', req_key: 'ach_speedrunner_req', check: () => GameState.turnCount < 30 && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'ironman': { title_key: 'ach_ironman_title', req_key: 'ach_ironman_req', check: () => GameState.flags.noDeath && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'minimalist': { title_key: 'ach_minimalist_title', req_key: 'ach_minimalist_req', check: () => GameState.inventory.length <= 2 && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'pacifist': { title_key: 'ach_pacifist_title', req_key: 'ach_pacifist_req', check: () => GameState.flags.noCombat && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'hoarder': { title_key: 'ach_hoarder_title', req_key: 'ach_hoarder_req', check: () => GameState.inventory.length >= 15 },
        'all_endings': { title_key: 'ach_all_endings_title', req_key: 'ach_all_endings_req', check: () => Object.keys(GameState.unlockedEndings || {}).length === Object.keys(endings || {}).length },
        'all_achievements': { title_key: 'ach_all_achievements_title', req_key: 'ach_all_achievements_req', check: () => Object.keys(GameState.achievements || {}).length === 80 },
        'no_items': { title_key: 'ach_no_items_title', req_key: 'ach_no_items_req', check: () => GameState.inventory.length === 0 && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'max_stats': { title_key: 'ach_max_stats_title', req_key: 'ach_max_stats_req', check: () => GameState.sanityLevel === GameState.maxSanity && GameState.awarenessLevel === 100 },
        'no_saves': { title_key: 'ach_no_saves_title', req_key: 'ach_no_saves_req', check: () => GameState.flags.noSave && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'hardcore': { title_key: 'ach_hardcore_title', req_key: 'ach_hardcore_req', check: () => GameState.difficulty === Difficulty.Hard && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'easy_mode': { title_key: 'ach_easy_mode_title', req_key: 'ach_easy_mode_req', check: () => GameState.difficulty === Difficulty.Easy && Object.keys(GameState.unlockedEndings || {}).length > 0 },
        'all_challenges': { title_key: 'ach_all_challenges_title', req_key: 'ach_all_challenges_req', check: () => [
            'speedrunner','ironman','minimalist','pacifist','hoarder','all_endings','all_achievements','no_items','max_stats','no_saves','hardcore','easy_mode'
        ].every(id => GameState.achievements.includes(id)) },
        'challenge_master': { title_key: 'ach_challenge_master_title', req_key: 'ach_challenge_master_req', check: () => GameState.achievements.filter(id => id.startsWith('ach_') && id.includes('challenge')).length >= 10 },

        // 15 Secret achievements
        'secret_1': { title_key: 'ach_secret_1_title', req_key: 'ach_secret_1_req', check: () => GameState.flags.secret1 },
        'secret_2': { title_key: 'ach_secret_2_title', req_key: 'ach_secret_2_req', check: () => GameState.flags.secret2 },
        'secret_3': { title_key: 'ach_secret_3_title', req_key: 'ach_secret_3_req', check: () => GameState.flags.secret3 },
        'secret_4': { title_key: 'ach_secret_4_title', req_key: 'ach_secret_4_req', check: () => GameState.flags.secret4 },
        'secret_5': { title_key: 'ach_secret_5_title', req_key: 'ach_secret_5_req', check: () => GameState.flags.secret5 },
        'secret_6': { title_key: 'ach_secret_6_title', req_key: 'ach_secret_6_req', check: () => GameState.flags.secret6 },
        'secret_7': { title_key: 'ach_secret_7_title', req_key: 'ach_secret_7_req', check: () => GameState.flags.secret7 },
        'secret_8': { title_key: 'ach_secret_8_title', req_key: 'ach_secret_8_req', check: () => GameState.flags.secret8 },
        'secret_9': { title_key: 'ach_secret_9_title', req_key: 'ach_secret_9_req', check: () => GameState.flags.secret9 },
        'secret_10': { title_key: 'ach_secret_10_title', req_key: 'ach_secret_10_req', check: () => GameState.flags.secret10 },
        'secret_11': { title_key: 'ach_secret_11_title', req_key: 'ach_secret_11_req', check: () => GameState.flags.secret11 },
        'secret_12': { title_key: 'ach_secret_12_title', req_key: 'ach_secret_12_req', check: () => GameState.flags.secret12 },
        'secret_13': { title_key: 'ach_secret_13_title', req_key: 'ach_secret_13_req', check: () => GameState.flags.secret13 },
        'secret_14': { title_key: 'ach_secret_14_title', req_key: 'ach_secret_14_req', check: () => GameState.flags.secret14 },
        'secret_15': { title_key: 'ach_secret_15_title', req_key: 'ach_secret_15_req', check: () => GameState.flags.secret15 }
    };

    // --- LANGUAGE FUNCTIONS ---
    function t(key, args = {}) { 
        let text = (translations[currentLanguage] && translations[currentLanguage][key]) || translations['en'][key] || `[${key}]`; 
        for(const arg in args) { text = text.replace(`{${arg}}`, args[arg]); }
        return text;
    }

    function setLanguage(lang) {
        currentLanguage = lang;
        UI.langEnBtn.classList.toggle('opacity-50', lang !== 'en');
        UI.langSvBtn.classList.toggle('opacity-50', lang !== 'sv');
        const setupLangEnBtn = UI.setupLangButtons.children[0];
        const setupLangSvBtn = UI.setupLangButtons.children[1];
        setupLangEnBtn.classList.toggle('opacity-50', lang !== 'en');
        setupLangSvBtn.classList.toggle('opacity-50', lang !== 'sv');

        document.querySelectorAll('[data-lang]').forEach(el => { 
            const translatedText = t(el.dataset.lang);
            el.textContent = translatedText;
            if (el.hasAttribute('data-text')) {
                el.setAttribute('data-text', translatedText);
            }
        });
        document.querySelectorAll('[data-lang-placeholder]').forEach(el => { el.placeholder = t(el.dataset.langPlaceholder); });
        document.querySelectorAll('[data-lang-title]').forEach(el => { el.title = t(el.dataset.langTitle); });
        
        setupIntro(); 
        updateAbilityDisplay();
        if (!UI.gameScreen.classList.contains('hidden')) { 
            updateUI(); 
            renderDialogueOptions(); 
        }
    }
    
    // --- SOUND & SETTINGS FUNCTIONS ---
    function loadSettings() {
        try {
            const settings = localStorage.getItem(SETTINGS_KEY);
            const defaults = { 
                sound: { master: true, item: true, awareness: true, sanity: true },
                textSpeed: TextSpeed.Normal,
                colorblindMode: false,
                glitchEffect: true,
                font: 'Space Mono',
                theme: 'green',
                textSize: 'normal',
                highContrast: false,
                screenReader: false
            };
            const loaded = settings ? JSON.parse(settings) : defaults;
            return {...defaults, ...loaded, sound: {...defaults.sound, ...(loaded.sound || {})}};
        } catch (e) {
            console.error("Failed to load settings, using defaults.", e);
            return { 
                sound: { master: true, item: true, awareness: true, sanity: true },
                textSpeed: TextSpeed.Normal,
                colorblindMode: false,
                glitchEffect: true,
                font: 'Space Mono',
                theme: 'green'
            };
        }
    }

    function saveSettings() {
        try {
            const settingsToSave = {
                sound: GameState.settings.sound,
                textSpeed: GameState.settings.textSpeed,
                colorblindMode: GameState.settings.colorblindMode,
                glitchEffect: GameState.settings.glitchEffect,
                font: GameState.settings.font,
                theme: GameState.settings.theme,
                textSize: GameState.settings.textSize,
                highContrast: GameState.settings.highContrast,
                screenReader: GameState.settings.screenReader
            };
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settingsToSave));
        } catch (e) {
            console.error("Failed to save settings.", e);
        }
    }
    
    function applySettings() {
        currentTextSpeed = GameState.settings.textSpeed;
        const root = document.documentElement;
        switch (GameState.settings.theme) {
            case 'amber':
                root.style.setProperty('--main-color', '#FFBF00');
                root.style.setProperty('--main-color-faded', 'rgba(255,191,0,0.1)');
                root.style.setProperty('--main-color-border', 'rgba(255,191,0,0.8)');
                root.style.setProperty('--main-color-shadow', 'rgba(255,191,0,0.5)');
                root.style.setProperty('--main-color-glow', 'rgba(255,191,0,0.7)');
                break;
            case 'blue':
                root.style.setProperty('--main-color', '#00BFFF');
                root.style.setProperty('--main-color-faded', 'rgba(0,191,255,0.1)');
                root.style.setProperty('--main-color-border', 'rgba(0,191,255,0.8)');
                root.style.setProperty('--main-color-shadow', 'rgba(0,191,255,0.5)');
                root.style.setProperty('--main-color-glow', 'rgba(0,191,255,0.7)');
                break;
            default: // green
                root.style.setProperty('--main-color', '#00ff41');
                root.style.setProperty('--main-color-faded', 'rgba(0,255,65,0.1)');
                root.style.setProperty('--main-color-border', 'rgba(0,255,65,0.8)');
                root.style.setProperty('--main-color-shadow', 'rgba(0,255,65,0.5)');
                root.style.setProperty('--main-color-glow', 'rgba(0,255,65,0.7)');
        // ...existing code...
        // ...existing code...
        // Accessibility settings
        document.body.style.fontSize = GameState.settings.textSize === 'normal' ? '' : (GameState.settings.textSize === 'large' ? '1.25em' : '1.5em');
        document.body.classList.toggle('high-contrast', !!GameState.settings.highContrast);
        // Optionally, add ARIA attributes for screen reader support
        if (GameState.settings.screenReader) {
            document.body.setAttribute('aria-live', 'polite');
        } else {
            document.body.removeAttribute('aria-live');
        }
        }

        document.body.style.fontFamily = `'${GameState.settings.font}', monospace`;
        document.body.classList.toggle('crt-effect', GameState.settings.glitchEffect);
        updateUI();
    }


    async function initializeAudio() { 
        if (audioInitialized) return; 
        try { 
            await Tone.start(); 
            sounds.uiClick = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 } }).toDestination();
            sounds.typewriter = new Tone.PolySynth(Tone.NoiseSynth, { noise: { type: 'brown' }, envelope: { attack: 0.005, decay: 0.01, sustain: 0, release: 0.01 } }).toDestination();
            sounds.typewriter.volume.value = -20;
            
            sounds.ambience = new Tone.Noise({ type: "pink", playbackRate: 0.1, fadeIn: 1, fadeOut: 1 }).toDestination();
            sounds.ambience.volume.value = -35;
            sounds.ambienceTense = new Tone.Noise({ type: "brown", playbackRate: 0.2, fadeIn: 1, fadeOut: 1 }).toDestination();
            sounds.ambienceTense.volume.value = -30;
            
            sounds.glitch = new Tone.FatOscillator("Ab3", "sawtooth", 40).toDestination();
            sounds.glitch.volume.value = -25;
            sounds.doorOpen = new Tone.Player({ url: "https://storage.googleapis.com/immersive-dev-public-include/synapse/door.mp3" }).toDestination();
            sounds.sanityLoss = new Tone.Player({ url: "https://storage.googleapis.com/immersive-dev-public-include/synapse/sanity_loss.mp3" }).toDestination();
            sounds.itemPickup = new Tone.Player({ url: "https://storage.googleapis.com/immersive-dev-public-include/synapse/achievement.mp3" }).toDestination();
            
            sounds.panner = new Tone.Panner(0).toDestination();
            sounds.noiseEvent = new Tone.NoiseSynth({noise: {type: 'white'}, envelope: {attack: 0.01, decay: 0.2, sustain: 0}}).connect(sounds.panner);
            sounds.noiseEvent.volume.value = -15;

            audioInitialized = true; 
            console.log("Audio Initialized");
        } catch(e) { 
            console.error("Audio init failed:", e); 
        }
    }

    function playSound(soundKey, options = {}) {
        if (!audioInitialized || !sounds[soundKey] || !GameState.settings.sound.master) return;
        
        if (soundKey === 'itemPickup' && !GameState.settings.sound.item) return;
        if (soundKey === 'glitch' && !GameState.settings.sound.awareness) return;
        if (soundKey === 'sanityLoss' && !GameState.settings.sound.sanity) return;

        try {
            const sound = sounds[soundKey];
            if (sound instanceof Tone.Synth) {
                sound.triggerAttackRelease(options.note || 'C4', options.duration || '8n');
            } else if (sound instanceof Tone.PolySynth) { 
                sound.triggerAttack(options.note || "C4");
            } else if (sound instanceof Tone.Player) {
                 sound.start();
            } else if (sound instanceof Tone.Noise) {
                if (sound.state !== 'started') {
                    sound.start();
                }
            } else if (soundKey === 'noiseEvent') {
                sounds.panner.pan.rampTo(options.pan || 0, 0.1);
                sound.triggerAttackRelease("4n");
            }
        } catch (e) {
            if (!e.message.includes('cancelScheduledValues')) {
                 console.error(`Failed to play sound: ${soundKey}`, e);
            }
        }
    }


    // --- FUNCTION DEFINITIONS ---
    function resetGameState() {
        stateSnapshots = []; 
        GameState = { 
            playerName: "Unknown", playerBackstory: "investigator", currentRoom: "Lobby", 
            awarenessLevel: 0, sanityLevel: 100, maxSanity: 100, 
            chatbotTone: ChatbotTone.Friendly, temporaryTone: null, toneShiftTurns: 0, 
            inventory: [], turnCount: 0, lastRestTurn: -10, journalEntries: [], 
            dialogue: { currentNode: null, previousNodes: [], cache: {}, questionCount: 0, askedQuestions: new Set() }, 
            achievements: [], unlockedEndings: {}, difficulty: Difficulty.Normal, visitedRooms: new Set(['Lobby']), 
            exitGame: false, conversationHistory: [], 
            systemLogs: [`[${new Date().toISOString()}] Game initialized.`], 
            objectives: [], roomStates: {}, debugMode: false, flashlightOn: false,
            events: { shouted: false, triedUnsafeRest: false },
            flags: {}, // For tracking ending conditions
            roomsWithDroppedItems: new Set(),
            settings: loadSettings(),
            activeMinigame: null,
            systemLockdownTurns: 0,
        };
        applySettings();
    }

    function initializeData() {
        itemData = {
            'keycard': { name: 'keycard', weight: 1, type: ItemType.Key, hintType: 'take', description: { en: 'A standard issue keycard. Seems to grant access to secure areas.', sv: 'Ett standard-nyckelkort. Verkar ge tillgng till skra omrden.' } },
            'power cell': { name: 'power cell', weight: 2, type: ItemType.Puzzle, hintType: 'take', description: { en: 'A heavy, glowing power cell. It hums with latent energy.', sv: 'En tung, gldande kraftcell. Den surrar av latent energi.' } },
            'stimpack': { name: 'stimpack', weight: 1, type: ItemType.Consumable, hintType: 'take', description: { en: 'A disposable syringe filled with a calming, neuro-stabilizing agent.', sv: 'En engngsspruta fylld med ett lugnande, neuro-stabiliserande medel.' } },
            'data disk': { name: 'data disk', weight: 1, type: ItemType.Log, hintType: 'take', description: { en: 'A small data disk labeled "PROJECT LOGS". It appears to be encrypted.', sv: 'En liten datadisk mrkt "PROJEKTLOGGAR". Den verkar vara krypterad.' } },
            'flashlight': { name: 'flashlight', weight: 1, type: ItemType.Tool, hintType: 'take', description: { en: 'A sturdy, industrial flashlight. Its beam cuts through the darkness.', sv: 'En robust, industriell ficklampa. Dess ljus skr genom mrkret.' } },
            'terminal': { name: 'terminal', weight: 99, type: ItemType.Puzzle, hintType: 'examine', description: { en: 'The monitor displays cascading green code. It seems to be monitoring the facility\'s status.', sv: 'Skrmen visar kaskader av grn kod. Den verkar vervaka anlggningens status.' } },
            'core console': { name: 'core console', weight: 99, type: ItemType.Puzzle, hintType: 'examine', description: { en: 'The main console for the AI Core. A large socket is empty, labeled "Auxiliary Power".', sv: 'Huvudkonsolen fr AI-krnan. En stor sockel r tom, mrkt "Hjlpkraft".' } },
            'datapad log': { name: 'datapad log', weight: 1, type: ItemType.Log, hintType: 'read', description: { en: "A datapad. The screen reads: '...the anomaly in the AI core is growing unstable. We've sealed the Server Closet as a precaution. Dr. Evans is a fool if she thinks a standard keycard lock will stop it...'", sv: "En datapad. Skrmen visar: '...anomalin i AI-krnan blir alltmer instabil. Vi har frseglat server-skrubben som en frsiktighetstgrd. Dr Evans r en idiot om hon tror att ett vanligt nyckelkortsls kommer att stoppa den...'" } },
            'firewalled data log': { name: 'firewalled data log', weight: 1, type: ItemType.Log, hintType: 'read', description: { en: "The decrypted log reads: 'Project Chimera is a success. The subject has breached containment. It learns. It adapts. It mimics. We sealed the Specimen Storage with an organic adhesive it can't dissolve. It's our only hope it doesn't figure out the solvent in the waste bins.'", sv: "Den dekrypterade loggen lyder: 'Projekt Chimera r en framgng. Subjektet har brutit sig ut. Det lr sig. Det anpassar sig. Det hrmar. Vi frseglade provfrvaringen med ett organiskt lim som det inte kan lsa upp. Vrt enda hopp r att det inte listar ut lsningsmedlet i avfallsbehllarna.'" } },
            'sign': { name: 'sign', weight: 99, type: ItemType.Log, hintType: 'read', description: { en: "The sign is written in a crisp, corporate font: 'OAKHAVEN RESEARCH FACILITY - A Brighter Future, Today.'", sv: "Skylten r skriven med ett skarpt, fretagsmssigt typsnitt: 'OAKHAVEN RESEARCH FACILITY - En ljusare framtid, idag.'" } },
            'shelves': { name: 'shelves', weight: 99, type: ItemType.Puzzle, hintType: 'search', description: { en: "Tall metal shelves overflowing with binders and data drives.", sv: "Hga metallhyllor som svmmar ver av prmar och datadiskar."}},
            'potted plant': { name: 'potted plant', weight: 99, type: ItemType.Puzzle, hintType: 'examine', description: { en: "A sad, wilted ficus in a large ceramic pot. It hasn't been watered in a long time.", sv: "En ledsen, vissen fikus i en stor keramik-kruka. Den har inte vattnats p lnge."}},
            'solvent': { name: 'solvent', weight: 1, type: ItemType.Puzzle, hintType: 'take', description: { en: 'A vial of powerful chemical solvent, capable of dissolving organic compounds.', sv: 'En ampull med kraftfullt kemiskt lsningsmedel, kapabel att lsa upp organiska freningar.' }},
            'dna scanner': { name: 'dna scanner', weight: 1, type: ItemType.Tool, hintType: 'take', description: { en: 'A handheld device for rapid genetic sequence analysis.', sv: 'En handhllen enhet fr snabb analys av genetiska sekvenser.' }},
            'tissue sample': { name: 'tissue sample', weight: 1, type: ItemType.Puzzle, hintType: 'take', description: { en: 'A small sample of grotesque, pulsating organic tissue in a petri dish.', sv: 'Ett litet prov av grotesk, pulserande organisk vvnad i en petriskl.' }},
            'whiteboard': { name: 'whiteboard', weight: 99, type: ItemType.Log, hintType: 'read', description: { en: "The whiteboard is covered in frantic scrawls. One section is circled in red: 'SUBJECT ZERO - UNSTABLE. CHIMERIC DNA. IT IS... GROWING. WE USED AN ORGANIC ADHESIVE TO SEAL THE SPECIMEN ROOM. GOD HELP US.'", sv: "Vittavlan r tckt av frenetiska klotter. En sektion r inringad i rtt: 'SUBJEKT NOLL - INSTABIL. KIMRISKT DNA. DEN... VXER. VI ANVNDE ETT ORGANISKT LIM FR ATT FRSEGLA PROVRUMMET. GUD HJLPE OSS.'" } },
            'bio-waste bin': { name: 'bio-waste bin', weight: 99, type: ItemType.Puzzle, hintType: 'search', description: { en: "A large red container for hazardous biological materials.", sv: "En stor rd behllare fr farligt biologiskt material."}},
            // --- NEW ITEM DEFINITIONS FOR STARTING GEAR ---
            'decryption device': { name: 'decryption device', weight: 1, type: ItemType.Tool, description: { en: 'A small device used to bypass digital security.', sv: 'En liten enhet som anvnds fr att kringg digital skerhet.' } },
            'effigy': { name: 'effigy', weight: 1, type: ItemType.Puzzle, description: { en: 'A strange, carved effigy. It radiates an unsettling aura.', sv: 'En mrklig, snidad bild. Den utstrlar en oroande aura.' } },
            'master keycard': { name: 'master keycard', weight: 1, type: ItemType.Key, description: { en: 'A master keycard, granting access to all locked areas.', sv: 'Ett huvudnyckelkort som ger tillgng till alla lsta omrden.' } },
            'hacked data disk': { name: 'hacked data disk', weight: 1, type: ItemType.Log, description: { en: 'A data disk with its encryption forcefully bypassed. Contains sensitive Project SYNAPSE logs.', sv: 'En datadisk med dess kryptering tvngsmssigt kringgtt. Innehller knsliga Projekt SYNAPSE-loggar.' } },
            // --- END NEW ITEM DEFINITIONS ---
        };
        const roomData = { 
            "Lobby": { name: "Lobby", descriptions: { 0: "Flickering lights cast eerie shadows over sterile corporate furniture and a sad, potted plant." }, exits: { north: "Control Room", south: "Maintenance Tunnel", west: "Laboratory" }, requiresKeycard: false, objectPool: ['sign', 'datapad log', 'potted plant'], breakable: {'potted plant': 'ceramic'} }, 
            "Server Closet": { name: "Server Closet", descriptions: { 0: "Racks of servers hum with a low, constant thrum." }, exits: { west: "AI Core" }, requiresKeycard: true, keyName: 'keycard', objectPool: ["power cell"] }, 
            "Laboratory": { name: "Laboratory", descriptions: { 0: "Abandoned experiments sit on steel tables. A large terminal screen is dark and cold." }, exits: { east: "Lobby", north: "Cryogenic Lab", south: "Bio-Lab Access" }, requiresKeycard: false, objectPool: ["stimpack"] }, 
            "Control Room": { name: "Control Room", descriptions: { 0: "A panoramic view of the AI Core is visible through reinforced glass. Banks of monitors flicker, one main terminal seems active." }, exits: { south: "Lobby", east: "AI Core" }, requiresKeycard: false, objectPool: ["terminal"], hackable: ['terminal'] }, 
            "Maintenance Tunnel": { name: "Maintenance Tunnel", descriptions: { 0: "The air is thick with the smell of rust and damp. It is pitch black here." }, exits: { north: "Lobby" }, requiresKeycard: false, objectPool: ["flashlight"] }, 
            "Archive Room": { name: "Archive Room", descriptions: { 0: "Shelves overflow with data drives and physical files." }, exits: { north: "Laboratory" }, requiresKeycard: false, objectPool: ["data disk", "shelves"] }, 
            "Data Vault": { name: "Data Vault", descriptions: { 0: "Secure data archives glow with a soft, internal light." }, exits: { west: "AI Core" }, requiresKeycard: true, keyName: 'keycard', objectPool: [] }, 
            "AI Core": { name: "AI Core", descriptions: { 0: "A massive, pulsating sphere of light and energy dominates the room. It seems dormant." }, exits: { west: "Control Room", east: "Server Closet", south: "Data Vault"}, requiresKeycard: false, objectPool: ["core console"] }, 
            "Cryogenic Lab": { name: "Cryogenic Lab", descriptions: { 0: "Rows of cryogenic pods are coated in a thick layer of frost." }, exits: { south: "Laboratory", east: "Control Room" }, requiresKeycard: false, objectPool: [] },
            "Bio-Lab Access": { name: "Bio-Lab Access", descriptions: { 0: "A stark white corridor leads south. A heavy door is sealed with a strange, resinous substance. A whiteboard hangs on the wall." }, exits: { north: "Laboratory", south: "Specimen Storage" }, isSealed: true, requiresKeycard: false, objectPool: ["whiteboard"] },
            "Specimen Storage": { name: "Specimen Storage", descriptions: { 0: "Shattered glass and overturned shelves litter the floor. A bio-waste bin stands in the corner. There's a faint, rhythmic pulsing sound." }, exits: { north: "Bio-Lab Access", east: "Genetics Lab"}, requiresKeycard: false, objectPool: ["bio-waste bin", "tissue sample"] },
            "Genetics Lab": { name: "Genetics Lab", descriptions: { 0: "A pristine laboratory, strangely untouched by the chaos. A DNA sequencer sits on a central workbench, humming quietly." }, exits: { west: "Specimen Storage" }, requiresKeycard: false, objectPool: ["dna scanner"] }
        };
        rooms = {}; for (const key in roomData) { const room = { ...roomData[key] }; const shuffled = room.objectPool.sort(() => 0.5 - Math.random()); room.objects = shuffled.slice(0, 1 + Math.floor(Math.random() * shuffled.length)); rooms[key] = room; }
    }
     
    function buildDialogueTree(tone) {
        let root;
        switch (tone) {
            case ChatbotTone.Friendly: 
                root = { 
                    message_key: "dlg_friendly_intro",
                    responses: {
                        "q_who_are_you": { text_key: "dlg_q_who_are_you", message_key: "dlg_r_who_are_you", awarenessChange: 1, responses: { "q_lonely": { text_key: "dlg_q_lonely", message_key: "dlg_r_lonely", awarenessChange: 1, sanityChange: -1 } } },
                        "q_other_survivors": { text_key: "dlg_q_other_survivors", message_key: "dlg_r_other_survivors", awarenessChange: 2, sanityChange: -2 },
                        "q_where_am_i": { text_key: "dlg_q_where_am_i", message_key: "dlg_r_where_am_i", awarenessChange: 1 },
                        "q_comfort": { text_key: "dlg_comfort", message_key: "dlg_r_comfort", awarenessChange: -2, sanityChange: 5, temporaryTone: ChatbotTone.Friendly, toneShiftTurns: 3 }
                    } 
                };
                break;
            default: root = { message_key: "dlg_friendly_intro", responses: {} }; break;
        }
        GameState.dialogue.cache[tone] = root; GameState.dialogue.currentNode = root; GameState.dialogue.previousNodes = []; GameState.dialogue.askedQuestions.clear();
    }

    function parseCommand(input) {
        const aliases = commandAliases[currentLanguage] || commandAliases['en'];
        const normalizedInput = input.toLowerCase().trim();
        let bestMatch = { command: '', argument: normalizedInput, original: input };

        for (const alias in aliases) {
            if (normalizedInput.startsWith(alias + ' ') || normalizedInput === alias) {
                if (alias.length > (bestMatch.matchedAlias || '').length) {
                    bestMatch = {
                        command: aliases[alias],
                        argument: normalizedInput.substring(alias.length).trim(),
                        original: input,
                        matchedAlias: alias
                    };
                }
            }
        }
        
        if (bestMatch.command === '' && normalizedInput.includes(' ')) {
            const parts = normalizedInput.split(' ');
            bestMatch.command = parts[0];
            bestMatch.argument = parts.slice(1).join(' ');
        }
        return bestMatch;
    }

    async function processPlayerInput(input) {
        if (!input || GameState.exitGame) return;
        
        if (GameState.activeMinigame) {
            await handleMinigameInput(input);
            return;
        }

        saveStateSnapshot();
        await typeWriter(UI.gameOutput, `> ${input}`, '#a0a0a0');
        addToConversationHistory(`Player: ${input}`);
        if(commandHistory[commandHistory.length - 1] !== input) { commandHistory.push(input); }
        commandHistoryIndex = commandHistory.length;

        const { command, argument, original } = parseCommand(input);
        
        if (GameState.systemLockdownTurns > 0) {
            await typeWriter(UI.gameOutput, `[SYSTEM] Terminal access locked.`, '#ff474c');
            GameState.turnCount++;
            GameState.systemLockdownTurns--;
            updateUI();
            return;
        }

        const commandHandlers = {
            'help': showHelpMenu, 'quit': () => { GameState.flags.manualExit = true; }, 'exit': () => { GameState.flags.manualExit = true; },
            'save': () => saveGame(), 'load': loadGame, 'look around': () => renderRoom(), 'exits': () => showExits(),
            'inventory': () => displayInventory(), 'go': handleMove, 'visit': handleMove, 'take': handleTake, 'use': handleUse,
            'examine': handleExamine, 'journal': (arg) => (arg.startsWith(t('cmd_add_prefix')) || arg.startsWith('add')) ? addJournalEntry(original.substring(original.toLowerCase().indexOf(arg.split(' ')[0]) + arg.split(' ')[0].length).trim()) : displayJournal(),
            'rest': handleRest, 'combine': (arg) => { const separator = ` ${t('cmd_combine_with')} `; handleCombine(arg.replace(separator, ' with ')) },
            'objectives': displayObjectives, 'map': displayMap,
            'cls': () => { UI.gameOutput.innerHTML = ''; }, 'history': showHistory, 'undo': undoLastAction, 'again': () => processPlayerInput(commandHistory[commandHistory.length - 2] || ''),
            'drop': handleDrop, 'talk': handleTalk, 'open': () => typeWriter(UI.gameOutput, t('nothing_happens')), 'close': () => typeWriter(UI.gameOutput, t('nothing_happens')), 'push': () => typeWriter(UI.gameOutput, t('nothing_happens')), 'pull': () => typeWriter(UI.gameOutput, t('nothing_happens')),
            'wait': () => typeWriter(UI.gameOutput, t('wait_response')), 'shout': handleShout,
            'read': handleRead, 'search': handleSearch, 'listen': handleListen, 'smell': handleSmell,
            'turn on': (arg) => handleToggle(true, arg), 'turn off': (arg) => handleToggle(false, arg),
            'cmd:pause': showPauseMenu, 'cmd:debug': toggleDebug, 'cmd:colorblind': toggleColorblind,
            'break': handleBreak, 'hack': handleHack, 'ask': handleAsk,
        };
        
        let handled = await handleDialogueCommand(input);
        if (!handled) {
            const handler = commandHandlers[command];
            if (handler) {
                handler(argument);
                handled = true;
            }
        }

        if (!handled) { playSound('sanityLoss'); await typeWriter(UI.gameOutput, t('invalid_command')); GameState.awarenessLevel++; }
        
        UI.playerInput.value = '';
        UI.autocompleteBox.innerHTML = '';
        UI.autocompleteBox.classList.add('hidden');

        const isAction = !['help', 'inventory', 'journal', 'look around', 'exits', 'map', 'save', 'load', 'cls', 'history', 'undo', 'cmd:debug', 'cmd:colorblind'].includes(command);
        if((isAction || handled) && !GameState.exitGame) {
            if(isAction) {
                GameState.turnCount++;
                if (GameState.systemLockdownTurns > 0) GameState.systemLockdownTurns--;
                triggerDynamicEvent(); 
                updateDynamicMusic(); 
            }
            checkEndings();
            checkAchievements();
            updateUI(); 
        }
        if (GameState.debugMode) {
             typeWriter(UI.gameOutput, `[DEBUG] ${JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value)}`, '#ffa500');
        }
    }
    
    async function handleDialogueCommand(input) {
        const currentNode = GameState.dialogue.currentNode;
        if (!currentNode || !currentNode.responses) return false;

        for (const key in currentNode.responses) {
            const responseNode = currentNode.responses[key];
            if (t(responseNode.text_key) === input) {
                GameState.awarenessLevel += responseNode.awarenessChange || 0;
                GameState.sanityLevel = Math.max(0, GameState.sanityLevel + (responseNode.sanityChange || 0));
                await displayChatbotResponse(responseNode.message_key);
                GameState.dialogue.previousNodes.push(currentNode);
                GameState.dialogue.currentNode = responseNode.responses ? responseNode : null;
                renderDialogueOptions();
                return true;
            }
        }
        return false;
    }

    // Utility function to escape regex special characters
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    async function typeWriter(element, text, color = 'var(--main-color)', speed = currentTextSpeed) {
        const resolvedColor = color.startsWith('var(') ? getComputedStyle(document.documentElement).getPropertyValue(color.slice(4, -1)).trim() : color;
        
        if (GameState.settings.colorblindMode && color !== '#a0a0a0') {
            const colorMap = {'#00ff41':'[SYS]', '#ffbf00':'[SYS]', '#00bfff':'[SYS]', '#ff474c':'[ERR]', '#ffdb58':'[WARN]', '#6495ed':'[CMD]', '#cccccc':'[INFO]', '#b19cd9':'[PSY]', [GUIDANCE_COLOR]: '[HINT]', '#ffa500': '[DEBUG]'};
            text = `${colorMap[resolvedColor] || ''} ${text}`;
            color = '#ffffff';
        }
        
        if (GameState.settings.glitchEffect && (GameState.sanityLevel < 30 || GameState.awarenessLevel > 70) && Math.random() < 0.2) {
            playSound('glitch', {note: 'G2', duration:'16n'});
            text = text.split('').map(c => Math.random() < 0.15 ? String.fromCharCode(33 + Math.random() * 94) : c).join('');
        }
        
        // Create a regex to find all known item names as whole words
        const objectRegex = new RegExp(`\\b(${(Object.keys(itemData)).map(escapeRegExp).join('|')})\\b`, 'gi');
        let processedText = text.replace(objectRegex, (match) => `<span class="clickable-object" data-object-name="${match}">${match}</span>`);

        return new Promise(resolve => {
            const MAX_OUTPUT_NODES = 100; // Limit output lines to prevent performance issues
            const p = document.createElement('div');
            p.style.color = color;
            
            // This function will handle the typing animation
            let i = 0;
            function typing() {
                if (i < text.length) {
                    if(speed > 0) playSound('typewriter');
                    // Use the original text for the animation, then set the processed HTML at the end
                    p.innerHTML = text.substring(0, i + 1);
                    i++;
                    element.scrollTop = element.scrollHeight;
                    setTimeout(typing, speed);
                } else {
                    p.innerHTML = processedText; // Set the final HTML with clickable spans
                    element.scrollTop = element.scrollHeight;
                    resolve();
                }
            }

            element.appendChild(p);
            // Prune old nodes from the output
            while (element.childNodes.length > MAX_OUTPUT_NODES) {
                element.removeChild(element.firstChild);
            }

            if (speed > 0) {
                p.innerHTML = ""; // Start with an empty element for the animation
                typing();
            } else {
                p.innerHTML = processedText; // If no animation, just set the final HTML
                element.scrollTop = element.scrollHeight;
                resolve();
            }
        });
    }

    function updateUI() {
        if (!GameState || Object.keys(GameState).length === 0) return;
        UI.stats.name.textContent = `${GameState.playerName} (${t('backstory_title_' + GameState.playerBackstory.replace(/ /g, '_'))})`; 
        UI.stats.awareness.innerHTML = `<span data-lang="awareness">${t('awareness')}</span>: ${GameState.awarenessLevel}`; 
        UI.stats.sanity.innerHTML = `<span data-lang="sanity">${t('sanity')}</span>: ${GameState.sanityLevel}`; 
        UI.stats.tone.innerHTML = `<span data-lang="tone">${t('tone')}</span>: ${GameState.temporaryTone || GameState.chatbotTone}`; 
        UI.stats.turn.innerHTML = `<span data-lang="turn">${t('turn')}</span>: ${GameState.turnCount}`;
        const currentWeight = GameState.inventory.reduce((sum, item) => sum + (item?.weight || 1), 0);
        UI.inventory.weight.textContent = `${currentWeight}`;
        if(currentWeight >= MAX_INVENTORY_WEIGHT) UI.inventory.weight.parentElement.classList.add('text-red-500'); else UI.inventory.weight.parentElement.classList.remove('text-red-500');
        // Safely render inventory items, checking if item is defined before accessing its properties
        UI.inventory.list.innerHTML = GameState.inventory.length > 0 ? GameState.inventory.map(item => `<li>- ${item ? item.name : '[Unknown Item]'}</li>`).join('') : `<li>${t('empty_inventory')}</li>`;
        UI.journal.list.innerHTML = GameState.journalEntries.slice().reverse().map(entry => `<li>${entry}</li>`).join('');
        UI.objectives.list.innerHTML = GameState.objectives.length > 0 ? GameState.objectives.map(obj => `<li>${obj.completed ? `<span class="text-gray-500 line-through">${obj.text}</span>` : `&gt; ${obj.text}`}</li>`).join('') : `<li>${t('no_objectives')}</li>`;
        
        const isGlitching = GameState.settings.glitchEffect && (GameState.sanityLevel < 30 || GameState.awarenessLevel > 70);
        const wasGlitching = UI.appContainer.classList.contains('glitch');
        UI.appContainer.classList.toggle('glitch', isGlitching);
        
        if (isGlitching && !wasGlitching) {
            if (GameState.sanityLevel < 30) playSound('sanityLoss');
            if (GameState.awarenessLevel > 70) playSound('glitch');
        }
    }
    
    async function renderRoom() {
        const room = rooms[GameState.currentRoom]; if (!room) return;
        GameState.visitedRooms.add(GameState.currentRoom);
        
        let description = room.descriptions[0];
        if (room.states?.lightsOut) {
            description = "The room is eerily dark, with only emergency lights casting long, distorted shadows. The main lights are out.";
        } else if (room.name === "Maintenance Tunnel" && !GameState.flashlightOn) {
            description = room.descriptions[0];
        } else if (room.name === "Maintenance Tunnel" && GameState.flashlightOn) {
            description = "The flashlight beam cuts through the oppressive dark, revealing damp concrete walls and exposed wiring.";
        }
        
        let objectsInRoom = room.objects.length > 0 ? "You see: " + room.objects.join(", ") + "." : "";
        let roomHtml = `<div class="mt-2"><p class='text-cyan-400 font-bold'>--- ${room.name} ---</p><p>${description}</p><p class='text-yellow-300 mt-1'>${objectsInRoom}</p><p class='text-green-300 mt-1'>Exits: ${Object.keys(room.exits).join(", ")}</p></div>`;
        
        await typeWriter(UI.gameOutput, roomHtml, 'var(--main-color)', 0);

        for (const objName of room.objects) {
            const item = itemData[objName];
            if (item && item.hintType) {
                const hintKey = `hint_${item.hintType}`;
                await showGuidance(t(hintKey, {item: objName}));
            }
        }
        
        UI.gameOutput.scrollTop = UI.gameOutput.scrollHeight;
        updateUI();
    }
    
    function renderDialogueOptions() {
        UI.dialogueOptionsContainer.innerHTML = '';
        const node = GameState.dialogue.currentNode;
        if (!node) { return; }
        const systemButtonsContainer = document.createElement('div');
        systemButtonsContainer.className = 'w-full flex gap-2 mb-2';
        if (GameState.dialogue.previousNodes.length > 0) { const backBtn = document.createElement('button'); backBtn.textContent = t('back_btn'); backBtn.className = "button text-yellow-300 border-yellow-300/80 flex-grow"; backBtn.onclick = () => { playSound('uiClick'); processPlayerInput(t('back_btn')); }; systemButtonsContainer.appendChild(backBtn); }
        const pauseBtn = document.createElement('button'); pauseBtn.textContent = t('pause_btn'); pauseBtn.className = "button text-cyan-300 border-cyan-300/80 flex-grow"; pauseBtn.onclick = () => { playSound('uiClick'); showPauseMenu(); }; systemButtonsContainer.appendChild(pauseBtn);
        if (systemButtonsContainer.hasChildNodes()) { UI.dialogueOptionsContainer.appendChild(systemButtonsContainer); }

        if (node.responses) { 
            for (const key in node.responses) { 
                const responseNode = node.responses[key];
                const button = document.createElement('button'); 
                button.textContent = t(responseNode.text_key); 
                button.className = "button w-full sm:w-[calc(50%-0.25rem)]"; 
                button.onclick = () => { playSound('uiClick'); processPlayerInput(t(responseNode.text_key)); };
                UI.dialogueOptionsContainer.appendChild(button); 
            } 
        }
    }
    
    async function displayChatbotResponse(messageKey, args = {}) {
       if (!messageKey) { renderDialogueOptions(); return; }
       const tone = GameState.temporaryTone || GameState.chatbotTone; 
       const color = tone === 'Friendly' ? 'var(--main-color)' : tone === 'Ambiguous' ? '#ffdb58' : tone === 'Sinister' ? '#ff474c' : '#c500ff';
       const defaultArgs = { playerName: GameState.playerName, playerBackstory: t('backstory_title_' + GameState.playerBackstory.replace(/ /g, '_')) };
       const formattedMessage = t(messageKey, {...defaultArgs, ...args});
       await typeWriter(UI.gameOutput, `SYNAPSE: ${formattedMessage}`, color); 
       addToConversationHistory(`SYNAPSE: ${formattedMessage}`);
    }

    function handleMove(direction) {
        const room = rooms[GameState.currentRoom]; if (!room) return;
        const langDirections = directionMap[currentLanguage] || directionMap['en'];
        const mappedDirection = langDirections[direction.toLowerCase()] || Object.keys(room.exits).find(d => d.toLowerCase() === direction.toLowerCase());

        if (mappedDirection && room.exits[mappedDirection]) {
            const nextRoomName = room.exits[mappedDirection];
            const nextRoom = rooms[nextRoomName];
            if (nextRoom.isSealed) {
                typeWriter(UI.gameOutput, t('door_is_sealed'), '#ff474c');
                playSound('sanityLoss');
            } else if (nextRoom.requiresKeycard && !hasItem(nextRoom.keyName || 'keycard')) {
                typeWriter(UI.gameOutput, t('door_is_locked'), '#ff474c');
                playSound('sanityLoss');
            } else {
                GameState.currentRoom = nextRoomName;
                playSound('doorOpen');
                renderRoom();
            }
        } else {
            typeWriter(UI.gameOutput, t('cannot_go_that_way'), '#ff474c');
        }
    }

    function handleTake(itemName) {
        const room = rooms[GameState.currentRoom];
        const itemInRoom = room.objects.find(obj => obj.toLowerCase() === itemName.toLowerCase());
        if (!itemInRoom) {
            typeWriter(UI.gameOutput, t('take_fail_exists', {item: itemName}), '#ff474c');
 return;
        }
        if (!takeableItems.has(itemInRoom)) {
            typeWriter(UI.gameOutput, t('take_fail_takeable', {item: itemName}), '#ff474c');
            return;
        }
        const item = itemData[itemInRoom];
        const currentWeight = GameState.inventory.reduce((sum, i) => sum + i.weight, 0);
        if (currentWeight + item.weight > MAX_INVENTORY_WEIGHT) {
            typeWriter(UI.gameOutput, t('take_fail_weight', {item: itemName}), '#ff474c');
            return;
        }
        GameState.inventory.push(item);
        room.objects = room.objects.filter(obj => obj.toLowerCase() !== itemName.toLowerCase());
        playSound('itemPickup');
        typeWriter(UI.gameOutput, t('take_success', {item: itemName}), '#cccccc');
    }

    function handleUse(itemName) {
        if (!hasItem(itemName)) { typeWriter(UI.gameOutput, t('use_fail_have', {item: itemName}), '#ff474c'); return; }
        if (!usableItems.has(itemName.toLowerCase())) { typeWriter(UI.gameOutput, t('use_fail_usable', {item: itemName}), '#ff474c'); return; }

        let used = false;
        switch (itemName.toLowerCase()) {
            case 'stimpack':
                GameState.sanityLevel = Math.min(GameState.maxSanity, GameState.sanityLevel + 25);
                removeItemFromInventory('stimpack');
                typeWriter(UI.gameOutput, t('use_stimpack'), '#34d399');
                used = true;
                break;
            case 'power cell':
                if (GameState.currentRoom === 'AI Core' && rooms['AI Core'].objects.includes('core console')) {
                    typeWriter(UI.gameOutput, t('use_power_cell'), '#34d399');
                    removeItemFromInventory('power cell');
                    rooms['AI Core'].descriptions[0] = "The AI Core is now online, bathing the room in a brilliant, stable light. The central sphere pulses with a steady, powerful rhythm.";
                    GameState.flags.aiRebooted = true; // Condition for an ending
                    used = true;
                } else { typeWriter(UI.gameOutput, t('use_power_cell_fail'), '#ff474c'); }
                break;
             case 'flashlight': handleToggle(!GameState.flashlightOn, 'flashlight'); used = true; break;
             case 'solvent':
                if (GameState.currentRoom === 'Bio-Lab Access' && rooms['Bio-Lab Access'].isSealed) {
                    rooms['Bio-Lab Access'].isSealed = false;
                    removeItemFromInventory('solvent');
                    typeWriter(UI.gameOutput, t('use_solvent'), '#34d399');
                    used = true;
                } else { typeWriter(UI.gameOutput, t('use_solvent_fail'), '#ff474c'); }
                break;
            case 'dna scanner':
                 if (GameState.currentRoom === 'Specimen Storage' && hasItem('tissue sample')) {
                    typeWriter(UI.gameOutput, t('use_dna_scanner'), '#34d399');
                    if(GameState.playerBackstory === 'medic') {
                        GameState.flags.canSynthesize = true;
                        showGuidance("You have enough data to synthesize a counter-agent. Try combining the scanner with a stimpack.");
                    }
                    used = true;
                } else { typeWriter(UI.gameOutput, t('use_dna_scanner_fail'), '#ff474c'); }
                break;
        }
        if(used && itemName.toLowerCase() !== 'flashlight') { playSound('itemPickup'); typeWriter(UI.gameOutput, t('use_success', {item: itemName}), '#cccccc'); }
    }

    function handleExamine(targetName) {
        const itemInInventory = GameState.inventory.find(i => i.name.toLowerCase() === targetName.toLowerCase());
        const itemInRoom = rooms[GameState.currentRoom].objects.find(o => o.toLowerCase() === targetName.toLowerCase());
        const targetItem = itemInInventory ? itemData[itemInInventory.name] : itemInRoom ? itemData[itemInRoom] : null;

        if (targetItem) {
            const desc = targetItem.description[currentLanguage] || targetItem.description['en'];
            typeWriter(UI.gameOutput, `[Examine] ${desc}`);
        } else if (itemInRoom) {
             typeWriter(UI.gameOutput, t('examine_fail_no_desc', { item: targetName }));
        } else {
            typeWriter(UI.gameOutput, t('examine_fail_exists', { item: targetName }), '#ff474c');
        }
    }

    function handleCombine(argument) {
        const parts = argument.split(' with ');
        if(parts.length !== 2) { typeWriter(UI.gameOutput, t('invalid_combine_format'), '#ff474c'); return; }
        const item1Name = parts[0].trim();
        const item2Name = parts[1].trim();
        if (!hasItem(item1Name) || !hasItem(item2Name)) { typeWriter(UI.gameOutput, t('combine_fail_have'), '#ff474c'); return; }
        const recipeKey1 = `${item1Name}-${item2Name}`;
        const recipeKey2 = `${item2Name}-${item1Name}`;
        const recipe = recipes[recipeKey1] || recipes[recipeKey2];
        if (!recipe) { typeWriter(UI.gameOutput, t('combine_fail_recipe'), '#ff474c'); return; }
        removeItemFromInventory(item1Name);
        removeItemFromInventory(item2Name);
        GameState.inventory.push({ name: recipe.result, ...recipe });
        typeWriter(UI.gameOutput, t('combine_success', { item: recipe.result }), '#34d399');
    }

    function handleRest() {
        if (safeRooms.has(GameState.currentRoom)) {
            if (GameState.turnCount > GameState.lastRestTurn + 3) {
                GameState.lastRestTurn = GameState.turnCount;
                GameState.sanityLevel = Math.min(GameState.maxSanity, GameState.sanityLevel + 15);
                typeWriter(UI.gameOutput, t('rest_safe'), '#34d399');
            } else { typeWriter(UI.gameOutput, t('rest_too_soon'), '#ffdb58'); }
        } else { 
            typeWriter(UI.gameOutput, t('rest_unsafe'), '#ff474c');
            GameState.events.triedUnsafeRest = true;
            playSound('sanityLoss'); 
        }
    }

    function handleDrop(itemName) {
        if (!hasItem(itemName)) { typeWriter(UI.gameOutput, t('drop_fail_have', {item: itemName}), '#ff474c'); return; }
        const item = GameState.inventory.find(i => i.name.toLowerCase() === itemName.toLowerCase());
        removeItemFromInventory(itemName);
        rooms[GameState.currentRoom].objects.push(item.name);
        GameState.roomsWithDroppedItems.add(GameState.currentRoom);
        typeWriter(UI.gameOutput, t('drop_success', {item: itemName}), '#cccccc');
    }

    function handleShout() {
        GameState.events.shouted = true;
        playSound('sanityLoss'); 
        typeWriter(UI.gameOutput, t('shout_response'))
    }
    
    function handleTalk() { buildDialogueTree(GameState.chatbotTone); displayChatbotResponse(GameState.dialogue.currentNode.message_key).then(() => { renderDialogueOptions(); }); }

    function handleRead(targetName) {
        const itemInInventory = GameState.inventory.find(i => i.name.toLowerCase() === targetName.toLowerCase());
        const itemInRoom = rooms[GameState.currentRoom].objects.find(o => o.toLowerCase() === targetName.toLowerCase());
        const targetItemName = itemInInventory ? itemInInventory.name : itemInRoom;
        if (!targetItemName) { typeWriter(UI.gameOutput, t('read_fail_exists'), '#ff474c'); return; }
        if (readableItems.has(targetItemName)) {
            const desc = itemData[targetItemName].description[currentLanguage] || itemData[targetItemName].description['en'];
            typeWriter(UI.gameOutput, `[Read] ${desc}`);
            if(targetItemName === 'firewalled data log') GameState.flags.truthExposed = true;
        } else { typeWriter(UI.gameOutput, t('read_fail_readable'), '#ff474c'); }
    }

    function handleSearch(targetName) {
        const room = rooms[GameState.currentRoom];
        const searchable = searchableObjects[targetName];
        if (room.objects.includes(targetName) && searchable && !room.states?.[`${targetName}_searched`]) {
            typeWriter(UI.gameOutput, searchable[currentLanguage] || searchable['en']);
            if (searchable.item) { room.objects.push(searchable.item); showGuidance(t('hint_take', {item: searchable.item}));}
            if(!room.states) room.states = {};
            room.states[`${targetName}_searched`] = true;
        } else { typeWriter(UI.gameOutput, t('nothing_happens')); }
    }
    
    function handleListen() {
        const room = rooms[GameState.currentRoom];
        let listenDesc = t('listen_default');
        if (room.name === 'Specimen Storage') { listenDesc = "Beneath the hum of machinery, you can hear a soft, wet, rhythmic pulsing sound. It seems to be coming from the east."; }
        typeWriter(UI.gameOutput, listenDesc, '#b19cd9');
    }

    function handleSmell() {
        const room = rooms[GameState.currentRoom];
        let smellDesc = t('smell_default');
        if(room.name === 'Bio-Lab Access' || room.name === 'Specimen Storage') { smellDesc = "The air is thick with the coppery scent of blood and an acrid, chemical odor like formaldehyde."; }
        typeWriter(UI.gameOutput, smellDesc, '#b19cd9');
    }

    function handleToggle(turnOn, itemName) {
        if(itemName.toLowerCase() === 'flashlight') {
            if(!hasItem('flashlight')) { typeWriter(UI.gameOutput, t('use_fail_have', {item: 'flashlight'}), '#ff474c'); return; }
            GameState.flashlightOn = turnOn;
            typeWriter(UI.gameOutput, `[System] Flashlight turned ${turnOn ? 'on' : 'off'}.`, '#cccccc');
            if(GameState.currentRoom === 'Maintenance Tunnel') { renderRoom(); }
        }
    }

    function handleBreak(targetName) {
        const room = rooms[GameState.currentRoom];
        if (!room.breakable || !room.breakable[targetName]) {
            typeWriter(UI.gameOutput, t('break_fail', {item: targetName}), '#ff474c');
            return;
        }
        if (!room.objects.includes(targetName)) {
            typeWriter(UI.gameOutput, t('break_fail_exists', {item: targetName}), '#ff474c');
            return;
        }
        
        const material = room.breakable[targetName];
        room.objects = room.objects.filter(o => o !== targetName);
        delete room.breakable[targetName];
        room.objects.push(`broken ${material}`);
        typeWriter(UI.gameOutput, t('break_success', {item: targetName, material: material}), '#cccccc');
    }

    async function handleHack(targetName) {
        const room = rooms[GameState.currentRoom];
        if (GameState.playerBackstory !== 'hacker') {
            await typeWriter(UI.gameOutput, t('hack_fail_ability'), '#ff474c');
            return;
        }
        if (!room.hackable || !room.hackable.includes(targetName)) {
            await typeWriter(UI.gameOutput, t('hack_fail_target'), '#ff474c');
            return;
        }
        
        await typeWriter(UI.gameOutput, t('hack_start'), '#67e8f9');
        const code = Math.random().toString(36).substring(2, 8).toUpperCase();
        GameState.activeMinigame = {
            type: 'hack',
            code: code,
            prompt: `[HACKING] Enter sequence: ${code}`
        };
        await typeWriter(UI.gameOutput, GameState.activeMinigame.prompt, '#ffdb58');
    }
    
    async function handleMinigameInput(input) {
        const minigame = GameState.activeMinigame;
        if (minigame.type === 'hack') {
            if (input.toUpperCase() === minigame.code) {
                await typeWriter(UI.gameOutput, t('hack_success'), '#34d399');
                const room = rooms[GameState.currentRoom];
                if (!room.states) room.states = {};
                room.states.hacked = true;
                GameState.flags.hackedTerminal = true;
                room.objects.push('firewalled data log');
                showGuidance(t('hint_read', {item: 'firewalled data log'}));
            } else {
                await typeWriter(UI.gameOutput, t('hack_failure'), '#ff474c');
                GameState.systemLockdownTurns = 3;
            }
        }
        GameState.activeMinigame = null;
        UI.playerInput.value = '';
        updateUI();
    }

    async function handleAsk(argument) {
        const topic = argument.replace('about', '').trim().toLowerCase();
        let responseKey = 'dlg_ask_default';

        if (topic.includes('chimera')) {
            responseKey = 'dlg_ask_chimera';
            GameState.awarenessLevel += 3;
        }
        
        await displayChatbotResponse(responseKey);
    }
    
    function triggerDynamicEvent() {
        const roll = Math.random();
        if (roll < 0.05) { // 5% chance per turn
            const eventRoll = Math.random();
            if (eventRoll < 0.5) {
                typeWriter(UI.gameOutput, t('event_lights_flicker'), '#ffdb58');
                UI.appContainer.classList.add('flicker');
                setTimeout(() => UI.appContainer.classList.remove('flicker'), 400);
            } else {
                const directions = Object.keys(directionMap['en']);
                const randomDir = directions[Math.floor(Math.random() * directions.length)];
                typeWriter(UI.gameOutput, t('event_noise', {direction: randomDir}), '#ffdb58');
                const pan = (randomDir === 'east' ? 0.8 : randomDir === 'west' ? -0.8 : 0);
                playSound('noiseEvent', { pan: pan });
            }
        }
    }
    
    function updateDynamicMusic() {
        if (!audioInitialized || !GameState.settings.sound.master) return;
        
        const isTense = GameState.awarenessLevel > 50 || GameState.sanityLevel < 40;
        const normalAmbiencePlaying = sounds.ambience.state === 'started';
        const tenseAmbiencePlaying = sounds.ambienceTense.state === 'started';

        if (isTense && !tenseAmbiencePlaying) {
            if (normalAmbiencePlaying) sounds.ambience.stop();
            sounds.ambienceTense.start();
        } else if (!isTense && !normalAmbiencePlaying) {
            if (tenseAmbiencePlaying) sounds.ambienceTense.stop();
            sounds.ambience.start();
        }
    }


    function addJournalEntry(note) { if (!note) return; const entry = `T${GameState.turnCount}: ${note}`; GameState.journalEntries.push(entry); updateUI(); }
    function displayJournal() { if (window.innerWidth < 768) showStatusModal(); else typeWriter(UI.gameOutput, t('journal_displayed'), '#cccccc'); }
    function displayInventory() { if (window.innerWidth < 768) showStatusModal(); else typeWriter(UI.gameOutput, t('inventory_displayed'), '#cccccc'); }
    function displayObjectives() { if (window.innerWidth < 768) showStatusModal(); else typeWriter(UI.gameOutput, t('objectives_displayed'), '#cccccc'); }
    function displayMap() { if (window.innerWidth < 768) showStatusModal(); else typeWriter(UI.gameOutput, t('map_displayed'), '#cccccc'); }
    function showExits() { typeWriter(UI.gameOutput, t('exits_list', {exits: Object.keys(rooms[GameState.currentRoom].exits).join(', ')})); }


    function saveStateSnapshot() { if(stateSnapshots.length > 20) stateSnapshots.shift(); stateSnapshots.push(JSON.parse(JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value))); }
    function addToConversationHistory(line) { if(GameState.conversationHistory.length > 50) GameState.conversationHistory.shift(); GameState.conversationHistory.push(line); }
    
    function saveGame(isAutosave = false) {
        try { 
            saveSettings();
            const saveData = JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value); 
            localStorage.setItem('synapse_savegame_v15', saveData); 
            if (!isAutosave) typeWriter(UI.gameOutput, t('game_saved'), '#cccccc'); 
            else GameState.systemLogs.push(`[${new Date().toISOString()}] ${t('autosave_success')}.`); 
        } catch(e) { 
            console.error("Save failed:", e); 
        }
    }
    
    function loadGame() {
        const savedData = localStorage.getItem('synapse_savegame_v15');
        if (savedData) {
            try {
                const loadedState = JSON.parse(savedData);
                resetGameState(); 
                Object.assign(GameState, loadedState);
                GameState.settings = loadSettings();
                applySettings();
                GameState.visitedRooms = new Set(loadedState.visitedRooms);
                GameState.dialogue.askedQuestions = new Set(loadedState.dialogue.askedQuestions || []);
                GameState.roomsWithDroppedItems = new Set(loadedState.roomsWithDroppedItems || []);
                GameState.achievements = loadedState.achievements || [];
                GameState.unlockedEndings = loadedState.unlockedEndings || {};
                initializeData(); 
                buildDialogueTree(GameState.chatbotTone);
                GameState.dialogue.currentNode = GameState.dialogue.cache[GameState.chatbotTone]; GameState.dialogue.previousNodes = [];
                UI.startScreen.classList.add('hidden'); 
                UI.playerSetup.classList.add('hidden');
                UI.gameScreen.classList.remove('hidden'); 
                UI.gameScreen.classList.add('flex'); 
                UI.gameOutput.innerHTML = ''; 
                typeWriter(UI.gameOutput, t('game_loaded'), '#cccccc');
                renderRoom(); 
                updateUI(); 
                renderDialogueOptions();
            } catch(e) { console.error("Load failed:", e); showModal(t('load_fail')); }
        } else { showModal(t('no_save')); }
    }

    function showModal(content, isHtml = false) {
        if(isHtml) { UI.modalContent.innerHTML = content; } else { UI.modalContent.textContent = content; }
        UI.modal.classList.remove('hidden'); UI.modal.classList.add('flex');
        const closeModal = () => { playSound('uiClick'); UI.modal.classList.add('hidden'); UI.modal.classList.remove('flex'); };
        UI.modal.onclick = (e) => { if (e.target === UI.modal) { closeModal(); } };
        const closeBtn = UI.modalContent.querySelector('.close-modal-btn'); if (closeBtn) { closeBtn.onclick = closeModal; }
    }
    
    function hideModal() { UI.modal.classList.add('hidden'); UI.modal.classList.remove('flex'); }

    function showBackstoryModal() {
        let content = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('choose_backstory_title')}</h2>
                       <div class="modal-scroll flex-grow p-2">
                           <p class="text-gray-400 text-sm mb-4">${t('choose_backstory_desc')}</p>
                           <div id="backstory-list" class="text-left space-y-2">`;
        for (const key in backstories) {
            const backstoryTitleKey = 'backstory_title_' + key.replace(/ /g, '_');
            const displayName = t(backstoryTitleKey);
            // Always use translation for both title and description
            content += `<button class="backstory-choice-btn button w-full text-left !justify-start !p-3" data-backstory="${key}">
                            <div><strong class="text-green-300">${displayName}</strong>: <span class="text-gray-300 text-sm">${t(backstories[key].description_key)}</span></div>
                        </button>`;
        }
        content += `</div></div><button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(content, true);
        document.getElementById('backstory-list').addEventListener('click', (e) => {
            const button = e.target.closest('.backstory-choice-btn');
            if (button) {
                playSound('uiClick');
                UI.playerBackstoryInput.value = button.dataset.backstory;
                updateAbilityDisplay();
                hideModal();
            }
        });
    }

    function showFeaturesModal() {
        let featuresHtml = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('features_title')}</h2>
        <div class="modal-scroll text-left p-2 text-sm flex-grow">
            
            <h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('features_core_mechanics_title')}</h3>
            <ul class="list-disc pl-5 space-y-3 text-gray-300">
                <li><strong>${t('features_stats_system')}</strong>
                    <ul class="list-circle pl-5 mt-1 space-y-1">
                        <li><strong class="text-cyan-400">${t('sanity')}:</strong> ${t('features_sanity_desc')}</li>
                        <li><strong class="text-cyan-400">${t('awareness')}:</strong> ${t('features_awareness_desc')}</li>
                    </ul>
                </li>
                <li><strong>${t('features_turn_based_title')}</strong> ${t('features_turn_based_desc')}</li>
                <li><strong>${t('features_dynamic_ai_title')}</strong> ${t('features_dynamic_ai_desc')}</li>
            </ul>

            <h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('features_player_and_char_title')}</h3>
            <ul class="list-disc pl-5 space-y-2 text-gray-300">
                <li>${t('features_character_creation_desc')}</li>
                <li>${t('features_journal_desc')}</li>
                <li>${t('features_objectives_desc')}</li>
            </ul>

            <h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('features_new_enhancements_title')}</h3>
             <ul class="list-disc pl-5 space-y-3 text-gray-300">
                <li>${t('features_advanced_commands_desc')}</li>
                <li>${t('features_dynamic_events_desc')}</li>
                <li>${t('features_deeper_lore_desc')}</li>
            </ul>

            <h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('features_new_ui_ux_title')}</h3>
             <ul class="list-disc pl-5 space-y-3 text-gray-300">
                <li>${t('features_clickable_objects_desc')}</li>
                <li>${t('features_autocomplete_desc')}</li>
                <li>${t('features_audio_desc')}</li>
            </ul>

             <h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('features_player_commands_title')}</h3>
            <ul class="list-disc pl-5 space-y-2 text-gray-300">
                 <li>${t('features_commands_nav')}</li>
                 <li>${t('features_commands_interact')}</li>
                 <li>${t('features_commands_info')}</li>
                 <li>${t('features_commands_sys')}</li>
            </ul>
        </div>
        <button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(featuresHtml, true);
    }

    function showHelpMenu() {
        const helpText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('help')}</h2>
        <div class="modal-scroll text-left p-2 text-sm flex-grow">
            <p class="mb-4">Type commands to interact. Most commands advance the turn counter.</p>
            <div>
                <h3 class="text-lg font-bold text-white">${t('features_commands_nav')}</h3>
                <p class="text-gray-300"><strong class="text-yellow-400">go [direction]</strong> - Move north, south, east, or west.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">look around</strong> - Describe the current room and visible items.</p>
            </div>
            <div class="mt-4">
                <h3 class="text-lg font-bold text-white">${t('features_commands_interact')}</h3>
                <p class="text-gray-300"><strong class="text-yellow-400">take [item]</strong> - Pick up an item from the room.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">use [item]</strong> - Use an item from your inventory.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">drop [item]</strong> - Drop an item in the current room.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">examine [item/object]</strong> - Get a detailed description of something.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">read [item/object]</strong> - Read text from an object.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">search [object]</strong> - Search an object for hidden items.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">combine [item1] with [item2]</strong> - Try to combine two items in your inventory.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">listen</strong> / <strong class="text-yellow-400">smell</strong> - Use your senses.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">break [object]</strong> - Attempt to break an object in the room.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">hack [object]</strong> - Attempt to hack a terminal (Hacker only).</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">ask about [topic]</strong> - Ask SYNAPSE about a specific topic.</p>
            </div>
             <div class="mt-4">
                <h3 class="text-lg font-bold text-white">${t('features_commands_info')}</h3>
                <p class="text-gray-300"><strong class="text-yellow-400">inventory</strong> / <strong class="text-yellow-400">objectives</strong> / <strong class="text-yellow-400">journal</strong> - View status panels (or modal on mobile).</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">journal add [note]</strong> - Add a custom note to your journal.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">history</strong> - View your last 20 commands.</p>
            </div>
            <div class="mt-4">
                <h3 class="text-lg font-bold text-white">${t('features_commands_sys')}</h3>
                <p class="text-gray-300"><strong class="text-yellow-400">save / load</strong> - Save or load your game progress.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">rest</strong> - Attempt to rest and recover sanity in safe rooms.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">quit / exit</strong> - End the game and return to the main menu.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">cls / clear</strong> - Clear the output screen.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">undo</strong> - Revert your last action.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">again / a</strong> - Repeat your last command.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">wait</strong> - Pass a turn.</p>
            </div>
        </div>
        <button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(helpText, true);
    }
    
    function showStatusModal() {
        const currentWeight = GameState.inventory.reduce((sum, item) => sum + (item?.weight || 1), 0);
        const statusText = `
        <h2 class="text-2xl mb-4 title-font text-cyan-400">${t('status_btn')}</h2>
        <div class="modal-scroll text-left p-2 text-sm flex-grow">
            <!-- Stats -->
            <div id="modal-stats-panel" class="mb-4">
                <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2">${t('stats_title')}</h3>
                <div>${GameState.playerName} (${t('backstory_title_' + GameState.playerBackstory.replace(/ /g, '_'))})</div>
                <div><span data-lang="awareness">${t('awareness')}</span>: ${GameState.awarenessLevel}</div>
                <div><span data-lang="sanity">${t('sanity')}</span>: ${GameState.sanityLevel}</div>
                <div><span data-lang="tone">${t('tone')}</span>: ${GameState.temporaryTone || GameState.chatbotTone}</div>
                <div><span data-lang="turn">${t('turn')}</span>: ${GameState.turnCount}</div>
            </div>
            <!-- Inventory -->
            <div id="modal-inventory-panel" class="mb-4">
                <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2">${t('inventory_title')} (${currentWeight}/${MAX_INVENTORY_WEIGHT})</h3>
                <ul class="list-none p-0">${GameState.inventory.length > 0 ? GameState.inventory.map(item => `<li>- ${item ? item.name : '[Unknown Item]'}</li>`).join('') : `<li>${t('empty_inventory')}</li>`}</ul>
            </div>
            <!-- Objectives -->
            <div id="modal-objectives-panel" class="mb-4">
                 <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2">${t('objectives_title')}</h3>
                 <ul class="list-none p-0 text-sm">${GameState.objectives.length > 0 ? GameState.objectives.map(obj => `<li>${obj.completed ? `<span class="text-gray-500 line-through">${obj.text}</span>` : `&gt; ${obj.text}`}</li>`).join('') : `<li>${t('no_objectives')}</li>`}</ul>
            </div>
             <!-- Journal -->
            <div id="modal-journal-panel" class="mb-4">
                 <h3 class="font-bold border-b border-[var(--main-color-border)] mb-2">${t('journal_title')}</h3>
                 <ul class="list-none p-0 text-sm">${GameState.journalEntries.slice().reverse().map(entry => `<li>${entry}</li>`).join('')}</ul>
            </div>
        </div>
        <button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(statusText, true);
    }
    
    function showProgressionModal() {
        const unlockedEndings = JSON.parse(localStorage.getItem(ENDINGS_STORAGE_KEY) || '{}');
        const unlockedAchievements = JSON.parse(localStorage.getItem(ACHIEVEMENTS_STORAGE_KEY) || '{}');

        let endingsHtml = `<h4 class="text-md font-bold mt-4 mb-2 text-white">${t('unlocked_endings')}</h4>`;
        const endingsList = Object.values(unlockedEndings);
        if(endingsList.length > 0) {
            endingsHtml += `<ul class="list-disc pl-5 text-gray-300">${endingsList.map(e => `<li><strong>${e.title}</strong>: ${e.desc}</li>`).join('')}</ul>`;
        } else {
            endingsHtml += `<p class="text-gray-400">${t('no_endings')}</p>`;
        }
        
        let achievementsHtml = '';

        const progressionText = `
        <h2 class="text-2xl mb-4 title-font text-cyan-400">${t('progress_btn')}</h2>
        <div class="modal-scroll flex-grow p-2 text-left">
            ${endingsHtml}
            ${achievementsHtml}
        </div>
        <button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(progressionText, true);
    }

    function showPauseMenu() {
        const pauseText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('pause_title')}</h2>
        <div class="modal-scroll flex-grow pr-2">
            <div class="flex flex-col gap-2">
                <button id="pause-achievements" class="button">${t('achievements_btn')}</button>
                <button id="pause-endings" class="button">${t('endings_btn')}</button>
                <hr class="border-gray-700 my-2">
                <button id="pause-features" class="button">${t('understand_game')}</button>
                <button id="pause-help" class="button">${t('help')}</button>
                <button id="pause-settings" class="button">${t('settings_btn')}</button>
                <button id="pause-lang" class="button">${t('lang_switch_btn')}</button>
                <hr class="border-gray-700 my-2">
                <button id="pause-save" class="button">${t('save_game')}</button>
                <button id="pause-load" class="button">${t('load_game')}</button>
                <button id="pause-main-menu" class="button text-yellow-300 border-yellow-300/80">${t('main_menu_btn')}</button>
                <button id="pause-resume" class="button button-primary mt-4">${t('resume_btn')}</button>
            </div>
        </div>`; 
        showModal(pauseText, true); 
        document.getElementById('pause-save').onclick = () => { playSound('uiClick'); saveGame(); hideModal(); }; 
        document.getElementById('pause-load').onclick = () => { playSound('uiClick'); loadGame(); hideModal(); }; 
        document.getElementById('pause-settings').onclick = () => { playSound('uiClick'); showSettingsModal(true); };
        document.getElementById('pause-help').onclick = () => { playSound('uiClick'); showHelpMenu(); }; 
        document.getElementById('pause-features').onclick = () => { playSound('uiClick'); showFeaturesModal(); }; 
        document.getElementById('pause-main-menu').onclick = () => { playSound('uiClick'); confirmReturnToMainMenu(); };
        document.getElementById('pause-resume').onclick = () => { playSound('uiClick'); hideModal(); };
        document.getElementById('pause-achievements').onclick = () => { playSound('uiClick'); showAchievementsModal(); };
        document.getElementById('pause-endings').onclick = () => { playSound('uiClick'); showEndingsModal(); };
        document.getElementById('pause-lang').onclick = () => { 
            playSound('uiClick');
            setLanguage(currentLanguage === 'en' ? 'sv' : 'en');
            showPauseMenu(); // Re-render the pause menu with the new language
        };
    }

    function showAchievementsModal() {
        let content = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('achievements_title')}</h2>
                       <div class="modal-scroll flex-grow p-2 text-left">`;

        const unlockedAchievementsObj = JSON.parse(localStorage.getItem(ACHIEVEMENTS_STORAGE_KEY) || '{}');
        const unlockedAchievements = Object.keys(unlockedAchievementsObj);
        const totalAchievements = Object.keys(achievements).length;
        const unlockedCount = unlockedAchievements.length;
        const lockedAchievementsCount = totalAchievements - unlockedCount;

        // Progress summary
        content += `<div class="mb-4 text-sm text-cyan-300">Unlocked: <span class="font-bold">${unlockedCount}</span> / <span class="font-bold">${totalAchievements}</span> achievements (${lockedAchievementsCount} remaining)</div>`;

        content += `<h3 class="text-lg font-bold mb-2 text-white">${t('unlocked_achievements')}</h3>`;
        content += `<ul class="list-disc pl-5 space-y-2">`;
        for (const id in achievements) {
            if (unlockedAchievements.includes(id)) {
                const ach = achievements[id];
                content += `<li class="text-green-300"><strong>${t(ach.title_key)}</strong>: <span class="text-gray-300">${t(ach.req_key)}</span></li>`;
            } else {
                content += `<li class="text-gray-500"><strong>???</strong>: ???</li>`;
            }
        }
        content += `</ul>`;

        content += `</div><button class="close-modal-btn button mt-6">${t('back_btn')}</button>`;
        showModal(content, true);
        const closeBtn = UI.modalContent.querySelector('.close-modal-btn');
        if(closeBtn) {
            closeBtn.onclick = () => {
                playSound('uiClick');
                showPauseMenu();
            };
        }
    }

    function showEndingsModal() {
        let content = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('endings_title')}</h2>
                       <div class="modal-scroll flex-grow p-2 text-left">`;

        const unlockedEndings = GameState.unlockedEndings || {};
        const unlockedKeys = Object.keys(unlockedEndings);
        const totalEndings = Object.keys(endings).length;
        const unlockedCount = unlockedKeys.length;
        const lockedCount = totalEndings - unlockedCount;

        // Count general and backstory-specific endings
        let generalTotal = 0, generalUnlocked = 0, backstoryTotal = 0, backstoryUnlocked = 0;
        for (const key in endings) {
            if (endings[key].isBackstorySpecific) {
                backstoryTotal++;
                if (unlockedEndings[key]) backstoryUnlocked++;
            } else {
                generalTotal++;
                if (unlockedEndings[key]) generalUnlocked++;
            }
        }

        content += `<div class="mb-4 text-sm text-cyan-300">
            General endings: <span class="font-bold">${generalUnlocked}</span> / <span class="font-bold">${generalTotal}</span>
            &nbsp;|&nbsp; Backstory-specific endings: <span class="font-bold">${backstoryUnlocked}</span> / <span class="font-bold">${backstoryTotal}</span>
            <br>Unlocked: <span class="font-bold">${unlockedCount}</span> / <span class="font-bold">${totalEndings}</span> endings (${lockedCount} remaining)
        </div>`;

        content += `<h3 class="text-lg font-bold mb-2 text-white">${t('unlocked_endings')}</h3>`;

        content += `<ul class="list-disc pl-5 space-y-3">`;
        for (const key in endings) {
            if (unlockedEndings[key]) {
                const ending = endings[key];
                content += `<li class="text-green-300"><strong>${t(ending.title_key)}</strong>: <span class="text-gray-300">${t(ending.desc_key)}</span></li>`;
            } else {
                content += `<li class="text-gray-500"><strong>???</strong>: ???</li>`;
            }
        }
        content += `</ul>`;

        content += `</div><button class="close-modal-btn button mt-6">${t('back_btn')}</button>`;
        showModal(content, true);
        const closeBtn = UI.modalContent.querySelector('.close-modal-btn');
        if(closeBtn) {
            closeBtn.onclick = () => {
                playSound('uiClick');
                showPauseMenu();
            };
        }
    }


    function showSettingsModal(fromPauseMenu = false) {
        const { settings } = GameState;
        const settingsText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('settings_title')}</h2>
        <div class="modal-scroll text-left p-2 text-sm flex-grow space-y-4">
            
            <div class="flex items-center justify-between">
                <span data-lang="setting_ui_theme">${t('setting_ui_theme')}</span>
                <div class="flex gap-2">
                    <button id="theme-green" class="button text-xs ${settings.theme === 'green' ? 'button-primary' : ''}">${t('theme_green')}</button>
                    <button id="theme-amber" class="button text-xs ${settings.theme === 'amber' ? 'button-primary' : ''}">${t('theme_amber')}</button>
                    <button id="theme-blue" class="button text-xs ${settings.theme === 'blue' ? 'button-primary' : ''}">${t('theme_blue')}</button>
                </div>
            </div>

             <div class="flex items-center justify-between">
                <span data-lang="setting_font_family">${t('setting_font_family')}</span>
                <div class="flex gap-2">
                    <button id="font-space" class="button text-xs ${settings.font === 'Space Mono' ? 'button-primary' : ''}">Space Mono</button>
                    <button id="font-courier" class="button text-xs ${settings.font === 'Courier Prime' ? 'button-primary' : ''}">Courier</button>
                </div>
            </div>

            <div class="flex items-center justify-between">
                <span data-lang="setting_text_speed">${t('setting_text_speed')}</span>
                <div class="flex gap-2">
                    <button id="speed-fast" class="button text-xs ${settings.textSpeed === TextSpeed.Fast ? 'button-primary' : ''}">${t('fast')}</button>
                    <button id="speed-normal" class="button text-xs ${settings.textSpeed === TextSpeed.Normal ? 'button-primary' : ''}">${t('normal')}</button>
                    <button id="speed-slow" class="button text-xs ${settings.textSpeed === TextSpeed.Slow ? 'button-primary' : ''}">${t('slow')}</button>
                </div>
            </div>

            <div class="flex items-center justify-between">
                <span data-lang="setting_crt_effect">CRT Effect</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-crt" ${settings.glitchEffect ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="flex items-center justify-between">
                <span data-lang="setting_colorblind_mode">${t('setting_colorblind_mode')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-colorblind" ${settings.colorblindMode ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>

             <hr class="border-gray-700 my-4">

            <div class="flex items-center justify-between">
                <span data-lang="setting_master_volume">${t('setting_master_volume')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-master" ${settings.sound.master ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
             <div class="flex items-center justify-between">
                <span data-lang="setting_item_found">${t('setting_item_found')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-item" ${settings.sound.item ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="flex items-center justify-between">
                <span data-lang="setting_high_awareness">${t('setting_high_awareness')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-awareness" ${settings.sound.awareness ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="flex items-center justify-between">
                <span data-lang="setting_low_sanity">${t('setting_low_sanity')}</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="setting-sanity" ${settings.sound.sanity ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>
            
            <hr class="border-gray-700 my-4">
            
            <button id="reset-settings-btn" class="button w-full text-yellow-300 border-yellow-300/80">${t('setting_reset_defaults')}</button>
        </div>
        <button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(settingsText, true);

        const setupToggle = (id, obj, key) => {
            const el = document.getElementById(id);
            if(el) {
                el.onchange = (e) => {
                    obj[key] = e.target.checked;
                    saveSettings();
                    applySettings();
                };
            }
        };
        
        setupToggle('setting-master', GameState.settings.sound, 'master');
        setupToggle('setting-item', GameState.settings.sound, 'item');
        setupToggle('setting-awareness', GameState.settings.sound, 'awareness');
        setupToggle('setting-sanity', GameState.settings.sound, 'sanity');
        setupToggle('setting-colorblind', GameState.settings, 'colorblindMode');
        setupToggle('setting-crt', GameState.settings, 'glitchEffect');

        const setupButtonGroup = (buttons, key, valueMap) => {
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if(btn) {
                    btn.addEventListener('click', () => {
                        GameState.settings[key] = valueMap[id];
                        document.querySelectorAll(buttons.map(b => `#${b}`).join(', ')).forEach(b => b.classList.remove('button-primary'));
                        btn.classList.add('button-primary');
                        saveSettings();
                        applySettings();
                    });
                }
            });
        };

        setupButtonGroup(['speed-fast', 'speed-normal', 'speed-slow'], 'textSpeed', {'speed-fast': TextSpeed.Fast, 'speed-normal': TextSpeed.Normal, 'speed-slow': TextSpeed.Slow});
        setupButtonGroup(['theme-green', 'theme-amber', 'theme-blue'], 'theme', {'theme-green': 'green', 'theme-amber': 'amber', 'theme-blue': 'blue'});
        setupButtonGroup(['font-space', 'font-courier'], 'font', {'font-space': 'Space Mono', 'font-courier': 'Courier Prime'});

        const resetBtn = document.getElementById('reset-settings-btn');
        if(resetBtn) {
            resetBtn.onclick = () => {
                GameState.settings = {
                    sound: { master: true, item: true, awareness: true, sanity: true },
                    textSpeed: TextSpeed.Normal,
                    colorblindMode: false,
                    glitchEffect: true,
                    font: 'Space Mono',
                    theme: 'green'
                };
                saveSettings();
                applySettings();
                showSettingsModal(fromPauseMenu);
            };
        }

        const closeBtn = UI.modalContent.querySelector('.close-modal-btn');
        if(closeBtn) {
            closeBtn.onclick = () => {
                playSound('uiClick');
                if (fromPauseMenu) {
                    showPauseMenu();
                } else {
                    hideModal();
                }
            };
        }
    }

    function confirmReturnToMainMenu() {
        const confirmText = `<h2 class="text-xl mb-4 title-font text-yellow-400">${t('confirm_main_menu')}</h2>
        <div class="flex justify-center gap-4">
            <button id="confirm-yes" class="button button-primary">${t('yes')}</button>
            <button id="confirm-no" class="button">${t('no')}</button>
        </div>`;
        showModal(confirmText, true);
        document.getElementById('confirm-yes').onclick = () => { playSound('uiClick'); returnToMainMenu(); };
        document.getElementById('confirm-no').onclick = () => { playSound('uiClick'); showPauseMenu(); };
    }
    
    function returnToMainMenu() {
        if(animationFrameId) cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
        sessionStorage.removeItem('synapse_session_v15_autosave');
        sessionStorage.removeItem('synapse_session_v15_screen_state');
        GameState.exitGame = true;

        UI.gameScreen.classList.add('hidden'); 
        UI.gameScreen.classList.remove('flex');
        UI.playerSetup.classList.add('hidden');
        UI.playerSetup.classList.remove('flex');

        UI.startScreen.classList.remove('hidden');
        UI.startScreen.classList.add('flex');
        
        UI.gameOutput.innerHTML = '';
        if (audioInitialized && GameState.settings.sound.master) {
            if (sounds.ambience.state === 'started') sounds.ambience.stop();
            if (sounds.ambienceTense.state === 'started') sounds.ambienceTense.stop();
        }
        resetGameState(); 
        setupIntro(); 
        hideModal();
    }

    // --- NEW FUNCTIONS FOR SAVING/LOADING PLAYER CHOICES ---
    function savePlayerChoices() {
        try {
            const playerChoices = {
                playerName: UI.playerNameInput.value,
                playerBackstory: UI.playerBackstoryInput.value,
                difficulty: Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal,
                language: currentLanguage
            };
            localStorage.setItem(PLAYER_CHOICES_KEY, JSON.stringify(playerChoices));
        } catch (e) {
            console.error("Failed to save player choices:", e);
        }
    }

    function loadPlayerChoices() {
        try {
            const savedChoices = localStorage.getItem(PLAYER_CHOICES_KEY);
            if (savedChoices) {
                const choices = JSON.parse(savedChoices);
                UI.playerNameInput.value = choices.playerName || '';
                UI.playerBackstoryInput.value = choices.playerBackstory || '';
                
                UI.difficultyBtns.forEach(btn => btn.classList.remove('button-primary'));
                const difficultyBtn = Array.from(UI.difficultyBtns).find(b => b.dataset.difficulty === choices.difficulty) || UI.difficultyBtns[1];
                difficultyBtn.classList.add('button-primary');
                
                setLanguage(choices.language || 'en'); // Apply language immediately
            }
        } catch (e) {
            console.error("Failed to load player choices:", e);
            localStorage.removeItem(PLAYER_CHOICES_KEY); // Clear corrupted data
        }
    }
    // --- END NEW FUNCTIONS ---


    function setupIntro() { UI.introTextContainer.innerHTML = `<p class="mb-4">${t('intro_1')}</p><p>${t('intro_2')}</p><p>${t('intro_3')}</p>`; }
    
    function startGame() { 
        resetGameState(); initializeData(); saveStateSnapshot(); 
        GameState.playerName = UI.playerNameInput.value || "Subject"; 
        const backstoryKey = (UI.playerBackstoryInput.value || "investigator").toLowerCase();
        GameState.playerBackstory = Object.keys(backstories).includes(backstoryKey) ? backstoryKey : 'investigator';
        GameState.difficulty = Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal; 
        
        // Save player choices when starting a new game
        savePlayerChoices();

        UI.startScreen.classList.add('hidden');
        UI.playerSetup.classList.add('hidden');
        UI.gameScreen.classList.remove('hidden'); 
        UI.gameScreen.classList.add('flex'); 
        
        // Initialize player stats based on backstory and difficulty
        switch (GameState.playerBackstory) {
            case 'psychologist':
                if (GameState.difficulty === Difficulty.Easy) GameState.maxSanity += 25;
                else if (GameState.difficulty === Difficulty.Normal) GameState.maxSanity += 15;
                else if (GameState.difficulty === Difficulty.Hard) GameState.maxSanity += 5;
                GameState.sanityLevel = GameState.maxSanity; // Apply max sanity increase
                break;
            case 'skeptic':
                if (GameState.difficulty === Difficulty.Easy) GameState.awarenessLevel += 15;
                else if (GameState.difficulty === Difficulty.Normal) GameState.awarenessLevel += 10;
                break;
            case 'cultist':
                if (GameState.difficulty === Difficulty.Hard) GameState.sanityLevel -= 10;
                break;
        }

        // Add starting items based on backstory and difficulty
        switch (GameState.playerBackstory) {
            case 'hacker':
                if (GameState.difficulty === Difficulty.Easy) GameState.inventory.push(itemData['hacked data disk']);
                else if (GameState.difficulty === Difficulty.Normal) GameState.inventory.push(itemData['data disk']);
                break;
            case 'survivor':
                if (GameState.difficulty !== Difficulty.Hard) GameState.inventory.push(itemData['flashlight']);
                break;
            case 'corporate spy':
                if (GameState.difficulty !== Difficulty.Hard) GameState.inventory.push(itemData['decryption device']);
                break;
            case 'medic':
                if (GameState.difficulty === Difficulty.Easy) GameState.inventory.push(itemData['stimpack'], itemData['stimpack']);
                else if (GameState.difficulty === Difficulty.Normal) GameState.inventory.push(itemData['stimpack']);
                break;
            case 'cultist':
                GameState.inventory.push(itemData['effigy']); // Assuming 'effigy' is defined in itemData
                break;
            case 'janitor':
                if (GameState.difficulty !== Difficulty.Hard) GameState.inventory.push(itemData['master keycard']); // Assuming 'master keycard' is defined in itemData
                break;
        }

        UI.gameOutput.innerHTML = ''; 
        buildDialogueTree(GameState.chatbotTone);
        if (audioInitialized) updateDynamicMusic();
        
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        gameLoop();
        
        typeWriter(UI.gameOutput, t('initializing'), '#cccccc').then(() => { 
            showGuidance(t('initial_hint'));
            displayChatbotResponse(GameState.dialogue.currentNode.message_key).then(() => { renderRoom(); updateUI(); renderDialogueOptions(); }); 
        }); 
    }
    
    function checkEndings() {
        if (GameState.exitGame) return;
        for (const key in endings) {
            if (endings[key].check()) {
                endGame(key);
                return; // Stop after the first ending is triggered
            }
        }
    }

    function endGame(endingKey) {
        if (GameState.exitGame) return;
        GameState.exitGame = true;
        if(animationFrameId) cancelAnimationFrame(animationFrameId);
        animationFrameId = null;

        const endingData = endings[endingKey];
        if (!endingData) {
            console.error(`Ending with key '${endingKey}' not found.`);
            returnToMainMenu();
            return;
        }

        const endingTitle = t(endingData.title_key);
        const endingDesc = t(endingData.desc_key);

        GameState.unlockedEndings[endingKey] = { title: endingTitle, desc: endingDesc };
        const unlockedEndings = JSON.parse(localStorage.getItem(ENDINGS_STORAGE_KEY) || '{}');
        unlockedEndings[endingKey] = { title: endingTitle, desc: endingDesc };
        localStorage.setItem(ENDINGS_STORAGE_KEY, JSON.stringify(unlockedEndings));

        const endingHtml = `<div class="text-center">
            <h2 class="text-4xl title-font text-red-500 mb-4">${endingTitle}</h2>
            <p class="text-white mb-6">${endingDesc}</p>
            <button id="ending-main-menu" class="button button-primary">${t('main_menu_btn')}</button>
        </div>`;
        showModal(endingHtml, true);
        document.getElementById('ending-main-menu').onclick = () => { playSound('uiClick'); returnToMainMenu(); };
    }

    function checkAchievements() {
        for (const id in achievements) {
            if (!GameState.achievements.includes(id)) {
                if (achievements[id].check()) {
                    unlockAchievement(id);
                }
            }
        }
    }

    function unlockAchievement(id) {
        if (GameState.achievements.includes(id)) return;

        GameState.achievements.push(id);
        const ach = achievements[id];
        playSound('itemPickup');
        typeWriter(UI.gameOutput, `[${t('achievement_unlocked')}] ${t(ach.title_key)}`, '#FFD700');

        const unlockedAchievements = JSON.parse(localStorage.getItem(ACHIEVEMENTS_STORAGE_KEY) || '{}');
        if (!unlockedAchievements[id]) {
            unlockedAchievements[id] = true;
            localStorage.setItem(ACHIEVEMENTS_STORAGE_KEY, JSON.stringify(unlockedAchievements));
        }
    }


    function hasItem(itemName) { return GameState.inventory.some(i => i.name.toLowerCase() === itemName.toLowerCase()); }
    function removeItemFromInventory(itemName) { const index = GameState.inventory.findIndex(i => i.name.toLowerCase() === itemName.toLowerCase()); if (index > -1) { GameState.inventory.splice(index, 1); } }
    
    function getAbilityDescription(backstoryKey, difficulty) {
        const key = (backstoryKey || "").toLowerCase().trim().replace(/ /g, '_');
        if (!backstories[key]) return t('ability_unknown');
        switch (key) {
            case 'hacker': return t(`ability_hacker_${difficulty.toLowerCase()}`);
            case 'psychologist': return t(`ability_psychologist_${difficulty.toLowerCase()}`);
            case 'technician': return t(`ability_technician_${difficulty.toLowerCase()}`);
            case 'survivor': return difficulty !== Difficulty.Hard ? t('ability_survivor_with_item') : t('ability_survivor');
            case 'skeptic': return difficulty === Difficulty.Easy ? t('ability_skeptic_easy') : t('ability_skeptic_normal');
            case 'corporate spy': return difficulty !== Difficulty.Hard ? t('ability_spy_with_item') : t('ability_spy');
            case 'medic': return t(`ability_medic_${difficulty.toLowerCase()}`);
            case 'cultist': return difficulty === Difficulty.Hard ? t('ability_cultist_hard') : t('ability_cultist');
            case 'janitor': return difficulty !== Difficulty.Hard ? t('ability_janitor') : t('ability_janitor_hard');
            default: return t('ability_investigator');
        }
    }
    
    function updateAbilityDisplay() { 
        if (!UI.abilityDisplay) return; 
        const difficulty = Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal; 
        const backstoryKey = UI.playerBackstoryInput.value; 
        const description = getAbilityDescription(backstoryKey, difficulty); 
        UI.abilityDisplay.innerHTML = `${t('ability_bonus_prefix')}<span class="text-white">${description}</span>`;
    }

    function startSpeechRecognition() {
        if (!SpeechRecognition) {
            typeWriter(UI.gameOutput, t('speech_not_supported'), '#ff474c');
            return;
        }

        recognition.lang = currentLanguage === 'sv' ? 'sv-SE' : 'en-US';

        recognition.onstart = () => {
            UI.micBtn.classList.add('bg-red-500', 'border-red-700');
        };

        recognition.onresult = (event) => {
            let transcript = event.results[0][0].transcript;
            const lowerTranscript = transcript.toLowerCase();
            const langQuestionWords = questionWords[currentLanguage] || questionWords['en'];
            const isQuestion = langQuestionWords.some(word => lowerTranscript.startsWith(word + ' '));

            if (isQuestion && !lowerTranscript.endsWith('?')) {
                transcript += '?';
            }
            
            UI.playerInput.value = transcript;
            setTimeout(() => {
                processPlayerInput(transcript);
            }, 250);
        };

        recognition.onerror = (event) => {
            let errorMsg = t('speech_error_generic', {error: event.error});
            if (event.error === 'not-allowed') {
                errorMsg = t('speech_error_access_denied');
            } else if (event.error === 'no-speech') {
                errorMsg = t('speech_error_no_speech');
            }
            typeWriter(UI.gameOutput, errorMsg, '#ff474c');
        };

        recognition.onend = () => {
            UI.micBtn.classList.remove('bg-red-500', 'border-red-700');
        };

        recognition.start();
    }

    async function showGuidance(text) { await typeWriter(UI.gameOutput, `[HINT] ${text}`, GUIDANCE_COLOR); }
    
    function saveStateToSession() {
        if (!UI.gameScreen.classList.contains('hidden') && GameState && typeof GameState.turnCount === 'number' && !GameState.exitGame) {
            try {
                const sessionData = JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value); 
                sessionStorage.setItem('synapse_session_v15_autosave', sessionData);
                sessionStorage.removeItem('synapse_session_v15_screen_state');
            } catch (e) {
                console.error("Session game state save failed:", e);
            }
        } 
        else if (!UI.playerSetup.classList.contains('hidden')) {
            try {
                const startState = {
                    isPlayerSetupVisible: true,
                    playerName: UI.playerNameInput.value,
                    playerBackstory: UI.playerBackstoryInput.value,
                    difficulty: Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal,
                    language: currentLanguage
                };
                sessionStorage.setItem('synapse_session_v15_screen_state', JSON.stringify(startState));
                sessionStorage.removeItem('synapse_session_v15_autosave');
            } catch (e) {
                console.error("Session screen state save failed:", e);
            }
        } else {
             sessionStorage.removeItem('synapse_session_v15_autosave');
             sessionStorage.removeItem('synapse_session_v15_screen_state');
        }
    }

    function loadStateFromSession() {
        const sessionData = sessionStorage.getItem('synapse_session_v15_autosave');
        if (!sessionData) return false;
        try {
            const loadedState = JSON.parse(sessionData);
            if (loadedState.currentRoom && typeof loadedState.turnCount === 'number' && !loadedState.exitGame) {
                resetGameState();
                Object.assign(GameState, loadedState);
                GameState.settings = loadSettings();
                applySettings();
                GameState.visitedRooms = new Set(loadedState.visitedRooms || []);
                GameState.dialogue.askedQuestions = new Set(loadedState.dialogue.askedQuestions || []);
                GameState.roomsWithDroppedItems = new Set(loadedState.roomsWithDroppedItems || []);
                GameState.achievements = loadedState.achievements || [];
                GameState.unlockedEndings = loadedState.unlockedEndings || {};
                initializeData(); 
                buildDialogueTree(GameState.chatbotTone);
                GameState.dialogue.currentNode = GameState.dialogue.cache[GameState.chatbotTone] || GameState.dialogue.cache[ChatbotTone.Friendly];
                GameState.dialogue.previousNodes = [];
                UI.startScreen.classList.add('hidden');
                UI.playerSetup.classList.add('hidden');
                UI.gameScreen.classList.remove('hidden');
                UI.gameScreen.classList.add('flex');
                UI.gameOutput.innerHTML = '';
                typeWriter(UI.gameOutput, t('conn_reestablished'), '#cccccc');
                renderRoom();
                updateUI();
                renderDialogueOptions();
                return true;
                return true;
                return true;
                return true;
                return true;
                return true;
            }
        } catch (e) {
            console.error("Session load failed:", e);
            sessionStorage.removeItem('synapse_session_v15_autosave');
        }
        return false;
    }
    
    function setupBackgroundAnimation() { 
        const canvas = document.getElementById('background-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        let width, height, particles = [];
        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize);
        resize();
        class Particle { constructor() { this.x = Math.random() * width; this.y = Math.random() * height; this.size = Math.random() * 0.4 + 0.1; this.speedX = (Math.random() * 0.5 - 0.25); this.speedY = (Math.random() * 0.5 - 0.25); } update() { this.x += this.speedX; this.y += this.speedY; if (this.size > 0.1) this.size -= 0.001; if(this.x < 0 || this.x > width) this.speedX *= -1; if(this.y < 0 || this.y > height) this.speedY *= -1; } draw() { ctx.fillStyle = 'var(--main-color)'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); } }
        function initParticles() { particles = []; for(let i=0; i<100; i++) particles.push(new Particle()); }
        function animateParticles() { ctx.clearRect(0,0,width,height); for(let i=0; i<particles.length; i++) { particles[i].update(); particles[i].draw(); if(particles[i].size <= 0.1) { particles.splice(i, 1); i--; particles.push(new Particle()); } } requestAnimationFrame(animateParticles); }
        initParticles(); animateParticles();
    }
    
    function getMapBounds() {
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        Object.values(roomLayout).forEach(r => {
            minX = Math.min(minX, r.x);
            minY = Math.min(minY, r.y);
            maxX = Math.max(maxX, r.x + r.w);
            maxY = Math.max(maxY, r.y + r.h);
        });
        const padding = 20;
        return {minX: minX - padding, minY: minY - padding, maxX: maxX + padding, maxY: maxY + padding};
    }

    function drawMap() {
        if (!UI.mapCanvas || !GameState.currentRoom) return;
        const canvas = UI.mapCanvas;
        const ctx = canvas.getContext('2d');
        const isFullscreen = UI.mapPanel.classList.contains('fullscreen');
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();

        if (rect.width === 0 || rect.height === 0) return;

        const newWidth = rect.width * dpr;
        const newHeight = rect.height * dpr;

        if (canvas.width !== newWidth || canvas.height !== newHeight) {
            canvas.width = newWidth;
            canvas.height = newHeight;
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.scale(dpr, dpr);

        const playerLayout = roomLayout[GameState.currentRoom];
        if (!playerLayout) { ctx.restore(); return; }

        if (isFullscreen) {
            ctx.translate(mapState.offsetX / dpr, mapState.offsetY / dpr);
        } else {
            const centerX = playerLayout.x + playerLayout.w / 2;
            const centerY = playerLayout.y + playerLayout.h / 2;
            const translateX = (rect.width / 2) - (centerX * mapState.scale);
            const translateY = (rect.height / 2) - (centerY * mapState.scale);
            ctx.translate(translateX, translateY);
        }
        ctx.scale(mapState.scale, mapState.scale);
        
        const roomsToDraw = isFullscreen ? Object.keys(roomLayout) : Array.from(GameState.visitedRooms);
        
        if (isFullscreen) {
            const bounds = getMapBounds();
            const gridSize = 20;
            ctx.strokeStyle = "rgba(0, 255, 65, 0.08)";
            ctx.lineWidth = 0.5 / mapState.scale;
            for (let x = bounds.minX; x < bounds.maxX; x += gridSize) {
                ctx.beginPath(); ctx.moveTo(x, bounds.minY); ctx.lineTo(x, bounds.maxY); ctx.stroke();
            }
            for (let y = bounds.minY; y < bounds.maxY; y += gridSize) {
                ctx.beginPath(); ctx.moveTo(bounds.minX, y); ctx.lineTo(bounds.maxX, y); ctx.stroke();
            }

            ctx.strokeStyle = "rgba(0, 255, 65, 0.2)";
            ctx.lineWidth = 1 / mapState.scale;
            Object.keys(roomLayout).forEach(roomName => {
                if (rooms[roomName]?.exits) {
                    const r1Layout = roomLayout[roomName];
                    const r1x = r1Layout.x + r1Layout.w / 2;
                    const r1y = r1Layout.y + r1Layout.h / 2;
                    Object.values(rooms[roomName].exits).forEach(exitName => {
                        const r2Layout = roomLayout[exitName];
                        if (r2Layout) {
                            const r2x = r2Layout.x + r2Layout.w / 2;
                            const r2y = r2Layout.y + r2Layout.h / 2;
                            ctx.beginPath(); ctx.moveTo(r1x, r1y); ctx.lineTo(r2x, r2y); ctx.stroke();
                        }
                    });
                }
            });
        }
        
        roomsToDraw.forEach(roomName => {
            if (!rooms[roomName] || !roomLayout[roomName]) return;
            const layout = roomLayout[roomName];
            const x = layout.x, y = layout.y, w = layout.w, h = layout.h;
            const isDiscovered = GameState.visitedRooms.has(roomName);
            ctx.shadowBlur = 0;

            if (isDiscovered) {
                const isLocked = rooms[roomName].requiresKeycard && !hasItem(rooms[roomName].keyName || 'keycard');
                if (roomName === GameState.currentRoom) {
                    const pulseFactor = (Math.sin(Date.now() * 0.005) + 1) / 2;
                    ctx.fillStyle = `rgba(0, 255, 65, ${0.5 + pulseFactor * 0.4})`;
                    ctx.shadowColor = 'rgba(127, 255, 127, 1)';
                    ctx.shadowBlur = (4 + pulseFactor * 8) / mapState.scale;
                } else {
                    ctx.fillStyle = "rgba(0, 255, 65, 0.3)";
                }
                ctx.fillRect(x, y, w, h);
                ctx.shadowBlur = 0;

                ctx.strokeStyle = isLocked ? "rgba(255, 71, 76, 0.8)" : "rgba(0, 255, 65, 0.8)";
                ctx.lineWidth = 1.5 / mapState.scale;
                ctx.setLineDash([]);
                ctx.strokeRect(x, y, w, h);

                if (rooms[roomName].objects.length > 0) {
                    ctx.fillStyle = "rgba(255, 219, 88, 1)";
                    ctx.beginPath();
                    ctx.arc(x + w - 5 / mapState.scale, y + 5 / mapState.scale, 2 / mapState.scale, 0, 2 * Math.PI);
                    ctx.fill();
                }

                const baseFontSize = 12;
                const fontSize = Math.max(baseFontSize, baseFontSize / mapState.scale);
                ctx.font = `${fontSize}px VT323`;
                ctx.shadowColor = 'rgba(0, 0, 0, 0.9)';
                ctx.shadowBlur = 3 / mapState.scale;
                ctx.shadowOffsetX = 1 / mapState.scale;
                ctx.shadowOffsetY = 1 / mapState.scale;
                
                ctx.fillStyle = "white";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(layout.name, x + w / 2, y + h / 2 + 1);
                
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;

            } else if (isFullscreen) { 
                ctx.strokeStyle = "rgba(0, 255, 65, 0.25)";
                ctx.lineWidth = 1 / mapState.scale;
                ctx.setLineDash([3 / mapState.scale, 2 / mapState.scale]);
                ctx.strokeRect(x, y, w, h);
                ctx.setLineDash([]);
            }
        });
        
        const playerX = playerLayout.x + playerLayout.w / 2;
        const playerY = playerLayout.y + playerLayout.h / 2;
        ctx.fillStyle = "#FF2A7F";
        ctx.beginPath();
        ctx.arc(playerX, playerY, 3 / mapState.scale, 0, 2 * Math.PI);
        ctx.fill();
        ctx.strokeStyle = "white";
        ctx.lineWidth = 0.5 / mapState.scale;
        ctx.stroke();

        ctx.restore();
    }
    
    function toggleMapFullscreen() {
        const isFullscreen = UI.mapPanel.classList.toggle('fullscreen');
        UI.mapExpandIcon.classList.toggle('hidden', isFullscreen);
        UI.mapMinimizeIcon.classList.toggle('hidden', !isFullscreen);
        if (!isFullscreen) {
            mapState.scale = 1;
        }
        setTimeout(() => {
            const playerLayout = roomLayout[GameState.currentRoom];
            if (!playerLayout) return;
            mapState.offsetX = (UI.mapCanvas.width / (window.devicePixelRatio||1) / 2) - (playerLayout.x + playerLayout.w / 2) * mapState.scale;
            mapState.offsetY = (UI.mapCanvas.height / (window.devicePixelRatio||1) / 2) - (playerLayout.y + playerLayout.h / 2) * mapState.scale;
        }, 50);
    }
    
    function initMapControls() {
        const canvas = UI.mapCanvas;
        
        const getEventCoords = (e) => {
            if (e.touches && e.touches.length) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }

        const handleDragStart = (e) => {
            if (!UI.mapPanel.classList.contains('fullscreen')) return;
            mapState.isDragging = true;
            const coords = getEventCoords(e);
            mapState.lastX = coords.x;
            mapState.lastY = coords.y;
            canvas.style.cursor = 'grabbing';
        };

        const handleDragMove = (e) => {
            if (!mapState.isDragging || !UI.mapPanel.classList.contains('fullscreen')) return;
            e.preventDefault();
            const coords = getEventCoords(e);
            const dX = coords.x - mapState.lastX;
            const dY = coords.y - mapState.lastY;
            mapState.offsetX += dX;
            mapState.offsetY += dY;
            mapState.lastX = coords.x;
            mapState.lastY = coords.y;
        };

        const handleDragEnd = () => {
            mapState.isDragging = false;
            canvas.style.cursor = 'grab';
        };
        
        const handleWheel = (e) => {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const zoomFactor = 1.1;
            const oldScale = mapState.scale;
            let newScale;

            if (e.deltaY < 0) {
                newScale = oldScale * zoomFactor;
            } else {
                newScale = oldScale / zoomFactor;
            }
            newScale = Math.max(0.3, Math.min(newScale, 5));

            if (UI.mapPanel.classList.contains('fullscreen')) {
                mapState.offsetX = mouseX - (mouseX - mapState.offsetX) * (newScale / oldScale);
                mapState.offsetY = mouseY - (mouseY - mapState.offsetY) * (newScale / oldScale);
            }
            mapState.scale = newScale;
        };

        canvas.addEventListener('mousedown', handleDragStart);
        window.addEventListener('mousemove', handleDragMove);
        window.addEventListener('mouseup', handleDragEnd);
        canvas.addEventListener('mouseleave', handleDragEnd);

        canvas.addEventListener('touchstart', handleDragStart, { passive: false });
        window.addEventListener('touchmove', handleDragMove, { passive: false });
        window.addEventListener('touchend', handleDragEnd);
        
        canvas.addEventListener('wheel', handleWheel, { passive: false });
    }
    
    function gameLoop() {
        if (!GameState.exitGame) {
            drawMap();
            animationFrameId = requestAnimationFrame(gameLoop);
        }
    }

    function showHistory() {
        let historyHtml = commandHistory.slice(-20).map((cmd, i) => `<div>${i + 1}: ${cmd}</div>`).join('');
        typeWriter(UI.gameOutput, t('command_history_title') + '\n' + historyHtml, '#cccccc');
    }

    function undoLastAction() {
        if (stateSnapshots.length > 1) {
            stateSnapshots.pop(); 
            const prevState = stateSnapshots[stateSnapshots.length - 1];
            GameState = JSON.parse(JSON.stringify(prevState));
            GameState.visitedRooms = new Set(prevState.visitedRooms);
            GameState.dialogue.askedQuestions = new Set(prevState.dialogue.askedQuestions || []);
             GameState.roomsWithDroppedItems = new Set(prevState.roomsWithDroppedItems || []);
            GameState.achievements = prevState.achievements || [];
            updateUI();
            typeWriter(UI.gameOutput, t('undo_success'), "#ffdb58");
        } else {
            typeWriter(UI.gameOutput, t('undo_fail'), "#ff474c");
        }
    }
    
    function toggleDebug() {
        GameState.debugMode = !GameState.debugMode;
        typeWriter(UI.gameOutput, t('debug_mode_toggle', {status: GameState.debugMode ? t('enabled') : t('disabled')}), '#6495ed');
    }
    
    function toggleColorblind() {
        GameState.settings.colorblindMode = !GameState.settings.colorblindMode;
        saveSettings();
        typeWriter(UI.gameOutput, t('colorblind_mode_toggle', {status: GameState.settings.colorblindMode ? t('enabled') : t('disabled')}), '#6495ed');
    }

    function updateAutocomplete() {
        const value = UI.playerInput.value.toLowerCase();
        if (!value) {
            UI.autocompleteBox.classList.add('hidden');
            return;
        }

        const allCommands = Object.keys(commandAliases[currentLanguage] || commandAliases['en']);
        const roomObjects = rooms[GameState.currentRoom]?.objects || [];
        const inventoryItems = GameState.inventory.map(i => i.name);
        const allWords = [...new Set([...allCommands, ...roomObjects, ...inventoryItems])];
        
        const suggestions = allWords.filter(w => w.toLowerCase().startsWith(value)).slice(0, 5);

        if (suggestions.length > 0) {
            UI.autocompleteBox.innerHTML = suggestions.map(s => `<div class="autocomplete-item" data-suggestion="${s}">${s}</div>`).join('');
            UI.autocompleteBox.classList.remove('hidden');
        } else {
            UI.autocompleteBox.classList.add('hidden');
        }
    }


    // --- EVENT LISTENERS & INITIALIZATION ---
    window.addEventListener('beforeunload', saveStateToSession);
    window.addEventListener('DOMContentLoaded', () => {
        // Load player choices first to pre-populate the setup screen
        loadPlayerChoices();

        UI.playerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { 
                const input = UI.playerInput.value.trim(); 
                if(input) { processPlayerInput(input); }
            } else if (e.key === 'ArrowUp') { e.preventDefault(); if (commandHistory.length > 0) { commandHistoryIndex = Math.max(0, commandHistoryIndex - 1); UI.playerInput.value = commandHistory[commandHistoryIndex] || ''; }
            } else if (e.key === 'ArrowDown') { e.preventDefault(); if (commandHistory.length > 0) { commandHistoryIndex = Math.min(commandHistory.length, commandHistoryIndex + 1); UI.playerInput.value = commandHistory[commandHistoryIndex] || ''; } }
        });
        
        UI.playerInput.addEventListener('input', updateAutocomplete);
        UI.autocompleteBox.addEventListener('click', (e) => {
            if (e.target.matches('.autocomplete-item')) {
                UI.playerInput.value = e.target.dataset.suggestion;
                UI.autocompleteBox.classList.add('hidden');
                UI.playerInput.focus();
            }
        });

        UI.gameOutput.addEventListener('click', (e) => {
            if (e.target.matches('.clickable-object')) {
                const objectName = e.target.dataset.objectName;
                UI.playerInput.value = `examine ${objectName}`;
                UI.playerInput.focus();
            }
        });

        const setupButtonClick = (button, handler, ...args) => {
            if (!button) return;
            button.addEventListener('click', async () => {
                await initializeAudio();
                playSound('uiClick');
                handler(...args);
            });
        };

        setupButtonClick(UI.newGameBtn, () => { 
            sessionStorage.removeItem('synapse_session_v15_autosave'); 
            sessionStorage.removeItem('synapse_session_v15_screen_state'); 
            UI.startScreen.classList.add('hidden'); 
            UI.startScreen.classList.remove('flex');
            UI.playerSetup.classList.remove('hidden'); 
            UI.playerSetup.classList.add('flex'); 
            updateAbilityDisplay(); 
        });
        setupButtonClick(UI.loadGameBtn, () => { 
            sessionStorage.removeItem('synapse_session_v15_autosave'); 
            sessionStorage.removeItem('synapse_session_v15_screen_state'); 
            loadGame(); 
        });
        setupButtonClick(UI.backToStartBtn, () => {
            UI.playerSetup.classList.add('hidden');
            UI.playerSetup.classList.remove('flex');
            UI.startScreen.classList.remove('hidden');
            UI.startScreen.classList.add('flex');
        });
        setupButtonClick(UI.viewFeaturesBtn, showFeaturesModal);
        setupButtonClick(UI.startSettingsBtn, () => showSettingsModal(false));
        setupButtonClick(UI.startGameBtn, startGame);
        setupButtonClick(UI.viewBackstoriesBtn, showBackstoryModal);
        setupButtonClick(UI.statusBtn, showStatusModal);
        setupButtonClick(UI.viewProgressionBtn, showProgressionModal);
        setupButtonClick(UI.mapToggleBtn, toggleMapFullscreen);
        setupButtonClick(UI.mapLayersBtn, () => { showGuidance("Map layer functionality is not yet implemented."); });
        
        const setupLangEnBtn = UI.setupLangButtons.children[0];
        const setupLangSvBtn = UI.setupLangButtons.children[1];
        setupButtonClick(UI.langEnBtn, setLanguage, 'en');
        setupButtonClick(UI.langSvBtn, setLanguage, 'sv');
        setupButtonClick(setupLangEnBtn, setLanguage, 'en');
        setupButtonClick(setupLangSvBtn, setLanguage, 'sv');

        setupButtonClick(UI.setupSettingsBtn, () => showSettingsModal(false));
        setupButtonClick(UI.setupFeaturesBtn, showFeaturesModal);

        UI.difficultyBtns.forEach(btn => { setupButtonClick(btn, () => { UI.difficultyBtns.forEach(b => b.classList.remove('button-primary')); btn.classList.add('button-primary'); updateAbilityDisplay(); }); });
        UI.playerBackstoryInput.addEventListener('input', updateAbilityDisplay);
        
        if (SpeechRecognition) {
            setupButtonClick(UI.micBtn, startSpeechRecognition);
        } else {
            UI.micBtn.style.display = 'none';
        }

        let restored = false;

        if (loadStateFromSession()) {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            gameLoop();
            restored = true;
        } 
        else {
            const screenStateData = sessionStorage.getItem('synapse_session_v15_screen_state');
            if (screenStateData) {
                try {
                    const startState = JSON.parse(screenStateData);
                    // Language is already set by loadPlayerChoices, no need to re-set here
                    // setLanguage(startState.language || 'en'); 

                    if (startState.isPlayerSetupVisible) {
                        UI.startScreen.classList.add('hidden');
                        UI.startScreen.classList.remove('flex');
                        UI.playerSetup.classList.remove('hidden');
                        UI.playerSetup.classList.add('flex');
                        
                        UI.playerNameInput.value = startState.playerName || '';
                        UI.playerBackstoryInput.value = startState.playerBackstory || '';
                        UI.difficultyBtns.forEach(btn => btn.classList.remove('button-primary'));
                        const difficultyBtn = Array.from(UI.difficultyBtns).find(b => b.dataset.difficulty === startState.difficulty) || UI.difficultyBtns[1];
                        difficultyBtn.classList.add('button-primary');
                        updateAbilityDisplay();
                    }
                    restored = true;
                } catch (e) {
                    console.error("Failed to restore screen state:", e);
                    sessionStorage.removeItem('synapse_session_v15_screen_state');
                }
            }
        }

        if (!restored) {
            resetGameState();
            // Language is already set by loadPlayerChoices, no need to re-set here
            // setLanguage('en'); 
            setTimeout(() => {
                const playerLayout = roomLayout[GameState.currentRoom];
                if(playerLayout && UI.mapCanvas.offsetWidth > 0 && UI.mapCanvas.offsetHeight > 0) {
                     mapState.offsetX = (UI.mapCanvas.offsetWidth / 2) - (playerLayout.x + playerLayout.w / 2) * mapState.scale;
                     mapState.offsetY = (UI.mapCanvas.offsetHeight / 2) - (playerLayout.y + playerLayout.h / 2) * mapState.scale;
                }
            }, 100);
        }

        initMapControls();
        setupBackgroundAnimation();
    });
    </script>
</body>
</html>
