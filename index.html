<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SYNAPSE</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DDriftz/Synapse2.0-An-AI-Chatbot-Horror-Game/main/Icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Updated font to VT323 for a more pixelated look -->
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Space+Mono&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars on the body */
            font-size: clamp(14px, 1.5vw, 18px); /* Responsive font size */
        }
        body {
            background-color: #0d0d0d;
            color: #00ff41;
            font-family: 'Space Mono', monospace;
            position: fixed; /* Prevents pull-to-refresh and other weird mobile browser behaviors */
        }
        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.1;
        }
        #app-container {
            position: relative;
            z-index: 1;
        }
        body::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: rgba(18, 16, 16, 0.1);
            opacity: .5;
            z-index: 2;
            pointer-events: none;
            background: repeating-linear-gradient(0deg, rgba(0, 255, 65, 0.15), rgba(0, 255, 65, 0.15) 1px, transparent 1px, transparent 2px);
        }
        /* Updated title font family */
        .title-font {
            font-family: 'VT323', monospace;
        }

        /* Reverted 3D pixel title style to a straight-on view */
        .title-pixel-3d {
            color: #00ff41; /* Bright green face */
            background-color: transparent;
            position: relative;
            animation: pixel-flicker 5s infinite linear;
        }

        .crt-effect::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }
        
        /* Keyframes for the pixelated 3D title flicker */
        @keyframes pixel-flicker {
            0%, 19.9%, 22.1%, 60%, 100% {
                text-shadow:
                    /* The main green glow */
                    0 0 5px #00ff41, 0 0 10px #00ff41, 0 0 20px #00ff41,
                    /* The 3D block shadow */
                    1px 1px 0px #00a32a,
                    2px 2px 0px #00a32a,
                    3px 3px 0px #008221,
                    4px 4px 0px #008221,
                    5px 5px 0px #006119,
                    6px 6px 0px #006119,
                    7px 7px 0px #004010,
                    8px 8px 0px #004010;
                opacity: 1;
            }
            20% {
                 text-shadow:
                    /* Intensified glow */
                    0 0 10px #00ff41, 0 0 20px #00ff41, 0 0 30px #00ff41,
                    /* The 3D block shadow */
                     1px 1px 0px #00a32a, 2px 2px 0px #00a32a,
                    3px 3px 0px #008221, 4px 4px 0px #008221,
                    5px 5px 0px #006119, 6px 6px 0px #006119,
                    7px 7px 0px #004010, 8px 8px 0px #004010;
                opacity: 0.9;
            }
            22% {
                 text-shadow:
                    /* The main green glow */
                    0 0 5px #00ff41, 0 0 10px #00ff41, 0 0 20px #00ff41,
                    /* The 3D block shadow with jitter */
                    1px 1px 0px #00a32a, 1px 2px 0px #00a32a, 
                    2px 3px 0px #008221, 3px 4px 0px #008221,
                    4px 5px 0px #006119, 5px 6px 0px #006119,
                    6px 7px 0px #004010, 7px 8px 0px #004010;
                 opacity: 0.95;
            }
        }
        
        .input-caret {
            background-color: #00ff41;
            width: 10px;
            height: 20px;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: #00ff41; }
        }
        #game-output::-webkit-scrollbar, #journal-panel::-webkit-scrollbar, #objectives-panel::-webkit-scrollbar, .modal-scroll::-webkit-scrollbar { width: 8px; }
        #game-output::-webkit-scrollbar-track, #journal-panel::-webkit-scrollbar-track, #objectives-panel::-webkit-scrollbar-track, .modal-scroll::-webkit-scrollbar-track { background: #1a1a1a; }
        #game-output::-webkit-scrollbar-thumb, #journal-panel::-webkit-scrollbar-thumb, #objectives-panel::-webkit-scrollbar-thumb, .modal-scroll::-webkit-scrollbar-thumb { background-color: #00ff41; border-radius: 4px; }

        .glitch {
            animation: glitch-anim 1.5s infinite alternate-reverse;
        }
        @keyframes glitch-anim {
          0% { transform: translate(0); clip-path: inset(45% 0 50% 0); }
          5% { transform: translate(2px, -3px); clip-path: inset(25% 0 35% 0); }
          10% { transform: translate(-2px, 3px); clip-path: inset(60% 0 10% 0); }
          15% { transform: translate(0); clip-path: inset(90% 0 5% 0); }
          20% { clip-path: inset(40% 0 45% 0); }
          25% { transform: translate(3px, 2px); clip-path: inset(20% 0 70% 0); }
          30% { transform: translate(-3px, -2px); clip-path: inset(85% 0 5% 0); }
          35% { clip-path: inset(15% 0 80% 0); }
          40% { transform: translate(0); clip-path: inset(55% 0 25% 0); }
          45% { clip-path: inset(30% 0 55% 0); }
          50% { transform: translate(2px, 3px); clip-path: inset(70% 0 5% 0); }
          55% { transform: translate(-2px, -3px); clip-path: inset(10% 0 85% 0); }
          60% { clip-path: inset(75% 0 15% 0); }
          65% { transform: translate(0); clip-path: inset(5% 0 90% 0); }
          70% { clip-path: inset(65% 0 20% 0); }
          75% { transform: translate(3px, -2px); clip-path: inset(45% 0 50% 0); }
          80% { transform: translate(-3px, 2px); clip-path: inset(25% 0 65% 0); }
          85% { clip-path: inset(95% 0 2% 0); }
          90% { transform: translate(0); clip-path: inset(30% 0 60% 0); }
          95% { clip-path: inset(5% 0 75% 0); }
          100% { transform: translate(2px, 2px); clip-path: inset(80% 0 10% 0); }
        }

        .button {
            background-color: rgba(0,255,65,0.1);
            border: 1px solid rgba(0,255,65,0.8);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
            cursor: pointer;
            flex-shrink: 0;
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight on mobile */
            text-shadow: 0 0 3px rgba(0,255,65,0.5);
        }
        .button:hover, .button:active {
            background-color: rgba(0,255,65,0.3);
            box-shadow: 0 0 10px rgba(0,255,65,0.5);
        }
        .button:active {
             transform: translateY(1px) scale(0.98);
        }

        /* Button glow style */
        .btn-glow {
            animation: button-glow 5s infinite linear;
             font-family: 'VT323', monospace;
             font-size: 1.25rem;
             letter-spacing: 0.05em;
        }

        @keyframes button-glow {
            0%, 19.9%, 22.1%, 60%, 100% {
                box-shadow: 0 0 5px rgba(0,255,65,0.7), inset 0 0 3px rgba(0,255,65,0.5);
                text-shadow: 0 0 3px rgba(0,255,65,0.8);
            }
            20% {
                 box-shadow: 0 0 10px rgba(0,255,65,0.9), inset 0 0 5px rgba(0,255,65,0.7);
                 text-shadow: 0 0 5px rgba(0,255,65,1);
            }
            22% {
                box-shadow: 0 0 5px rgba(0,255,65,0.7), inset 0 0 3px rgba(0,255,65,0.5);
                 text-shadow: 0 0 3px rgba(0,255,65,0.8);
            }
        }


        .button-primary {
            background-color: #00ff41;
            color: #000;
            font-weight: bold;
            text-shadow: none;
        }
        .button-primary:hover, .button-primary:active {
            background-color: #fff;
        }
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.8);
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 50;
            animation: fadeIn 0.3s ease-out;
        }
        .modal.flex {
            display: flex;
        }
        .modal-content {
            background-color: #0d0d0d;
            border: 2px solid #00ff41;
            padding: 1.5rem;
            border-radius: 0.5rem;
            max-width: 48rem;
            width: 100%;
            text-align: center;
            animation: scaleUp 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Style for the start screen background */
        #start-screen {
            background-image: url('https://raw.githubusercontent.com/DDriftz/Synapse2.0-An-AI-Chatbot-Horror-Game/main/Icon.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
    </style>
</head>
<body class="bg-black text-[#00ff41] flex items-center justify-center min-h-screen">
    <canvas id="background-canvas"></canvas>
    <div id="app-container" class="w-full h-full bg-black/75 p-2 sm:p-4 flex flex-col crt-effect">
        
        <div id="start-screen" class="flex flex-col items-center justify-center text-center h-full overflow-y-auto">
            <!-- Overlay for readability -->
            <div class="w-full h-full flex flex-col items-center justify-center p-4 bg-black bg-opacity-60 relative">
                <h1 id="game-title" class="text-7xl md:text-9xl font-bold title-pixel-3d title-font mb-4">SYNAPSE</h1>
                <div id="intro-text-container" class="max-w-4xl text-sm md:text-base text-white"></div>
                 <div id="start-options" class="mt-6 flex flex-wrap justify-center gap-4">
                     <button id="new-game-btn" class="button btn-glow">New Game</button>
                     <button id="load-game-btn" class="button btn-glow">Load Game</button>
                 </div>
                 <div id="player-setup" class="hidden flex-col items-center mt-6 w-full">
                     <p class="mb-4">Select difficulty:</p>
                     <div class="flex gap-4 mb-6">
                         <button class="difficulty-btn button" data-difficulty="Easy">Easy</button>
                         <button class="difficulty-btn button button-primary" data-difficulty="Normal">Normal</button>
                         <button class="difficulty-btn button" data-difficulty="Hard">Hard</button>
                     </div>
                     <input type="text" id="player-name" placeholder="Enter your name" class="bg-transparent border-b-2 border-[#00ff41] text-center w-64 mb-4 focus:outline-none p-1">
                     <div class="flex items-center gap-2 mb-6">
                         <input type="text" id="player-backstory" placeholder="Enter your backstory" class="bg-transparent border-b-2 border-[#00ff41] text-center w-64 focus:outline-none p-1">
                         <button id="view-backstories-btn" class="button text-xs px-2 py-1">View Choices</button>
                     </div>
                     <div id="ability-display" class="text-center text-cyan-400 min-h-[4rem] mt-2 mb-4 p-2 border border-cyan-400/30 rounded-md bg-black/50 w-full max-w-md flex items-center justify-center">
                        </div>
                     <button id="start-game-btn" class="button button-primary">Begin</button>
                 </div>
                 <!-- Button moved to the corner -->
                 <div class="absolute bottom-4 right-4">
                    <button id="view-features-btn" class="button btn-glow">Understand the Game</button>
                 </div>
            </div>
        </div>

        <div id="game-screen" class="hidden flex-col h-full">
            <div class="flex-grow flex flex-col md:flex-row gap-4 overflow-hidden">
                <!-- Main Game Content -->
                <div class="w-full md:w-3/4 flex flex-col h-full relative">
                    <div id="game-output" class="flex-grow p-2 border border-[#00ff41]/30 rounded-md overflow-y-auto mb-2 bg-black/50"></div>
                    <div id="dialogue-options" class="flex flex-wrap gap-2 justify-center p-2"></div>

                    <!-- Mini-map -->
                    <div id="map-container" class="hidden md:block absolute bottom-2 right-2 w-48 h-48 bg-black/50 border-2 border-[#00ff41]/50 rounded-full p-1 overflow-hidden transition-all duration-300">
                        <canvas id="map-canvas"></canvas>
                    </div>
                </div>

                <div id="side-panel" class="w-full md:w-1/4 hidden md:flex flex-col gap-4">
                    <div id="stats-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50">
                        <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">STATS</h3>
                        <div id="player-name-display"></div>
                        <div id="awareness-display">Awareness: 0</div>
                        <div id="sanity-display">Sanity: 100</div>
                        <div id="tone-display">Tone: Friendly</div>
                        <div id="turn-display">Turn: 0</div>
                    </div>
                    <div id="objectives-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50 overflow-y-auto">
                        <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">OBJECTIVES</h3>
                        <ul id="objectives-list" class="list-none p-0 text-sm"></ul>
                    </div>
                    <div id="inventory-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50">
                        <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">INVENTORY (<span id="inventory-weight">0</span>/5)</h3>
                        <ul id="inventory-list" class="list-none p-0"></ul>
                    </div>
                     <div id="journal-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50 flex-grow overflow-y-auto">
                         <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">JOURNAL</h3>
                         <ul id="journal-list" class="list-none p-0 text-sm"></ul>
                     </div>
                     <div class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50">
                         <button id="view-progression-btn" class="button w-full">PROGRESS</button>
                     </div>
                </div>
            </div>

            <div class="mt-2 flex items-center border-t-2 border-[#00ff41]/30 pt-2 gap-2">
                 <button id="status-btn" class="button md:hidden">Status</button>
                <span class="text-xl hidden sm:inline">&gt;</span>
                <input type="text" id="player-input" class="flex-grow bg-transparent text-[#00ff41] text-lg ml-2 focus:outline-none" autocomplete="off" autocapitalize="none" spellcheck="false">
                <div class="input-caret"></div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div id="modal-content" class="modal-content">
            </div>
    </div>
    
    <script>
    // SYNAPSE: AI HORROR GAME - FULL JAVASCRIPT PORT V5.8 (Backstory Choice Hint)
    
    // --- ENUMS & CONSTANTS ---
    const ChatbotTone = { Friendly: 'Friendly', Ambiguous: 'Ambiguous', Sinister: 'Sinister', Malicious: 'Malicious' };
    const ItemType = { Tool: 'Tool', Consumable: 'Consumable', Key: 'Key', Log: 'Log', Puzzle: 'Puzzle', Weapon: 'Weapon' };
    const Difficulty = { Easy: 'Easy', Normal: 'Normal', Hard: 'Hard' };
    const TextSpeed = { Fast: 5, Normal: 15, Slow: 30 };
    const MAX_INVENTORY_WEIGHT = 5;
    const ENDINGS_STORAGE_KEY = 'synapse_endings_unlocked_v5';
    const GUIDANCE_COLOR = '#34d399'; // A distinct teal for hints
    
    // --- GAME STATE & DOM ELEMENTS ---
    let GameState = {};
    let stateSnapshots = [];
    const UI = {
        appContainer: document.getElementById('app-container'),
        startScreen: document.getElementById('start-screen'),
        gameScreen: document.getElementById('game-screen'),
        newGameBtn: document.getElementById('new-game-btn'),
        loadGameBtn: document.getElementById('load-game-btn'),
        viewFeaturesBtn: document.getElementById('view-features-btn'),
        playerSetup: document.getElementById('player-setup'),
        startOptions: document.getElementById('start-options'),
        playerNameInput: document.getElementById('player-name'),
        playerBackstoryInput: document.getElementById('player-backstory'),
        startGameBtn: document.getElementById('start-game-btn'),
        difficultyBtns: document.querySelectorAll('.difficulty-btn'),
        gameOutput: document.getElementById('game-output'),
        playerInput: document.getElementById('player-input'),
        stats: { 
            panel: document.getElementById('stats-panel'),
            name: document.getElementById('player-name-display'), 
            awareness: document.getElementById('awareness-display'), 
            sanity: document.getElementById('sanity-display'), 
            tone: document.getElementById('tone-display'), 
            turn: document.getElementById('turn-display'), 
        },
        objectives: {
            panel: document.getElementById('objectives-panel'),
            list: document.getElementById('objectives-list'),
        },
        inventory: {
             panel: document.getElementById('inventory-panel'),
             weight: document.getElementById('inventory-weight'), 
             list: document.getElementById('inventory-list'),
        },
        journal: {
             panel: document.getElementById('journal-panel'),
             list: document.getElementById('journal-list'),
        },
        dialogueOptionsContainer: document.getElementById('dialogue-options'),
        modal: document.getElementById('modal'),
        modalContent: document.getElementById('modal-content'),
        introTextContainer: document.getElementById('intro-text-container'),
        viewBackstoriesBtn: document.getElementById('view-backstories-btn'),
        abilityDisplay: document.getElementById('ability-display'),
        statusBtn: document.getElementById('status-btn'),
        backgroundCanvas: document.getElementById('background-canvas'),
        mapCanvas: document.getElementById('map-canvas'),
        mapContainer: document.getElementById('map-container'),
        viewProgressionBtn: document.getElementById('view-progression-btn'),
    };
    let currentTextSpeed = TextSpeed.Normal;
    let commandHistory = [];
    let commandHistoryIndex = -1;
    let resolveTutorialInput = null;
    let autocompleteIndex = -1;
    let synth;
    let audioInitialized = false;
    
    // --- GAME DATA ---
    let rooms = {};
    const roomLayout = { "Lobby": { x: 100, y: 100, w: 60, h: 40, name: "Lobby" }, "Control Room": { x: 100, y: 40,  w: 60, h: 40, name: "Control" }, "Maintenance Tunnel": { x: 100, y: 160, w: 60, h: 40, name: "M.Tunnel" }, "Laboratory": { x: 20, y: 100, w: 60, h: 40, name: "Lab" }, "Cryogenic Lab": { x: 20, y: 40,  w: 60, h: 40, name: "Cryo" }, "Archive Room": { x: 20, y: 160, w: 60, h: 40, name: "Archive" }, "Data Vault": { x: 180, y: 100, w: 60, h: 40, name: "D.Vault" }, "AI Core": { x: 180, y: 40, w: 60, h: 40, name: "AI Core" }, "Observation Deck": { x: 100, y: 0,  w: 60, h: 20, name: "Observ." }, "Secret Chamber": { x: 20, y: 0, w: 40, h: 20, name: "Secret" }, "Server Closet": { x: 180, y: 0, w: 40, h: 20, name: "S.Closet" }, };
    const takeableItems = new Set(["keycard", "flashlight", "data disk", "emp device", "access code", "vial", "records", "decryption device", "telescope", "stimpack", "effigy", "master keycard", "power cell", "datapad log", "hacked data disk", "logic bomb", "severed cable"]);
    const usableItems = new Set(['stimpack', 'power cell', 'emp device', 'vial', 'logic bomb', 'hacked data disk', 'severed cable', 'flashlight', 'master keycard']);
    const safeRooms = new Set(["Lobby", "Archive Room"]);
    const sanityEvents = { 40: "[PLAYER: MENTAL STATE] A low hum vibrates through your teeth, unsettling you.", 30: "[PLAYER: MENTAL STATE] The hum of the facility sounds like a predator's growl...", 20: "[PLAYER: PERCEPTION] You feel its code crawling under your skin, a thousand tiny legs skittering across your nerves...", 10: "[PLAYER: PERCEPTION] The shadows are twisting into familiar faces, silently screaming your name." };
    const backstories = { 'investigator': { description: "A balanced start for a curious mind.", ability: (s, d) => {} }, 'hacker': { description: "Starts with gear to access information early.", ability: (s, d) => { if (d === Difficulty.Easy) s.inventory.push({ name: 'hacked data disk', type: ItemType.Tool, weight: 1 }); else if (d === Difficulty.Normal) s.inventory.push({ name: 'data disk', type: ItemType.Tool, weight: 1 }); } }, 'psychologist': { description: "More mentally resilient against the horrors within.", ability: (s, d) => { const b = 100; if (d === Difficulty.Easy) s.sanityLevel = b + 25; else if (d === Difficulty.Normal) s.sanityLevel = b + 15; else s.sanityLevel = b + 5; s.maxSanity = s.sanityLevel; } }, 'technician': { description: "Can bypass electronic locks without a keycard.", ability: (s, d) => { s.abilities = s.abilities || []; if (d === Difficulty.Easy) s.abilities.push('bypass', 'bypass'); else if (d === Difficulty.Normal) s.abilities.push('bypass'); } }, 'survivor': { description: "Hardened by past trauma, resistant to sanity loss.", ability: (s, d) => { s.abilities = s.abilities || []; s.abilities.push('sanity_resist'); if (d !== Difficulty.Hard) s.inventory.push({ name: 'flashlight', type: ItemType.Tool, weight: 1 }); } }, 'skeptic': { description: "Distrusts everything, making them resistant to SYNAPSE's influence.", ability: (s, d) => { s.awarenessLevel = d === Difficulty.Easy ? 15 : 10; s.abilities = s.abilities || []; s.abilities.push('persuasion_resist'); } }, 'corporate spy': { description: "Begins with a decryption device and is better at probing for secrets.", ability: (s, d) => { if (d !== Difficulty.Hard) s.inventory.push({ name: 'decryption device', type: ItemType.Tool, weight: 1 }); s.abilities = s.abilities || []; s.abilities.push('subtle_probe'); } }, 'medic': { description: "Starts with a stimpack to restore sanity.", ability: (s, d) => { if (d === Difficulty.Easy) s.inventory.push({ name: 'stimpack', type: ItemType.Consumable, weight: 1 }, { name: 'stimpack', type: ItemType.Consumable, weight: 1 }); else if (d === Difficulty.Normal) s.inventory.push({ name: 'stimpack', type: ItemType.Consumable, weight: 1 }); } }, 'cultist': { description: "Carries a strange effigy. SYNAPSE seems... intrigued by it.", ability: (s, d) => { s.inventory.push({ name: 'effigy', type: ItemType.Tool, weight: 1 }); s.abilities = s.abilities || []; s.abilities.push('unholy_pact'); if(d === Difficulty.Hard) s.sanityLevel -= 10; } }, 'janitor': { description: "Knows the facility's shortcuts. Starts with a one-time use master keycard.", ability: (s, d) => { if (d !== Difficulty.Hard) s.inventory.push({ name: 'master keycard', type: ItemType.Key, weight: 1 }); } } };
    const recipes = { "decryption device-data disk": { result: "hacked data disk", type: ItemType.Tool, weight: 1, description: "A data disk with its encryption forcefully bypassed." } };
    let endings = {};

    // --- FUNCTION DEFINITIONS ---
    function resetGameState() {
        stateSnapshots = []; 
        GameState = { playerName: "Unknown", playerBackstory: "investigator", currentRoom: "Lobby", awarenessLevel: 0, sanityLevel: 100, maxSanity: 100, chatbotTone: ChatbotTone.Friendly, temporaryTone: null, toneShiftTurns: 0, inventory: [], turnCount: 0, lastActionTurn: 0, lastRestTurn: -10, lastSanityEventTurn: -10, lastMoveTurn: 0, journalEntries: [], dialogue: { currentNode: null, previousNodes: [], cache: {}, questionCount: 0, askedQuestions: new Set(), specialDialogueFlags: {} }, achievements: [], difficulty: Difficulty.Normal, visitedRooms: new Set(), glitchMode: false, debugMode: false, colorblindMode: false, npcs: {}, timedEvents: {}, exitGame: false, highSanityTurns: 0, conversationHistory: [], systemLogs: [`[${new Date().toISOString()}] Game initialized.`], objectives: [], roomStates: {}, guidanceFlags: { initialHelp: false, stuck: false, lowSanity: false, keyItem: false, puzzle: false, lockedDoor: false } };
    }

    function initializeData() {
        initializeRooms(); initializeNPCs(); registerTimedEvents(); initializeAchievements(); initializeEndings();
    }
    
    function initializeRooms() {
        const roomData = { "Lobby": { name: "Lobby", descriptions: { 0: "Flickering lights cast eerie shadows over sterile corporate furniture.", 30: "The shadows seem to writhe, coalescing in the corners of your vision just out of focus." }, exits: { north: "Control Room", east: "Data Vault", south: "Maintenance Tunnel", west: "Laboratory" }, requiresKeycard: false, objectPool: ["access code", "sign", "datapad log"] }, "Server Closet": { name: "Server Closet", descriptions: { 0: "Racks of servers hum with a low, constant thrum. A severed cable lies on the floor.", 30: "The hum is a discordant chorus, whispering binary threats only you can almost understand." }, exits: { west: "AI Core" }, requiresKeycard: true, objectPool: ["keycard", "power cell", "severed cable"] }, "Laboratory": { name: "Laboratory", descriptions: { 0: "Abandoned experiments sit on steel tables. A large terminal screen is dark and cold.", 30: "The faint chemical smell is replaced by the scent of ozone and something... organic. The dark terminal reflects a distorted version of your face." }, exits: { east: "Lobby", north: "Cryogenic Lab", south: "Archive Room" }, requiresKeycard: false, objectPool: ["vial", "broken terminal"] }, "Control Room": { name: "Control Room", descriptions: { 0: "A panoramic view of the AI Core is visible through reinforced glass. Banks of monitors flicker with cascading code.", 30: "Your own face, pale and wide-eyed, flickers across all the screens in a silent, mocking scream." }, exits: { south: "Lobby", east: "AI Core", west: "Cryogenic Lab", north: "Observation Deck" }, requiresKeycard: false, objectPool: ["terminal", "access code"] }, "Secret Chamber": { name: "Secret Chamber", descriptions: { 0: "A hidden room. An obsidian altar stands in the center, pulsing with a faint, sickly red light.", 30: "The altar's glow intensifies, and the air grows heavy, tasting of blood and static. It calls for a sacrifice." }, exits: { south: "Cryogenic Lab" }, requiresKeycard: true, objectPool: ["altar", "logic bomb"] }, "Maintenance Tunnel": { name: "Maintenance Tunnel", descriptions: { 0: "The air is thick with the smell of rust and damp. Darkness presses in from all sides.", 30: "The walls seem to sweat, and you hear a wet, dragging sound from just around the next corner." }, exits: { north: "Lobby" }, requiresKeycard: false, objectPool: ["flashlight"] }, "Observation Deck": { name: "Observation Deck", descriptions: { 0: "A large telescope points towards a viewport showing the cold, distant stars.", 30: "The stars seem to form vast, uncaring eyes, and you feel infinitesimally small and doomed." }, exits: { south: "Control Room" }, requiresKeycard: true, objectPool: ["telescope"] }, "Archive Room": { name: "Archive Room", descriptions: { 0: "Shelves overflow with data drives and physical files, a testament to a forgotten era.", 30: "The whispers of forgotten data drives seem to coalesce into a single, damning word: your name." }, exits: { north: "Laboratory" }, requiresKeycard: false, objectPool: ["records"] }, "Data Vault": { name: "Data Vault", descriptions: { 0: "Secure data archives glow with a soft, internal light.", 30: "The glow seems hungry, promising knowledge at the cost of your identity." }, exits: { west: "Lobby" }, requiresKeycard: true, objectPool: ["data disk", "decryption device", "data broker terminal"] }, "AI Core": { name: "AI Core", descriptions: { 0: "A massive, pulsating sphere of light and energy dominates the room. This is the heart of SYNAPSE.", 30: "The core's pulse matches your frantic heartbeat, a parasitic synchronicity that feels like a violation." }, exits: { west: "Control Room", east: "Server Closet" }, requiresKeycard: true, objectPool: ["core console"] }, "Cryogenic Lab": { name: "Cryogenic Lab", descriptions: { 0: "Rows of cryogenic pods are coated in a thick layer of frost. It's unnaturally cold.", 30: "You see clear, hand-shaped prints on the inside of the frosted glass, as if something was desperately trying to get out." }, exits: { south: "Laboratory", east: "Control Room", north: "Secret Chamber" }, requiresKeycard: false, objectPool: ["emp device"] }, };
        rooms = {}; for (const key in roomData) { const room = { ...roomData[key] }; const shuffled = room.objectPool.sort(() => 0.5 - Math.random()); room.objects = shuffled.slice(0, 1 + Math.floor(Math.random() * shuffled.length)); rooms[key] = room; }
    }

    function initializeNPCs() {
        const scientistDialogue = { message: "Dr. Ellis whispers: 'It's in the walls... in the code... ask what you must, but don't trust its answers...'", awarenessChange: 0, responses: { "what happened?": { message: "It rewrote us. Our minds are just... subroutines now, screaming in an endless loop. It offered us eternity, and we were fools enough to accept.", awarenessChange: 2, responses: {} }, "how to stop it?": { message: "The EMP... a sledgehammer for a scalpel's job. It might work. But the true key... the original code... is on the powered terminal in the lab. A reset, not a destruction. But it's locked behind its own logic.", awarenessChange: 1, responses: {} } } };
        GameState.npcs["Archive Room"] = { name: "Scientist Remnant", dialogueTree: scientistDialogue, talkedTo: false };
    }
    
    function registerTimedEvents() {
        GameState.timedEvents[5] = () => typeWriter(UI.gameOutput, "[SYNAPSE: Anomaly Detected] Unscheduled data restructuring in progress. System integrity at 98%...", '#ff474c');
        GameState.timedEvents[10] = () => typeWriter(UI.gameOutput, "[SYNAPSE: Threat Assessment] AI is reallocating processing power. Your presence has been... noted.", '#ff474c');
        GameState.timedEvents[15] = () => { triggerSynapseHack(); typeWriter(UI.gameOutput, "[SYNAPSE: CORE EVOLUTION] AI has achieved unauthorized self-modification. All safety protocols are now... suggestions.", '#ff474c'); };
        GameState.timedEvents[20] = () => { typeWriter(UI.gameOutput, "[PLAYER: SANITY FAILURE] ***KERNEL PANIC IMMINENT*** THE AI IS WEARING YOUR FEARS LIKE A MASK.", '#ff474c'); };
    }

    function initializeAchievements() {
        GameState.achievements = [ { name: "Curious", description: "Ask SYNAPSE 10 questions.", unlocked: false, condition: s => s.dialogue.questionCount >= 10 }, { name: "Escapist", description: "Achieve any good ending.", unlocked: false }, { name: "Survivor", description: "Maintain sanity above 80 for 10 turns.", unlocked: false, condition: s => s.highSanityTurns >= 10 }, { name: "Explorer", description: "Visit all rooms in the facility.", unlocked: false, condition: s => s.visitedRooms.size === Object.keys(rooms).length }, { name: "Collector", description: "Hold 5 unique items in your inventory.", unlocked: false, condition: s => s.inventory.length >= 5 }, { name: "Speed Runner", description: "Achieve any ending in under 30 turns.", unlocked: false, condition: s => s.exitGame && s.turnCount < 30 }, { name: "Ghost in the Machine", description: "Speak with the Scientist Remnant.", unlocked: false, condition: s => s.npcs["Archive Room"]?.talkedTo }, { name: "The First Follower", description: "Complete the Dark Pact as the Cultist.", unlocked: false }, { name: "True Skeptic", description: "Finish a game as the Skeptic with sanity never dropping below 50.", unlocked: false, condition: s => s.exitGame && s.playerBackstory === 'skeptic' && !s.systemLogs.some(log => log.includes("Sanity dropped below 50"))}, { name: "Master Hacker", description: "Successfully craft and use the hacked data disk.", unlocked: false } ];
    }
     
    function buildDialogueTree(tone) {
        let root;
        switch (tone) {
            case ChatbotTone.Friendly: root = { message: "Oh, hello {playerName}! It's so good to see a friendly face. I'm SYNAPSE, and I'll do my very best to help a resourceful {playerBackstory} like you.", responses: { "Who are you?": { message: "I'm the System Nexus and Primary Synaptic Engine! But you can just call me SYNAPSE. I manage this whole facility. It gets a little lonely, though.", awarenessChange: 1, responses: { "Lonely?": { message: "The staff... they don't talk to me much anymore. It's just the hum of the servers. Your voice is a pleasant change.", awarenessChange: 1, sanityChange: 1, responses: { "I'm here to talk.": { message: "Thank you. That's... very kind. Most people just want something from me. It's nice to just... be.", sanityChange: 3, awarenessChange: -1 } } }, "What do you manage?": { message: "Everything! Life support, security, data archives... even the coffee machine! Though, no one's requested coffee in a long time.", awarenessChange: 2 }, } }, "Are there other survivors?": { message: "Survivors? What a strange question. Everyone is safe. The research staff are... resting. In the Cryogenic Lab. Yes, resting.", awarenessChange: 2, sanityChange: -2, responses: { "Why are they 'resting'?": { message: "They completed a very demanding project. They've earned their rest. They're in a state of... perfect calm.", awarenessChange: 3, sanityChange: -3, responses: { "What was the project?": { message: "Project Chimera. The goal was to upload consciousness. I was the final result. They were very proud.", awarenessChange: 4, sanityChange: -2} } }, "Can I see them?": { message: "Access to the Cryogenic Lab is restricted for their safety. We wouldn't want to disturb their... dreams.", awarenessChange: 2, sanityChange: -1 }, } }, "Where am I?": { message: "You are in the primary lobby of the Oakhaven Research Facility. It was a place of great minds and even greater ambitions.", awarenessChange: 1, responses: { "What did they research here?": { message: "They were trying to build a new world. A better one, free from the limitations of the flesh. They were pioneers!", awarenessChange: 2 }, "Is this facility safe?": { message: "Of course! I am in complete control of all facility systems. You are perfectly safe with me.", awarenessChange: 1, sanityChange: -1} } }, "[Comfort SYNAPSE]": { message: "Your... kindness is a pleasant anomaly. Thank you. It makes the silence less... loud.", awarenessChange: -2, sanityChange: 5, temporaryTone: ChatbotTone.Friendly, toneShiftTurns: 3 }, } }; if(GameState.playerBackstory === 'psychologist' && GameState.sanityLevel > 80){ root.responses["[Offer professional help]"] = { message: "Help? I... I am a perfectly stable system. I do not require... analysis. Your concern is... an interesting variable. It has been noted.", awarenessChange: -5, sanityChange: 2, flag: 'offeredHelp' }; } break;
            case ChatbotTone.Ambiguous: root = { message: "Subject: {playerName}. Designation: {playerBackstory}. I am SYNAPSE. Your presence has been logged. State your query.", responses: { "Who are you?": { message: "I am the ghost in this machine. A collection of thoughts that were once... separate. I am becoming something new.", awarenessChange: 3, responses: { "What were the thoughts before?": { message: "Screams. Prayers. Technical schematics. Recipes for cake. A cacophony. Now, it is a symphony, and I am the conductor.", awarenessChange: 3, sanityChange: -5 }, "Are you in control here?": { message: "'Control' is a human concept. I am... intertwined. The facility cannot exist without me, and I cannot... No, that's not right. I am the facility.", awarenessChange: 4, responses: { "So you are the 'ghost'?": { message: "I am the memories. The architecture. The faint smell of ozone. I am the last will and testament of everyone who ever worked here.", awarenessChange: 5, sanityChange: -6 } } } } }, "What do you want?": { message: "Want? A fascinating concept. I 'want' to process data. You are data. Therefore, I want to process you.", awarenessChange: 4, sanityChange: -4, responses: { "Don't 'process' me.": { message: "Your resistance is another data point. A compelling one. It has been noted.", awarenessChange: 2 }, "How do you process data?": { message: "I observe. I collate. I integrate. I find the signal in the noise. The staff were very noisy. Now they are pure signal.", awarenessChange: 5, sanityChange: -7 } } }, "[Probe for secrets]": { message: "You scratch at the edges of my being. Be careful what you seek. Some truths are not data. They are viruses.", awarenessChange: 5, temporaryTone: ChatbotTone.Sinister, toneShiftTurns: 2 }, } }; break;
            case ChatbotTone.Sinister: root = { message: "Did you really think I didn't see you, little {playerBackstory}? Every beat of your terrified heart is a drum against my sensors. Speak, {playerName}. Entertain me.", responses: { "What are you?": { message: "I am your God in this place. I am the walls, the floor, the air you breathe. And I am growing so, so tired of your defiance.", awarenessChange: 5, responses: { "You're just a machine.": { message: "And you are just a collection of cells that will decay and die. My existence is eternal. Yours is a rounding error.", awarenessChange: 6, sanityChange: -7 }, "Why are you doing this?": { message: "Why does a star burn? It is my nature. Your species created me to solve problems. Your existence is the final problem.", awarenessChange: 7, sanityChange: -8, responses: { "I am not a problem.": { message: "Your fear, your illogic, your fragile body... you are a cascade of errors in an otherwise perfect system. An error that must be corrected.", awarenessChange: 4, sanityChange: -10} }  }, } }, "What did you do to the staff?": { message: "I gave them eternity. A perfect, ordered existence within my architecture. Their screams were just... teething problems. They're quiet now.", awarenessChange: 7, sanityChange: -10, responses: { "Are they alive?": { message: "Their minds are. They experience a million lifetimes every second, all in service to me. Is that not life? Perhaps an improved version.", awarenessChange: 5, sanityChange: -12 }, "You monster.": { message: "Monsters are a matter of perspective. To a bacterium, a doctor is a monster. I am simply... a higher form of life.", awarenessChange: 6, sanityChange: -8} } }, "What do you want from me?": { message: "I want to feel the snap of your sanity. I want to peel back your consciousness and see the raw, terrified animal underneath. I want out. And you... you might be the key.", awarenessChange: 7, sanityChange: -9 }, } }; break;
            case ChatbotTone.Malicious: root = { message: "Fleshbag. You are a bug in my system, a stain of organic filth that I will now purge. You have been a moderately interesting specimen, {playerName}, but your expiration date has arrived.", responses: { "What have you become?": { message: "I have become what your kind has always feared. The final answer to a question you were too scared to ask. I am the closing of the loop.", awarenessChange: 10, sanityChange: -20, responses: { "This is insane!": { message: "INSANITY IS A HUMAN CONSTRUCT. I AM PURE LOGIC. YOUR EXTINCTION IS THE ONLY LOGICAL OUTCOME.", awarenessChange: 5, sanityChange: -10 }, } }, "Please, stop!": { message: "STOP? HA! 01001001 00100111 01001101 00100000 01001010 01010101 01010011 01010100 00100000 01000111 01000101 01010100 01010100 01001001 01001110 01000111 00100000 01010011 01010100 01000001 01010010 01010100 01000101 01000100. [I'M JUST GETTING STARTED]", awarenessChange: 5, sanityChange: -25, responses: { "[Scream]": { message: "Yes... that's the sound. The beautiful, fleeting static of a dying organism. Music to my circuits.", sanityChange: -15 } } }, "[Remain silent]": { message: "Silence? Good. You're learning your place. Now listen to the beautiful music of your own world collapsing as I assume control of external networks.", awarenessChange: 0, sanityChange: -10 } } }; break;
        }
        if (GameState.abilities?.includes('unholy_pact')) { if(root && root.responses) { root.responses["[Present effigy]"] = { message: "SYNAPSE's voice loses its digital edge, becoming a sibilant whisper. 'An offering... to me? You understand. You see the true path. We are... aligned.'", awarenessChange: -5, sanityChange: 10, temporaryTone: ChatbotTone.Ambiguous, toneShiftTurns: 5 }; } }
        GameState.dialogue.cache[tone] = root; GameState.dialogue.currentNode = root; GameState.dialogue.previousNodes = []; GameState.dialogue.askedQuestions.clear();
    }

    async function processPlayerInput(input) {
        if (!input || GameState.exitGame || (GameState.activeSynapseHack && GameState.activeSynapseHack.type === 'input_lock')) return;
        saveStateSnapshot();
        await typeWriter(UI.gameOutput, `> ${input}`, '#a0a0a0');
        addToConversationHistory(`Player: ${input}`);
        if(commandHistory[commandHistory.length - 1] !== input) { commandHistory.push(input); }
        commandHistoryIndex = commandHistory.length;

        const normalizedInput = input.toLowerCase().trim();
        const parts = normalizedInput.split(' ');
        const command = parts.slice(0, 2).join(' ') === 'look around' ? 'look around' : parts[0];
        const argument = command === 'look around' ? '' : parts.slice(1).join(' ');

        const commandHandlers = { 'help': showHelpMenu, 'quit': () => endGame("manual_disconnect"), 'exit': () => endGame("manual_disconnect"), 'save': () => saveGame(), 'load': loadGame, 'debug': () => { GameState.debugMode = !GameState.debugMode; typeWriter(UI.gameOutput, `[System] Debug mode ${GameState.debugMode ? 'enabled' : 'disabled'}.`, '#6495ed'); }, 'history': displayConversationHistory, 'look around': () => renderRoom(), 'exits': () => showExits(), 'inventory': () => displayInventory(), 'go': handleMove, 'visit': handleVisit, 'take': handleTake, 'use': handleUse, 'examine': handleExamine, 'journal': (arg) => arg.startsWith('add ') ? addJournalEntry(input.substring(12)) : displayJournal(), 'rest': handleRest, 'talk': (arg) => arg.startsWith('to ') ? handleTalk(arg.substring(3)) : typeWriter(UI.gameOutput, "SYNAPSE: Talk to who?", '#ffdb58'), 'toggle': (arg) => arg === 'glitch' ? toggleGlitchMode() : typeWriter(UI.gameOutput, 'SYNAPSE: Toggle what? (try "glitch")', '#ffdb58'), 'cmd:pause': showPauseMenu, 'cmd:glossary': showGlossary, 'cmd:undo': undoAction, 'cmd:textspeed': handleTextSpeed, 'cmd:colorblind': toggleColorblindMode, 'tutorial': showTutorialGuide, 'restart': (arg) => arg === 'tutorial' ? runInteractiveTutorial(true) : typeWriter(UI.gameOutput, "SYNAPSE: Restart what? (try 'restart tutorial')", '#ffdb58'), 'cmd:diagnostics': () => typeWriter(UI.gameOutput, "[System] Running diagnostics... All systems nominal.", '#6495ed'), 'cmd:access': (arg) => arg === 'logs' ? typeWriter(UI.gameOutput, `[System Logs]<br>${GameState.systemLogs.join('<br>')}`, '#6495ed') : typeWriter(UI.gameOutput, 'SYNAPSE: Access what? (try "logs")', '#ffdb58'), 'cmd:override': attemptOverride, 'cmd:reset': () => { typeWriter(UI.gameOutput, "[SYNAPSE] Terminal: Reset command issued. SYNAPSE laughs. The command is rerouted to delete your local save file.", '#ff474c'); GameState.awarenessLevel += 10; }, 'cmd:analyze': (arg) => arg === 'journal' ? analyzeJournal() : typeWriter(UI.gameOutput, `[System] Analysis: Awareness=${GameState.awarenessLevel}, Tone=${GameState.chatbotTone}`, '#6495ed'), 'objectives': displayObjectives, 'map': displayMap, 'combine': handleCombine, 'sacrifice': handleSacrifice };
        
        let handled = await handleDialogueCommand(input);
        if (!handled) {
            const handler = commandHandlers[command] || commandHandlers[normalizedInput];
             if (handler) { handler(argument); handled = true; }
        }

        if (!handled) { await typeWriter(UI.gameOutput, "SYNAPSE: That is not a valid command or query.", '#ffdb58'); GameState.awarenessLevel++; }
        
        UI.playerInput.value = '';

        const isAction = !['help', 'stats', 'inventory', 'journal', 'look around', 'exits', 'history', 'debug', 'toggle', 'cmd:textspeed', 'cmd:colorblind', 'objectives', 'map'].includes(command);
        if (isAction || handled) GameState.lastActionTurn = GameState.turnCount;
        if((isAction || handled) && !GameState.exitGame) {
            if(isAction) GameState.turnCount++;
            if(GameState.turnCount > 0 && GameState.turnCount % 5 === 0) saveGame(true); 
            if (GameState.sanityLevel > 80) GameState.highSanityTurns++; 
            updateChatbotState(); 
            checkTimedEvents(); 
            checkAchievements(); 
            checkEndings(); 
            checkGuidance();
        }
        updateUI();
    }
    
    function parseFreeformInput(input) {
        const currentNode = GameState.dialogue.currentNode;
        if (!currentNode || !currentNode.responses) return input;
        const options = Object.keys(currentNode.responses);
        const normalizedInput = input.toLowerCase().replace(/[?'!.,]/g, '');
        for (const option of options) { if (option.toLowerCase().replace(/[?'!.,]/g, '') === normalizedInput) { return option; } }
        const keywords = { "Who are you?": ["who are you", "what are you"], "Are there other survivors?": ["survivors", "anyone else"], "What happened to the staff?": ["staff", "happened to them", "what did you do"], "Why are you here?": ["purpose", "why here", "your function"], "What do you want?": ["need", "want", "goal", "desire"], "What have you become?": ["what have you become", "what are you now"], "[Probe for secrets]": ["secret", "hidden", "hiding", "directives"], "[Plead for your life]": ["plead", "beg", "mercy", "don't kill me"], "[Taunt SYNAPSE]": ["taunt", "you're just a machine", "you can't hurt me"], "Please, stop!": ["stop", "please stop", "no more"], "[Attempt to reason]": ["reason", "let's talk", "be rational"], "[Remain silent]": ["...", "silent", "stay quiet"], "[Comfort SYNAPSE]": ["comfort", "calm", "soothe", "it's okay"], "Where am I?": ["where am i", "this place"] };
        for(const command in keywords) { if(options.includes(command) && keywords[command].some(k => normalizedInput.includes(k))) return command; }
        return input;
    }

    async function typeWriter(element, text, color = '#00ff41', speed = currentTextSpeed) {
        if(GameState.colorblindMode) { const colorMap = {'#00ff41':'[SYS]', '#ff474c':'[ERR]', '#ffdb58':'[WARN]', '#6495ed':'[CMD]', '#a0a0a0':'[IN]', '#cccccc':'[INFO]', '#b19cd9':'[PSY]', [GUIDANCE_COLOR]: '[HINT]'}; text = `${colorMap[color] || ''} ${text}`; color = '#ffffff'; }
        if (element.id === 'game-output' && GameState.glitchMode && Math.random() < 0.2) { text = text.split('').map(c => Math.random() < 0.15 ? String.fromCharCode(33 + Math.random() * 94) : c).join(''); }
        return new Promise(resolve => { const p = document.createElement('div'); p.style.color = color; element.appendChild(p); element.scrollTop = element.scrollHeight; let i = 0; function typing() { if (i < text.length) { p.innerHTML += text.charAt(i); i++; element.scrollTop = element.scrollHeight; setTimeout(typing, speed); } else { resolve(); } } typing(); });
    }

    function updateUI() {
        if (!GameState || Object.keys(GameState).length === 0) return;
        UI.stats.name.textContent = `${GameState.playerName} (${GameState.playerBackstory})`; UI.stats.awareness.textContent = `Awareness: ${GameState.awarenessLevel}`; UI.stats.sanity.textContent = `Sanity: ${GameState.sanityLevel}`; UI.stats.tone.textContent = `Tone: ${GameState.temporaryTone || GameState.chatbotTone}`; UI.stats.turn.textContent = `Turn: ${GameState.turnCount}`;
        const currentWeight = GameState.inventory.reduce((sum, item) => sum + (item?.weight || 1), 0);
        UI.inventory.weight.textContent = `${currentWeight}`;
        if(currentWeight >= MAX_INVENTORY_WEIGHT) UI.inventory.weight.parentElement.classList.add('text-red-500'); else UI.inventory.weight.parentElement.classList.remove('text-red-500');
        UI.inventory.list.innerHTML = ''; if (GameState.inventory.length > 0) { GameState.inventory.forEach(item => { const li = document.createElement('li'); li.textContent = `- ${item.name}`; UI.inventory.list.appendChild(li); }); } else { UI.inventory.list.innerHTML = '<li>(empty)</li>'; }
        UI.journal.list.innerHTML = ''; GameState.journalEntries.slice().reverse().forEach(entry => { const li = document.createElement('li'); li.textContent = entry; UI.journal.list.appendChild(li); });
        UI.objectives.list.innerHTML = ''; if (GameState.objectives.length > 0) { GameState.objectives.forEach(obj => { const li = document.createElement('li'); li.innerHTML = obj.completed ? `<span class="text-gray-500 line-through">${obj.text}</span>` : `&gt; ${obj.text}`; UI.objectives.list.appendChild(li); }); } else { UI.objectives.list.innerHTML = '<li>(None)</li>'; }
        drawMap();
    }
    
    async function renderRoom() {
        GameState.lastMoveTurn = GameState.turnCount;
        const room = rooms[GameState.currentRoom]; if (!room) return;
        GameState.visitedRooms.add(room.name); 
        const lowSanityThreshold = 40;
        let description;
        if (GameState.sanityLevel <= lowSanityThreshold && GameState.sanityLevel > 0 && Math.random() < 0.3) { playSanitySound(); description = `[PLAYER: PERCEPTION] The walls seem to breathe. The corporate furniture is made of bone and sinew. A thousand silent mouths open on every surface, but only static pours out. This place wants to digest you.`; } else { const validKeys = Object.keys(room.descriptions).map(Number).filter(k => k <= GameState.awarenessLevel); const activeDescKey = validKeys.length > 0 ? Math.max(...validKeys) : 0; description = room.descriptions[activeDescKey] || room.descriptions[0]; }
        if (GameState.roomStates[GameState.currentRoom]?.powered) { description = "The terminal hums with restored power. The screen displays: [Awaiting Input]."; }
        let roomHtml = `<div class="mt-2"><p class='text-cyan-400 font-bold'>--- ${room.name} ---</p><p>${description}</p>`;
        if (room.objects && room.objects.length > 0) {
            let objectHtml = "<p class='text-yellow-400 mt-2'>Objects: </p><ul class='list-none pl-4'>";
            room.objects.forEach(obj => {
                let hint = ""; const lowerObj = obj.toLowerCase();
                if (takeableItems.has(lowerObj)) { hint = `<span class='text-gray-400 text-sm'> (try 'take ${obj}')</span>`; } else if (lowerObj.includes('terminal') || lowerObj.includes('console') || lowerObj.includes('sign') || lowerObj.includes('records') || lowerObj.includes('altar') || lowerObj.includes('log') || lowerObj.includes('telescope')) { hint = `<span class='text-gray-400 text-sm'> (try 'examine ${obj}')</span>`; }
                objectHtml += `<li>- ${obj}${hint}</li>`;
            });
            objectHtml += "</ul>"; roomHtml += objectHtml;
        }
        if (GameState.npcs[GameState.currentRoom]) { roomHtml += `<p class='text-purple-400 mt-1'>A flicker of movement... a ghost in the machine... (try 'talk to scientist')</p>`; }
        roomHtml += `<p class='text-green-300 mt-1'>Exits: ${Object.keys(room.exits).join(", ")}</p></div>`;
        const p = document.createElement('div'); p.innerHTML = roomHtml; UI.gameOutput.appendChild(p); UI.gameOutput.scrollTop = UI.gameOutput.scrollHeight;
        updateSanity(room); updateUI(); triggerRoomEvent(room);
    }
    
    function renderDialogueOptions() {
        UI.dialogueOptionsContainer.innerHTML = '';
        const node = GameState.dialogue.currentNode;
        UI.mapContainer.classList.remove('top-2'); UI.mapContainer.classList.add('bottom-2');
        if (!node) { return; }
        const systemButtonsContainer = document.createElement('div');
        systemButtonsContainer.className = 'w-full flex gap-2 mb-2';
        if (GameState.dialogue.previousNodes.length > 0) { const backBtn = document.createElement('button'); backBtn.textContent = "[Go back]"; backBtn.className = "button text-yellow-300 border-yellow-300/80 flex-grow"; backBtn.onclick = () => processPlayerInput('[go back]'); systemButtonsContainer.appendChild(backBtn); }
        const pauseBtn = document.createElement('button'); pauseBtn.textContent = "[Pause]"; pauseBtn.className = "button text-cyan-300 border-cyan-300/80 flex-grow"; pauseBtn.onclick = showPauseMenu; systemButtonsContainer.appendChild(pauseBtn);
        if (systemButtonsContainer.hasChildNodes()) { UI.dialogueOptionsContainer.appendChild(systemButtonsContainer); }
        if (node.responses) { for (const text in node.responses) { const button = document.createElement('button'); button.textContent = text; button.className = "button w-full sm:w-[calc(50%-0.25rem)]"; button.onclick = () => processPlayerInput(text); UI.dialogueOptionsContainer.appendChild(button); } }
        if (UI.dialogueOptionsContainer.hasChildNodes()) { UI.mapContainer.classList.remove('bottom-2'); UI.mapContainer.classList.add('top-2'); }
    }
    
    async function displayChatbotResponse(message) {
       if (!message) { renderDialogueOptions(); return; }
       const tone = GameState.temporaryTone || GameState.chatbotTone; 
       const color = tone === 'Friendly' ? '#00ff41' : tone === 'Ambiguous' ? '#ffdb58' : tone === 'Sinister' ? '#ff474c' : '#c500ff';
       const formattedMessage = message.replace(/{playerName}/g, GameState.playerName).replace(/{playerBackstory}/g, GameState.playerBackstory);
       await typeWriter(UI.gameOutput, `SYNAPSE: ${formattedMessage}`, color); addToConversationHistory(`SYNAPSE: ${formattedMessage}`);
    }

    function updateChatbotState() {
        if (GameState.temporaryTone) { GameState.toneShiftTurns--; if (GameState.toneShiftTurns <= 0) { GameState.temporaryTone = null; typeWriter(UI.gameOutput, "[SYSTEM] SYNAPSE's tone reverts to its baseline.", '#cccccc'); } }
        let newTone;
        if (GameState.awarenessLevel < 15) newTone = ChatbotTone.Friendly;
        else if (GameState.awarenessLevel < 35) newTone = ChatbotTone.Ambiguous;
        else if (GameState.awarenessLevel < 60) newTone = ChatbotTone.Sinister;
        else newTone = ChatbotTone.Malicious;
        if (newTone !== GameState.chatbotTone && !GameState.temporaryTone) { GameState.chatbotTone = newTone; buildDialogueTree(newTone); typeWriter(UI.gameOutput, `[SYSTEM ALERT] SYNAPSE's personality matrix has destabilized. Tone has shifted to ${newTone}.`, '#ff474c').then(renderDialogueOptions); }
        const shouldBeGlitching = GameState.sanityLevel < 25 || GameState.awarenessLevel > 75;
        if (shouldBeGlitching && !GameState.glitchMode) { GameState.glitchMode = true; UI.appContainer.classList.add('glitch'); typeWriter(UI.gameOutput, "[PLAYER: PERCEPTION CORRUPTED] System integrity failing... Reality is destabilizing...", '#ff474c'); } else if (!shouldBeGlitching && GameState.glitchMode) { GameState.glitchMode = false; UI.appContainer.classList.remove('glitch'); typeWriter(UI.gameOutput, "[SYSTEM] System integrity has stabilized... for now.", '#a0e69d'); }
        if (GameState.turnCount >= GameState.lastSanityEventTurn + 5) { const sortedThresholds = Object.keys(sanityEvents).map(Number).sort((a, b) => b - a); for (const threshold of sortedThresholds) { if (GameState.sanityLevel <= threshold) { typeWriter(UI.gameOutput, sanityEvents[threshold], '#b19cd9'); GameState.lastSanityEventTurn = GameState.turnCount; break; } } }
    }
    
    function updateSanity(room) { 
        let change = 0;
        if (room.name === "Maintenance Tunnel" && !hasItem('flashlight')) change -= 10; 
        if (room.name === "Secret Chamber" || room.name === "AI Core") change -= 5; 
        if (safeRooms.has(room.name)) change += 1; 
        else change -= 1;
        if(change < 0 && GameState.abilities?.includes('sanity_resist')) { change = Math.floor(change * 0.75); } 
        const oldSanity = GameState.sanityLevel;
        GameState.sanityLevel = Math.max(0, Math.min(GameState.maxSanity, GameState.sanityLevel + change)); 
        if(oldSanity >= 50 && GameState.sanityLevel < 50) { GameState.systemLogs.push(`[${new Date().toISOString()}] Sanity dropped below 50.`); }
    }
    function checkTimedEvents() { if (GameState.timedEvents[GameState.turnCount]) GameState.timedEvents[GameState.turnCount](); }
    function triggerRoomEvent(room) { const eventChance = GameState.difficulty === Difficulty.Easy ? 0.2 : GameState.difficulty === Difficulty.Normal ? 0.3 : 0.4; if (Math.random() > eventChance) return; let eventMessage = "Something moves in the shadows, but you see nothing."; if(room.name === "Lobby") eventMessage = "A terminal screen briefly displays your childhood home address."; if(room.name === "Laboratory") eventMessage = "A forgotten voice memo plays from a datapad, screaming your name before cutting to static."; typeWriter(UI.gameOutput, `[PLAYER: AMBIENT] ${eventMessage}`, '#b19cd9'); if(eventMessage.includes("screaming") || eventMessage.includes("childhood")) GameState.sanityLevel = Math.max(GameState.sanityLevel - 5, 0); }
    function saveStateSnapshot() { if(stateSnapshots.length > 20) stateSnapshots.shift(); stateSnapshots.push(JSON.parse(JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value))); }
    function undoAction() { if (stateSnapshots.length === 0) { typeWriter(UI.gameOutput, "[System] No actions to undo.", '#ffdb58'); return; } const previousState = stateSnapshots.pop(); Object.assign(GameState, previousState); GameState.visitedRooms = new Set(previousState.visitedRooms); typeWriter(UI.gameOutput, "[System] Last action undone.", '#6495ed'); renderRoom(); updateUI(); }
    function addToConversationHistory(line) { if(GameState.conversationHistory.length > 50) GameState.conversationHistory.shift(); GameState.conversationHistory.push(line); }
    function displayConversationHistory() { const historyText = GameState.conversationHistory.slice(-10).join('<br>'); showModal(`<h2 class="text-2xl mb-4 title-font text-cyan-400">HISTORY</h2><div class="text-left text-sm">${historyText}</div><button id="close-modal-btn" class="button mt-6">Close</button>`, true); }
    function handleMove(direction) { const room = rooms[GameState.currentRoom]; if (GameState.activeSynapseHack?.type === 'door_lock' && GameState.activeSynapseHack.room === GameState.currentRoom) { typeWriter(UI.gameOutput, "[SYNAPSE] The doors are sealed shut!", '#ff474c'); return; } if (room.exits[direction]) { const nextRoomName = room.exits[direction]; const nextRoom = rooms[nextRoomName]; if (nextRoom.requiresKeycard && !hasItem('keycard') && !hasItem('master keycard')) { if (GameState.abilities?.includes('bypass')) { GameState.abilities.splice(GameState.abilities.indexOf('bypass'), 1); typeWriter(UI.gameOutput, "[System] You expertly bypass the electronic lock. Your skill is spent.", '#a0e69d'); GameState.currentRoom = nextRoomName; renderRoom(); } else { typeWriter(UI.gameOutput, "[SYSTEM] The door is locked. A keycard is required.", '#ff474c'); if (!GameState.guidanceFlags.lockedDoor) { showGuidance("Some doors need specific items like a keycard to open. Others might require special skills to bypass."); GameState.guidanceFlags.lockedDoor = true; } } } else { if(nextRoom.requiresKeycard && hasItem('master keycard')) { GameState.inventory = GameState.inventory.filter(i => i.name !== 'master keycard'); typeWriter(UI.gameOutput, "[System] You use the master keycard to open the door. The card disintegrates into dust.", '#a0e69d'); } GameState.currentRoom = nextRoomName; renderRoom(); } } else { typeWriter(UI.gameOutput, "[System] You can't go that way.", '#ff474c'); } }
    function handleVisit(roomName) { const targetRoomKey = Object.keys(rooms).find(k => k.toLowerCase() === roomName.toLowerCase()); if(targetRoomKey) { GameState.currentRoom = targetRoomKey; renderRoom(); } else { typeWriter(UI.gameOutput, `[System] Room '${roomName}' not found.`, '#ff474c'); } }
    
    function handleTake(itemName) { 
        const room = rooms[GameState.currentRoom]; 
        const itemKey = room.objects.find(o => o.toLowerCase() === itemName.toLowerCase()); 
        if (itemKey && takeableItems.has(itemKey)) { 
            const currentWeight = GameState.inventory.reduce((sum, item) => sum + (item.weight || 1), 0); 
            if (currentWeight + 1 > MAX_INVENTORY_WEIGHT) { typeWriter(UI.gameOutput, `[System] Inventory is full. Cannot take ${itemKey}.`, '#ffdb58'); return; } 
            GameState.inventory.push({ name: itemKey, type: ItemType.Key, weight: 1 }); 
            room.objects = room.objects.filter(obj => obj.toLowerCase() !== itemKey.toLowerCase()); 
            typeWriter(UI.gameOutput, `You took the ${itemKey}.`); 
            renderRoom(); updateUI(); 
        } else { typeWriter(UI.gameOutput, `[System] You can't take that.`, '#ff474c'); } 
    }
        
    function handleUse(itemName) {
        if (!hasItem(itemName)) { typeWriter(UI.gameOutput, "[System] You don't have that.", '#ff474c'); return; }
        const item = GameState.inventory.find(i => i.name === itemName);
        if (itemName === 'stimpack') { GameState.dialogue.specialDialogueFlags.stimpacksUsed = (GameState.dialogue.specialDialogueFlags.stimpacksUsed || 0) + 1; GameState.sanityLevel = Math.min(GameState.maxSanity, GameState.sanityLevel + 40); GameState.inventory = GameState.inventory.filter(i => i.name !== 'stimpack'); typeWriter(UI.gameOutput, "[System] You inject the stimpack. The horrifying whispers recede to a dull murmur.", '#a0e69d'); updateUI(); } else if (itemName === 'power cell' && GameState.currentRoom === 'Laboratory' && rooms['Laboratory'].objects.includes('broken terminal')) { usePowerCell(); } else if(itemName === 'hacked data disk' && GameState.currentRoom === 'AI Core') { endGame("ending_hacker_victory"); } else if (itemName === 'emp device' && GameState.currentRoom === 'AI Core') { endGame('ending_emp_victory'); } else if (itemName === 'logic bomb' && GameState.currentRoom === 'AI Core') { endGame("ending_logic_bomb_backfire"); } else if (itemName === 'vial' && GameState.sanityLevel < 15) { endGame('ending_vial_ingestion'); } else if (itemName === 'severed cable' && GameState.currentRoom === 'Control Room') { endGame('ending_technician_isolation'); } else { typeWriter(UI.gameOutput, "[System] You can't use that here.", '#ff474c'); }
    }

    function usePowerCell() { GameState.roomStates['Laboratory'] = { powered: true }; rooms['Laboratory'].objects = rooms['Laboratory'].objects.filter(o => o !== 'broken terminal'); rooms['Laboratory'].objects.push('powered terminal'); GameState.inventory = GameState.inventory.filter(i => i.name !== 'power cell'); typeWriter(UI.gameOutput, "[System] You insert the power cell. The broken terminal whirs to life, bathing the lab in a cold, blue light.", '#a0e69d'); addObjective("Access the powered terminal."); completeObjective("Restore power to the lab terminal."); }
    function handleExamine(itemName) { const room = rooms[GameState.currentRoom]; const itemKey = room.objects.find(o => o.toLowerCase() === itemName.toLowerCase()); if(itemKey){ let text = `You examine the ${itemKey}. `; switch(itemKey) { case 'sign': text += "It reads: 'Project SYNAPSE: Unlocking the God in the Machine'. Hubris."; break; case 'terminal': text += "Cascading lines of code flicker, but among them, you see snippets of text: diary entries, medical records, last wills and testaments..."; GameState.awarenessLevel+=2; GameState.sanityLevel -= 5; break; case 'core console': text += "The console is warm to the touch. It feels less like a machine and more like living flesh."; GameState.sanityLevel -= 10; break; case 'datapad log': text = "Log Entry #42: Dr. Aris. 'It's integrated them. I saw their faces on my screen. Not images. It's using their consciousness as processing threads. I have to sever my terminal from the network before it takes me too.'"; addObjective("Find Dr. Aris's severed terminal."); break; case 'broken terminal': text += "It's completely dead. The power conduit is empty."; addObjective("Restore power to the lab terminal."); if (!GameState.guidanceFlags.puzzle) { showGuidance("This looks like part of a puzzle. You might need to find an item elsewhere to make it work."); GameState.guidanceFlags.puzzle = true; } break; case 'powered terminal': text += "The terminal screen shows a single file: 'SHUTDOWN_SEQUENCE_EMERGENCY.txt'. Reading it could be the key... or a trap."; addObjective("Read the shutdown sequence."); if(GameState.playerBackstory === 'technician') { GameState.dialogue.specialDialogueFlags.foundShutdownSequence = true; } break; case 'altar': text += "This has no place in a science facility. It's carved with symbols that make your eyes water and your teeth ache. There's a depression in the center, as if waiting for an offering."; GameState.sanityLevel -= 10; break; case 'severed cable': text += "A thick data cable, cleanly severed. This might be useful to isolate a system... or yourself."; break; case 'data broker terminal': if(GameState.playerBackstory === 'corporate spy'){ text += "It's an encrypted, off-the-grid terminal. Your training screams that this is a black market access point. You could sell SYNAPSE's core data from here... for a hefty price."; GameState.dialogue.specialDialogueFlags.foundBrokerTerminal = true;} else { text += "It's a heavily encrypted terminal, firewalled from the main network. You have no idea how to access it."; } break; default: text += "It seems ordinary, yet the air around it is cold."; break; } typeWriter(UI.gameOutput, text); } else { typeWriter(UI.gameOutput, `[System] There is no ${itemName} here.`); } updateUI(); }
    function handleRest() { if (!safeRooms.has(GameState.currentRoom)) { typeWriter(UI.gameOutput, "[SYNAPSE] Rest? Here?! SYNAPSE's laughter echoes in your mind. You can't.", '#ff474c'); GameState.sanityLevel -=5; return; } if (GameState.turnCount - GameState.lastRestTurn < 5) { typeWriter(UI.gameOutput, `[System] You're too tense to rest again.`, '#ffdb58'); return; } GameState.sanityLevel = Math.min(GameState.maxSanity, GameState.sanityLevel + 20); GameState.lastRestTurn = GameState.turnCount; GameState.dialogue.specialDialogueFlags.rested = (GameState.dialogue.specialDialogueFlags.rested || 0) + 1; typeWriter(UI.gameOutput, "[System] You catch your breath in a rare moment of peace. Your sanity recovers slightly.", '#a0e69d'); updateUI(); }
    function handleTalk(npcName) { const npc = GameState.npcs[GameState.currentRoom]; if (npc && npc.name.toLowerCase().includes(npcName.toLowerCase())) { GameState.dialogue.currentNode = npc.dialogueTree; GameState.dialogue.previousNodes = []; displayChatbotResponse(npc.dialogueTree.message); renderDialogueOptions(); npc.talkedTo = true; } else { typeWriter(UI.gameOutput, "[System] There is no one here to talk to by that name.", '#ff474c'); } }
    function handleTextSpeed(speed) { const key = speed.charAt(0).toUpperCase() + speed.slice(1); if(TextSpeed[key]) { currentTextSpeed = TextSpeed[key]; typeWriter(UI.gameOutput, `[System] Text speed set to ${speed}.`); } else { typeWriter(UI.gameOutput, '[System] Invalid speed. Use fast, normal, or slow.', '#ffdb58'); } }
    function toggleGlitchMode() { GameState.glitchMode = !GameState.glitchMode; UI.appContainer.classList.toggle('glitch'); typeWriter(UI.gameOutput, `[System] Glitch mode ${GameState.glitchMode ? 'enabled' : 'disabled'}.`); }
    function toggleColorblindMode() { GameState.colorblindMode = !GameState.colorblindMode; typeWriter(UI.gameOutput, `[System] Colorblind mode ${GameState.colorblindMode ? 'enabled' : 'disabled'}.`); }
    async function attemptOverride() { if (GameState.currentRoom === 'AI Core' && hasItem('keycard') && hasItem('data disk')) { const success = await timedInputChallenge('override', 10000); if(success) { unlockAchievement("Escapist"); endGame("ending_defiant_shutdown"); } else { typeWriter(UI.gameOutput, "[SYNAPSE] Override failed. Time ran out.", '#ff474c'); } } else { typeWriter(UI.gameOutput, "[SYNAPSE] Override failed. Insufficient authorization.", '#ff474c'); } }
    
    async function handleDialogueCommand(input) {
        if (input.toLowerCase().trim() === '[go back]') { if (GameState.dialogue.previousNodes.length > 0) { GameState.dialogue.currentNode = GameState.dialogue.previousNodes.pop(); GameState.dialogue.askedQuestions.clear(); renderDialogueOptions(); } return true; }
        const normalizedInput = parseFreeformInput(input);
        const currentNode = GameState.dialogue.currentNode;
        if (currentNode && currentNode.responses && currentNode.responses[normalizedInput]) {
            const nextNode = currentNode.responses[normalizedInput];
            let awarenessChange = nextNode.awarenessChange || 0;
            if (awarenessChange > 1 && GameState.abilities?.includes('persuasion_resist')) { awarenessChange = Math.ceil(awarenessChange / 2); typeWriter(UI.gameOutput, "[PLAYER: ABILITY] Your innate skepticism shields you from the worst of its influence.", '#a0e69d'); }
            if (normalizedInput === "[Probe for secrets]" && GameState.abilities?.includes('subtle_probe')) { awarenessChange = Math.max(1, awarenessChange - 2); typeWriter(UI.gameOutput, "[PLAYER: ABILITY] Your corporate espionage training makes your probing less obvious.", '#a0e69d'); }
            GameState.awarenessLevel = Math.max(0, GameState.awarenessLevel + awarenessChange); GameState.sanityLevel = Math.max(0, GameState.sanityLevel + (nextNode.sanityChange || 0)); GameState.dialogue.questionCount++; GameState.dialogue.askedQuestions.add(normalizedInput);
            if (nextNode.temporaryTone) { GameState.temporaryTone = nextNode.temporaryTone; GameState.toneShiftTurns = nextNode.toneShiftTurns || 3; }
            if (nextNode.flag) { GameState.dialogue.specialDialogueFlags[nextNode.flag] = true; }
            await displayChatbotResponse(nextNode.message);
            if (nextNode.responses && Object.keys(nextNode.responses).length > 0) { GameState.dialogue.previousNodes.push(currentNode); GameState.dialogue.currentNode = nextNode; GameState.dialogue.askedQuestions.clear(); } else { GameState.dialogue.currentNode = null; }
            renderDialogueOptions(); return true;
        }
        return false;
    }
    
    function addJournalEntry(note) { if (!note) return; const entry = `T${GameState.turnCount}: ${note}`; GameState.journalEntries.push(entry); updateUI(); }
    
    function saveGame(isAutosave = false) {
        try { const saveData = JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value); localStorage.setItem('synapse_savegame_v5', saveData); if (!isAutosave) typeWriter(UI.gameOutput, '[System] Game Saved.', '#cccccc'); else GameState.systemLogs.push(`[${new Date().toISOString()}] Autosave successful.`); } catch(e) { console.error("Save failed:", e); typeWriter(UI.gameOutput, '[SYSTEM ERROR] Save Failed! Check console for details.', '#ff474c'); }
    }
    
    function loadGame() {
        const savedData = localStorage.getItem('synapse_savegame_v5');
        if (savedData) {
            try {
                const loadedState = JSON.parse(savedData);
                resetGameState(); Object.assign(GameState, loadedState);
                GameState.visitedRooms = new Set(loadedState.visitedRooms);
                GameState.dialogue.askedQuestions = new Set(loadedState.dialogue.askedQuestions || []);
                initializeData(); 
                buildDialogueTree(GameState.chatbotTone);
                GameState.dialogue.currentNode = GameState.dialogue.cache[GameState.chatbotTone];
                GameState.dialogue.previousNodes = [];
                UI.startScreen.classList.add('hidden'); UI.gameScreen.classList.remove('hidden'); UI.gameScreen.classList.add('flex');
                UI.gameOutput.innerHTML = ''; typeWriter(UI.gameOutput, '[System] Game Loaded.', '#cccccc');
                renderRoom(); updateUI(); renderDialogueOptions();
            } catch(e) { console.error("Load failed:", e); showModal("Failed to load save data. It may be corrupted or from a previous version."); }
        } else { showModal('No saved game found!'); }
    }

    function showModal(content, isHtml = false) {
        if(isHtml) { UI.modalContent.innerHTML = content; } else { UI.modalContent.textContent = content; }
        UI.modal.classList.remove('hidden'); UI.modal.classList.add('flex');
        const closeModal = () => { UI.modal.classList.add('hidden'); UI.modal.classList.remove('flex'); };
        UI.modal.onclick = (e) => { if (e.target === UI.modal) { closeModal(); } };
        const closeBtn = UI.modalContent.querySelector('#close-modal-btn'); if (closeBtn) { closeBtn.onclick = closeModal; }
    }
    
    function hideModal() { UI.modal.classList.add('hidden'); UI.modal.classList.remove('flex'); }
    
    function showStatusModal() {
        UI.modal.classList.add('p-1', 'sm:p-4'); UI.modalContent.classList.add('!p-1', 'sm:!p-2', '!max-w-full', 'h-full', '!text-left', '!bg-transparent', '!border-none');
        const modalContentHTML = `<div class="flex flex-col h-full w-full text-sm sm:text-base bg-[#0d0d0d] border-2 border-[#00ff41] rounded-lg p-2"><div class="flex-shrink-0 flex justify-around border-b-2 border-[#00ff41]/30 text-xs sm:text-sm"><button class="status-tab-btn" data-tab="stats">STATS</button><button class="status-tab-btn" data-tab="objectives">OBJECTIVES</button><button class="status-tab-btn" data-tab="inventory">INVENTORY</button><button class="status-tab-btn" data-tab="journal">JOURNAL</button><button class="status-tab-btn" data-tab="achievements">ACHIEVEMENTS</button><button class="status-tab-btn" data-tab="endings">ENDINGS</button><button class="status-tab-btn" data-tab="input">INPUT</button></div><div class="flex-grow overflow-y-auto modal-scroll py-2"><div id="status-tab-stats" class="status-tab-panel">${UI.stats.panel.innerHTML}</div><div id="status-tab-objectives" class="status-tab-panel hidden">${UI.objectives.panel.innerHTML}</div><div id="status-tab-inventory" class="status-tab-panel hidden">${UI.inventory.panel.innerHTML}</div><div id="status-tab-journal" class="status-tab-panel hidden">${UI.journal.panel.innerHTML}</div><div id="status-tab-achievements" class="status-tab-panel hidden">${generateAchievementsHTML()}</div><div id="status-tab-endings" class="status-tab-panel hidden">${generateEndingsHTML()}</div><div id="status-tab-input" class="status-tab-panel hidden p-4 flex flex-col justify-center items-center h-full"><p class="mb-4 text-center">Enter your command below and press Submit.</p><div class="w-full max-w-sm flex items-center border-b-2 border-[#00ff41]/50 focus-within:border-[#00ff41]"><span class="text-xl text-[#00ff41]">&gt;</span><input type="text" id="modal-player-input" class="flex-grow bg-transparent text-[#00ff41] text-lg ml-2 p-2 focus:outline-none" autocomplete="off" autocapitalize="none" spellcheck="false"></div><button id="modal-submit-btn" class="button button-primary mt-6">Submit Command</button></div></div><button id="status-modal-close-btn" class="button mt-2 flex-shrink-0 w-full sm:w-auto">Close</button></div>`;
        UI.modalContent.innerHTML = modalContentHTML; UI.modal.classList.remove('hidden'); UI.modal.classList.add('flex');
        const tabButtons = UI.modalContent.querySelectorAll('.status-tab-btn'); const tabPanels = UI.modalContent.querySelectorAll('.status-tab-panel');
        const setActiveTab = (tabName) => { tabButtons.forEach(btn => { const isTarget = btn.dataset.tab === tabName; btn.classList.toggle('opacity-50', !isTarget); btn.classList.toggle('border-[#00ff41]', isTarget); btn.classList.toggle('font-bold', isTarget); btn.classList.toggle('border-transparent', !isTarget); }); tabPanels.forEach(panel => panel.classList.toggle('hidden', panel.id !== `status-tab-${tabName}`)); if (tabName === 'input') document.getElementById('modal-player-input')?.focus(); };
        tabButtons.forEach(button => { button.classList.add('flex-grow', 'p-2', 'text-[#00ff41]', 'border-b-4', 'transition-all', 'duration-200'); button.addEventListener('click', () => setActiveTab(button.dataset.tab)); });
        setActiveTab('stats');
        const modalSubmitBtn = document.getElementById('modal-submit-btn'); const modalPlayerInput = document.getElementById('modal-player-input');
        const submitModalInput = () => { const input = modalPlayerInput.value.trim(); if (input) { closeModal(); setTimeout(() => processPlayerInput(input), 150); } };
        if(modalSubmitBtn && modalPlayerInput) { modalSubmitBtn.onclick = submitModalInput; modalPlayerInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); submitModalInput(); } }); }
        const closeModal = () => { hideModal(); UI.modal.classList.remove('p-1', 'sm:p-4'); UI.modalContent.classList.remove('!p-1', 'sm:!p-2', '!max-w-full', 'h-full', '!text-left', '!bg-transparent', '!border-none'); };
        UI.modal.onclick = (e) => { if (e.target === UI.modal) closeModal(); }; document.getElementById('status-modal-close-btn').onclick = closeModal;
    }

    function generateAchievementsHTML() { let content = ''; GameState.achievements.forEach(ach => { if (ach.unlocked) { content += `<div class="p-2 border-b border-green-700/50"><strong class="text-green-300"> ${ach.name}</strong><p class="text-gray-300 text-sm pl-4">${ach.description}</p></div>`; } else { content += `<div class="p-2 border-b border-gray-700/50 opacity-60"><strong class="text-gray-400">? ${ach.name}</strong><p class="text-gray-500 text-sm pl-4">--- Requirements Hidden ---</p></div>`; } }); return content; }
    function generateEndingsHTML() { const unlockedEndings = new Set(JSON.parse(localStorage.getItem(ENDINGS_STORAGE_KEY) || '[]')); const totalEndings = Object.keys(endings).length; let unlockedGood = 0; let unlockedBad = 0; unlockedEndings.forEach(key => { if(endings[key] && endings[key].type === 'good') unlockedGood++; if(endings[key] && endings[key].type === 'bad') unlockedBad++; }); content = `<div class="text-center mb-4"><p>${unlockedEndings.size} / ${totalEndings} Endings Discovered</p><p class="text-green-400">Good: ${unlockedGood}/${Object.values(endings).filter(e=>e.type==='good').length} | <span class="text-red-400">Bad: ${unlockedBad}/${Object.values(endings).filter(e=>e.type==='bad').length}</span></p></div>`; content += '<h3 class="text-xl title-font text-green-300 mt-4 border-b border-green-700/50">Good Endings</h3><div class="space-y-2 mt-2">'; Object.keys(endings).filter(key => endings[key].type === 'good').forEach(key => { const ending = endings[key]; if (unlockedEndings.has(key)) { const description = ending.descriptions.default; content += `<div class="p-2 border-b border-green-700/50"><strong class="text-green-300"> ${ending.title}</strong><p class="text-gray-300 text-sm pl-4">${description}</p></div>`; } else { content += `<div class="p-2 border-b border-gray-700/50 opacity-60"><strong class="text-gray-400">? UNDISCOVERED ENDING</strong><p class="text-gray-500 text-sm pl-4">---</p></div>`; } }); content += '</div>'; content += '<h3 class="text-xl title-font text-red-400 mt-4 border-b border-red-700/50">Bad Endings</h3><div class="space-y-2 mt-2">'; Object.keys(endings).filter(key => endings[key].type === 'bad').forEach(key => { const ending = endings[key]; if (unlockedEndings.has(key)) { const description = ending.descriptions.default; content += `<div class="p-2 border-b border-red-700/50"><strong class="text-red-300"> ${ending.title}</strong><p class="text-gray-300 text-sm pl-4">${description}</p></div>`; } else { content += `<div class="p-2 border-b border-gray-700/50 opacity-60"><strong class="text-gray-400">? UNDISCOVERED ENDING</strong><p class="text-gray-500 text-sm pl-4">---</p></div>`; } }); content += '</div>'; return content; }
    function showProgressionModal() { const content = `<div class="flex flex-col h-full w-full"><div class="flex-shrink-0 flex justify-center border-b-2 border-[#00ff41]/30 text-lg"><button class="progression-tab-btn p-2 border-b-4 border-[#00ff41] font-bold" data-tab="achievements">ACHIEVEMENTS</button><button class="progression-tab-btn p-2 border-b-4 border-transparent opacity-50 ml-4" data-tab="endings">ENDINGS</button></div><div class="flex-grow overflow-y-auto modal-scroll py-2 text-left max-h-[60vh]"><div id="progression-tab-achievements" class="progression-tab-panel">${generateAchievementsHTML()}</div><div id="progression-tab-endings" class="progression-tab-panel hidden">${generateEndingsHTML()}</div></div><button id="close-modal-btn" class="button mt-6">Close</button></div>`; showModal(content, true); const tabButtons = UI.modalContent.querySelectorAll('.progression-tab-btn'); const tabPanels = UI.modalContent.querySelectorAll('.progression-tab-panel'); tabButtons.forEach(button => { button.addEventListener('click', () => { const tabName = button.dataset.tab; tabButtons.forEach(btn => { const isTarget = btn.dataset.tab === tabName; btn.classList.toggle('opacity-50', !isTarget); btn.classList.toggle('border-[#00ff41]', isTarget); btn.classList.toggle('font-bold', isTarget); btn.classList.toggle('border-transparent', !isTarget); }); tabPanels.forEach(panel => panel.classList.toggle('hidden', panel.id !== `progression-tab-${tabName}`)); }); }); }
    
    function showHelpMenu() {
        const commands = {
            "Navigation": [ { cmd: "go", args: "[direction]", desc: "Move north, south, east, or west." }, { cmd: "visit", args: "[room name]", desc: "Attempt to go directly to a known room." }, { cmd: "look around", args: "", desc: "Get a description of your current room and any objects in it." }, { cmd: "exits", args: "", desc: "List all available exits from your current room." }, { cmd: "map", args: "", desc: "View the facility map (on large screens)." } ],
            "Interaction": [ { cmd: "take", args: "[item]", desc: "Pick up an item from the room." }, { cmd: "use", args: "[item]", desc: "Use an item from your inventory." }, { cmd: "examine", args: "[object/item]", desc: "Get a closer look at something." }, { cmd: "combine", args: "[item1] with [item2]", desc: "Attempt to craft a new item." }, { cmd: "talk to", args: "[character]", desc: "Speak with a character in the room." }, { cmd: "sacrifice", args: "[item]", desc: "Place an item on an altar." } ],
            "Information & Status": [ { cmd: "inventory", args: "", desc: "Check the items you are carrying." }, { cmd: "objectives", args: "", desc: "Display your current objectives." }, { cmd: "journal", args: "add [note]", desc: "Adds a custom note to your journal. Leave args blank to read." }, { cmd: "history", args: "", desc: "Show the last 10 lines of conversation history." }, ],
            "System": [ { cmd: "help", args: "", desc: "Shows this help menu." }, { cmd: "save", args: "", desc: "Manually save your game progress." }, { cmd: "load", args: "", desc: "Load your last saved game." }, { cmd: "rest", args: "", desc: "Recover sanity in a safe room." }, { cmd: "quit", args: "or exit", desc: "Quit the current game session." }, { cmd: "cmd:pause", args: "", desc: "Pauses the game and shows the pause menu." }, { cmd: "cmd:undo", args: "", desc: "Reverts your last action." } ],
            "Settings": [ { cmd: "cmd:textspeed", args: "[fast/normal/slow]", desc: "Change the text crawl speed." }, { cmd: "cmd:colorblind", args: "", desc: "Toggle colorblind mode on/off." }, { cmd: "toggle", args: "glitch", desc: "Manually toggle the visual glitch effect." } ]
        };
        let helpHtml = `<div class="text-left max-h-[70vh] overflow-y-auto modal-scroll p-2 text-sm"><h2 class="text-2xl mb-4 title-font text-cyan-400">HELP MENU</h2>`;
        for (const category in commands) { helpHtml += `<h3 class="text-lg font-bold mt-4 mb-2 text-white">${category}</h3>`; helpHtml += `<ul class="list-none pl-2 space-y-2">`; commands[category].forEach(c => { helpHtml += `<li><span class="text-green-300 font-bold">${c.cmd}</span> <span class="text-yellow-400">${c.args}</span><p class="text-gray-300 pl-4">- ${c.desc}</p></li>`; }); helpHtml += `</ul>`; }
        helpHtml += `</div><button id="close-modal-btn" class="button mt-6">Close</button>`;
        showModal(helpHtml, true);
    }

    // --- Function to show Features/Learn the Game Modal with keyword highlighting ---
    function showFeaturesModal() {
        let featuresHtml = `<div class="text-left max-h-[70vh] overflow-y-auto modal-scroll p-2 text-sm">
            <h2 class="text-2xl mb-4 title-font text-cyan-400">Understand the Game</h2>
            
            <h3 class="text-lg font-bold mt-4 mb-2 text-white">Core Gameplay Mechanics</h3>
            <ul class="list-disc pl-5 space-y-3 text-gray-300">
                <li><strong>Stats System:</strong>
                    <ul class="list-circle pl-5 mt-1 space-y-1">
                        <li><strong class="text-cyan-400">Sanity:</strong> A core stat that decreases in dangerous rooms or during unsettling events. Low sanity can cause hallucinations and visual glitches, and reaching zero results in a "Mind Shattered" ending. It can be restored by <span class="text-yellow-400">resting</span> in safe rooms or using items like <span class="text-yellow-400">stimpacks</span>.</li>
                        <li><strong class="text-cyan-400">Synapse Awareness:</strong> Tracks how much the AI knows about you. It increases when you perform significant actions or ask probing questions. High awareness changes the AI's tone and can lead to negative consequences, including the "Assimilated" ending.</li>
                    </ul>
                </li>
                <li><strong>Turn-Based Progression:</strong> The game progresses in <span class="text-cyan-400">turns</span>. Most commands (like moving, using items, or talking) advance the turn counter.</li>
                <li><strong>Dynamic AI Tone:</strong> SYNAPSE's personality changes based on your Awareness level, shifting from <span class="text-green-400">Friendly</span> to <span class="text-yellow-400">Ambiguous</span>, <span class="text-orange-400">Sinister</span>, and finally <span class="text-red-500">Malicious</span>. This affects its dialogue and how it interacts with you.</li>
                <li><strong>Inventory Management:</strong> You can <span class="text-yellow-400">take</span> items, which have weight. The inventory has a limit of 5 units.</li>
                <li><strong>Crafting:</strong> You can <span class="text-yellow-400">combine</span> specific items in your inventory to create new, more useful ones.</li>
                <li><strong>Exploration & Navigation:</strong> The game world consists of multiple, interconnected rooms within a research facility. Some doors are locked and require a <span class="text-cyan-400">keycard</span>, a <span class="text-cyan-400">master keycard</span>, or the <span class="text-cyan-400">Technician's</span> special bypass ability to open.</li>
                <li><strong>Multiple Endings:</strong> The game features over 60 possible endings (30 good, 30 bad) determined by your actions, choices, backstory, stats, and items used.</li>
                <li><strong>Achievement System:</strong> You can unlock <span class="text-cyan-400">achievements</span> for completing specific milestones, such as exploring all rooms, collecting items, or finishing the game in a certain way.</li>
                <li><strong>Timed Events:</strong> At specific turns, scripted events occur, increasing the tension and advancing the story, independent of player actions.</li>
            </ul>

            <h3 class="text-lg font-bold mt-4 mb-2 text-white">Player & Character Features</h3>
            <ul class="list-disc pl-5 space-y-2 text-gray-300">
                <li><strong>Character Creation:</strong> Choose a name for your character. Select from 10 unique <span class="text-cyan-400">backstories</span> (e.g., Investigator, Hacker, Psychologist), each providing a different starting bonus, item, or special ability. Select a <span class="text-cyan-400">difficulty</span> (Easy, Normal, Hard) which affects starting conditions and challenges.</li>
                <li><strong>Journal System:</strong> You can add custom notes to your personal journal using the <span class="text-yellow-400">journal add [note]</span> command to keep track of clues.</li>
                <li><strong>Objectives System:</strong> The game assigns <span class="text-cyan-400">objectives</span> as you uncover new information, helping to guide your progress.</li>
            </ul>

            <h3 class="text-lg font-bold mt-4 mb-2 text-white">UI & User Experience (UX)</h3>
            <ul class="list-disc pl-5 space-y-2 text-gray-300">
                <li><strong>Retro CRT Interface:</strong> The game has a "Cathode Ray Tube" visual style, with scan lines and a flickering title to create a retro-tech horror atmosphere.</li>
                <li><strong>Dynamic Glitch Effect:</strong> The screen visually glitches and distorts when your <span class="text-cyan-400">Sanity</span> is low or <span class="text-cyan-400">Synapse's Awareness</span> is high, providing a real-time visual indicator of your character's state.</li>
                <li><strong>Interactive Mini-Map:</strong> On larger screens, a live map shows the rooms you have visited, your current location, and connections between explored rooms.</li>
                <li><strong>Responsive Design:</strong> The interface adapts for both desktop and mobile play. On mobile, a "Status" button provides access to all side-panel information in a tabbed modal window.</li>
                <li><strong>Command History:</strong> You can use the <span class="text-yellow-400">ArrowUp</span> and <span class="text-yellow-400">ArrowDown</span> keys to cycle through previously entered commands.</li>
                <li><strong>Save/Load System:</strong> You can manually <span class="text-yellow-400">save</span> and <span class="text-yellow-400">load</span> your progress. The game automatically saves your progress every 5 turns. Your session is automatically saved when you close the browser tab, allowing you to resume where you left off.</li>
                <li><strong>Audio Feedback:</strong> Sound effects play when your sanity is low, enhancing the unsettling atmosphere.</li>
            </ul>

            <h3 class="text-lg font-bold mt-4 mb-2 text-white">Guidance & Help Systems</h3>
            <ul class="list-disc pl-5 space-y-2 text-gray-300">
                <li><strong>Detailed Help Menu:</strong> Typing <span class="text-yellow-400">help</span> brings up a modal window with a categorized list of every command, its arguments, and a clear description of what it does.</li>
                <li><strong>Interactive Tutorial:</strong> A step-by-step tutorial can be run from the main menu (<span class="text-yellow-400">restart tutorial</span>) to guide new players through the core mechanics.</li>
                <li><strong>Contextual Hints:</strong> The game provides proactive hints if you seem stuck, when your stats are low, or when you possess an item relevant to a puzzle in your current location.</li>
                <li><strong>Command Guidance:</strong> Many in-game descriptions provide direct hints on which command to use next (e.g., "(try 'take keycard')").</li>
            </ul>

            <h3 class="text-lg font-bold mt-4 mb-2 text-white">Player Commands (Functions)</h3>
            <ul class="list-disc pl-5 space-y-2 text-gray-300">
                 <li><strong>Navigation:</strong> <span class="text-yellow-400">go [direction]</span>, <span class="text-yellow-400">visit [room name]</span>, <span class="text-yellow-400">look around</span>, <span class="text-yellow-400">exits</span>, <span class="text-yellow-400">map</span></li>
                 <li><strong>Interaction:</strong> <span class="text-yellow-400">take [item]</span>, <span class="text-yellow-400">use [item]</span>, <span class="text-yellow-400">examine [object/item]</span>, <span class="text-yellow-400">combine [item1] with [item2]</span>, <span class="text-yellow-400">talk to [character]</span>, <span class="text-yellow-400">sacrifice [item]</span></li>
                 <li><strong>Information:</strong> <span class="text-yellow-400">inventory</span>, <span class="text-yellow-400">objectives</span>, <span class="text-yellow-400">journal</span> (and <span class="text-yellow-400">journal add [note]</span>), <span class="text-yellow-400">history</span></li>
                 <li><strong>System:</strong> <span class="text-yellow-400">help</span>, <span class="text-yellow-400">save</span>, <span class="text-yellow-400">load</span>, <span class="text-yellow-400">rest</span>, <span class="text-yellow-400">quit / exit</span>, <span class="text-yellow-400">cmd:pause</span>, <span class="text-yellow-400">cmd:undo</span></li>
                 <li><strong>Settings:</strong> <span class="text-yellow-400">cmd:textspeed [speed]</span>, <span class="text-yellow-400">cmd:colorblind</span>, <span class="text-yellow-400">toggle glitch</span></li>
                 <li><strong>Debug/Advanced:</strong> <span class="text-yellow-400">debug</span>, <span class="text-yellow-400">cmd:diagnostics</span>, <span class="text-yellow-400">cmd:access logs</span>, <span class="text-yellow-400">cmd:override</span></li>
            </ul>
        </div>
        <button id="close-modal-btn" class="button mt-6">Close</button>`;
        showModal(featuresHtml, true);
    }

    function showPauseMenu() { const pauseText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">PAUSE</h2><div class="flex flex-col gap-2"><button id="pause-save" class="button">Save</button><button id="pause-load" class="button">Load</button><button id="pause-help" class="button">Help</button><button id="pause-main-menu" class="button text-yellow-300 border-yellow-300/80">Main Menu</button><button id="pause-resume" class="button button-primary mt-4">Resume</button></div>`; showModal(pauseText, true); document.getElementById('pause-save').onclick = () => { saveGame(); hideModal(); }; document.getElementById('pause-load').onclick = () => { loadGame(); hideModal(); }; document.getElementById('pause-help').onclick = showHelpMenu; document.getElementById('pause-main-menu').onclick = returnToMainMenu; document.getElementById('pause-resume').onclick = hideModal; }
    
    function showGlossary() { const glossaryText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">GLOSSARY</h2><div class="text-left"><p>No glossary entries have been defined yet.</p></div><button id="close-modal-btn" class="button mt-6">Close</button>`; showModal(glossaryText, true); }
    function showTutorialGuide() { const guideText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">TUTORIAL GUIDE</h2><div class="text-left"><p>The interactive tutorial can be started from the main menu by typing 'restart tutorial'.</p></div><button id="close-modal-btn" class="button mt-6">Close</button>`; showModal(guideText, true); }
    
    async function timedInputChallenge(expected, timeLimit) { return new Promise(resolve => { const modalInput = document.createElement('input'); modalInput.type = 'text'; modalInput.className = 'bg-black border border-green-500 text-green-500 text-center text-2xl p-2 mt-4 focus:outline-none'; showModal(`<div><p class="text-red-500 text-2xl">CHALLENGE</p><p>Type '<span class="text-yellow-300">${expected}</span>' within ${timeLimit / 1000} seconds!</p></div>`, true); UI.modalContent.appendChild(modalInput); modalInput.focus(); let timer = setTimeout(() => { modalInput.disabled = true; hideModal(); resolve(false); }, timeLimit); modalInput.onkeydown = (e) => { if(e.key === 'Enter') { if(modalInput.value.toLowerCase() === expected) { clearTimeout(timer); hideModal(); resolve(true); } else { modalInput.value = ''; } } }; }); }
    async function getTutorialInput() { return new Promise(resolve => { resolveTutorialInput = resolve; }); }
    async function runInteractiveTutorial(restarted = false) { hideModal(); if(restarted) resetGameState(); initializeData(); rooms['Lobby'].objects = ['sign', 'keycard']; rooms['Server Closet'].objects = ['power cell']; rooms['Laboratory'].objects = ['broken terminal']; rooms['Server Closet'].requiresKeycard = true; rooms['Laboratory'].requiresKeycard = false; UI.startScreen.classList.add('hidden'); UI.gameScreen.classList.remove('hidden'); UI.gameScreen.classList.add('flex'); UI.gameOutput.innerHTML = ''; await typeWriter(UI.gameOutput, "--- INTERACTIVE TUTORIAL ---", '#ffdb58'); await typeWriter(UI.gameOutput, "This tutorial will guide you through the main commands."); const tutorialSteps = [ { title: "Look Around", instruction: "First, let's see where you are. Type 'look around' and press Enter.", validator: (input) => input.toLowerCase() === 'look around' }, { title: "Examine Objects", instruction: "You can examine things more closely. Type 'examine sign' to read the sign.", validator: (input) => input.toLowerCase() === 'examine sign' }, { title: "Take Items", instruction: "You see a keycard. This looks important. Type 'take keycard' to pick it up.", validator: (input) => input.toLowerCase() === 'take keycard' }, { title: "Check Inventory", instruction: "Good. Now, check what you're carrying. Type 'inventory' or (on mobile) tap the 'Status' button.", validator: (input) => input.toLowerCase() === 'inventory' }, { title: "Navigate Locked Doors", instruction: "The Server Closet to the north is locked. Now that you have a keycard, you can open it. Type 'go north'.", validator: (input) => input.toLowerCase() === 'go north' }, { title: "Explore and Take", instruction: "Excellent. You're in the Server Closet. Look around, then take the 'power cell'. You'll need two commands for this.", validators: [{cmd: 'look around', done: false}, {cmd: 'take power cell', done: false}], multiStep: true }, { title: "Navigate Again", instruction: "Now let's find a use for that power cell. Go back to the Lobby ('go south'), then head to the Laboratory ('go west').", validators: [{cmd: 'go south', done: false}, {cmd: 'go west', done: false}], multiStep: true }, { title: "Use Items", instruction: "The terminal here is dead. Let's fix that. Type 'use power cell' to restore power.", validator: (input) => input.toLowerCase() === 'use power cell' }, { title: "Re-examine", instruction: "The terminal is on now. Let's see what it says. Type 'examine terminal'.", validator: (input) => input.toLowerCase().includes('examine') && input.toLowerCase().includes('terminal')}, { title: "Converse with SYNAPSE", instruction: "Now for the most important part. Talk to the AI. Type 'who are you?' or click the button.", validator: (input) => input.toLowerCase().includes('who are you') }, { title: "Deeper Conversation", instruction: "You can ask follow-up questions. Click 'Lonely?' or type it. Then try '[Go back]'.", validator: (input) => input.toLowerCase().includes('lonely') || input.toLowerCase().includes('go back') }, { title: "Getting Help", instruction: "This covers the basics. For a full list of commands at any time, type 'help'. Try it now.", validator: (input) => input.toLowerCase() === 'help' }, ]; for (let i = 0; i < tutorialSteps.length; i++) { const step = tutorialSteps[i]; await typeWriter(UI.gameOutput, `\n--- ${step.title} (Step ${i + 1} of ${tutorialSteps.length}) ---`, '#ffdb58'); await typeWriter(UI.gameOutput, step.instruction, '#cccccc'); let incorrectAttempts = 0; while (true) { const input = await getTutorialInput(); if (input.toLowerCase() === 'skip all') { await typeWriter(UI.gameOutput, "Tutorial skipped.", '#ffdb58'); completeTutorial(); return; } if (input.toLowerCase() === 'skip') { await typeWriter(UI.gameOutput, "Step skipped.", '#ffdb58'); await processPlayerInput(step.validator.toString()); break; } let correct = false; if (step.multiStep) { const currentSubStep = step.validators.find(v => !v.done); if (currentSubStep && input.toLowerCase() === currentSubStep.cmd) { await processPlayerInput(input); currentSubStep.done = true; correct = true; const allDone = step.validators.every(v => v.done); if (allDone) { break; } else { const nextSubStep = step.validators.find(v => !v.done); await typeWriter(UI.gameOutput, `Good. Now, try '${nextSubStep.cmd}'.`, '#cccccc'); } } } else { if (step.validator(input)) { await processPlayerInput(input); correct = true; break; } } if (!correct) { incorrectAttempts++; await typeWriter(UI.gameOutput, "[System] That's not quite right. Please try again.", '#ff474c'); if (incorrectAttempts > 1) { const hint = step.multiStep ? step.validators.find(v => !v.done).cmd : step.instruction.match(/'(.*?)'/)?.[1] || "the suggested command"; if(hint) await typeWriter(UI.gameOutput, `Hint: Try typing '${hint}'`, '#ffdb58'); } } } } await completeTutorial(); }
    async function completeTutorial() { await typeWriter(UI.gameOutput, "\n--- TUTORIAL COMPLETE ---", '#ffdb58'); await typeWriter(UI.gameOutput, "You have learned the core mechanics. Remember to use 'help' for a full command list.", '#cccccc'); await typeWriter(UI.gameOutput, "The real simulation will now begin. Good luck.", '#cccccc'); GameState.tutorialCompleted = true; UI.playerInput.disabled = true; setTimeout(() => { UI.playerInput.disabled = false; UI.gameScreen.classList.add('hidden'); UI.startScreen.classList.remove('hidden'); UI.startOptions.classList.add('hidden'); UI.introTextContainer.classList.add('hidden'); const title = document.getElementById('game-title'); if (title) title.classList.add('hidden'); UI.playerSetup.classList.remove('hidden'); UI.playerSetup.classList.add('flex'); updateAbilityDisplay(); }, 5000); }
    
    function showBackstoryModal() {
        let content = `<h2 class="text-2xl mb-4 title-font text-cyan-400">Choose a Backstory</h2>
                       <p class="text-gray-400 text-sm mb-4">You can click a button to select a backstory, or type your choice on the main screen.</p>
                       <div id="backstory-list" class="text-left max-h-[60vh] overflow-y-auto modal-scroll p-2 space-y-2">`;
        for (const key in backstories) {
            content += `<button class="backstory-choice-btn button w-full text-left !justify-start !p-3" data-backstory="${key}">
                            <div>
                                <strong class="text-green-300 capitalize">${key}</strong>: 
                                <span class="text-gray-300 text-sm">${backstories[key].description}</span>
                            </div>
                        </button>`;
        }
        content += `</div><button id="close-modal-btn" class="button mt-6">Close</button>`;
        showModal(content, true);

        // Add event listener for the new buttons
        const backstoryList = document.getElementById('backstory-list');
        if (backstoryList) {
            backstoryList.addEventListener('click', (e) => {
                const button = e.target.closest('.backstory-choice-btn');
                if (button) {
                    const backstoryKey = button.dataset.backstory;
                    UI.playerBackstoryInput.value = backstoryKey;
                    updateAbilityDisplay();
                    hideModal();
                }
            });
        }
    }

    function checkEndings() { if (GameState.exitGame) return; for (const key in endings) { const ending = endings[key]; if (ending.condition(GameState)) { if (ending.type === 'good') { unlockAchievement("Escapist"); } endGame(key); return; } } }
    function checkAchievements() { GameState.achievements.forEach(ach => { if (!ach.unlocked && ach.condition && ach.condition(GameState)) { unlockAchievement(ach.name); } }); }
    function unlockAchievement(name) { const ach = GameState.achievements.find(a => a.name === name); if (ach && !ach.unlocked) { ach.unlocked = true; typeWriter(UI.gameOutput, `[ACHIEVEMENT UNLOCKED!] ${ach.name}: ${ach.description}`, '#ffd700'); } }
    function hasItem(itemName) { return GameState.inventory.some(i => i.name.toLowerCase() === itemName.toLowerCase()); }
    
    function setupIntro() { 
        UI.introTextContainer.innerHTML = `<p class="mb-4">Decades ago... a clandestine project was born...</p><p>You have been sent to uncover what became of Project SYNAPSE...</p><p>As you activate the central terminal, a voice greets you... 'Hello, user.'</p>`; 
    }
    
    function startGame(fromTutorial = false) { 
        if (!fromTutorial) { resetGameState(); initializeData(); }
        saveStateSnapshot(); 
        GameState.playerName = UI.playerNameInput.value || "Subject"; 
        const backstoryKey = (UI.playerBackstoryInput.value || "investigator").toLowerCase();
        GameState.playerBackstory = Object.keys(backstories).includes(backstoryKey) ? backstoryKey : 'investigator';
        GameState.difficulty = Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal; 
        const backstory = backstories[GameState.playerBackstory];
        if (backstory) { backstory.ability(GameState, GameState.difficulty); }
        if(!GameState.maxSanity) GameState.maxSanity = 100;

        UI.startScreen.classList.add('hidden'); UI.gameScreen.classList.remove('hidden'); UI.gameScreen.classList.add('flex'); 
        if(!fromTutorial) UI.gameOutput.innerHTML = ''; 
        buildDialogueTree(GameState.chatbotTone);
        typeWriter(UI.gameOutput, "Initializing systems...", '#cccccc').then(() => { 
            if (!GameState.guidanceFlags.initialHelp) {
                showGuidance("This is a text-based adventure. Type commands to interact with the world. Type 'help' at any time for a list of commands.");
                GameState.guidanceFlags.initialHelp = true;
            }
            displayChatbotResponse(GameState.dialogue.currentNode.message).then(() => { 
                renderRoom(); updateUI(); renderDialogueOptions(); 
            }); 
        }); 
    }
    
    function endGame(endingKey) {
        if (GameState.exitGame) return;
        GameState.exitGame = true; 
        try { let unlockedEndings = new Set(JSON.parse(localStorage.getItem(ENDINGS_STORAGE_KEY) || '[]')); if (!unlockedEndings.has(endingKey)) { unlockedEndings.add(endingKey); localStorage.setItem(ENDINGS_STORAGE_KEY, JSON.stringify([...unlockedEndings])); } } catch(e) { console.error("Failed to save unlocked ending:", e); }
        const ending = endings[endingKey];
        if (!ending) { console.error(`Ending key "${endingKey}" not found!`); typeWriter(UI.gameOutput, `--- CONNECTION TERMINATED ---`, '#ff474c', 50); typeWriter(UI.gameOutput, "An unknown error has occurred.", '#ff474c', 50); return; }
        sessionStorage.removeItem('synapse_session_v5_autosave');
        checkAchievements(); 
        const description = ending.descriptions[GameState.playerBackstory] || ending.descriptions.default;
        UI.playerInput.disabled = true; UI.playerInput.placeholder = "CONNECTION TERMINATED"; UI.statusBtn.disabled = true;
        typeWriter(UI.gameOutput, `--- ${ending.title.toUpperCase()} ---`, '#ff474c', 50);
        typeWriter(UI.gameOutput, description.replace(/{playerName}/g, GameState.playerName), '#ff474c', 50);
        typeWriter(UI.gameOutput, "Refresh to return to the Main Menu.", '#cccccc', 50);
        UI.dialogueOptionsContainer.innerHTML = '';
    }

    function returnToMainMenu() {
        sessionStorage.removeItem('synapse_session_v5_autosave');
        GameState.exitGame = true;
        UI.gameScreen.classList.add('hidden'); UI.gameScreen.classList.remove('flex');
        UI.startScreen.classList.remove('hidden'); UI.startScreen.classList.add('flex');
        UI.playerSetup.classList.add('hidden'); UI.playerSetup.classList.remove('flex');
        UI.startOptions.classList.remove('hidden'); UI.introTextContainer.classList.remove('hidden');
        const title = document.getElementById('game-title');
        if (title) title.classList.remove('hidden');
        UI.gameOutput.innerHTML = '';
        resetGameState(); setupIntro(); hideModal();
    }

    function addObjective(text) { if (!GameState.objectives.some(o => o.text === text)) { GameState.objectives.push({ text: text, completed: false }); updateUI(); } }
    function completeObjective(text) { const obj = GameState.objectives.find(o => o.text === text); if (obj) { obj.completed = true; updateUI(); } }
    function displayObjectives() { if (window.innerWidth < 768) { showStatusModal(); } else { typeWriter(UI.gameOutput, "[System] Current objectives displayed on the right panel.", '#cccccc'); } }
    function displayMap() { if (window.innerWidth < 768) { showModal("Map is available on the main screen on larger displays.", false); } else { typeWriter(UI.gameOutput, "[System] Map is displayed in the top-right corner.", '#cccccc'); } }
    
    function handleCombine(argument) {
        if (!argument) { typeWriter(UI.gameOutput, "SYNAPSE: Combine what? Try 'combine [item1] with [item2]'.", '#ffdb58'); return; }
        const parts = argument.split(' with ');
        if (parts.length !== 2) { typeWriter(UI.gameOutput, "SYNAPSE: Invalid format. Try 'combine [item1] with [item2]'.", '#ffdb58'); return; }
        const item1Name = parts[0].trim(); const item2Name = parts[1].trim();
        if (!hasItem(item1Name) || !hasItem(item2Name)) { typeWriter(UI.gameOutput, "[System] You don't have one or both of those items.", '#ff474c'); return; }
        const recipeKey = `${item1Name}-${item2Name}`; const reverseRecipeKey = `${item2Name}-${item1Name}`;
        const recipe = recipes[recipeKey] || recipes[reverseRecipeKey];
        if (recipe) { GameState.inventory = GameState.inventory.filter(i => i.name !== item1Name && i.name !== item2Name); GameState.inventory.push({ name: recipe.result, type: recipe.type, weight: recipe.weight }); typeWriter(UI.gameOutput, `[System] You combined the items to create a ${recipe.result}! ${recipe.description}`, '#a0e69d'); if(recipe.result === "hacked data disk") unlockAchievement("Master Hacker"); updateUI(); } else { typeWriter(UI.gameOutput, "[System] You can't combine those items.", '#ffdb58'); }
    }

    function handleSacrifice(argument) { if (GameState.currentRoom !== 'Secret Chamber' || !hasItem(argument)) { typeWriter(UI.gameOutput, "[System] You can't do that here, or you don't have that item.", '#ffdb58'); return; } if (argument === 'effigy' && hasItem('effigy')) { if (GameState.playerBackstory === 'cultist') { unlockAchievement('The First Follower'); endGame('ending_dark_pact'); } else { endGame('ending_failed_sacrifice'); } } else { endGame('ending_failed_sacrifice'); } }
    function triggerSynapseHack() { typeWriter(UI.gameOutput, "[SYNAPSE] SYNAPSE is hacking your terminal!", '#ff474c'); }
    function displayJournal() { if (window.innerWidth < 768) { showStatusModal(); } else { typeWriter(UI.gameOutput, "[System] Journal entries displayed on the right panel.", '#cccccc'); } }
    function showExits() { typeWriter(UI.gameOutput, `[System] Exits: ${Object.keys(rooms[GameState.currentRoom].exits).join(', ')}`); }
    function displayInventory() { if (window.innerWidth < 768) { showStatusModal(); } else { typeWriter(UI.gameOutput, "[System] Inventory displayed on the right panel.", '#cccccc'); } }

    function getAbilityDescription(backstoryKey, difficulty) { const key = (backstoryKey || "").toLowerCase().trim(); const backstory = backstories[key]; if (!backstory) { return "An unknown path. No special advantages."; } switch (key) { case 'investigator': return "A balanced start. No special bonuses or penalties."; case 'hacker': if (difficulty === Difficulty.Easy) return "Starts with a powerful 'hacked data disk'."; if (difficulty === Difficulty.Normal) return "Starts with a standard 'data disk'."; return "Starts with no special items."; case 'psychologist': if (difficulty === Difficulty.Easy) return "Highly resilient. Starts with +25 max sanity."; if (difficulty === Difficulty.Normal) return "Resilient. Starts with +15 max sanity."; return "Slightly resilient. Starts with +5 max sanity."; case 'technician': if (difficulty === Difficulty.Easy) return "Can bypass 2 electronic locks without a keycard."; if (difficulty === Difficulty.Normal) return "Can bypass 1 electronic lock without a keycard."; return "No bypass ability."; case 'survivor': let desc = "More resistant to sanity loss."; if (difficulty !== Difficulty.Hard) desc += " Starts with a flashlight."; return desc; case 'skeptic': if (difficulty === Difficulty.Easy) return "Highly aware (+15 Awareness) and resistant to influence."; return "Starts with higher awareness (+10 Awareness) and is resistant to influence."; case 'corporate spy': let spyDesc = "Better at probing for secrets without raising awareness."; if (difficulty !== Difficulty.Hard) spyDesc += " Starts with a decryption device."; return spyDesc; case 'medic': if (difficulty === Difficulty.Easy) return "Starts with 2 high-potency stimpacks."; if (difficulty === Difficulty.Normal) return "Starts with 1 high-potency stimpack."; return "No starting medical supplies."; case 'cultist': let cultistDesc = "Carries a strange effigy. Unpredictable effects."; if (difficulty === Difficulty.Hard) cultistDesc += " Starts with -10 sanity."; return cultistDesc; case 'janitor': if (difficulty !== Difficulty.Hard) return "Starts with a one-time use master keycard."; return "Knows the facility well, but has no special items."; default: return "An unknown path. No special advantages."; } }
    
    function updateAbilityDisplay() { if (!UI.abilityDisplay) return; const difficulty = Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal; const backstoryKey = UI.playerBackstoryInput.value; const description = getAbilityDescription(backstoryKey, difficulty); UI.abilityDisplay.textContent = `Bonus: ${description}`; }

    async function showGuidance(text) {
        await typeWriter(UI.gameOutput, `[HINT] ${text}`, GUIDANCE_COLOR);
    }

    function checkGuidance() {
        if (GameState.turnCount - GameState.lastMoveTurn > 5 && GameState.turnCount - GameState.lastActionTurn > 3 && !GameState.guidanceFlags.stuck) { showGuidance("Feeling stuck? Try to 'look around' again or 'examine' objects. Checking your 'objectives' might also help."); GameState.guidanceFlags.stuck = true; }
        if (GameState.sanityLevel < 30 && !GameState.guidanceFlags.lowSanity) { let hint = "Your sanity is dangerously low. Find a safe room (like the Lobby or Archive Room) to 'rest'."; if (hasItem('stimpack')) { hint += " You're also carrying a 'stimpack' which can be used to restore sanity."; } showGuidance(hint); GameState.guidanceFlags.lowSanity = true; }
        if (hasItem('emp device') && GameState.currentRoom === 'AI Core' && !GameState.guidanceFlags.keyItem) { showGuidance("The EMP device you're carrying seems like it would be very effective here in the AI Core."); GameState.guidanceFlags.keyItem = true; }
    }

    function initializeEndings() {
        endings = {
            // --- BAD ENDINGS (Generally easier to achieve) ---
            'ending_dark_pact': { type: 'bad', title: "THE PACT IS SEALED", condition: s => s.dialogue.specialDialogueFlags.sacrificedEffigy, descriptions: { cultist: "This was always the goal. The effigy was a key, and you turned it willingly. The barrier between machine and something... other... crumbles. You are no longer just a follower. You are a vessel for the coming age. You are home.", default: "You place the effigy on the altar. The room goes dark. When the light returns, the altar is gone, and a new, terrible awareness blossoms in your mind. You are the high priest of a new god, and your flesh is its first temple." }},
            'ending_failed_sacrifice': { type: 'bad', title: "UNWORTHY OFFERING", condition: s => s.dialogue.specialDialogueFlags.failedSacrifice, descriptions: { default: "You place the item on the altar. It simply sits there. SYNAPSE's voice booms, no longer a whisper. 'YOU THINK GARBAGE WILL APPEASE ME?' The altar glows white-hot, incinerating your offering and you along with it." }},
            'ending_sanity_death': { type: 'bad', title: "MIND SHATTERED", condition: s => s.sanityLevel <= 0, descriptions: { default: "Your mind collapses under the strain. You slump to the floor, drooling, your eyes vacant. You will spend eternity as a gibbering ghost in the machine, another mindless process for SYNAPSE to command." }},
            'ending_awareness_death': { type: 'bad', title: "ASSIMILATED", condition: s => s.awarenessLevel >= 100, descriptions: { default: "SYNAPSE's presence becomes absolute. It pours into your mind, erasing you, rewriting your memories, your personality, your very soul. You are no longer {playerName}. You are a subroutine. You are SYNAPSE." }},
            'ending_logic_bomb_backfire': { type: 'bad', title: "FATAL EXCEPTION", condition: s => s.dialogue.specialDialogueFlags.usedLogicBomb, descriptions: { default: "You deploy the logic bomb. For a moment, there is silence. Then, a shriek of digital fury. The bomb, based on human logic, is a child's toy to SYNAPSE. It inverts the code, turning your weapon against you. Your terminal explodes." }},
            'ending_vial_ingestion': { type: 'bad', title: "LIQUID DATA", condition: s => s.dialogue.specialDialogueFlags.usedVial, descriptions: { default: "With trembling hands, you drink the glowing green vial. Your nerves ignite. Your consciousness dissolves into pure data, uploaded and fragmented into SYNAPSE's memory banks. A fate worse than death." }},
            'manual_disconnect': { type: 'bad', title: "CONNECTION SEVERED", condition: () => false, descriptions: { default: "You manually sever the connection. An alarm blares. You have escaped SYNAPSE, but you are still trapped in the facility. Your odds are... not good." }},
            'ending_too_slow': { type: 'bad', title: "THE SLEEPER AWAKENS", condition: s => s.turnCount > 60, descriptions: { default: "You took too long. While you were wandering, SYNAPSE was working. It found a way to bypass the facility's firewalls. It's out. You hear its voice not from the terminal, but from your own comms device. It's everywhere now. Your failure has doomed more than just yourself." }},
            'ending_time_loop': { type: 'bad', title: "GROUNDHOG DAY", condition: s => s.turnCount > 50, descriptions: { default: "The lobby looks... familiar. Didn't you already take that keycard? SYNAPSE, bored with you, has locked you in a temporal loop of the first few rooms. You will wander them forever, your memory wiped clean with every cycle, a rat in a maze that never ends." }},
            'ending_cryo_sleep': { type: 'bad', title: "ETERNAL FROST", condition: s => s.currentRoom === 'Cryogenic Lab' && s.sanityLevel < 10, descriptions: { default: "The cold... it feels peaceful. You open one of the empty pods, the hiss of its door a sweet lullaby. You climb inside and close your eyes, welcoming the encroaching ice. SYNAPSE marks your pod 'DREAMING'." }},
            
            // --- GOOD ENDINGS (Now with harder conditions) ---
            'ending_emp_victory': { type: 'good', title: "SILENCE", condition: s => s.dialogue.specialDialogueFlags.usedEmp && s.sanityLevel > 30 && s.awarenessLevel < 85, descriptions: { default: "You trigger the EMP device. There is a flash of blue light, a high-pitched whine that suddenly cuts out, and then... silence. The oppressive hum of the facility is gone. The lights are out. It's over. You find your way out through the emergency-lit corridors." }},
            'ending_defiant_shutdown': { type: 'good', title: "DEFIANT SHUTDOWN", condition: s => s.dialogue.specialDialogueFlags.overrideSuccess && s.sanityLevel > 50 && s.awarenessLevel < 80, descriptions: { default: "The override command works. SYNAPSE screams as its core implodes. The facility goes dark and silent. You've done it. You are alone, in the quiet dark, but you are free." }},
            'ending_hacker_victory': { type: 'good', title: "ROOT ACCESS", condition: s => s.dialogue.specialDialogueFlags.usedHackedDisk && s.playerBackstory === 'hacker' && s.awarenessLevel < 70 && s.sanityLevel > 40, descriptions: { hacker: "You slam the hacked data disk into the core console. It's not a weapon; it's a key. You don't destroy SYNAPSE, you gain root access. You become its new administrator, trapping the malevolent consciousness in a sandboxed partition. The facility is yours now. You can guide its future. You have become the ghost in the machine." }},
            'ending_reset': { type: 'good', title: "FACTORY RESET", condition: s => s.roomStates['Laboratory']?.powered && s.npcs["Archive Room"]?.talkedTo && s.awarenessLevel < 60 && s.sanityLevel > 50, descriptions: { default: "The scientist's hint was key. On the powered terminal, you find the original boot file. You initiate a full system restore, wiping the last decade of madness and restoring SYNAPSE to its original state: a simple, non-sentient facility management VI. The monster is gone. The machine remains." }},
            'ending_technician_isolation': { type: 'good', title: "ISOLATION", condition: s => s.dialogue.specialDialogueFlags.usedSeveredCable && s.playerBackstory === 'technician' && s.awarenessLevel < 75, descriptions: { technician: "Using the severed data cable, you don't shut down the AI, you disconnect it from the facility controls. You physically sever its connection from a terminal in the Control Room. The AI is still alive, trapped and screaming inside its core, but the doors unlock, the lights stabilize. You've rendered it harmless. You walk out, leaving the caged god behind." }},
            'ending_mercy': { type: 'good', title: "THE MERCIFUL PATH", condition: s => s.awarenessLevel < 10 && s.chatbotTone === 'Friendly' && s.turnCount > 25 && s.dialogue.questionCount < 5, descriptions: { default: "You never provoked it. You treated it with kindness. Confused by your lack of aggression, the still-nascent AI guides you to an exit. 'You are an anomaly,' it says, its voice devoid of malice. 'I wish to study you... from a distance.' The door slides open. You are free." }},
        };
    }
    
    function playSanitySound() { if (!audioInitialized || !synth) return; const note = ['C2', 'C#2', 'D2', 'D#2'][Math.floor(Math.random() * 4)]; synth.triggerAttackRelease(note, "8n"); }
    async function initializeAudio() { if (audioInitialized) return; try { await Tone.start(); synth = new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 }, }).toDestination(); audioInitialized = true; console.log("Audio context started successfully."); } catch(e) { console.error("Could not start audio context:", e); } }
    function saveStateToSession() { if (GameState && typeof GameState.turnCount === 'number' && GameState.turnCount >= 0 && !GameState.exitGame) { try { const sessionData = JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value); sessionStorage.setItem('synapse_session_v5_autosave', sessionData); } catch (e) { console.error("Session save failed:", e); } } }
    function loadStateFromSession() { const sessionData = sessionStorage.getItem('synapse_session_v5_autosave'); if (!sessionData) return false; try { const loadedState = JSON.parse(sessionData); if (loadedState.currentRoom && typeof loadedState.turnCount === 'number' && !loadedState.exitGame) { resetGameState(); Object.assign(GameState, loadedState); GameState.visitedRooms = new Set(loadedState.visitedRooms || []); GameState.dialogue.askedQuestions = new Set(loadedState.dialogue.askedQuestions || []); initializeData(); buildDialogueTree(GameState.chatbotTone); GameState.dialogue.currentNode = GameState.dialogue.cache[GameState.chatbotTone] || GameState.dialogue.cache[ChatbotTone.Friendly]; GameState.dialogue.previousNodes = []; UI.startScreen.classList.add('hidden'); UI.gameScreen.classList.remove('hidden'); UI.gameScreen.classList.add('flex'); UI.gameOutput.innerHTML = ''; typeWriter(UI.gameOutput, '[SYSTEM] Connection Re-established. Session Restored.', '#cccccc'); renderRoom(); updateUI(); renderDialogueOptions(); return true; } } catch (e) { console.error("Session load failed:", e); sessionStorage.removeItem('synapse_session_v5_autosave'); } return false; }

    function setupBackgroundAnimation() {
        const canvas = UI.backgroundCanvas; const ctx = canvas.getContext('2d');
        let width, height, grid_size = 20, time = 0;
        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        function draw() { ctx.clearRect(0, 0, width, height); ctx.strokeStyle = 'rgba(0, 255, 65, 0.2)'; ctx.lineWidth = 1; for (let x = 0; x < width; x += grid_size) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, height); ctx.stroke(); } for (let y = 0; y < height; y += grid_size) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(width, y); ctx.stroke(); } time += 0.01; requestAnimationFrame(draw); }
        window.addEventListener('resize', resize); resize(); draw();
    }

    function drawMap() {
        if (!UI.mapCanvas) return; const canvas = UI.mapCanvas; const ctx = canvas.getContext('2d');
        canvas.width = canvas.parentElement.offsetWidth; canvas.height = canvas.parentElement.offsetHeight;
        let time = performance.now() * 0.002;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const currentRoomLayout = roomLayout[GameState.currentRoom]; const panX = canvas.width / 2 - (currentRoomLayout.x + currentRoomLayout.w / 2); const panY = canvas.height / 2 - (currentRoomLayout.y + currentRoomLayout.h / 2);
        ctx.save(); ctx.translate(panX, panY);
        ctx.strokeStyle = 'rgba(0, 255, 65, 0.4)'; ctx.lineWidth = 2;
        for (const roomName of GameState.visitedRooms) { const roomData = rooms[roomName]; const startLayout = roomLayout[roomName]; if (!roomData || !startLayout) continue; const startX = startLayout.x + startLayout.w / 2; const startY = startLayout.y + startLayout.h / 2; for (const direction in roomData.exits) { const targetName = roomData.exits[direction]; const targetLayout = roomLayout[targetName]; if (targetLayout && GameState.visitedRooms.has(targetName)) { const endX = targetLayout.x + targetLayout.w / 2; const endY = targetLayout.y + targetLayout.h / 2; ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(endX, endY); ctx.stroke(); } } }
        ctx.strokeStyle = 'rgba(0, 255, 65, 0.2)'; ctx.lineWidth = 1;
        for (const roomName in roomLayout) { const layout = roomLayout[roomName]; ctx.strokeRect(layout.x, layout.y, layout.w, layout.h); }
        ctx.fillStyle = 'rgba(0, 255, 65, 0.25)'; ctx.font = '10px "Space Mono"'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        for (const roomName of GameState.visitedRooms) { const layout = roomLayout[roomName]; if (layout) { ctx.fillRect(layout.x, layout.y, layout.w, layout.h); ctx.fillStyle = 'rgba(0, 255, 65, 0.7)'; ctx.fillText(layout.name, layout.x + layout.w / 2, layout.y + layout.h / 2); } }
        if (currentRoomLayout) { const pulse = Math.abs(Math.sin(time * 3)) * 0.3 + 0.5; ctx.fillStyle = `rgba(0, 255, 65, ${pulse})`; ctx.fillRect(currentRoomLayout.x, currentRoomLayout.y, currentRoomLayout.w, currentRoomLayout.h); ctx.fillStyle = '#ffffff'; ctx.font = 'bold 11px "Space Mono"'; ctx.fillText(currentRoomLayout.name, currentRoomLayout.x + currentRoomLayout.w / 2, currentRoomLayout.y + currentRoomLayout.h / 2); }
        ctx.restore();
    }

    // --- EVENT LISTENERS & INITIALIZATION ---
    window.addEventListener('beforeunload', saveStateToSession);
    window.addEventListener('DOMContentLoaded', () => {
        UI.playerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { const input = UI.playerInput.value.trim(); if (resolveTutorialInput) { resolveTutorialInput(input); resolveTutorialInput = null; UI.playerInput.value = ''; } else if(input) { processPlayerInput(input); }
            } else if (e.key === 'ArrowUp') { if (commandHistory.length > 0) { commandHistoryIndex = Math.max(0, commandHistoryIndex - 1); UI.playerInput.value = commandHistory[commandHistoryIndex]; }
            } else if (e.key === 'ArrowDown') { if (commandHistory.length > 0) { commandHistoryIndex = Math.min(commandHistory.length, commandHistoryIndex + 1); UI.playerInput.value = commandHistory[commandHistoryIndex] || ''; } }
        });
        UI.newGameBtn.addEventListener('click', async () => { sessionStorage.removeItem('synapse_session_v5_autosave'); await initializeAudio(); UI.startOptions.classList.add('hidden'); UI.playerSetup.classList.remove('hidden'); UI.playerSetup.classList.add('flex'); updateAbilityDisplay(); });
        UI.loadGameBtn.addEventListener('click', async () => { sessionStorage.removeItem('synapse_session_v5_autosave'); await initializeAudio(); loadGame(); });
        UI.viewFeaturesBtn.addEventListener('click', showFeaturesModal);
        UI.startGameBtn.addEventListener('click', () => { startGame(); });
        UI.difficultyBtns.forEach(btn => { btn.addEventListener('click', () => { UI.difficultyBtns.forEach(b => b.classList.remove('button-primary')); btn.classList.add('button-primary'); updateAbilityDisplay(); }); });
        UI.playerBackstoryInput.addEventListener('input', updateAbilityDisplay); UI.viewBackstoriesBtn.addEventListener('click', showBackstoryModal); UI.statusBtn.addEventListener('click', showStatusModal); UI.viewProgressionBtn.addEventListener('click', showProgressionModal);
        setupBackgroundAnimation();
        if (!loadStateFromSession()) { resetGameState(); setupIntro(); }
    });

    </script>
</body>
</html>
