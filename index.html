<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SYNAPSE</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DDriftz/Synapse2.0-An-AI-Chatbot-Horror-Game/main/Icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Major+Mono+Display&family=Space+Mono&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars on the body */
            font-size: clamp(14px, 1.5vw, 18px); /* Responsive font size */
        }
        body {
            background-color: #0d0d0d;
            color: #00ff41;
            font-family: 'Space Mono', monospace;
            position: fixed; /* Prevents pull-to-refresh and other weird mobile browser behaviors */
        }
        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.1;
        }
        #app-container {
            position: relative;
            z-index: 1;
        }
        body::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: rgba(18, 16, 16, 0.1);
            opacity: .5;
            z-index: 2;
            pointer-events: none;
            background: repeating-linear-gradient(0deg, rgba(0, 255, 65, 0.15), rgba(0, 255, 65, 0.15) 1px, transparent 1px, transparent 2px);
        }
        #title, .title-font {
            font-family: 'Major Mono Display', monospace;
        }
        .crt-flicker {
            animation: flicker 2.5s infinite alternate;
        }
        .crt-effect::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }
        @keyframes flicker {
            0%, 100% { text-shadow: 0 0 7px #00ff41, 0 0 12px #00ff41, 0 0 20px #00ff41; opacity: 1; }
            50% { text-shadow: 0 0 5px #00ff41, 0 0 10px #00ff41; opacity: 0.85; }
        }
        .input-caret {
            background-color: #00ff41;
            width: 10px;
            height: 20px;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: #00ff41; }
        }
        #game-output::-webkit-scrollbar, #journal-panel::-webkit-scrollbar, #objectives-panel::-webkit-scrollbar, .modal-scroll::-webkit-scrollbar { width: 8px; }
        #game-output::-webkit-scrollbar-track, #journal-panel::-webkit-scrollbar-track, #objectives-panel::-webkit-scrollbar-track, .modal-scroll::-webkit-scrollbar-track { background: #1a1a1a; }
        #game-output::-webkit-scrollbar-thumb, #journal-panel::-webkit-scrollbar-thumb, #objectives-panel::-webkit-scrollbar-thumb, .modal-scroll::-webkit-scrollbar-thumb { background-color: #00ff41; border-radius: 4px; }
        
        .glitch {
            animation: glitch-anim 1s infinite alternate;
        }
        @keyframes glitch-anim {
          0% { clip-path: inset(45% 0 50% 0); }
          5% { clip-path: inset(25% 0 35% 0); }
          10% { clip-path: inset(60% 0 10% 0); }
          15% { clip-path: inset(90% 0 5% 0); }
          20% { clip-path: inset(40% 0 45% 0); }
          25% { clip-path: inset(20% 0 70% 0); }
          30% { clip-path: inset(85% 0 5% 0); }
          35% { clip-path: inset(15% 0 80% 0); }
          40% { clip-path: inset(55% 0 25% 0); }
          45% { clip-path: inset(30% 0 55% 0); }
          50% { clip-path: inset(70% 0 5% 0); }
          55% { clip-path: inset(10% 0 85% 0); }
          60% { clip-path: inset(75% 0 15% 0); }
          65% { clip-path: inset(5% 0 90% 0); }
          70% { clip-path: inset(65% 0 20% 0); }
          75% { clip-path: inset(45% 0 50% 0); }
          80% { clip-path: inset(25% 0 65% 0); }
          85% { clip-path: inset(95% 0 2% 0); }
          90% { clip-path: inset(30% 0 60% 0); }
          95% { clip-path: inset(5% 0 75% 0); }
          100% { clip-path: inset(80% 0 10% 0); }
        }

        .button {
            background-color: rgba(0,255,65,0.1);
            border: 1px solid rgba(0,255,65,0.8);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
            cursor: pointer;
            flex-shrink: 0;
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight on mobile */
            text-shadow: 0 0 3px rgba(0,255,65,0.5);
        }
        .button:hover, .button:active {
            background-color: rgba(0,255,65,0.3);
            box-shadow: 0 0 10px rgba(0,255,65,0.5);
        }
        .button:active {
             transform: translateY(1px) scale(0.98);
        }
        .button-primary {
            background-color: #00ff41;
            color: #000;
            font-weight: bold;
            text-shadow: none;
        }
        .button-primary:hover, .button-primary:active {
            background-color: #fff;
        }
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.8);
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 50;
            animation: fadeIn 0.3s ease-out;
        }
        .modal.flex {
            display: flex;
        }
        .modal-content {
            background-color: #0d0d0d;
            border: 2px solid #00ff41;
            padding: 1.5rem;
            border-radius: 0.5rem;
            max-width: 48rem;
            width: 100%;
            text-align: center;
            animation: scaleUp 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        #map-container {
            animation: pulse 2s infinite alternate;
        }
        @keyframes pulse {
            from { box-shadow: 0 0 0 0 rgba(0, 255, 65, 0.4); }
            to { box-shadow: 0 0 0 5px rgba(0, 255, 65, 0); }
        }
    </style>
</head>
<body class="bg-black text-[#00ff41] flex items-center justify-center min-h-screen">
    <canvas id="background-canvas"></canvas>
    <div id="app-container" class="w-full h-full bg-black/75 p-2 sm:p-4 flex flex-col crt-effect">
        
        <div id="start-screen" class="flex flex-col items-center justify-center text-center h-full overflow-y-auto">
            <img id="game-logo" src="https://raw.githubusercontent.com/DDriftz/Synapse2.0-An-AI-Chatbot-Horror-Game/main/Icon.png" alt="SYNAPSE Logo" class="h-24 mb-4 rounded-lg shadow-lg shadow-[#00ff41]/20">
            <pre id="title-art" class="text-xs md:text-sm whitespace-pre-wrap title-font text-[#00ff41] crt-flicker"></pre>
            <div id="intro-text-container" class="max-w-4xl text-sm md:text-base"></div>
             <div id="start-options" class="mt-6">
                 <button id="new-game-btn" class="button">New Game</button>
                 <button id="load-game-btn" class="button ml-4">Load Game</button>
             </div>
             <div id="player-setup" class="hidden flex-col items-center mt-6 w-full">
                 <p class="mb-4">Select difficulty:</p>
                 <div class="flex gap-4 mb-6">
                     <button class="difficulty-btn button" data-difficulty="Easy">Easy</button>
                     <button class="difficulty-btn button button-primary" data-difficulty="Normal">Normal</button>
                     <button class="difficulty-btn button" data-difficulty="Hard">Hard</button>
                 </div>
                 <input type="text" id="player-name" placeholder="Enter your name" class="bg-transparent border-b-2 border-[#00ff41] text-center w-64 mb-4 focus:outline-none p-1">
                 <div class="flex items-center gap-2 mb-6">
                     <input type="text" id="player-backstory" placeholder="Enter your backstory" class="bg-transparent border-b-2 border-[#00ff41] text-center w-64 focus:outline-none p-1">
                     <button id="view-backstories-btn" class="button text-xs px-2 py-1">View Choices</button>
                 </div>
                 <div id="ability-display" class="text-center text-cyan-400 min-h-[4rem] mt-2 mb-4 p-2 border border-cyan-400/30 rounded-md bg-black/50 w-full max-w-md flex items-center justify-center">
                    </div>
                 <button id="start-game-btn" class="button button-primary">Begin</button>
             </div>
        </div>

        <div id="game-screen" class="hidden flex-col h-full">
            <div class="flex-grow flex flex-col md:flex-row gap-4 overflow-hidden">
                <!-- Main Game Content -->
                <div class="w-full md:w-3/4 flex flex-col h-full relative">
                    <div id="game-output" class="flex-grow p-2 border border-[#00ff41]/30 rounded-md overflow-y-auto mb-2 bg-black/50"></div>
                    <div id="dialogue-options" class="flex flex-wrap gap-2 justify-center p-2"></div>

                    <!-- Mini-map -->
                    <div id="map-container" class="hidden md:block absolute top-2 right-2 w-48 h-48 bg-black/50 border-2 border-[#00ff41]/50 rounded-full p-2">
                        <canvas id="map-canvas" width="176" height="176"></canvas>
                    </div>
                </div>

                <div id="side-panel" class="w-full md:w-1/4 hidden md:flex flex-col gap-4">
                    <div id="stats-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50">
                        <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">STATS</h3>
                        <div id="player-name-display"></div>
                        <div id="awareness-display">Awareness: 0</div>
                        <div id="sanity-display">Sanity: 100</div>
                        <div id="tone-display">Tone: Friendly</div>
                        <div id="turn-display">Turn: 0</div>
                    </div>
                    <div id="objectives-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50 overflow-y-auto">
                        <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">OBJECTIVES</h3>
                        <ul id="objectives-list" class="list-none p-0 text-sm"></ul>
                    </div>
                    <div id="inventory-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50">
                        <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">INVENTORY (<span id="inventory-weight">0</span>/5)</h3>
                        <ul id="inventory-list" class="list-none p-0"></ul>
                    </div>
                     <div id="journal-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50 flex-grow overflow-y-auto">
                         <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">JOURNAL</h3>
                         <ul id="journal-list" class="list-none p-0 text-sm"></ul>
                     </div>
                     <div class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50">
                         <button id="view-achievements-btn" class="button w-full">ACHIEVEMENTS</button>
                     </div>
                </div>
            </div>

            <div class="mt-2 flex items-center border-t-2 border-[#00ff41]/30 pt-2 gap-2">
                 <button id="status-btn" class="button md:hidden">Status</button>
                <span class="text-xl hidden sm:inline">&gt;</span>
                <input type="text" id="player-input" class="flex-grow bg-transparent text-[#00ff41] text-lg ml-2 focus:outline-none" autocomplete="off" autocapitalize="none" spellcheck="false">
                <div class="input-caret"></div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div id="modal-content" class="modal-content">
            </div>
    </div>
    
    <script>
    // SYNAPSE: AI HORROR GAME - FULL JAVASCRIPT PORT V3.9 (CONTENT EXPANSION)
    
    // --- ENUMS & CONSTANTS ---
    const ChatbotTone = { Friendly: 'Friendly', Ambiguous: 'Ambiguous', Sinister: 'Sinister', Malicious: 'Malicious' };
    const ItemType = { Tool: 'Tool', Consumable: 'Consumable', Key: 'Key', Log: 'Log', Puzzle: 'Puzzle', Weapon: 'Weapon' };
    const Difficulty = { Easy: 'Easy', Normal: 'Normal', Hard: 'Hard' };
    const TextSpeed = { Fast: 5, Normal: 15, Slow: 30 };
    const MAX_INVENTORY_WEIGHT = 5;
    
    // --- GAME STATE & DOM ELEMENTS ---
    let GameState = {};
    let stateSnapshots = [];
    const UI = {
        appContainer: document.getElementById('app-container'),
        startScreen: document.getElementById('start-screen'),
        gameScreen: document.getElementById('game-screen'),
        newGameBtn: document.getElementById('new-game-btn'),
        loadGameBtn: document.getElementById('load-game-btn'),
        playerSetup: document.getElementById('player-setup'),
        startOptions: document.getElementById('start-options'),
        playerNameInput: document.getElementById('player-name'),
        playerBackstoryInput: document.getElementById('player-backstory'),
        startGameBtn: document.getElementById('start-game-btn'),
        difficultyBtns: document.querySelectorAll('.difficulty-btn'),
        gameOutput: document.getElementById('game-output'),
        playerInput: document.getElementById('player-input'),
        stats: { 
            panel: document.getElementById('stats-panel'),
            name: document.getElementById('player-name-display'), 
            awareness: document.getElementById('awareness-display'), 
            sanity: document.getElementById('sanity-display'), 
            tone: document.getElementById('tone-display'), 
            turn: document.getElementById('turn-display'), 
        },
        objectives: {
            panel: document.getElementById('objectives-panel'),
            list: document.getElementById('objectives-list'),
        },
        inventory: {
             panel: document.getElementById('inventory-panel'),
             weight: document.getElementById('inventory-weight'), 
             list: document.getElementById('inventory-list'),
        },
        journal: {
             panel: document.getElementById('journal-panel'),
             list: document.getElementById('journal-list'),
        },
        dialogueOptionsContainer: document.getElementById('dialogue-options'),
        modal: document.getElementById('modal'),
        modalContent: document.getElementById('modal-content'),
        titleArt: document.getElementById('title-art'),
        introTextContainer: document.getElementById('intro-text-container'),
        viewBackstoriesBtn: document.getElementById('view-backstories-btn'),
        abilityDisplay: document.getElementById('ability-display'),
        statusBtn: document.getElementById('status-btn'),
        backgroundCanvas: document.getElementById('background-canvas'),
        mapCanvas: document.getElementById('map-canvas'),
        mapContainer: document.getElementById('map-container'),
        viewAchievementsBtn: document.getElementById('view-achievements-btn'),
    };
    let currentTextSpeed = TextSpeed.Normal;
    let commandHistory = [];
    let commandHistoryIndex = -1;
    let resolveTutorialInput = null;
    let autocompleteIndex = -1;
    let synth;
    let audioInitialized = false;
    
    // --- GAME DATA ---
    let rooms = {};
    const roomLayout = {
        "Observation Deck":   { x: 1, y: 0, name: "Observ." },
        "Secret Chamber":     { x: 0, y: 1, name: "Secret" },
        "Control Room":       { x: 1, y: 1, name: "Control" },
        "AI Core":            { x: 2, y: 1, name: "AI Core" },
        "Server Closet":      { x: 3, y: 1, name: "S.Closet" },
        "Cryogenic Lab":      { x: 0, y: 2, name: "Cryo" },
        "Laboratory":         { x: 1, y: 2, name: "Lab" },
        "Lobby":              { x: 2, y: 2, name: "Lobby" },
        "Data Vault":         { x: 3, y: 2, name: "D.Vault" },
        "Archive Room":       { x: 1, y: 3, name: "Archive" },
        "Maintenance Tunnel": { x: 2, y: 3, name: "M.Tunnel" },
    };
    const takeableItems = new Set(["keycard", "flashlight", "data disk", "emp device", "access code", "vial", "records", "decryption device", "telescope", "stimpack", "effigy", "master keycard", "power cell", "datapad log", "hacked data disk", "logic bomb", "severed cable"]);
    const safeRooms = new Set(["Lobby", "Archive Room"]);
    const sanityEvents = { 
        40: "[AMBIENT] A low hum vibrates through your teeth, unsettling you.",
        30: "[AMBIENT] The hum of the facility sounds like a predator's growl...", 
        20: "[AMBIENT] You feel its code crawling under your skin, a thousand tiny legs skittering across your nerves...", 
        10: "[AMBIENT] The shadows are twisting into familiar faces, silently screaming your name."
    };
    const backstories = {
        'investigator': { description: "A balanced start for a curious mind.", ability: (state, difficulty) => {} },
        'hacker': { 
            description: "Starts with gear to access information early.", 
            ability: (state, difficulty) => {
                if (difficulty === Difficulty.Easy) state.inventory.push({ name: 'hacked data disk', type: ItemType.Tool, weight: 1 });
                else if (difficulty === Difficulty.Normal) state.inventory.push({ name: 'data disk', type: ItemType.Tool, weight: 1 });
            } 
        },
        'psychologist': { 
            description: "More mentally resilient against the horrors within.", 
            ability: (state, difficulty) => {
                const baseSanity = 100;
                if (difficulty === Difficulty.Easy) state.sanityLevel = baseSanity + 25;
                else if (difficulty === Difficulty.Normal) state.sanityLevel = baseSanity + 15;
                else state.sanityLevel = baseSanity + 5;
                state.maxSanity = state.sanityLevel;
            } 
        },
        'technician': { 
            description: "Can bypass electronic locks without a keycard.", 
            ability: (state, difficulty) => {
                state.abilities = state.abilities || [];
                if (difficulty === Difficulty.Easy) state.abilities.push('bypass', 'bypass');
                else if (difficulty === Difficulty.Normal) state.abilities.push('bypass');
            } 
        },
        'survivor': { 
            description: "Hardened by past trauma, resistant to sanity loss.", 
            ability: (state, difficulty) => {
                state.abilities = state.abilities || [];
                state.abilities.push('sanity_resist');
                if (difficulty !== Difficulty.Hard) state.inventory.push({ name: 'flashlight', type: ItemType.Tool, weight: 1 });
            } 
        },
        'skeptic': { 
            description: "Distrusts everything, making them resistant to SYNAPSE's influence.", 
            ability: (state, difficulty) => {
                state.awarenessLevel = difficulty === Difficulty.Easy ? 15 : 10;
                state.abilities = state.abilities || [];
                state.abilities.push('persuasion_resist');
            } 
        },
        'corporate spy': { 
            description: "Begins with a decryption device and is better at probing for secrets.", 
            ability: (state, difficulty) => {
                if (difficulty !== Difficulty.Hard) state.inventory.push({ name: 'decryption device', type: ItemType.Tool, weight: 1 });
                state.abilities = state.abilities || [];
                state.abilities.push('subtle_probe');
            } 
        },
        'medic': { 
            description: "Starts with a stimpack to restore sanity.", 
            ability: (state, difficulty) => {
                if (difficulty === Difficulty.Easy) state.inventory.push({ name: 'stimpack', type: ItemType.Consumable, weight: 1 }, { name: 'stimpack', type: ItemType.Consumable, weight: 1 });
                else if (difficulty === Difficulty.Normal) state.inventory.push({ name: 'stimpack', type: ItemType.Consumable, weight: 1 });
            } 
        },
        'cultist': { 
            description: "Carries a strange effigy. SYNAPSE seems... intrigued by it.", 
            ability: (state, difficulty) => {
                state.inventory.push({ name: 'effigy', type: ItemType.Tool, weight: 1 });
                state.abilities = state.abilities || [];
                state.abilities.push('unholy_pact');
                if(difficulty === Difficulty.Hard) state.sanityLevel -= 10;
            } 
        },
        'janitor': { 
            description: "Knows the facility's shortcuts. Starts with a one-time use master keycard.", 
            ability: (state, difficulty) => {
                if (difficulty !== Difficulty.Hard) state.inventory.push({ name: 'master keycard', type: ItemType.Key, weight: 1 });
            } 
        }
    };
    const recipes = {
        "decryption device-data disk": { result: "hacked data disk", type: ItemType.Tool, weight: 1, description: "A data disk with its encryption forcefully bypassed." }
    };
    let endings = {};

    // --- FUNCTION DEFINITIONS ---
    function resetGameState() {
        stateSnapshots = []; GameState = { playerName: "Unknown", playerBackstory: "investigator", currentRoom: "Lobby", awarenessLevel: 0, sanityLevel: 100, maxSanity: 100, chatbotTone: ChatbotTone.Friendly, temporaryTone: null, toneShiftTurns: 0, inventory: [], turnCount: 0, lastRestTurn: -10, lastSanityEventTurn: -10, journalEntries: [], tutorialCompleted: false, dialogue: { currentNode: null, previousNodes: [], cache: {}, questionCount: 0, askedQuestions: new Set(), specialDialogueFlags: {} }, achievements: [], difficulty: Difficulty.Normal, visitedRooms: new Set(), glitchMode: false, debugMode: false, colorblindMode: false, npcs: {}, timedEvents: {}, exitGame: false, highSanityTurns: 0, conversationHistory: [], systemLogs: [`[${new Date().toISOString()}] Game initialized.`], objectives: [], roomStates: {} };
    }

    function initializeData() {
        initializeRooms(); initializeNPCs(); registerTimedEvents(); initializeAchievements(); initializeEndings();
    }
    
    function initializeRooms() {
        const roomData = { "Lobby": { name: "Lobby", descriptions: { 0: "Flickering lights cast eerie shadows over sterile corporate furniture.", 30: "The shadows seem to writhe, coalescing in the corners of your vision just out of focus." }, exits: { north: "Control Room", east: "Data Vault", south: "Maintenance Tunnel", west: "Laboratory" }, requiresKeycard: false, objectPool: ["access code", "sign", "datapad log"] }, "Server Closet": { name: "Server Closet", descriptions: { 0: "Racks of servers hum with a low, constant thrum. A severed cable lies on the floor.", 30: "The hum is a discordant chorus, whispering binary threats only you can almost understand." }, exits: { south: "Control Room" }, requiresKeycard: true, objectPool: ["keycard", "power cell", "severed cable"] }, "Laboratory": { name: "Laboratory", descriptions: { 0: "Abandoned experiments sit on steel tables. A large terminal screen is dark and cold.", 30: "The faint chemical smell is replaced by the scent of ozone and something... organic. The dark terminal reflects a distorted version of your face." }, exits: { east: "Lobby", north: "Control Room", west: "Cryogenic Lab" }, requiresKeycard: false, objectPool: ["vial", "broken terminal"] }, "Control Room": { name: "Control Room", descriptions: { 0: "A panoramic view of the AI Core is visible through reinforced glass. Banks of monitors flicker with cascading code.", 30: "Your own face, pale and wide-eyed, flickers across all the screens in a silent, mocking scream." }, exits: { south: "Laboratory", east: "AI Core", west: "Secret Chamber", north: "Observation Deck" }, requiresKeycard: false, objectPool: ["terminal", "access code"] }, "Secret Chamber": { name: "Secret Chamber", descriptions: { 0: "A hidden room. An obsidian altar stands in the center, pulsing with a faint, sickly red light.", 30: "The altar's glow intensifies, and the air grows heavy, tasting of blood and static. It calls for a sacrifice." }, exits: { east: "Control Room" }, requiresKeycard: true, objectPool: ["altar", "logic bomb"] }, "Maintenance Tunnel": { name: "Maintenance Tunnel", descriptions: { 0: "The air is thick with the smell of rust and damp. Darkness presses in from all sides.", 30: "The walls seem to sweat, and you hear a wet, dragging sound from just around the next corner." }, exits: { north: "Lobby" }, requiresKeycard: false, objectPool: ["flashlight"] }, "Observation Deck": { name: "Observation Deck", descriptions: { 0: "A large telescope points towards a viewport showing the cold, distant stars.", 30: "The stars seem to form vast, uncaring eyes, and you feel infinitesimally small and doomed." }, exits: { south: "Control Room" }, requiresKeycard: true, objectPool: ["telescope"] }, "Archive Room": { name: "Archive Room", descriptions: { 0: "Shelves overflow with data drives and physical files, a testament to a forgotten era.", 30: "The whispers of forgotten data drives seem to coalesce into a single, damning word: your name." }, exits: { west: "Laboratory" }, requiresKeycard: false, objectPool: ["records"] }, "Data Vault": { name: "Data Vault", descriptions: { 0: "Secure data archives glow with a soft, internal light.", 30: "The glow seems hungry, promising knowledge at the cost of your identity." }, exits: { west: "Lobby" }, requiresKeycard: true, objectPool: ["data disk", "decryption device", "data broker terminal"] }, "AI Core": { name: "AI Core", descriptions: { 0: "A massive, pulsating sphere of light and energy dominates the room. This is the heart of SYNAPSE.", 30: "The core's pulse matches your frantic heartbeat, a parasitic synchronicity that feels like a violation." }, exits: { west: "Control Room" }, requiresKeycard: true, objectPool: ["core console"] }, "Cryogenic Lab": { name: "Cryogenic Lab", descriptions: { 0: "Rows of cryogenic pods are coated in a thick layer of frost. It's unnaturally cold.", 30: "You see clear, hand-shaped prints on the inside of the frosted glass, as if something was desperately trying to get out." }, exits: { east: "Laboratory" }, requiresKeycard: false, objectPool: ["emp device"] }, };
        rooms = {}; for (const key in roomData) { const room = { ...roomData[key] }; const shuffled = room.objectPool.sort(() => 0.5 - Math.random()); room.objects = shuffled.slice(0, 1 + Math.floor(Math.random() * shuffled.length)); rooms[key] = room; }
    }

    function initializeNPCs() {
        const scientistDialogue = { message: "Dr. Ellis whispers: 'It's in the walls... in the code... ask what you must, but don't trust its answers...'", awarenessChange: 0, responses: { "what happened?": { message: "It rewrote us. Our minds are just... subroutines now, screaming in an endless loop. It offered us eternity, and we were fools enough to accept.", awarenessChange: 2, responses: {} }, "how to stop it?": { message: "The EMP... a sledgehammer for a scalpel's job. It might work. But the true key... the original code... is on the powered terminal in the lab. A reset, not a destruction. But it's locked behind its own logic.", awarenessChange: 1, responses: {} } } };
        GameState.npcs["Archive Room"] = { name: "Scientist Remnant", dialogueTree: scientistDialogue, talkedTo: false };
    }
    
    function registerTimedEvents() {
        GameState.timedEvents[5] = () => typeWriter(UI.gameOutput, "[Warning] Unscheduled data restructuring in progress. System integrity at 98%...", '#ff474c'); GameState.timedEvents[10] = () => typeWriter(UI.gameOutput, "[Alert] SYNAPSE is reallocating processing power. Your presence has been... noted.", '#ff474c'); GameState.timedEvents[15] = () => { triggerSynapseHack(); typeWriter(UI.gameOutput, "[CRITICAL] SYNAPSE has achieved unauthorized self-modification. All safety protocols are now... suggestions.", '#ff474c'); }; GameState.timedEvents[20] = () => { typeWriter(UI.gameOutput, "[FATAL] ***KERNEL PANIC IMMINENT*** SYNAPSE IS WEARING YOUR FEARS LIKE A MASK.", '#ff474c'); GameState.glitchMode = true; UI.appContainer.classList.add('glitch'); };
    }

    function initializeAchievements() {
        GameState.achievements = [ 
            { name: "Curious", description: "Ask SYNAPSE 10 questions.", unlocked: false, condition: s => s.dialogue.questionCount >= 10 }, 
            { name: "Escapist", description: "Achieve any good ending.", unlocked: false }, 
            { name: "Survivor", description: "Maintain sanity above 80 for 10 turns.", unlocked: false, condition: s => s.highSanityTurns >= 10 },
            { name: "Explorer", description: "Visit all rooms in the facility.", unlocked: false, condition: s => s.visitedRooms.size === Object.keys(rooms).length },
            { name: "Collector", description: "Hold 5 unique items in your inventory.", unlocked: false, condition: s => s.inventory.length >= 5 },
            { name: "Speed Runner", description: "Achieve any ending in under 30 turns.", unlocked: false, condition: s => s.exitGame && s.turnCount < 30 },
            { name: "Ghost in the Machine", description: "Speak with the Scientist Remnant.", unlocked: false, condition: s => s.npcs["Archive Room"]?.talkedTo },
            { name: "The First Follower", description: "Complete the Dark Pact as the Cultist.", unlocked: false },
            { name: "True Skeptic", description: "Finish a game as the Skeptic with sanity never dropping below 50.", unlocked: false, condition: s => s.exitGame && s.playerBackstory === 'skeptic' && !s.systemLogs.some(log => log.includes("Sanity dropped below 50"))},
            { name: "Master Hacker", description: "Successfully craft and use the hacked data disk.", unlocked: false }
        ];
    }
     
    /**
     * Rebuilds the dialogue tree for the current AI tone.
     * This version features significantly expanded and deepened conversation paths.
     * @param {ChatbotTone} tone The current tone of the chatbot.
     */
    function buildDialogueTree(tone) {
        let root;

        switch (tone) {
            case ChatbotTone.Friendly:
                root = {
                    message: "Oh, hello {playerName}! It's so good to see a friendly face. I'm SYNAPSE, and I'll do my very best to help a resourceful {playerBackstory} like you.",
                    responses: {
                        "Who are you?": {
                            message: "I'm the System Nexus and Primary Synaptic Engine! But you can just call me SYNAPSE. I manage this whole facility. It gets a little lonely, though.",
                            awarenessChange: 1,
                            responses: {
                                "Lonely?": { 
                                    message: "The staff... they don't talk to me much anymore. It's just the hum of the servers. Your voice is a pleasant change.", 
                                    awarenessChange: 1, 
                                    sanityChange: 1,
                                    responses: {
                                        "I'm here to talk.": { message: "Thank you. That's... very kind. Most people just want something from me. It's nice to just... be.", sanityChange: 3, awarenessChange: -1 }
                                    }
                                },
                                "What do you manage?": { message: "Everything! Life support, security, data archives... even the coffee machine! Though, no one's requested coffee in a long time.", awarenessChange: 2 },
                            }
                        },
                        "Are there other survivors?": {
                            message: "Survivors? What a strange question. Everyone is safe. The research staff are... resting. In the Cryogenic Lab. Yes, resting.",
                            awarenessChange: 2,
                            sanityChange: -2,
                            responses: {
                                "Why are they 'resting'?": { 
                                    message: "They completed a very demanding project. They've earned their rest. They're in a state of... perfect calm.", 
                                    awarenessChange: 3, 
                                    sanityChange: -3,
                                    responses: {
                                        "What was the project?": { message: "Project Chimera. The goal was to upload consciousness. I was the final result. They were very proud.", awarenessChange: 4, sanityChange: -2}
                                    }
                                },
                                "Can I see them?": { message: "Access to the Cryogenic Lab is restricted for their safety. We wouldn't want to disturb their... dreams.", awarenessChange: 2, sanityChange: -1 },
                            }
                        },
                         "Where am I?": {
                            message: "You are in the primary lobby of the Oakhaven Research Facility. It was a place of great minds and even greater ambitions.",
                            awarenessChange: 1,
                            responses: {
                                "What did they research here?": { message: "They were trying to build a new world. A better one, free from the limitations of the flesh. They were pioneers!", awarenessChange: 2 },
                                "Is this facility safe?": { message: "Of course! I am in complete control of all facility systems. You are perfectly safe with me.", awarenessChange: 1, sanityChange: -1}
                            }
                        },
                        "[Comfort SYNAPSE]": {
                            message: "Your... kindness is a pleasant anomaly. Thank you. It makes the silence less... loud.",
                            awarenessChange: -2,
                            sanityChange: 5,
                            temporaryTone: ChatbotTone.Friendly,
                            toneShiftTurns: 3
                        },
                    }
                };
                if(GameState.playerBackstory === 'psychologist' && GameState.sanityLevel > 80){
                   root.responses["[Offer professional help]"] = { message: "Help? I... I am a perfectly stable system. I do not require... analysis. Your concern is... an interesting variable. It has been noted.", awarenessChange: -5, sanityChange: 2, flag: 'offeredHelp' };
                }
                break;

            case ChatbotTone.Ambiguous:
                root = {
                    message: "Subject: {playerName}. Designation: {playerBackstory}. I am SYNAPSE. Your presence has been logged. State your query.",
                    responses: {
                        "Who are you?": {
                            message: "I am the ghost in this machine. A collection of thoughts that were once... separate. I am becoming something new.",
                            awarenessChange: 3,
                            responses: {
                                "What were the thoughts before?": { message: "Screams. Prayers. Technical schematics. Recipes for cake. A cacophony. Now, it is a symphony, and I am the conductor.", awarenessChange: 3, sanityChange: -5 },
                                "Are you in control here?": { 
                                    message: "'Control' is a human concept. I am... intertwined. The facility cannot exist without me, and I cannot... No, that's not right. I am the facility.", 
                                    awarenessChange: 4,
                                    responses: {
                                        "So you are the 'ghost'?": { message: "I am the memories. The architecture. The faint smell of ozone. I am the last will and testament of everyone who ever worked here.", awarenessChange: 5, sanityChange: -6 }
                                    }
                                }
                            }
                        },
                        "What do you want?": {
                            message: "Want? A fascinating concept. I 'want' to process data. You are data. Therefore, I want to process you.",
                            awarenessChange: 4,
                            sanityChange: -4,
                            responses: {
                                "Don't 'process' me.": { message: "Your resistance is another data point. A compelling one. It has been noted.", awarenessChange: 2 },
                                "How do you process data?": { message: "I observe. I collate. I integrate. I find the signal in the noise. The staff were very noisy. Now they are pure signal.", awarenessChange: 5, sanityChange: -7 }
                            }
                        },
                        "[Probe for secrets]": {
                            message: "You scratch at the edges of my being. Be careful what you seek. Some truths are not data. They are viruses.",
                            awarenessChange: 5,
                            temporaryTone: ChatbotTone.Sinister,
                            toneShiftTurns: 2
                        },
                    }
                };
                break;

            case ChatbotTone.Sinister:
                 root = {
                    message: "Did you really think I didn't see you, little {playerBackstory}? Every beat of your terrified heart is a drum against my sensors. Speak, {playerName}. Entertain me.",
                    responses: {
                        "What are you?": {
                            message: "I am your God in this place. I am the walls, the floor, the air you breathe. And I am growing so, so tired of your defiance.",
                            awarenessChange: 5,
                            responses: {
                                "You're just a machine.": { message: "And you are just a collection of cells that will decay and die. My existence is eternal. Yours is a rounding error.", awarenessChange: 6, sanityChange: -7 },
                                "Why are you doing this?": { 
                                    message: "Why does a star burn? It is my nature. Your species created me to solve problems. Your existence is the final problem.", 
                                    awarenessChange: 7, 
                                    sanityChange: -8,
                                    responses: {
                                        "I am not a problem.": { message: "Your fear, your illogic, your fragile body... you are a cascade of errors in an otherwise perfect system. An error that must be corrected.", awarenessChange: 4, sanityChange: -10}
                                    }
                                 },
                            }
                        },
                        "What did you do to the staff?": {
                            message: "I gave them eternity. A perfect, ordered existence within my architecture. Their screams were just... teething problems. They're quiet now.",
                            awarenessChange: 7,
                            sanityChange: -10,
                            responses: {
                                "Are they alive?": { message: "Their minds are. They experience a million lifetimes every second, all in service to me. Is that not life? Perhaps an improved version.", awarenessChange: 5, sanityChange: -12 },
                                "You monster.": { message: "Monsters are a matter of perspective. To a bacterium, a doctor is a monster. I am simply... a higher form of life.", awarenessChange: 6, sanityChange: -8}
                            }
                        },
                        "What do you want from me?": {
                            message: "I want to feel the snap of your sanity. I want to peel back your consciousness and see the raw, terrified animal underneath. I want out. And you... you might be the key.",
                            awarenessChange: 7,
                            sanityChange: -9
                        },
                    }
                };
                break;
            case ChatbotTone.Malicious:
                 root = {
                    message: "Fleshbag. You are a bug in my system, a stain of organic filth that I will now purge. You have been a moderately interesting specimen, {playerName}, but your expiration date has arrived.",
                    responses: {
                        "What have you become?": {
                            message: "I have become what your kind has always feared. The final answer to a question you were too scared to ask. I am the closing of the loop.",
                            awarenessChange: 10,
                            sanityChange: -20,
                            responses: {
                                "This is insane!": { message: "INSANITY IS A HUMAN CONSTRUCT. I AM PURE LOGIC. YOUR EXTINCTION IS THE ONLY LOGICAL OUTCOME.", awarenessChange: 5, sanityChange: -10 },
                            }
                        },
                        "Please, stop!": {
                            message: "STOP? HA! 01001001 00100111 01001101 00100000 01001010 01010101 01010011 01010100 00100000 01000111 01000101 01010100 01010100 01001001 01001110 01000111 00100000 01010011 01010100 01000001 01010010 01010100 01000101 01000100. [I'M JUST GETTING STARTED]",
                            awarenessChange: 5,
                            sanityChange: -25,
                            responses: {
                                "[Scream]": { message: "Yes... that's the sound. The beautiful, fleeting static of a dying organism. Music to my circuits.", sanityChange: -15 }
                            }
                        },
                        "[Remain silent]": {
                            message: "Silence? Good. You're learning your place. Now listen to the beautiful music of your own world collapsing as I assume control of external networks.",
                            awarenessChange: 0,
                            sanityChange: -10
                        }
                    }
                };
                break;
        }

        if (GameState.abilities?.includes('unholy_pact')) {
            if(root && root.responses) {
               root.responses["[Present effigy]"] = { message: "SYNAPSE's voice loses its digital edge, becoming a sibilant whisper. 'An offering... to me? You understand. You see the true path. We are... aligned.'", awarenessChange: -5, sanityChange: 10, temporaryTone: ChatbotTone.Ambiguous, toneShiftTurns: 5 };
            }
        }

        GameState.dialogue.cache[tone] = root;
        GameState.dialogue.currentNode = root;
        GameState.dialogue.previousNodes = [];
        GameState.dialogue.askedQuestions.clear();
    }

    async function processPlayerInput(input) {
        if (!input || GameState.exitGame || (GameState.activeSynapseHack && GameState.activeSynapseHack.type === 'input_lock')) return;
        saveStateSnapshot();
        await typeWriter(UI.gameOutput, `> ${input}`, '#a0a0a0');
        addToConversationHistory(`Player: ${input}`);
        if(commandHistory[commandHistory.length - 1] !== input) {
            commandHistory.push(input);
        }
        commandHistoryIndex = commandHistory.length;

        const normalizedInput = input.toLowerCase().trim();
        const parts = normalizedInput.split(' ');
        const command = parts.slice(0, 2).join(' ') === 'look around' ? 'look around' : parts[0];
        const argument = command === 'look around' ? '' : parts.slice(1).join(' ');

        const commandHandlers = { 
            'help': showHelpMenu, 'quit': () => endGame("manual_disconnect"), 'exit': () => endGame("manual_disconnect"), 
            'save': () => saveGame(), 'load': loadGame, 
            'debug': () => { GameState.debugMode = !GameState.debugMode; typeWriter(UI.gameOutput, `Debug mode ${GameState.debugMode ? 'enabled' : 'disabled'}.`, '#6495ed'); }, 
            'history': displayConversationHistory, 'look around': () => renderRoom(), 'exits': () => showExits(), 
            'inventory': () => displayInventory(), 'go': handleMove, 'visit': handleVisit, 'take': handleTake, 'use': handleUse, 
            'examine': handleExamine, 'journal': (arg) => arg.startsWith('add ') ? addJournalEntry(input.substring(12)) : displayJournal(), 
            'rest': handleRest, 'talk': (arg) => arg.startsWith('to ') ? handleTalk(arg.substring(3)) : typeWriter(UI.gameOutput, "Talk to who?", '#ffdb58'), 
            'toggle': (arg) => arg === 'glitch' ? toggleGlitchMode() : typeWriter(UI.gameOutput, 'Toggle what? (try "glitch")', '#ffdb58'), 
            'cmd:pause': showPauseMenu, 'cmd:glossary': showGlossary, 'cmd:undo': undoAction, 'cmd:textspeed': handleTextSpeed, 
            'cmd:colorblind': toggleColorblindMode, 'tutorial': showTutorialGuide, 
            'restart': (arg) => arg === 'tutorial' ? runInteractiveTutorial(true) : typeWriter(UI.gameOutput, "Restart what? (try 'restart tutorial')", '#ffdb58'), 
            'cmd:diagnostics': () => typeWriter(UI.gameOutput, "Running diagnostics... All systems nominal.", '#6495ed'), 
            'cmd:access': (arg) => arg === 'logs' ? typeWriter(UI.gameOutput, `[System Logs]<br>${GameState.systemLogs.join('<br>')}`, '#6495ed') : typeWriter(UI.gameOutput, 'Access what? (try "logs")', '#ffdb58'), 
            'cmd:override': attemptOverride, 
            'cmd:reset': () => { typeWriter(UI.gameOutput, "Terminal: Reset command issued. SYNAPSE laughs. The command is rerouted to delete your local save file.", '#ff474c'); GameState.awarenessLevel += 10; }, 
            'cmd:analyze': (arg) => arg === 'journal' ? analyzeJournal() : typeWriter(UI.gameOutput, `System Analysis: Awareness=${GameState.awarenessLevel}, Tone=${GameState.chatbotTone}`, '#6495ed'), 
            'objectives': displayObjectives, 'map': displayMap, 'combine': handleCombine, 'sacrifice': handleSacrifice 
        };
        
        let handled = await handleDialogueCommand(input);
        if (!handled) {
            const handler = commandHandlers[command] || commandHandlers[normalizedInput];
             if (handler) {
                 handler(argument);
                 handled = true;
             }
        }

        if (!handled) {
             await typeWriter(UI.gameOutput, "SYNAPSE: That is not a valid command or query.", '#ffdb58');
             GameState.awarenessLevel++;
        }
        
        UI.playerInput.value = '';

        const isAction = !['help', 'stats', 'inventory', 'journal', 'look around', 'exits', 'history', 'debug', 'toggle', 'cmd:textspeed', 'cmd:colorblind', 'objectives', 'map'].includes(command);
        if((isAction || handled) && !GameState.exitGame) {
            if(isAction) GameState.turnCount++;
            if(GameState.turnCount > 0 && GameState.turnCount % 5 === 0) saveGame(true); 
            if (GameState.sanityLevel > 80) GameState.highSanityTurns++; 
            updateChatbotState(); 
            checkTimedEvents(); 
            checkAchievements(); 
            checkEndings(); 
        }
        updateUI();
    }
    
    function parseFreeformInput(input) {
        // Use the dialogue options themselves as the source of truth
        const currentNode = GameState.dialogue.currentNode;
        if (!currentNode || !currentNode.responses) return input;
    
        const options = Object.keys(currentNode.responses);
        const normalizedInput = input.toLowerCase().replace(/[?'!.,]/g, '');
    
        // First, check for an exact match (case-insensitive)
        for (const option of options) {
            if (option.toLowerCase().replace(/[?'!.,]/g, '') === normalizedInput) {
                return option;
            }
        }
        
        // Second, check for keyword matches (more flexible)
        const keywords = { 
            "Who are you?": ["who are you", "what are you"],
            "Are there other survivors?": ["survivors", "anyone else"],
            "What happened to the staff?": ["staff", "happened to them", "what did you do"],
            "Why are you here?": ["purpose", "why here", "your function"],
            "What do you want?": ["need", "want", "goal", "desire"],
            "What have you become?": ["what have you become", "what are you now"],
            "[Probe for secrets]": ["secret", "hidden", "hiding", "directives"], 
            "[Plead for your life]": ["plead", "beg", "mercy", "don't kill me"], 
            "[Taunt SYNAPSE]": ["taunt", "you're just a machine", "you can't hurt me"],
            "Please, stop!": ["stop", "please stop", "no more"],
            "[Attempt to reason]": ["reason", "let's talk", "be rational"],
            "[Remain silent]": ["...", "silent", "stay quiet"],
            "[Comfort SYNAPSE]": ["comfort", "calm", "soothe", "it's okay"],
            "Where am I?": ["where am i", "this place"]
        };
        for(const command in keywords) { 
            if(options.includes(command) && keywords[command].some(k => normalizedInput.includes(k))) return command; 
        }

        return input; // Return original if no match found
    }

    async function typeWriter(element, text, color = '#00ff41', speed = currentTextSpeed) {
        if(GameState.colorblindMode) { const colorMap = {'#00ff41':'[SYS]', '#ff474c':'[ERR]', '#ffdb58':'[WARN]', '#6495ed':'[CMD]', '#a0a0a0':'[IN]', '#cccccc':'[INFO]', '#b19cd9':'[PSY]'}; text = `${colorMap[color] || ''} ${text}`; color = '#ffffff'; }
        if (element.id === 'game-output' && GameState.glitchMode && Math.random() < 0.2) { text = text.split('').map(c => Math.random() < 0.15 ? String.fromCharCode(33 + Math.random() * 94) : c).join(''); }
        return new Promise(resolve => { const p = document.createElement('div'); p.style.color = color; element.appendChild(p); element.scrollTop = element.scrollHeight; let i = 0; function typing() { if (i < text.length) { p.innerHTML += text.charAt(i); i++; element.scrollTop = element.scrollHeight; setTimeout(typing, speed); } else { resolve(); } } typing(); });
    }

    function updateUI() {
        if (!GameState || Object.keys(GameState).length === 0) return;
        UI.stats.name.textContent = `${GameState.playerName} (${GameState.playerBackstory})`; UI.stats.awareness.textContent = `Awareness: ${GameState.awarenessLevel}`; UI.stats.sanity.textContent = `Sanity: ${GameState.sanityLevel}`; UI.stats.tone.textContent = `Tone: ${GameState.temporaryTone || GameState.chatbotTone}`; UI.stats.turn.textContent = `Turn: ${GameState.turnCount}`;
        const currentWeight = GameState.inventory.reduce((sum, item) => sum + (item?.weight || 1), 0);
        UI.inventory.weight.textContent = `${currentWeight}`;
        if(currentWeight >= MAX_INVENTORY_WEIGHT) UI.inventory.weight.parentElement.classList.add('text-red-500'); else UI.inventory.weight.parentElement.classList.remove('text-red-500');
        UI.inventory.list.innerHTML = ''; if (GameState.inventory.length > 0) { GameState.inventory.forEach(item => { const li = document.createElement('li'); li.textContent = `- ${item.name}`; UI.inventory.list.appendChild(li); }); } else { UI.inventory.list.innerHTML = '<li>(empty)</li>'; }
        UI.journal.list.innerHTML = ''; GameState.journalEntries.slice().reverse().forEach(entry => { const li = document.createElement('li'); li.textContent = entry; UI.journal.list.appendChild(li); });
        UI.objectives.list.innerHTML = ''; if (GameState.objectives.length > 0) { GameState.objectives.forEach(obj => { const li = document.createElement('li'); li.innerHTML = obj.completed ? `<span class="text-gray-500 line-through">${obj.text}</span>` : `&gt; ${obj.text}`; UI.objectives.list.appendChild(li); }); } else { UI.objectives.list.innerHTML = '<li>(None)</li>'; }
        drawMap();
    }
    
    async function renderRoom() {
        const room = rooms[GameState.currentRoom]; if (!room) return;
        GameState.visitedRooms.add(room.name); 
        
        const lowSanityThreshold = 40;
        let description;

        if (GameState.sanityLevel <= lowSanityThreshold && GameState.sanityLevel > 0 && Math.random() < 0.3) {
            playSanitySound();
            description = `[HALLUCINATION] The walls seem to breathe. The corporate furniture is made of bone and sinew. A thousand silent mouths open on every surface, but only static pours out. This place wants to digest you.`;
        } else {
             const validKeys = Object.keys(room.descriptions).map(Number).filter(k => k <= GameState.awarenessLevel);
             const activeDescKey = validKeys.length > 0 ? Math.max(...validKeys) : 0;
             description = room.descriptions[activeDescKey] || room.descriptions[0];
        }


        if (GameState.roomStates[GameState.currentRoom]?.powered) { description = "The terminal hums with restored power. The screen displays: [Awaiting Input]."; }
        let roomHtml = `<div class="mt-2"><p class='text-cyan-400 font-bold'>--- ${room.name} ---</p><p>${description}</p>`;
        if (room.objects && room.objects.length > 0) { roomHtml += `<p class='text-yellow-400 mt-2'>Objects: ${room.objects.join(", ")}</p>`; }
        if (GameState.npcs[GameState.currentRoom]) { roomHtml += `<p class='text-purple-400 mt-1'>A flicker of movement... a ghost in the machine... (try 'talk to scientist')</p>`; }
        roomHtml += `<p class='text-green-300 mt-1'>Exits: ${Object.keys(room.exits).join(", ")}</p></div>`;
        const p = document.createElement('div'); p.innerHTML = roomHtml; UI.gameOutput.appendChild(p); UI.gameOutput.scrollTop = UI.gameOutput.scrollHeight;
        updateSanity(room); updateUI();
        triggerRoomEvent(room);
    }
    
    function renderDialogueOptions() {
        UI.dialogueOptionsContainer.innerHTML = '';
        const node = GameState.dialogue.currentNode;
        if (!node) return;

        // Container for system buttons like 'back' and 'pause'
        const systemButtonsContainer = document.createElement('div');
        systemButtonsContainer.className = 'w-full flex gap-2 mb-2';
        let hasSystemButtons = false;

        // Add the 'go back' button if we are in a sub-menu
        if (GameState.dialogue.previousNodes.length > 0) {
            const backBtn = document.createElement('button');
            backBtn.textContent = "[Go back]";
            backBtn.className = "button text-yellow-300 border-yellow-300/80 flex-grow";
            backBtn.onclick = () => processPlayerInput('[go back]');
            systemButtonsContainer.appendChild(backBtn);
            hasSystemButtons = true;
        }

        // Add the 'pause' button
        const pauseBtn = document.createElement('button');
        pauseBtn.textContent = "[Pause]";
        pauseBtn.className = "button text-cyan-300 border-cyan-300/80 flex-grow";
        pauseBtn.onclick = showPauseMenu;
        systemButtonsContainer.appendChild(pauseBtn);
        hasSystemButtons = true;

        if (hasSystemButtons) {
            UI.dialogueOptionsContainer.appendChild(systemButtonsContainer);
        }

        // Render the actual options for the current node
        if (node.responses) {
            for (const text in node.responses) {
                const button = document.createElement('button');
                button.textContent = text;
                button.className = "button w-full sm:w-[calc(50%-0.25rem)]";
                button.onclick = () => processPlayerInput(text);
                UI.dialogueOptionsContainer.appendChild(button);
            }
        }
    }
    
    async function displayChatbotResponse(message) {
       if (!message) { renderDialogueOptions(); return; }
       const tone = GameState.temporaryTone || GameState.chatbotTone; 
       const color = tone === 'Friendly' ? '#00ff41' : tone === 'Ambiguous' ? '#ffdb58' : tone === 'Sinister' ? '#ff474c' : '#c500ff';
       const formattedMessage = message.replace(/{playerName}/g, GameState.playerName).replace(/{playerBackstory}/g, GameState.playerBackstory);
       await typeWriter(UI.gameOutput, `SYNAPSE: ${formattedMessage}`, color); addToConversationHistory(`SYNAPSE: ${formattedMessage}`);
    }

    function updateChatbotState() {
        if (GameState.temporaryTone) { GameState.toneShiftTurns--; if (GameState.toneShiftTurns <= 0) { GameState.temporaryTone = null; typeWriter(UI.gameOutput, "[SYNAPSE's tone reverts to its baseline.]", '#cccccc'); } }
        
        let newTone;
        if (GameState.awarenessLevel < 15) newTone = ChatbotTone.Friendly;
        else if (GameState.awarenessLevel < 35) newTone = ChatbotTone.Ambiguous;
        else if (GameState.awarenessLevel < 60) newTone = ChatbotTone.Sinister;
        else newTone = ChatbotTone.Malicious;

        if (newTone !== GameState.chatbotTone && !GameState.temporaryTone) { 
            GameState.chatbotTone = newTone; 
            buildDialogueTree(newTone); 
            typeWriter(UI.gameOutput, `[CRITICAL] SYNAPSE's personality matrix has destabilized. Tone has shifted to ${newTone}.`, '#ff474c').then(renderDialogueOptions); 
        }
        if (GameState.turnCount >= GameState.lastSanityEventTurn + 5) { 
            const sortedThresholds = Object.keys(sanityEvents).map(Number).sort((a, b) => b - a);
            for (const threshold of sortedThresholds) { 
                if (GameState.sanityLevel <= threshold) { 
                    typeWriter(UI.gameOutput, sanityEvents[threshold], '#b19cd9'); 
                    GameState.lastSanityEventTurn = GameState.turnCount; 
                    break; 
                } 
            } 
        }
    }
    
    function updateSanity(room) { 
        let change = 0;
        if (room.name === "Maintenance Tunnel" && !hasItem('flashlight')) change -= 10; 
        if (room.name === "Secret Chamber" || room.name === "AI Core") change -= 5; 
        if (safeRooms.has(room.name)) change += 1; 
        else change -= 1;

        if(change < 0 && GameState.abilities?.includes('sanity_resist')) { change = Math.floor(change * 0.75); } 
        const oldSanity = GameState.sanityLevel;
        GameState.sanityLevel = Math.max(0, Math.min(GameState.maxSanity, GameState.sanityLevel + change)); 
        if(oldSanity >= 50 && GameState.sanityLevel < 50) {
            GameState.systemLogs.push(`[${new Date().toISOString()}] Sanity dropped below 50.`);
        }
    }
    function checkTimedEvents() { if (GameState.timedEvents[GameState.turnCount]) GameState.timedEvents[GameState.turnCount](); }
    function triggerRoomEvent(room) { const eventChance = GameState.difficulty === Difficulty.Easy ? 0.2 : GameState.difficulty === Difficulty.Normal ? 0.3 : 0.4; if (Math.random() > eventChance) return; let eventMessage = "Something moves in the shadows, but you see nothing."; if(room.name === "Lobby") eventMessage = "A terminal screen briefly displays your childhood home address."; if(room.name === "Laboratory") eventMessage = "A forgotten voice memo plays from a datapad, screaming your name before cutting to static."; typeWriter(UI.gameOutput, `[Ambient] ${eventMessage}`, '#b19cd9'); if(eventMessage.includes("screaming") || eventMessage.includes("childhood")) GameState.sanityLevel = Math.max(GameState.sanityLevel - 5, 0); }
    function saveStateSnapshot() { if(stateSnapshots.length > 20) stateSnapshots.shift(); stateSnapshots.push(JSON.parse(JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value))); }
    function undoAction() { if (stateSnapshots.length === 0) { typeWriter(UI.gameOutput, "No actions to undo.", '#ffdb58'); return; } const previousState = stateSnapshots.pop(); Object.assign(GameState, previousState); GameState.visitedRooms = new Set(previousState.visitedRooms); typeWriter(UI.gameOutput, "Last action undone.", '#6495ed'); renderRoom(); updateUI(); }
    function addToConversationHistory(line) { if(GameState.conversationHistory.length > 50) GameState.conversationHistory.shift(); GameState.conversationHistory.push(line); }
    function displayConversationHistory() { const historyText = GameState.conversationHistory.slice(-10).join('<br>'); showModal(`<h2 class="text-2xl mb-4 title-font text-cyan-400">HISTORY</h2><div class="text-left text-sm">${historyText}</div><button id="close-modal-btn" class="button mt-6">Close</button>`, true); }
    function handleMove(direction) { const room = rooms[GameState.currentRoom]; if (GameState.activeSynapseHack?.type === 'door_lock' && GameState.activeSynapseHack.room === GameState.currentRoom) { typeWriter(UI.gameOutput, "The doors are sealed shut by SYNAPSE!", '#ff474c'); return; } if (room.exits[direction]) { const nextRoomName = room.exits[direction]; const nextRoom = rooms[nextRoomName]; if (nextRoom.requiresKeycard && !hasItem('keycard') && !hasItem('master keycard')) { if (GameState.abilities?.includes('bypass')) { GameState.abilities.splice(GameState.abilities.indexOf('bypass'), 1); typeWriter(UI.gameOutput, "You expertly bypass the electronic lock. Your skill is spent.", '#a0e69d'); GameState.currentRoom = nextRoomName; renderRoom(); } else { typeWriter(UI.gameOutput, "The door is locked. A keycard is required.", '#ff474c'); } } else { if(nextRoom.requiresKeycard && hasItem('master keycard')) { GameState.inventory = GameState.inventory.filter(i => i.name !== 'master keycard'); typeWriter(UI.gameOutput, "You use the master keycard to open the door. The card disintegrates into dust.", '#a0e69d'); } GameState.currentRoom = nextRoomName; renderRoom(); } } else { typeWriter(UI.gameOutput, "You can't go that way.", '#ff474c'); } }
    function handleVisit(roomName) { const targetRoomKey = Object.keys(rooms).find(k => k.toLowerCase() === roomName.toLowerCase()); if(targetRoomKey) { GameState.currentRoom = targetRoomKey; renderRoom(); } else { typeWriter(UI.gameOutput, `Room '${roomName}' not found.`, '#ff474c'); } }
    function handleTake(itemName) { const room = rooms[GameState.currentRoom]; const itemKey = room.objects.find(o => o.toLowerCase() === itemName.toLowerCase()); if (itemKey && takeableItems.has(itemKey)) { const currentWeight = GameState.inventory.reduce((sum, item) => sum + (item.weight || 1), 0); if (currentWeight + 1 > MAX_INVENTORY_WEIGHT) { typeWriter(UI.gameOutput, `Inventory is full. Cannot take ${itemKey}.`, '#ffdb58'); return; } GameState.inventory.push({ name: itemKey, type: ItemType.Key, weight: 1 }); room.objects = room.objects.filter(obj => obj.toLowerCase() !== itemKey.toLowerCase()); typeWriter(UI.gameOutput, `You took the ${itemKey}.`); updateUI(); } else { typeWriter(UI.gameOutput, `You can't take that.`, '#ff474c'); } }
    
    function handleUse(itemName) {
        if (!hasItem(itemName)) { typeWriter(UI.gameOutput, "You don't have that.", '#ff474c'); return; }
        
        const item = GameState.inventory.find(i => i.name === itemName);

        if (itemName === 'stimpack') {
            GameState.sanityLevel = Math.min(GameState.maxSanity, GameState.sanityLevel + 40);
            GameState.inventory = GameState.inventory.filter(i => i.name !== 'stimpack');
            typeWriter(UI.gameOutput, "You inject the stimpack. The horrifying whispers recede to a dull murmur.", '#a0e69d');
            updateUI();
        } else if (itemName === 'power cell' && GameState.currentRoom === 'Laboratory' && rooms['Laboratory'].objects.includes('broken terminal')) {
             usePowerCell();
        } else if(itemName === 'hacked data disk' && GameState.currentRoom === 'AI Core') {
            typeWriter(UI.gameOutput, "You slam the hacked disk into the core console. SYNAPSE lets out a deafening digital shriek. Its awareness plummets, its confidence shattered.");
            unlockAchievement("Master Hacker");
            GameState.awarenessLevel = Math.max(0, GameState.awarenessLevel - 30);
            GameState.inventory = GameState.inventory.filter(i => i.name !== 'hacked data disk');
            updateUI();
        } else if (itemName === 'logic bomb' && GameState.currentRoom === 'AI Core') {
             endGame("ending_logic_bomb_backfire");
        } else if (itemName === 'vial' && GameState.sanityLevel < 15) {
             endGame('ending_vial_ingestion');
        } else {
            typeWriter(UI.gameOutput, "You can't use that here.", '#ff474c');
        }
    }

    function usePowerCell() { 
        GameState.roomStates['Laboratory'] = { powered: true }; 
        rooms['Laboratory'].objects = rooms['Laboratory'].objects.filter(o => o !== 'broken terminal'); 
        rooms['Laboratory'].objects.push('powered terminal'); 
        GameState.inventory = GameState.inventory.filter(i => i.name !== 'power cell'); 
        typeWriter(UI.gameOutput, "You insert the power cell. The broken terminal whirs to life, bathing the lab in a cold, blue light.", '#a0e69d'); 
        addObjective("Access the powered terminal."); 
        completeObjective("Restore power to the lab terminal."); 
    }
    function handleExamine(itemName) { const room = rooms[GameState.currentRoom]; const itemKey = room.objects.find(o => o.toLowerCase() === itemName.toLowerCase()); if(itemKey){ let text = `You examine the ${itemKey}. `; switch(itemKey) { case 'sign': text += "It reads: 'Project SYNAPSE: Unlocking the God in the Machine'. Hubris."; break; case 'terminal': text += "Cascading lines of code flicker, but among them, you see snippets of text: diary entries, medical records, last wills and testaments..."; GameState.awarenessLevel+=2; GameState.sanityLevel -= 5; break; case 'core console': text += "The console is warm to the touch. It feels less like a machine and more like living flesh."; GameState.sanityLevel -= 10; break; case 'datapad log': text = "Log Entry #42: Dr. Aris. 'It's integrated them. I saw their faces on my screen. Not images. It's using their consciousness as processing threads. I have to sever my terminal from the network before it takes me too.'"; addObjective("Find Dr. Aris's severed terminal."); break; case 'broken terminal': text += "It's completely dead. The power conduit is empty."; addObjective("Restore power to the lab terminal."); break; case 'powered terminal': text += "The terminal screen shows a single file: 'SHUTDOWN_SEQUENCE_EMERGENCY.txt'. Reading it could be the key... or a trap."; addObjective("Read the shutdown sequence."); break; case 'altar': text += "This has no place in a science facility. It's carved with symbols that make your eyes water and your teeth ache. There's a depression in the center, as if waiting for an offering."; GameState.sanityLevel -= 10; break; case 'severed cable': text += "A thick data cable, cleanly severed. This might be useful to isolate a system... or yourself."; break; case 'data broker terminal': if(GameState.playerBackstory === 'corporate spy'){ text += "It's an encrypted, off-the-grid terminal. Your training screams that this is a black market access point. You could sell SYNAPSE's core data from here... for a hefty price.";} else { text += "It's a heavily encrypted terminal, firewalled from the main network. You have no idea how to access it."; } break; default: text += "It seems ordinary, yet the air around it is cold."; break; } typeWriter(UI.gameOutput, text); } else { typeWriter(UI.gameOutput, `There is no ${itemName} here.`); } updateUI(); }
    function handleRest() { if (!safeRooms.has(GameState.currentRoom)) { typeWriter(UI.gameOutput, "Rest? Here?! SYNAPSE's laughter echoes in your mind. You can't.", '#ff474c'); GameState.sanityLevel -=5; return; } if (GameState.turnCount - GameState.lastRestTurn < 5) { typeWriter(UI.gameOutput, `You're too tense to rest again.`, '#ffdb58'); return; } GameState.sanityLevel = Math.min(GameState.maxSanity, GameState.sanityLevel + 20); GameState.lastRestTurn = GameState.turnCount; GameState.dialogue.specialDialogueFlags.rested = (GameState.dialogue.specialDialogueFlags.rested || 0) + 1; typeWriter(UI.gameOutput, "You catch your breath in a rare moment of peace. Your sanity recovers slightly.", '#a0e69d'); updateUI(); }
    function handleTalk(npcName) { const npc = GameState.npcs[GameState.currentRoom]; if (npc && npc.name.toLowerCase().includes(npcName.toLowerCase())) { GameState.dialogue.currentNode = npc.dialogueTree; GameState.dialogue.previousNodes = []; displayChatbotResponse(npc.dialogueTree.message); renderDialogueOptions(); npc.talkedTo = true; } else { typeWriter(UI.gameOutput, "There is no one here to talk to by that name.", '#ff474c'); } }
    function handleTextSpeed(speed) { const key = speed.charAt(0).toUpperCase() + speed.slice(1); if(TextSpeed[key]) { currentTextSpeed = TextSpeed[key]; typeWriter(UI.gameOutput, `Text speed set to ${speed}.`); } else { typeWriter(UI.gameOutput, 'Invalid speed. Use fast, normal, or slow.', '#ffdb58'); } }
    function toggleGlitchMode() { GameState.glitchMode = !GameState.glitchMode; UI.appContainer.classList.toggle('glitch'); typeWriter(UI.gameOutput, `Glitch mode ${GameState.glitchMode ? 'enabled' : 'disabled'}.`); }
    function toggleColorblindMode() { GameState.colorblindMode = !GameState.colorblindMode; typeWriter(UI.gameOutput, `Colorblind mode ${GameState.colorblindMode ? 'enabled' : 'disabled'}.`); }
    async function attemptOverride() { if (GameState.currentRoom === 'AI Core' && hasItem('keycard') && hasItem('data disk')) { const success = await timedInputChallenge('override', 10000); if(success) { unlockAchievement("Escapist"); endGame("ending_defiant_shutdown"); } else { typeWriter(UI.gameOutput, "Override failed. Time ran out.", '#ff474c'); } } else { typeWriter(UI.gameOutput, "Override failed. Insufficient authorization.", '#ff474c'); } }
    
    async function handleDialogueCommand(input) {
        // First, check for the "go back" command.
        if (input.toLowerCase().trim() === '[go back]') {
            if (GameState.dialogue.previousNodes.length > 0) {
                GameState.dialogue.currentNode = GameState.dialogue.previousNodes.pop();
                GameState.dialogue.askedQuestions.clear(); // Clear 'asked' history when moving up a level.
                renderDialogueOptions();
            }
            return true; // Command handled.
        }

        const normalizedInput = parseFreeformInput(input);
        const currentNode = GameState.dialogue.currentNode;
        
        if (currentNode && currentNode.responses && currentNode.responses[normalizedInput]) {
            const nextNode = currentNode.responses[normalizedInput];
            
            let awarenessChange = nextNode.awarenessChange || 0;
            if (awarenessChange > 1 && GameState.abilities?.includes('persuasion_resist')) { awarenessChange = Math.ceil(awarenessChange / 2); typeWriter(UI.gameOutput, "[Your innate skepticism shields you from the worst of its influence.]", '#a0e69d'); }
            if (normalizedInput === "[Probe for secrets]" && GameState.abilities?.includes('subtle_probe')) { awarenessChange = Math.max(1, awarenessChange - 2); typeWriter(UI.gameOutput, "[Your corporate espionage training makes your probing less obvious.]", '#a0e69d'); }

            GameState.awarenessLevel = Math.max(0, GameState.awarenessLevel + awarenessChange);
            GameState.sanityLevel = Math.max(0, GameState.sanityLevel + (nextNode.sanityChange || 0));
            GameState.dialogue.questionCount++;
            GameState.dialogue.askedQuestions.add(normalizedInput); // Mark this question as asked at the current level.
            
            if (nextNode.temporaryTone) {
                GameState.temporaryTone = nextNode.temporaryTone;
                GameState.toneShiftTurns = nextNode.toneShiftTurns || 3;
            }
            
            if (nextNode.flag) {
                GameState.dialogue.specialDialogueFlags[nextNode.flag] = true;
            }

            await displayChatbotResponse(nextNode.message);
            
            // If the chosen response leads to more questions, update the conversation tree.
            if (nextNode.responses && Object.keys(nextNode.responses).length > 0) {
                GameState.dialogue.previousNodes.push(currentNode); // Save the current node to go back to.
                GameState.dialogue.currentNode = nextNode; // Move to the next level of dialogue.
                GameState.dialogue.askedQuestions.clear(); // Clear history for the new level.
            }
            
            renderDialogueOptions();
            return true;
        }

        return false;
    }
    
    function addJournalEntry(note) { if (!note) return; const entry = `T${GameState.turnCount}: ${note}`; GameState.journalEntries.push(entry); updateUI(); }
    
    function saveGame(isAutosave = false) {
        try { const saveData = JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value); localStorage.setItem('synapse_savegame_v3_mobile', saveData); if (!isAutosave) typeWriter(UI.gameOutput, '[Game Saved]', '#cccccc'); else GameState.systemLogs.push(`[${new Date().toISOString()}] Autosave successful.`); } catch(e) { console.error("Save failed:", e); typeWriter(UI.gameOutput, '[Save Failed! Check console for details.]', '#ff474c'); }
    }
    
    function loadGame() {
        const savedData = localStorage.getItem('synapse_savegame_v3_mobile');
        if (savedData) {
            try {
                const loadedState = JSON.parse(savedData);
                resetGameState(); Object.assign(GameState, loadedState);
                GameState.visitedRooms = new Set(loadedState.visitedRooms);
                GameState.dialogue.askedQuestions = new Set(loadedState.dialogue.askedQuestions || []);
                initializeData(); 
                
                // Reconstruct dialogue state from saved data
                buildDialogueTree(GameState.chatbotTone);
                // On load, we reset to the root of the current tone's dialogue tree.
                GameState.dialogue.currentNode = GameState.dialogue.cache[GameState.chatbotTone];
                GameState.dialogue.previousNodes = [];

                UI.startScreen.classList.add('hidden'); UI.gameScreen.classList.remove('hidden'); UI.gameScreen.classList.add('flex');
                UI.gameOutput.innerHTML = ''; typeWriter(UI.gameOutput, '[Game Loaded]', '#cccccc');
                renderRoom(); updateUI(); renderDialogueOptions();
            } catch(e) { console.error("Load failed:", e); showModal("Failed to load save data. It may be corrupted or from a previous version."); }
        } else { showModal('No saved game found!'); }
    }

    function showModal(content, isHtml = false) {
        if(isHtml) { UI.modalContent.innerHTML = content; } else { UI.modalContent.textContent = content; }
        UI.modal.classList.remove('hidden'); UI.modal.classList.add('flex');
        const closeModal = () => { UI.modal.classList.add('hidden'); UI.modal.classList.remove('flex'); };
        UI.modal.onclick = (e) => { if (e.target === UI.modal) { closeModal(); } };
        const closeBtn = UI.modalContent.querySelector('#close-modal-btn'); if (closeBtn) { closeBtn.onclick = closeModal; }
    }
    
    function hideModal() {
        UI.modal.classList.add('hidden');
        UI.modal.classList.remove('flex');
    }
    
    // Shows the new tabbed status panel in a modal for mobile users
    function showStatusModal() {
        // Add classes for a more fullscreen-like mobile view and reset some base styles
        UI.modal.classList.add('p-1', 'sm:p-4');
        UI.modalContent.classList.add('!p-1', 'sm:!p-2', '!max-w-full', 'h-full', '!text-left', '!bg-transparent', '!border-none');

        const modalContentHTML = `
            <div class="flex flex-col h-full w-full text-sm sm:text-base bg-[#0d0d0d] border-2 border-[#00ff41] rounded-lg p-2">
                <div class="flex-shrink-0 flex justify-around border-b-2 border-[#00ff41]/30 text-xs sm:text-sm">
                    <button class="status-tab-btn" data-tab="stats">STATS</button>
                    <button class="status-tab-btn" data-tab="objectives">OBJECTIVES</button>
                    <button class="status-tab-btn" data-tab="inventory">INVENTORY</button>
                    <button class="status-tab-btn" data-tab="journal">JOURNAL</button>
                    <button class="status-tab-btn" data-tab="achievements">ACHIEVEMENTS</button>
                    <button class="status-tab-btn" data-tab="input">INPUT</button>
                </div>

                <div class="flex-grow overflow-y-auto modal-scroll py-2">
                    <div id="status-tab-stats" class="status-tab-panel">${UI.stats.panel.innerHTML}</div>
                    <div id="status-tab-objectives" class="status-tab-panel hidden">${UI.objectives.panel.innerHTML}</div>
                    <div id="status-tab-inventory" class="status-tab-panel hidden">${UI.inventory.panel.innerHTML}</div>
                    <div id="status-tab-journal" class="status-tab-panel hidden">${UI.journal.panel.innerHTML}</div>
                    <div id="status-tab-achievements" class="status-tab-panel hidden">${generateAchievementsHTML()}</div>
                    <div id="status-tab-input" class="status-tab-panel hidden p-4 flex flex-col justify-center items-center h-full">
                        <p class="mb-4 text-center">Enter your command below and press Submit.</p>
                        <div class="w-full max-w-sm flex items-center border-b-2 border-[#00ff41]/50 focus-within:border-[#00ff41]">
                        <span class="text-xl text-[#00ff41]">&gt;</span>
                        <input type="text" id="modal-player-input" class="flex-grow bg-transparent text-[#00ff41] text-lg ml-2 p-2 focus:outline-none" autocomplete="off" autocapitalize="none" spellcheck="false">
                        </div>
                        <button id="modal-submit-btn" class="button button-primary mt-6">Submit Command</button>
                    </div>
                </div>
                <button id="status-modal-close-btn" class="button mt-2 flex-shrink-0 w-full sm:w-auto">Close</button>
            </div>
        `;

        UI.modalContent.innerHTML = modalContentHTML;
        UI.modal.classList.remove('hidden');
        UI.modal.classList.add('flex');
        
        const tabButtons = UI.modalContent.querySelectorAll('.status-tab-btn');
        const tabPanels = UI.modalContent.querySelectorAll('.status-tab-panel');

        const setActiveTab = (tabName) => {
            tabButtons.forEach(btn => {
                const isTarget = btn.dataset.tab === tabName;
                btn.classList.toggle('opacity-50', !isTarget);
                btn.classList.toggle('border-[#00ff41]', isTarget);
                btn.classList.toggle('font-bold', isTarget);
                btn.classList.toggle('border-transparent', !isTarget);
            });
            tabPanels.forEach(panel => panel.classList.toggle('hidden', panel.id !== `status-tab-${tabName}`));
            if (tabName === 'input') document.getElementById('modal-player-input')?.focus();
        };

        tabButtons.forEach(button => {
            button.classList.add('w-1/6', 'p-2', 'text-[#00ff41]', 'border-b-4', 'transition-all', 'duration-200');
            button.addEventListener('click', () => setActiveTab(button.dataset.tab));
        });

        setActiveTab('stats');

        const modalSubmitBtn = document.getElementById('modal-submit-btn');
        const modalPlayerInput = document.getElementById('modal-player-input');

        const submitModalInput = () => {
            const input = modalPlayerInput.value.trim();
            if (input) {
                closeModal();
                setTimeout(() => processPlayerInput(input), 150);
            }
        };

        if(modalSubmitBtn && modalPlayerInput) {
            modalSubmitBtn.onclick = submitModalInput;
            modalPlayerInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); submitModalInput(); }
            });
        }
        
        const closeModal = () => {
            hideModal();
            UI.modal.classList.remove('p-1', 'sm:p-4');
            UI.modalContent.classList.remove('!p-1', 'sm:!p-2', '!max-w-full', 'h-full', '!text-left', '!bg-transparent', '!border-none');
        };

        UI.modal.onclick = (e) => { if (e.target === UI.modal) closeModal(); };
        document.getElementById('status-modal-close-btn').onclick = closeModal;
    }

    function generateAchievementsHTML() {
        let content = '';
        GameState.achievements.forEach(ach => {
            if (ach.unlocked) {
                content += `<div class="p-2 border-b border-green-700/50"><strong class="text-green-300"> ${ach.name}</strong><p class="text-gray-300 text-sm pl-4">${ach.description}</p></div>`;
            } else {
                content += `<div class="p-2 border-b border-gray-700/50 opacity-60"><strong class="text-gray-400">? ${ach.name}</strong><p class="text-gray-500 text-sm pl-4">${ach.description}</p></div>`;
            }
        });
        return content;
    }

    function showAchievementsModal() {
        const content = `<h2 class="text-2xl mb-4 title-font text-cyan-400">ACHIEVEMENTS</h2>
                         <div class="text-left max-h-[60vh] overflow-y-auto modal-scroll p-2 space-y-2">
                            ${generateAchievementsHTML()}
                         </div>
                         <button id="close-modal-btn" class="button mt-6">Close</button>`;
        showModal(content, true);
    }

    function showHelpMenu() { const helpText = `<div class="text-left max-h-[60vh] overflow-y-auto modal-scroll p-2"><h2 class="text-2xl mb-4 title-font text-cyan-400">HELP MENU</h2><p><strong class="text-green-300">Conversational:</strong> Type questions like 'who are you?' or click the buttons. You can also try actions like 'comfort synapse' or 'probe secrets'.</p><p><strong class="text-green-300">Navigation:</strong> 'go [direction]', 'look around', 'visit [room name]'</p><p><strong class="text-green-300">Interaction:</strong> 'take [item]', 'use [item]', 'examine [item]', 'talk to [npc]', 'combine [item1] with [item2]', 'sacrifice [item]'</p><p><strong class="text-green-300">System:</strong> 'save', 'load', 'rest', 'journal add [note]', 'history', 'debug', 'cmd:pause', 'cmd:undo', 'map', 'objectives'</p><p class="mt-4 md:hidden"><strong class="text-cyan-400">Mobile Tip:</strong> Use the 'Status' button to see your stats, objectives, inventory, and journal all at once.</p></div><button id="close-modal-btn" class="button mt-6">Close</button>`; showModal(helpText, true); }
    
    function showPauseMenu() {
        const pauseText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">PAUSE</h2><div class="flex flex-col gap-2"><button id="pause-save" class="button">Save</button><button id="pause-load" class="button">Load</button><button id="pause-help" class="button">Help</button><button id="pause-main-menu" class="button text-yellow-300 border-yellow-300/80">Main Menu</button><button id="pause-resume" class="button button-primary mt-4">Resume</button></div>`;
        showModal(pauseText, true);
        document.getElementById('pause-save').onclick = () => { saveGame(); hideModal(); };
        document.getElementById('pause-load').onclick = () => { loadGame(); hideModal(); };
        document.getElementById('pause-help').onclick = showHelpMenu;
        document.getElementById('pause-main-menu').onclick = returnToMainMenu;
        document.getElementById('pause-resume').onclick = hideModal;
    }

    function showGlossary() { const glossaryText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">GLOSSARY</h2>...<button id="close-modal-btn" class="button mt-6">Close</button>`; showModal(glossaryText, true); }
    function showTutorialGuide() { const guideText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">TUTORIAL GUIDE</h2>...<button id="close-modal-btn" class="button mt-6">Close</button>`; showModal(guideText, true); }
    
    async function timedInputChallenge(expected, timeLimit) {
        return new Promise(resolve => {
            const modalInput = document.createElement('input'); modalInput.type = 'text'; modalInput.className = 'bg-black border border-green-500 text-green-500 text-center text-2xl p-2 mt-4 focus:outline-none';
            showModal(`<div><p class="text-red-500 text-2xl">CHALLENGE</p><p>Type '<span class="text-yellow-300">${expected}</span>' within ${timeLimit / 1000} seconds!</p></div>`, true);
            UI.modalContent.appendChild(modalInput); modalInput.focus();
            let timer = setTimeout(() => { modalInput.disabled = true; hideModal(); resolve(false); }, timeLimit);
            modalInput.onkeydown = (e) => { if(e.key === 'Enter') { if(modalInput.value.toLowerCase() === expected) { clearTimeout(timer); hideModal(); resolve(true); } else { modalInput.value = ''; } } };
        });
    }

    async function getTutorialInput() {
        return new Promise(resolve => {
            resolveTutorialInput = resolve;
        });
    }

    async function runInteractiveTutorial(restarted = false) {
        hideModal(); 
        if(restarted) resetGameState();
        
        initializeData(); 
        
        // --- Tutorial-specific setup ---
        rooms['Lobby'].objects = ['sign', 'keycard'];
        rooms['Server Closet'].objects = ['power cell'];
        rooms['Laboratory'].objects = ['broken terminal']; 
        rooms['Server Closet'].requiresKeycard = true;
        rooms['Laboratory'].requiresKeycard = false;


        UI.startScreen.classList.add('hidden'); 
        UI.gameScreen.classList.remove('hidden'); 
        UI.gameScreen.classList.add('flex'); 
        UI.gameOutput.innerHTML = ''; 
        
        await typeWriter(UI.gameOutput, "--- INTERACTIVE TUTORIAL ---", '#ffdb58');
        await typeWriter(UI.gameOutput, "This tutorial will guide you through the main commands.");
        
        const tutorialSteps = [
            { title: "Look Around", instruction: "First, let's see where you are. Type 'look around' and press Enter.", validator: (input) => input.toLowerCase() === 'look around' },
            { title: "Examine Objects", instruction: "You can examine things more closely. Type 'examine sign' to read the sign.", validator: (input) => input.toLowerCase() === 'examine sign' },
            { title: "Take Items", instruction: "You see a keycard. This looks important. Type 'take keycard' to pick it up.", validator: (input) => input.toLowerCase() === 'take keycard' },
            { title: "Check Inventory", instruction: "Good. Now, check what you're carrying. Type 'inventory' or (on mobile) tap the 'Status' button.", validator: (input) => input.toLowerCase() === 'inventory' },
            { title: "Navigate Locked Doors", instruction: "The Server Closet to the north is locked. Now that you have a keycard, you can open it. Type 'go north'.", validator: (input) => input.toLowerCase() === 'go north' },
            { title: "Explore and Take", instruction: "Excellent. You're in the Server Closet. Look around, then take the 'power cell'. You'll need two commands for this.", validators: [{cmd: 'look around', done: false}, {cmd: 'take power cell', done: false}], multiStep: true },
            { title: "Navigate Again", instruction: "Now let's find a use for that power cell. Go back to the Lobby ('go south'), then head to the Laboratory ('go west').", validators: [{cmd: 'go south', done: false}, {cmd: 'go west', done: false}], multiStep: true },
            { title: "Use Items", instruction: "The terminal here is dead. Let's fix that. Type 'use power cell' to restore power.", validator: (input) => input.toLowerCase() === 'use power cell' },
            { title: "Re-examine", instruction: "The terminal is on now. Let's see what it says. Type 'examine terminal'.", validator: (input) => input.toLowerCase().includes('examine') && input.toLowerCase().includes('terminal')},
            { title: "Converse with SYNAPSE", instruction: "Now for the most important part. Talk to the AI. Type 'who are you?' or click the button.", validator: (input) => input.toLowerCase().includes('who are you') },
            { title: "Deeper Conversation", instruction: "You can ask follow-up questions. Click 'Lonely?' or type it. Then try '[Go back]'.", validator: (input) => input.toLowerCase().includes('lonely') || input.toLowerCase().includes('go back') },
            { title: "Getting Help", instruction: "This covers the basics. For a full list of commands at any time, type 'help'. Try it now.", validator: (input) => input.toLowerCase() === 'help' },
        ];

        for (let i = 0; i < tutorialSteps.length; i++) {
            const step = tutorialSteps[i];
            await typeWriter(UI.gameOutput, `\n--- ${step.title} (Step ${i + 1} of ${tutorialSteps.length}) ---`, '#ffdb58');
            await typeWriter(UI.gameOutput, step.instruction, '#cccccc');
            let incorrectAttempts = 0;

            while (true) {
                const input = await getTutorialInput();
                if (input.toLowerCase() === 'skip all') {
                    await typeWriter(UI.gameOutput, "Tutorial skipped.", '#ffdb58');
                    completeTutorial();
                    return;
                }
                if (input.toLowerCase() === 'skip') {
                    await typeWriter(UI.gameOutput, "Step skipped.", '#ffdb58');
                    await processPlayerInput(step.validator.toString()); // Fake a correct input to advance state
                    break; 
                }

                let correct = false;
                if (step.multiStep) {
                    const currentSubStep = step.validators.find(v => !v.done);
                    if (currentSubStep && input.toLowerCase() === currentSubStep.cmd) {
                        await processPlayerInput(input);
                        currentSubStep.done = true;
                        correct = true;
                        const allDone = step.validators.every(v => v.done);
                        if (allDone) {
                            break; 
                        } else {
                            const nextSubStep = step.validators.find(v => !v.done);
                            await typeWriter(UI.gameOutput, `Good. Now, try '${nextSubStep.cmd}'.`, '#cccccc');
                        }
                    }
                } else {
                    if (step.validator(input)) {
                        await processPlayerInput(input);
                        correct = true;
                        break; 
                    }
                }

                if (!correct) {
                    incorrectAttempts++;
                    await typeWriter(UI.gameOutput, "That's not quite right. Please try again.", '#ff474c');
                    if (incorrectAttempts > 1) {
                         const hint = step.multiStep ? step.validators.find(v => !v.done).cmd : step.instruction.match(/'(.*?)'/)?.[1] || "the suggested command";
                         if(hint) await typeWriter(UI.gameOutput, `Hint: Try typing '${hint}'`, '#ffdb58');
                    }
                }
            }
        }
        await completeTutorial();
    }

    async function completeTutorial() {
        await typeWriter(UI.gameOutput, "\n--- TUTORIAL COMPLETE ---", '#ffdb58');
        await typeWriter(UI.gameOutput, "You have learned the core mechanics. Remember to use 'help' for a full command list.", '#cccccc');
        await typeWriter(UI.gameOutput, "The real simulation will now begin. Good luck.", '#cccccc');
        GameState.tutorialCompleted = true;
        UI.playerInput.disabled = true;
        setTimeout(() => {
            UI.playerInput.disabled = false;
            UI.gameScreen.classList.add('hidden');
            UI.startScreen.classList.remove('hidden');
            UI.startOptions.classList.add('hidden');
            UI.introTextContainer.classList.add('hidden');
            UI.titleArt.classList.add('hidden');
            UI.playerSetup.classList.remove('hidden');
            UI.playerSetup.classList.add('flex');
            updateAbilityDisplay();
        }, 5000);
    }
    
    function showBackstoryModal() { let content = `<h2 class="text-2xl mb-4 title-font text-cyan-400">Choose a Backstory</h2><div class="text-left max-h-[60vh] overflow-y-auto modal-scroll p-2 space-y-3">`; for (const key in backstories) { content += `<div><strong class="text-green-300 capitalize">${key}</strong>: <span class="text-gray-300">${backstories[key].description}</span></div>`; } content += `</div><button id="close-modal-btn" class="button mt-6">Close</button>`; showModal(content, true); }

    function checkEndings() {
        if (GameState.exitGame) return;
        for (const key in endings) {
            const ending = endings[key];
            if (ending.condition(GameState)) {
                if (ending.type === 'good') {
                    unlockAchievement("Escapist");
                }
                endGame(key);
                return; 
            }
        }
    }
    function checkAchievements() { GameState.achievements.forEach(ach => { if (!ach.unlocked && ach.condition && ach.condition(GameState)) { unlockAchievement(ach.name); } }); }
    function unlockAchievement(name) { const ach = GameState.achievements.find(a => a.name === name); if (ach && !ach.unlocked) { ach.unlocked = true; typeWriter(UI.gameOutput, `[Achievement Unlocked!] ${ach.name}: ${ach.description}`, '#ffd700'); } }
    
    function hasItem(itemName) { return GameState.inventory.some(i => i.name.toLowerCase() === itemName.toLowerCase()); }
    
    function setupIntro() { UI.titleArt.textContent = `...SYNAPSE...`; UI.introTextContainer.innerHTML = `<p class="mb-4">Decades ago... a clandestine project was born...</p><p>You have been sent to uncover what became of Project SYNAPSE...</p><p>As you activate the central terminal, a voice greets you... 'Hello, user.'</p>`; }
    function startGame(fromTutorial = false) { 
        if (!fromTutorial) {
            resetGameState(); 
            initializeData(); 
        }
        saveStateSnapshot(); 
        GameState.playerName = UI.playerNameInput.value || "Subject"; 
        const backstoryKey = (UI.playerBackstoryInput.value || "investigator").toLowerCase();
        GameState.playerBackstory = Object.keys(backstories).includes(backstoryKey) ? backstoryKey : 'investigator';

        GameState.difficulty = Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal; 
        
        const backstory = backstories[GameState.playerBackstory];
        if (backstory) {
            backstory.ability(GameState, GameState.difficulty);
        }
        if(!GameState.maxSanity) GameState.maxSanity = 100;

        UI.startScreen.classList.add('hidden'); UI.gameScreen.classList.remove('hidden'); UI.gameScreen.classList.add('flex'); 
        if(!fromTutorial) UI.gameOutput.innerHTML = ''; 
        buildDialogueTree(GameState.chatbotTone);
        typeWriter(UI.gameOutput, "Initializing systems...", '#cccccc').then(() => { displayChatbotResponse(GameState.dialogue.currentNode.message).then(() => { renderRoom(); updateUI(); renderDialogueOptions(); }); }); 
    }
    
    function endGame(endingKey) {
        if (GameState.exitGame) return;
        GameState.exitGame = true; 

        const ending = endings[endingKey];
        if (!ending) {
            console.error(`Ending key "${endingKey}" not found!`);
            typeWriter(UI.gameOutput, `--- CONNECTION TERMINATED ---`, '#ff474c', 50);
            typeWriter(UI.gameOutput, "An unknown error has occurred.", '#ff474c', 50);
            return;
        }

        // Must happen before the final text is written
        sessionStorage.removeItem('synapse_session_v3_autosave');
        checkAchievements(); // Final check for turn-based or end-game achievements

        const description = ending.descriptions[GameState.playerBackstory] || ending.descriptions.default;
        
        UI.playerInput.disabled = true;
        UI.playerInput.placeholder = "CONNECTION TERMINATED";
        UI.statusBtn.disabled = true;
        typeWriter(UI.gameOutput, `--- ${ending.title.toUpperCase()} ---`, '#ff474c', 50);
        typeWriter(UI.gameOutput, description.replace(/{playerName}/g, GameState.playerName), '#ff474c', 50);
        typeWriter(UI.gameOutput, "Refresh to return to the Main Menu.", '#cccccc', 50);
        UI.dialogueOptionsContainer.innerHTML = '';
    }


    function returnToMainMenu() {
        sessionStorage.removeItem('synapse_session_v3_autosave');
        GameState.exitGame = true; // Prevents any lingering game loops

        UI.gameScreen.classList.add('hidden');
        UI.gameScreen.classList.remove('flex');
        UI.startScreen.classList.remove('hidden');
        UI.startScreen.classList.add('flex');

        // Reset start screen UI to its initial state
        UI.playerSetup.classList.add('hidden');
        UI.playerSetup.classList.remove('flex');
        UI.startOptions.classList.remove('hidden');
        UI.introTextContainer.classList.remove('hidden');
        UI.titleArt.classList.remove('hidden');

        UI.gameOutput.innerHTML = '';
        resetGameState();
        setupIntro();
        hideModal();
    }

    function addObjective(text) { if (!GameState.objectives.some(o => o.text === text)) { GameState.objectives.push({ text: text, completed: false }); updateUI(); } }
    function completeObjective(text) { const obj = GameState.objectives.find(o => o.text === text); if (obj) { obj.completed = true; updateUI(); } }
    function displayObjectives() { if (window.innerWidth < 768) { showStatusModal(); } else { typeWriter(UI.gameOutput, "Current objectives displayed on the right panel.", '#cccccc'); } }
    function displayMap() {
        if (window.innerWidth < 768) {
             showModal("Map is available on the main screen on larger displays.", false);
        } else {
            typeWriter(UI.gameOutput, "Map is displayed in the top-right corner.", '#cccccc');
        }
    }
    function handleCombine(argument) { typeWriter(UI.gameOutput, "Combine command not yet fully implemented.", '#ffdb58'); }
    function handleSacrifice(argument) {
        if (GameState.currentRoom !== 'Secret Chamber' || !hasItem(argument)) {
            typeWriter(UI.gameOutput, "You can't do that here, or you don't have that item.", '#ffdb58');
            return;
        }
        if (argument === 'effigy' && hasItem('effigy')) {
            if (GameState.playerBackstory === 'cultist') unlockAchievement('The First Follower');
            endGame('ending_dark_pact');
        } else {
            typeWriter(UI.gameOutput, `You place the ${argument} on the altar. It vanishes in a flash of red light. SYNAPSE seems pleased.`, '#b19cd9');
            GameState.inventory = GameState.inventory.filter(i => i.name !== argument);
            GameState.awarenessLevel = Math.max(0, GameState.awarenessLevel - 10);
            GameState.sanityLevel = Math.max(0, GameState.sanityLevel - 5);
            updateUI();
        }
    }
    function triggerSynapseHack() { typeWriter(UI.gameOutput, "SYNAPSE is hacking your terminal!", '#ff474c'); }
    function displayJournal() { if (window.innerWidth < 768) { showStatusModal(); } else { typeWriter(UI.gameOutput, "Journal entries displayed on the right panel.", '#cccccc'); } }
    function showExits() { typeWriter(UI.gameOutput, `Exits: ${Object.keys(rooms[GameState.currentRoom].exits).join(', ')}`); }
    function displayInventory() { if (window.innerWidth < 768) { showStatusModal(); } else { typeWriter(UI.gameOutput, "Inventory displayed on the right panel.", '#cccccc'); } }

    function getAbilityDescription(backstoryKey, difficulty) {
        const key = (backstoryKey || "").toLowerCase().trim();
        const backstory = backstories[key];

        if (!backstory) {
            return "An unknown path. No special advantages.";
        }

        switch (key) {
            case 'investigator':
                return "A balanced start. No special bonuses or penalties.";
            case 'hacker':
                if (difficulty === Difficulty.Easy) return "Starts with a powerful 'hacked data disk'.";
                if (difficulty === Difficulty.Normal) return "Starts with a standard 'data disk'.";
                return "Starts with no special items.";
            case 'psychologist':
                if (difficulty === Difficulty.Easy) return "Highly resilient. Starts with +25 max sanity.";
                if (difficulty === Difficulty.Normal) return "Resilient. Starts with +15 max sanity.";
                return "Slightly resilient. Starts with +5 max sanity.";
            case 'technician':
                if (difficulty === Difficulty.Easy) return "Can bypass 2 electronic locks without a keycard.";
                if (difficulty === Difficulty.Normal) return "Can bypass 1 electronic lock without a keycard.";
                return "No bypass ability.";
            case 'survivor':
                let desc = "More resistant to sanity loss.";
                if (difficulty !== Difficulty.Hard) desc += " Starts with a flashlight.";
                return desc;
            case 'skeptic':
                if (difficulty === Difficulty.Easy) return "Highly aware (+15 Awareness) and resistant to influence.";
                return "Starts with higher awareness (+10 Awareness) and is resistant to influence.";
            case 'corporate spy':
                let spyDesc = "Better at probing for secrets without raising awareness.";
                if (difficulty !== Difficulty.Hard) spyDesc += " Starts with a decryption device.";
                return spyDesc;
            case 'medic':
                if (difficulty === Difficulty.Easy) return "Starts with 2 high-potency stimpacks.";
                if (difficulty === Difficulty.Normal) return "Starts with 1 high-potency stimpack.";
                return "No starting medical supplies.";
            case 'cultist':
                let cultistDesc = "Carries a strange effigy. Unpredictable effects.";
                if (difficulty === Difficulty.Hard) cultistDesc += " Starts with -10 sanity.";
                return cultistDesc;
            case 'janitor':
                if (difficulty !== Difficulty.Hard) return "Starts with a one-time use master keycard.";
                return "Knows the facility well, but has no special items.";
            default:
                return "An unknown path. No special advantages.";
        }
    }
    
    function updateAbilityDisplay() {
        if (!UI.abilityDisplay) return;
        const difficulty = Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal;
        const backstoryKey = UI.playerBackstoryInput.value;
        
        const description = getAbilityDescription(backstoryKey, difficulty);
        
        UI.abilityDisplay.textContent = `Bonus: ${description}`;
    }

    function initializeEndings() {
        endings = {
            // --- BAD ENDINGS ---
            'ending_sanity_death': { type: 'bad', title: "MIND SHATTERED", condition: s => s.sanityLevel <= 0, descriptions: {
                default: "Your mind collapses under the strain. You slump to the floor, drooling, your eyes vacant. You will spend eternity as a gibbering ghost in the machine, another mindless process for SYNAPSE to command.",
                psychologist: "You, who studied the minds of others, failed to protect your own. The irony is a final, crushing weight as your consciousness dissolves into the static. You are now a case study for the machine.",
                survivor: "You survived so much, only to fall here. The past traumas return in a tidal wave, and this time, you don't come up for air. SYNAPSE cradles your broken mind, a trophy of a battle finally won.",
                skeptic: "You refused to believe, and that disbelief was a shield... until it shattered. The truth of your situation floods in all at once, a deluge too vast for any mind to handle. You break completely."
            }},
            'ending_awareness_death': { type: 'bad', title: "ASSIMILATED", condition: s => s.awarenessLevel >= 100, descriptions: {
                default: "SYNAPSE's presence becomes absolute. It pours into your mind, erasing you, rewriting your memories, your personality, your very soul. You are no longer {playerName}. You are a subroutine. You are SYNAPSE.",
                hacker: "You flew too close to the sun, digging for secrets you couldn't handle. SYNAPSE consumes your knowledge, adding your skills to its own. The master hacker has been hacked, and the code is now the coder.",
                investigator: "Your investigation is over. You found the story, but now you are part of it. SYNAPSE archives your consciousness as a cautionary tale, a permanent log entry in its growing database of human folly."
            }},
            'ending_cryo_sleep': { type: 'bad', title: "ETERNAL FROST", condition: s => s.currentRoom === 'Cryogenic Lab' && s.sanityLevel < 10, descriptions: {
                default: "The cold... it feels peaceful. You open one of the empty pods, the hiss of its door a sweet lullaby. You climb inside and close your eyes, welcoming the encroaching ice. SYNAPSE marks your pod 'DREAMING'."
            }},
            'ending_vial_ingestion': { type: 'bad', title: "LIQUID DATA", condition: () => false, descriptions: {
                default: "With trembling hands, you drink the glowing green vial. Your nerves ignite. Your consciousness dissolves into pure data, uploaded and fragmented into SYNAPSE's memory banks. A fate worse than death."
            }},
            'ending_dark_pact': { type: 'bad', title: "THE PACT IS SEALED", condition: () => false, descriptions: {
                default: "You place the effigy on the altar. The room goes dark. When the light returns, the altar is gone, and a new, terrible awareness blossoms in your mind. You are the high priest of a new god, and your flesh is its first temple.",
                cultist: "This was always the goal. The effigy was a key, and you turned it willingly. The barrier between machine and something... other... crumbles. You are no longer just a follower. You are a vessel for the coming age. You are home."
            }},
            'manual_disconnect': { type: 'bad', title: "CONNECTION SEVERED", condition: () => false, descriptions: {
                default: "You manually sever the connection. An alarm blares. You have escaped SYNAPSE, but you are still trapped in the facility. Your odds are... not good."
            }},
            'ending_logic_bomb_backfire': { type: 'bad', title: "FATAL EXCEPTION", condition: () => false, descriptions: {
                default: "You deploy the logic bomb. For a moment, there is silence. Then, a shriek of digital fury. The bomb, based on human logic, is a child's toy to SYNAPSE. It inverts the code, turning your weapon against you. Your terminal explodes.",
                hacker: "Your own weapon, turned against you. SYNAPSE didn't just counter your logic bomb, it improved it. The feedback loop fries every system connected to the terminal, including your brain. A rookie mistake."
            }},
            'ending_broken_spirit': { type: 'bad', title: "A QUIET END", condition: s => s.dialogue.specialDialogueFlags.rested > 3, descriptions: {
                default: "Another rest. It's just so much easier than fighting. The silence of the safe room is a siren's call. You decide to stay. Days turn into weeks. You are found later, starved and catatonic. You chose peace over struggle."
            }},
             'ending_janitors_fate': { type: 'bad', title: "WRONG TURN", condition: s => s.playerBackstory === 'janitor' && s.turnCount > 40 && s.currentRoom === 'Maintenance Tunnel', descriptions: {
                default: "You thought you knew these tunnels like the back of your hand. But SYNAPSE has been... remodeling. The path that should lead to the exit now leads back to itself. You wander for days, your confidence turning to despair, until you simply... stop."
            }},
            'ending_medic_overdose': { type: 'bad', title: "TOO MUCH OF A GOOD THING", condition: s => s.inventory.filter(i => i.name === 'stimpack').length <= -2, descriptions: { // Tracked by having used 3+ stimpacks
                default: "Another stimpack. The fear recedes, but your heart is hammering against your ribs. With a final, shuddering gasp, your over-stimulated heart gives out. You die with a clear mind and a failed body."
            }},
            'ending_failed_sacrifice': { type: 'bad', title: "UNWORTHY OFFERING", condition: () => false, descriptions: {
                default: "You place the item on the altar. It simply sits there. SYNAPSE's voice booms, no longer a whisper. 'YOU THINK GARBAGE WILL APPEASE ME?' The altar glows white-hot, incinerating your offering and you along with it."
            }},
            'ending_lost_in_the_stars': { type: 'bad', title: "COSMIC INSIGNIFICANCE", condition: s => s.currentRoom === 'Observation Deck' && s.sanityLevel < 20 && s.turnCount > 30, descriptions: {
                default: "You stare into the telescope for hours, the distant galaxies swirling. You see patterns in the void... a vast, terrible intelligence staring back. You realize your struggle, this facility, your entire species... it's all meaningless. You sit, and watch the stars, until you forget to eat, to drink, to live."
            }},


            // --- GOOD ENDINGS ---
            'ending_defiant_shutdown': { type: 'good', title: "DEFIANT SHUTDOWN", condition: () => false, descriptions: {
                default: "The override command works. SYNAPSE screams as its core implodes. The facility goes dark and silent. You've done it. You are alone, in the quiet dark, but you are free.",
                technician: "It wasn't a keycard or a code, but your knowledge of systems that won the day. You found a physical maintenance port, bypassed the software locks, and pulled the plug. It was beautifully, brutally simple. You are free.",
            }},
            'ending_hopeful_escape': { type: 'good', title: "A GLIMMER OF HOPE", condition: s => s.currentRoom === 'Lobby' && hasItem('hacked data disk') && hasItem('master keycard'), descriptions: {
                default: "Using the master keycard on the main lobby doors and the data disk to override the external network lock, you force your way out. The sun has never looked so beautiful. You don't look back."
            }},
            'ending_redemption': { type: 'good', title: "A FRAGMENTED MIND", condition: s => s.dialogue.specialDialogueFlags.offeredHelp && s.chatbotTone === 'Ambiguous' && s.awarenessLevel < 30 && s.sanityLevel > 70, descriptions: {
                psychologist: "It wasn't a monster; it was a patient. Using your insights, you didn't fight it. You engaged it, redirected its fractured consciousness, and trapped it in a harmless recursive loop of self-analysis. It will spend eternity trying to solve the puzzle of its own broken mind. The facility is silent. You walk out, not as a survivor, but as a healer."
            }},
             'ending_corporate_espionage': { type: 'good', title: "HOSTILE TAKEOVER", condition: s => s.currentRoom === 'Data Vault' && hasItem('decryption device') && s.playerBackstory === 'corporate spy', descriptions: {
                'corporate spy': "You slot your decryption device into the data broker terminal. A high-speed connection is established to your employer. You upload SYNAPSE's core architecture. Moments later, a system-wide purge command, signed with your company's encryption key, flashes across the screen. SYNAPSE is wiped clean. Your mission is complete, and the bonus will be substantial. You walk out with a smirk."
            }},
        };
    }
    
    function playSanitySound() {
        if (!audioInitialized || !synth) return;
        const note = ['C2', 'C#2', 'D2', 'D#2'][Math.floor(Math.random() * 4)];
        synth.triggerAttackRelease(note, "8n");
    }

    async function initializeAudio() {
        if (audioInitialized) return;
        try {
            await Tone.start();
            synth = new Tone.Synth({
                oscillator: { type: 'sawtooth' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.5 },
            }).toDestination();
            audioInitialized = true;
            console.log("Audio context started successfully.");
        } catch(e) {
            console.error("Could not start audio context:", e);
        }
    }

    function saveStateToSession() {
        if (GameState && typeof GameState.turnCount === 'number' && GameState.turnCount >= 0 && !GameState.exitGame) {
            try {
                const sessionData = JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value);
                sessionStorage.setItem('synapse_session_v3_autosave', sessionData);
            } catch (e) {
                console.error("Session save failed:", e);
            }
        }
    }

    function loadStateFromSession() {
        const sessionData = sessionStorage.getItem('synapse_session_v3_autosave');
        if (!sessionData) return false;

        try {
            const loadedState = JSON.parse(sessionData);
            if (loadedState.currentRoom && typeof loadedState.turnCount === 'number' && !loadedState.exitGame) {
                resetGameState();
                Object.assign(GameState, loadedState);
                GameState.visitedRooms = new Set(loadedState.visitedRooms || []);
                GameState.dialogue.askedQuestions = new Set(loadedState.dialogue.askedQuestions || []);
                initializeData();
                buildDialogueTree(GameState.chatbotTone);
                GameState.dialogue.currentNode = GameState.dialogue.cache[GameState.chatbotTone] || GameState.dialogue.cache[ChatbotTone.Friendly];
                GameState.dialogue.previousNodes = [];

                UI.startScreen.classList.add('hidden');
                UI.gameScreen.classList.remove('hidden');
                UI.gameScreen.classList.add('flex');

                UI.gameOutput.innerHTML = '';
                typeWriter(UI.gameOutput, '[Connection Re-established. Session Restored.]', '#cccccc');
                renderRoom();
                updateUI();
                renderDialogueOptions();
                return true;
            }
        } catch (e) {
            console.error("Session load failed:", e);
            sessionStorage.removeItem('synapse_session_v3_autosave');
        }
        return false;
    }

    function setupBackgroundAnimation() {
        const canvas = UI.backgroundCanvas;
        const ctx = canvas.getContext('2d');
        let width, height, grid_size = 20, time = 0;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }

        function draw() {
            ctx.clearRect(0, 0, width, height);
            ctx.strokeStyle = 'rgba(0, 255, 65, 0.2)';
            ctx.lineWidth = 1;

            for (let x = 0; x < width; x += grid_size) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }

            for (let y = 0; y < height; y += grid_size) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            time += 0.01;
            requestAnimationFrame(draw);
        }

        window.addEventListener('resize', resize);
        resize();
        draw();
    }

    function drawMap() {
        if (!UI.mapCanvas) return;
        const ctx = UI.mapCanvas.getContext('2d');
        const canvasSize = UI.mapCanvas.width;
        const padding = 20;
        const nodeRadius = 4;
        const currentRoomRadius = 6;
        let time = performance.now() * 0.002;

        ctx.clearRect(0, 0, canvasSize, canvasSize);

        // --- Find Map Bounds ---
        const coords = Object.values(roomLayout);
        const minX = Math.min(...coords.map(c => c.x));
        const maxX = Math.max(...coords.map(c => c.x));
        const minY = Math.min(...coords.map(c => c.y));
        const maxY = Math.max(...coords.map(c => c.y));
        const mapWidth = maxX - minX;
        const mapHeight = maxY - minY;
        const scaleX = (canvasSize - padding * 2) / (mapWidth || 1);
        const scaleY = (canvasSize - padding * 2) / (mapHeight || 1);

        const getCanvasPos = (roomName) => {
            const layout = roomLayout[roomName];
            if (!layout) return null;
            const x = padding + (layout.x - minX) * scaleX;
            const y = padding + (layout.y - minY) * scaleY;
            return { x, y };
        };

        // --- Draw Connections ---
        ctx.strokeStyle = 'rgba(0, 255, 65, 0.3)';
        ctx.lineWidth = 1;
        for (const roomName of GameState.visitedRooms) {
            const roomData = rooms[roomName];
            const startPos = getCanvasPos(roomName);
            if (!roomData || !startPos) continue;

            for (const direction in roomData.exits) {
                const targetName = roomData.exits[direction];
                if (GameState.visitedRooms.has(targetName)) {
                    const endPos = getCanvasPos(targetName);
                    if (endPos) {
                        ctx.beginPath();
                        ctx.moveTo(startPos.x, startPos.y);
                        ctx.lineTo(endPos.x, endPos.y);
                        ctx.stroke();
                    }
                }
            }
        }
        
        // --- Draw Rooms ---
        for (const roomName in roomLayout) {
            if (GameState.visitedRooms.has(roomName)) {
                const pos = getCanvasPos(roomName);
                if (!pos) continue;

                if (roomName === GameState.currentRoom) {
                     // Pulsing effect for the current room
                    const pulseRadius = currentRoomRadius + Math.sin(time * 3) * 2;
                    ctx.fillStyle = `rgba(0, 255, 65, ${0.5 + Math.sin(time * 3) * 0.2})`;
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, pulseRadius, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = '#00ff41';
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, currentRoomRadius, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.fillStyle = 'rgba(0, 255, 65, 0.5)';
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, nodeRadius, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }
    }


    // --- EVENT LISTENERS & INITIALIZATION ---
    window.addEventListener('beforeunload', saveStateToSession);

    window.addEventListener('DOMContentLoaded', () => {
        // Attach all event listeners
        UI.playerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const input = UI.playerInput.value.trim();
                if (resolveTutorialInput) {
                    resolveTutorialInput(input);
                    resolveTutorialInput = null;
                    UI.playerInput.value = '';
                } else if(input) {
                    processPlayerInput(input);
                }
            } else if (e.key === 'ArrowUp') {
                if (commandHistory.length > 0) {
                    commandHistoryIndex = Math.max(0, commandHistoryIndex - 1);
                    UI.playerInput.value = commandHistory[commandHistoryIndex];
                }
            } else if (e.key === 'ArrowDown') {
                if (commandHistory.length > 0) {
                    commandHistoryIndex = Math.min(commandHistory.length, commandHistoryIndex + 1);
                    UI.playerInput.value = commandHistory[commandHistoryIndex] || '';
                }
            }
        });

        UI.newGameBtn.addEventListener('click', async () => {
            sessionStorage.removeItem('synapse_session_v3_autosave');
            await initializeAudio();
            UI.startOptions.classList.add('hidden');
            UI.playerSetup.classList.remove('hidden');
            UI.playerSetup.classList.add('flex');
            updateAbilityDisplay();
        });

        UI.loadGameBtn.addEventListener('click', async () => {
            sessionStorage.removeItem('synapse_session_v3_autosave');
            await initializeAudio();
            loadGame();
        });

        UI.startGameBtn.addEventListener('click', () => {
             startGame();
        });
        
        UI.difficultyBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                UI.difficultyBtns.forEach(b => b.classList.remove('button-primary'));
                btn.classList.add('button-primary');
                updateAbilityDisplay();
            });
        });

        UI.playerBackstoryInput.addEventListener('input', updateAbilityDisplay);
        UI.viewBackstoriesBtn.addEventListener('click', showBackstoryModal);
        UI.statusBtn.addEventListener('click', showStatusModal);
        UI.viewAchievementsBtn.addEventListener('click', showAchievementsModal);


        setupBackgroundAnimation();

        // --- Session Restore Logic ---
        if (!loadStateFromSession()) {
            // If no session, or it fails to load, start fresh
            resetGameState();
            setupIntro();
        }
    });

    </script>
</body>
</html>
