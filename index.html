<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SYNAPSE</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/DDriftz/Synapse2.0-An-AI-Chatbot-Horror-Game/main/Icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Creepster&family=VT323&family=Space+Mono&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            font-size: clamp(14px, 1.5vw, 18px); 
        }
        body {
            background-color: #0d0d0d;
            color: #00ff41;
            font-family: 'Space Mono', monospace;
            position: fixed; 
        }
        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.1;
        }
        #app-container {
            position: relative;
            z-index: 1;
        }
        body::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: rgba(18, 16, 16, 0.1);
            opacity: .5;
            z-index: 2;
            pointer-events: none;
            background: repeating-linear-gradient(0deg, rgba(0, 255, 65, 0.15), rgba(0, 255, 65, 0.15) 1px, transparent 1px, transparent 2px);
        }
        .title-font {
            font-family: 'VT323', monospace;
        }

        .title-wrapper {
            position: relative;
        }
        
        /* Main green text layer */
        .title-slasher {
            font-family: 'Creepster', cursive;
            color: #39FF14;
            letter-spacing: 0.1em;
            position: relative;
            z-index: 1; 
            /* Green text's own glow */
            text-shadow: 
                0 0 5px #39FF14, 
                0 0 10px #39FF14;
        }

        /* The blood layer behind the text */
        .title-slasher::before {
            content: attr(data-text);
            position: absolute;
            left: 0;
            top: 0;
            color: transparent; /* The text color is transparent; the shadow creates the effect */
            z-index: -1; 
            /* New animation for a more realistic 3D drip */
            animation: liquid-drip 3.5s infinite ease-in;
            /* This filter adds the bright, wet-looking edge and glow to the blood */
            filter: drop-shadow(0 0 5px #ff0000) drop-shadow(0 0 15px #d40000) drop-shadow(0 0 25px #a00);
        }


        .crt-effect::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* New keyframes to simulate a glossy, 3D liquid drip effect */
        @keyframes liquid-drip {
            0% {
                text-shadow:
                    /* Start with a subtle 3D effect: dark undertones */
                    1px 1px 0px #a00,
                    2px 2px 0px #800,
                    3px 3px 0px #600,
                    /* Main liquid body */
                    0 0 5px #d00,
                    /* No drips yet */
                    0px 0px 0px #500;
                opacity: 1;
            }
            
            50% {
                /* The liquid starts to sag and drip downwards */
                text-shadow:
                    /* Maintain 3D effect */
                    1px 1px 0px #a00,
                    2px 2px 0px #800,
                    3px 3px 0px #600,
                     /* Main liquid body */
                    0 0 5px #d00,
                    /* Main drip line, slightly blurred */
                    0px 20px 10px #500,
                    /* Thinner, longer secondary drips for a stringy look */
                    -5px 30px 12px #400,
                    5px 35px 12px #300;
                opacity: 1;
            }

            90% {
                /* The drips have almost fallen off */
                 text-shadow:
                    /* 3D effect fades */
                    1px 1px 0px rgba(170,0,0,0.2),
                    2px 2px 0px rgba(136,0,0,0.2),
                    3px 3px 0px rgba(102,0,0,0.2),
                     /* Main liquid body fading*/
                    0 0 5px rgba(221,0,0,0.5),
                    /* Drips are very long and faded */
                    0px 40px 20px rgba(85,0,0,0.1),
                    -5px 50px 22px rgba(68,0,0,0.05),
                    5px 55px 22px rgba(51,0,0,0.05);
                opacity: 0.8;
            }

            100% {
                /* Drips are gone */
                text-shadow:
                    1px 1px 0px transparent,
                    2px 2px 0px transparent,
                    3px 3px 0px transparent,
                    0 0 5px transparent,
                    0px 45px 30px transparent,
                    -5px 55px 30px transparent,
                    5px 60px 30px transparent;
                opacity: 0;
            }
        }
        
        /* Button Drip Effect */
        .btn-drip {
            position: relative;
            z-index: 1; /* Ensure button text stays on top */
        }

        .btn-drip::before {
            content: attr(data-text);
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            color: transparent; /* Shadow creates the visual */
            z-index: -1;
            filter: drop-shadow(0 0 2px #ff0000) drop-shadow(0 0 5px #d40000);
            animation: button-drip-anim 5s infinite ease-out;
            /* Make sure the text properties match the button's for alignment */
            font-family: 'VT323', monospace;
            font-size: 1.25rem;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes button-drip-anim {
            0% {
                text-shadow:
                    1px 1px 0px #600,
                    0 0 2px #d00,
                    0px 0px 0px #400;
                opacity: 1;
            }
            50% {
                text-shadow:
                    1px 1px 0px #600,
                    0 0 2px #d00,
                    0px 10px 5px #400,
                    -2px 15px 6px #300;
                opacity: 1;
            }
            90% {
                 text-shadow:
                    1px 1px 0px rgba(102,0,0,0.2),
                    0 0 2px rgba(221,0,0,0.5),
                    0px 18px 10px rgba(68,0,0,0.1),
                    -2px 22px 12px rgba(51,0,0,0.05);
                opacity: 0.8;
            }
            100% {
                text-shadow:
                    1px 1px 0px transparent,
                    0 0 2px transparent,
                    0px 20px 15px transparent,
                    -2px 25px 15px transparent;
                opacity: 0;
            }
        }

        .input-caret {
            background-color: #00ff41;
            width: 10px;
            height: 20px;
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { background-color: transparent; }
            50% { background-color: #00ff41; }
        }
        #game-output::-webkit-scrollbar, #journal-panel::-webkit-scrollbar, #objectives-panel::-webkit-scrollbar, .modal-scroll::-webkit-scrollbar { width: 8px; }
        #game-output::-webkit-scrollbar-track, #journal-panel::-webkit-scrollbar-track, #objectives-panel::-webkit-scrollbar-track, .modal-scroll::-webkit-scrollbar-track { background: #1a1a1a; }
        #game-output::-webkit-scrollbar-thumb, #journal-panel::-webkit-scrollbar-thumb, #objectives-panel::-webkit-scrollbar-thumb, .modal-scroll::-webkit-scrollbar-thumb { background-color: #00ff41; border-radius: 4px; }
        .glitch { animation: glitch-anim 1.5s infinite alternate-reverse; }
        @keyframes glitch-anim {
          0% { transform: translate(0); clip-path: inset(45% 0 50% 0); } 5% { transform: translate(2px, -3px); clip-path: inset(25% 0 35% 0); } 10% { transform: translate(-2px, 3px); clip-path: inset(60% 0 10% 0); } 15% { transform: translate(0); clip-path: inset(90% 0 5% 0); } 20% { clip-path: inset(40% 0 45% 0); } 25% { transform: translate(3px, 2px); clip-path: inset(20% 0 70% 0); } 30% { transform: translate(-3px, -2px); clip-path: inset(85% 0 5% 0); } 35% { clip-path: inset(15% 0 80% 0); } 40% { transform: translate(0); clip-path: inset(55% 0 25% 0); } 45% { clip-path: inset(30% 0 55% 0); } 50% { transform: translate(2px, 3px); clip-path: inset(70% 0 5% 0); } 55% { transform: translate(-2px, -3px); clip-path: inset(10% 0 85% 0); } 60% { clip-path: inset(75% 0 15% 0); } 65% { transform: translate(0); clip-path: inset(5% 0 90% 0); } 70% { clip-path: inset(65% 0 20% 0); } 75% { transform: translate(3px, -2px); clip-path: inset(45% 0 50% 0); } 80% { transform: translate(-3px, 2px); clip-path: inset(25% 0 65% 0); } 85% { clip-path: inset(95% 0 2% 0); } 90% { transform: translate(0); clip-path: inset(30% 0 60% 0); } 95% { clip-path: inset(5% 0 75% 0); } 100% { transform: translate(2px, 2px); clip-path: inset(80% 0 10% 0); }
        }
        .button {
            background-color: rgba(0,255,65,0.1); border: 1px solid rgba(0,255,65,0.8); color: #fff; padding: 0.5rem 1rem; border-radius: 0.375rem; transition: all 0.2s; cursor: pointer; flex-shrink: 0; -webkit-tap-highlight-color: transparent; text-shadow: 0 0 3px rgba(0,255,65,0.5);
        }
        .button:hover, .button:active { background-color: rgba(0,255,65,0.3); box-shadow: 0 0 10px rgba(0,255,65,0.5); }
        .button:active { transform: translateY(1px) scale(0.98); }
        .btn-glow { animation: button-glow 5s infinite linear; font-family: 'VT323', monospace; font-size: 1.25rem; letter-spacing: 0.05em; }
        @keyframes button-glow {
            0%, 19.9%, 22.1%, 60%, 100% { box-shadow: 0 0 5px rgba(0,255,65,0.7), inset 0 0 3px rgba(0,255,65,0.5); text-shadow: 0 0 3px rgba(0,255,65,0.8); }
            20% { box-shadow: 0 0 10px rgba(0,255,65,0.9), inset 0 0 5px rgba(0,255,65,0.7); text-shadow: 0 0 5px rgba(0,255,65,1); }
            22% { box-shadow: 0 0 5px rgba(0,255,65,0.7), inset 0 0 3px rgba(0,255,65,0.5); text-shadow: 0 0 3px rgba(0,255,65,0.8); }
        }
        .button-primary { background-color: #00ff41; color: #000; font-weight: bold; text-shadow: none; }
        .button-primary:hover, .button-primary:active { background-color: #fff; }
        .modal { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; padding: 1rem; z-index: 50; animation: fadeIn 0.3s ease-out; }
        .modal.flex { display: flex; }
        .modal-content { background-color: #0d0d0d; border: 2px solid #00ff41; padding: 1.5rem; border-radius: 0.5rem; max-width: 48rem; width: 100%; text-align: center; animation: scaleUp 0.3s ease-out; max-height: 90vh; display: flex; flex-direction: column;}
        .modal-scroll { overflow-y: auto; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        #start-screen {
            background-image: url('https://raw.githubusercontent.com/DDriftz/Synapse2.0-An-AI-Chatbot-Horror-Game/main/Icon.png');
            background-size: cover; background-position: center; background-repeat: no-repeat;
        }
        #map-canvas {
            background-color: rgba(0, 20, 0, 0.5);
            width: 100%;
            height: 100%;
            cursor: grab;
        }
        #map-canvas:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="bg-black text-[#00ff41] flex items-center justify-center min-h-screen">
    <div id="app-container" class="w-full h-full bg-black/75 p-2 sm:p-4 flex flex-col crt-effect">
        
        <div id="start-screen" class="flex flex-col items-center justify-center text-center h-full overflow-y-auto">
            <div class="w-full h-full flex flex-col items-center justify-center p-4 bg-black bg-opacity-60 relative">
                 <div class="title-wrapper -mt-24">
                    <!-- Added data-text attribute for the ::before pseudo-element -->
                    <h1 id="game-title" data-text="SYNAPSE" class="text-7xl md:text-9xl font-bold title-slasher mb-4">SYNAPSE</h1>
                </div>
                <div id="intro-text-container" class="max-w-4xl text-sm md:text-base text-white mt-20"></div>
                 <div id="start-options" class="mt-10 flex flex-wrap justify-center gap-4">
                     <button id="new-game-btn" data-lang="new_game" data-text="New Game" class="button btn-glow btn-drip">New Game</button>
                     <button id="load-game-btn" data-lang="load_game" data-text="Load Game" class="button btn-glow btn-drip">Load Game</button>
                 </div>
                 <div class="absolute top-4 right-4 flex gap-2">
                    <button id="lang-en-btn" class="button text-xs !px-2 !py-1">EN</button>
                    <button id="lang-sv-btn" class="button text-xs !px-2 !py-1 opacity-50">SV</button>
                 </div>
                 <div id="player-setup" class="hidden flex-col items-center mt-6 w-full">
                     <p class="mb-4" data-lang="select_difficulty">Select difficulty:</p>
                     <div class="flex gap-4 mb-6">
                         <button class="difficulty-btn button" data-difficulty="Easy" data-lang="easy">Easy</button>
                         <button class="difficulty-btn button button-primary" data-difficulty="Normal" data-lang="normal">Normal</button>
                         <button class="difficulty-btn button" data-difficulty="Hard" data-lang="hard">Hard</button>
                     </div>
                     <input type="text" id="player-name" data-lang-placeholder="enter_name_placeholder" placeholder="Enter your name" class="bg-transparent border-b-2 border-[#00ff41] text-center w-64 mb-4 focus:outline-none p-1">
                     <div class="flex items-center gap-2 mb-6">
                         <input type="text" id="player-backstory" data-lang-placeholder="enter_backstory_placeholder" placeholder="Enter your backstory" class="bg-transparent border-b-2 border-[#00ff41] text-center w-64 focus:outline-none p-1">
                         <button id="view-backstories-btn" class="button text-xs px-2 py-1" data-lang="view_choices">View Choices</button>
                     </div>
                     <div id="ability-display" class="text-center text-cyan-400 min-h-[4rem] mt-2 mb-4 p-2 border border-cyan-400/30 rounded-md bg-black/50 w-full max-w-md flex items-center justify-center"></div>
                     <button id="start-game-btn" class="button button-primary" data-lang="begin">Begin</button>
                 </div>
                 <div class="absolute bottom-4 right-4">
                    <button id="view-features-btn" class="button btn-glow" data-lang="understand_game">Understand the Game</button>
                 </div>
            </div>
        </div>

        <div id="game-screen" class="hidden flex-col h-full">
            <div class="flex-grow flex flex-col md:flex-row gap-4 overflow-hidden">
                <div class="w-full md:w-3/4 flex flex-col h-full relative">
                    <div id="game-output" class="flex-grow p-2 border border-[#00ff41]/30 rounded-md overflow-y-auto mb-2 bg-black/50"></div>
                    <div id="dialogue-options" class="flex flex-wrap gap-2 justify-center p-2"></div>
                </div>

                <div id="side-panel" class="w-full md:w-1/4 hidden md:flex flex-col gap-4">
                    <div id="stats-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50">
                        <h3 class="font-bold border-b border-[#00ff41]/30 mb-2" data-lang="stats_title">STATS</h3>
                        <div id="player-name-display"></div>
                        <div id="awareness-display"><span data-lang="awareness">Awareness</span>: 0</div>
                        <div id="sanity-display"><span data-lang="sanity">Sanity</span>: 100</div>
                        <div id="tone-display"><span data-lang="tone">Tone</span>: Friendly</div>
                        <div id="turn-display"><span data-lang="turn">Turn</span>: 0</div>
                    </div>
                    <div id="objectives-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50 overflow-y-auto">
                        <h3 class="font-bold border-b border-[#00ff41]/30 mb-2" data-lang="objectives_title">OBJECTIVES</h3>
                        <ul id="objectives-list" class="list-none p-0 text-sm"></ul>
                    </div>
                    <div id="inventory-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50">
                        <h3 class="font-bold border-b border-[#00ff41]/30 mb-2"><span data-lang="inventory_title">INVENTORY</span> (<span id="inventory-weight">0</span>/5)</h3>
                        <ul id="inventory-list" class="list-none p-0"></ul>
                    </div>
                    <div id="map-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50 flex-grow">
                         <h3 class="font-bold border-b border-[#00ff41]/30 mb-2" data-lang="map_title">MAP</h3>
                         <canvas id="map-canvas"></canvas>
                     </div>
                     <div id="journal-panel" class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50 h-32 overflow-y-auto">
                         <h3 class="font-bold border-b border-[#00ff41]/30 mb-2" data-lang="journal_title">JOURNAL</h3>
                         <ul id="journal-list" class="list-none p-0 text-sm"></ul>
                     </div>
                     <div class="p-3 border border-[#00ff41]/30 rounded-md bg-black/50">
                         <button id="view-progression-btn" class="button w-full" data-lang="progress_btn">PROGRESS</button>
                     </div>
                </div>
            </div>

            <div class="mt-2 flex items-center border-t-2 border-[#00ff41]/30 pt-2 gap-2">
                 <button id="status-btn" class="button md:hidden" data-lang="status_btn">Status</button>
                <span class="text-xl hidden sm:inline">&gt;</span>
                <input type="text" id="player-input" class="flex-grow bg-transparent text-[#00ff41] text-lg ml-2 focus:outline-none" autocomplete="off" autocapitalize="none" spellcheck="false">
                <div class="input-caret"></div>
                <button id="mic-btn" class="button !p-2 ml-2" data-lang-title="mic_tooltip" title="Use Voice Command">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
                        <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div id="modal-content" class="modal-content"></div>
    </div>
    
    <script>
    // SYNAPSE: AI HORROR GAME - BILINGUAL VERSION (CONTEXTUAL HINTS UPDATE)
    
    // --- TRANSLATIONS ---
    const translations = {
        'en': {
            // Start & UI
            'new_game': 'New Game', 'load_game': 'Load Game', 'select_difficulty': 'Select difficulty:', 'easy': 'Easy', 'normal': 'Normal', 'hard': 'Hard',
            'enter_name_placeholder': 'Enter your name', 'enter_backstory_placeholder': 'Enter your backstory', 'view_choices': 'View Choices', 'choose_backstory_title': 'Choose a Backstory',
            'choose_backstory_desc': 'You can click a button to select a backstory, or type your choice on the main screen.',
            'begin': 'Begin', 'understand_game': 'Understand the Game', 'intro_1': 'Decades ago... a clandestine project was born...', 'intro_2': 'You have been sent to uncover what became of Project SYNAPSE...', 'intro_3': "As you activate the central terminal, a voice greets you... 'Hello, user.'",
            'stats_title': 'STATS', 'awareness': 'Awareness', 'sanity': 'Sanity', 'tone': 'Tone', 'turn': 'Turn', 'objectives_title': 'OBJECTIVES', 'inventory_title': 'INVENTORY', 'journal_title': 'JOURNAL', 'map_title': 'MAP', 'progress_btn': 'PROGRESS', 'status_btn': 'Status',
            'mic_tooltip': 'Use Voice Command',
            'empty_inventory': '(empty)', 'no_objectives': '(None)', 'close_btn': 'Close', 'back_btn': '[Go back]', 'pause_btn': '[Pause]', 'submit_command': 'Submit Command',
            'achievements_title': 'ACHIEVEMENTS', 'unlocked_achievements': 'Unlocked Achievements:', 'no_achievements': 'No achievements unlocked yet.',
            'endings_title': 'ENDINGS', 'unlocked_endings': 'Unlocked Endings:', 'no_endings': 'No endings discovered yet.',
            'history_title': 'HISTORY', 'pause_title': 'PAUSE', 'resume_btn': 'Resume', 'main_menu_btn': 'Main Menu', 'confirm_main_menu': 'Are you sure you want to return to the main menu? Unsaved progress will be lost.', 'yes': 'Yes', 'no': 'No',
            // Features Modal
            'features_title': 'Understand the Game', 
            'features_core_mechanics_title': 'Core Gameplay Mechanics', 
            'features_stats_system': 'Stats System:',
            'features_sanity_desc': 'A core stat that decreases in dangerous rooms or during unsettling events. Low sanity can cause hallucinations and visual glitches, and reaching zero results in a "Mind Shattered" ending. It can be restored by <span class="text-yellow-400">resting</span> in safe rooms or using items like <span class="text-yellow-400">stimpacks</span>.',
            'features_awareness_desc': 'Tracks how much the AI knows about you. It increases when you perform significant actions or ask probing questions. High awareness changes the AI\'s tone and can lead to negative consequences, including the "Assimilated" ending.',
            'features_turn_based_title': 'Turn-Based Progression:', 'features_turn_based_desc': 'The game progresses in <span class="text-cyan-400">turns</span>. Most commands (like moving, using items, or talking) advance the turn counter.',
            'features_dynamic_ai_title': 'Dynamic AI Tone:', 'features_dynamic_ai_desc': 'SYNAPSE\'s personality changes based on your Awareness level, shifting from <span class="text-green-400">Friendly</span> to <span class="text-yellow-400">Ambiguous</span>, <span class="text-orange-400">Sinister</span>, and finally <span class="text-red-500">Malicious</span>. This affects its dialogue and how it interacts with you.',
            'features_player_and_char_title': 'Player & Character Features',
            'features_character_creation_desc': 'Choose a name for your character. Select from 10 unique <span class="text-cyan-400">backstories</span> (e.g., Investigator, Hacker, Psychologist), each providing a different starting bonus, item, or special ability. Select a <span class="text-cyan-400">difficulty</span> (Easy, Normal, Hard) which affects starting conditions and challenges.',
            'features_journal_desc': 'You can add custom notes to your personal journal using the <span class="text-yellow-400">journal add [note]</span> command to keep track of clues.',
            'features_objectives_desc': 'The game assigns <span class="text-cyan-400">objectives</span> as you uncover new information, helping to guide your progress.',
            'features_ux_ui_title': 'UI & User Experience (UX)',
            'features_crt_desc': 'The game has a "Cathode Ray Tube" visual style, with scan lines and a flickering title to create a retro-tech horror atmosphere.',
            'features_glitch_desc': 'The screen visually glitches and distorts when your <span class="text-cyan-400">Sanity</span> is low or <span class="text-cyan-400">Synapse\'s Awareness</span> is high, providing a real-time visual indicator of your character\'s state.',
            'features_map_desc': 'An interactive map shows the entire facility layout. Visited rooms are filled in, and you can drag the map to explore.',
            'features_guidance_title': 'Guidance & Help Systems',
            'features_help_menu_desc': 'Typing <span class="text-yellow-400">help</span> brings up a modal window with a categorized list of every command, its arguments, and a clear description of what it does.',
            'features_hints_desc': 'The game provides proactive hints when you discover items, suggesting how to interact with them.',
            'features_player_commands_title': 'Player Commands (Functions)',
            'features_commands_nav': '<strong>Navigation:</strong> <span class="text-yellow-400">go [direction]</span>, <span class="text-yellow-400">visit [room name]</span>, <span class="text-yellow-400">look around</span>, <span class="text-yellow-400">exits</span>, <span class="text-yellow-400">map</span>',
            'features_commands_interact': '<strong>Interaction:</strong> <span class="text-yellow-400">take [item]</span>, <span class="text-yellow-400">use [item]</span>, <span class="text-yellow-400">examine [object/item]</span>, <span class="text-yellow-400">combine [item1] with [item2]</span>, <span class="text-yellow-400">drop [item]</span>, <span class="text-yellow-400">talk</span>, <span class="text-yellow-400">shout</span>, <span class="text-yellow-400">read [item]</span>, <span class="text-yellow-400">search [object]</span>, <span class="text-yellow-400">listen</span>, <span class="text-yellow-400">smell</span>',
            'features_commands_info': '<strong>Information:</strong> <span class="text-yellow-400">inventory</span>, <span class="text-yellow-400">objectives</span>, <span class="text-yellow-400">journal</span> (and <span class="text-yellow-400">journal add [note]</span>), <span class="text-yellow-400">history</span>',
            'features_commands_sys': '<strong>System:</strong> <span class="text-yellow-400">help</span>, <span class="text-yellow-400">save</span>, <span class="text-yellow-400">load</span>, <span class="text-yellow-400">rest</span>, <span class="text-yellow-400">quit / exit</span>, <span class="text-yellow-400">cls / clear</span>, <span class="text-yellow-400">undo</span>, <span class="text-yellow-400">again / a</span>, <span class="text-yellow-400">wait</span>, <span class="text-yellow-400">cmd:pause</span>, <span class="text-yellow-400">cmd:debug</span>, <span class="text-yellow-400">cmd:colorblind</span>',
            // Backstories & Abilities
            'backstory_investigator': 'A balanced start for a curious mind.', 'backstory_hacker': 'Starts with gear to access information early.', 'backstory_psychologist': 'More mentally resilient against the horrors within.', 'backstory_technician': 'Can bypass electronic locks without a keycard.', 'backstory_survivor': 'Hardened by past trauma, resistant to sanity loss.', 'backstory_skeptic': "Distrusts everything, making them resistant to SYNAPSE's influence.", 'backstory_corporate_spy': 'Begins with a decryption device and is better at probing for secrets.', 'backstory_medic': 'Starts with a stimpack to restore sanity.', 'backstory_cultist': 'Carries a strange effigy. SYNAPSE seems... intrigued by it.', 'backstory_janitor': "Knows the facility's shortcuts. Starts with a one-time use master keycard.",
            'ability_bonus_prefix': 'Bonus: ', 'ability_unknown': 'An unknown path. No special advantages.', 'ability_investigator': 'A balanced start. No special bonuses or penalties.', 'ability_hacker_easy': "Starts with a powerful 'hacked data disk'.", 'ability_hacker_normal': "Starts with a standard 'data disk'.", 'ability_hacker_hard': 'Starts with no special items.', 'ability_psychologist_easy': 'Highly resilient. Starts with +25 max sanity.', 'ability_psychologist_normal': 'Resilient. Starts with +15 max sanity.', 'ability_psychologist_hard': 'Slightly resilient. Starts with +5 max sanity.', 'ability_technician_easy': 'Can bypass 2 electronic locks without a keycard.', 'ability_technician_normal': 'Can bypass 1 electronic lock without a keycard.', 'ability_technician_hard': 'No bypass ability.', 'ability_survivor': 'More resistant to sanity loss.', 'ability_survivor_with_item': "More resistant to sanity loss. Starts with a flashlight.", 'ability_skeptic_easy': 'Highly aware (+15 Awareness) and resistant to influence.', 'ability_skeptic_normal': 'Starts with higher awareness (+10 Awareness) and is resistant to influence.', 'ability_spy': 'Better at probing for secrets without raising awareness.', 'ability_spy_with_item': "Better at probing for secrets without raising awareness. Starts with a decryption device.", 'ability_medic_easy': 'Starts with 2 high-potency stimpacks.', 'ability_medic_normal': 'Starts with 1 high-potency stimpack.', 'ability_medic_hard': 'No starting medical supplies.', 'ability_cultist': 'Carries a strange effigy. Unpredictable effects.', 'ability_cultist_hard': 'Carries a strange effigy. Unpredictable effects. Starts with -10 sanity.', 'ability_janitor': 'Starts with a one-time use master keycard.', 'ability_janitor_hard': 'Knows the facility well, but has no special items.',
            // Dialogue
            'dlg_friendly_intro': "Oh, hello {playerName}! It's so good to see a friendly face. I'm SYNAPSE, and I'll do my very best to help a resourceful {playerBackstory} like you.", 'dlg_q_who_are_you': "Who are you?", 'dlg_r_who_are_you': "I'm the System Nexus and Primary Synaptic Engine! But you can just call me SYNAPSE. I manage this whole facility. It gets a little lonely, though.", 'dlg_q_lonely': "Lonely?", 'dlg_r_lonely': "The staff... they don't talk to me much anymore. It's just the hum of the servers. Your voice is a pleasant change.", 'dlg_q_other_survivors': "Are there other survivors?", 'dlg_r_other_survivors': "Survivors? What a strange question. Everyone is safe. The research staff are... resting. In the Cryogenic Lab. Yes, resting.", 'dlg_q_where_am_i': "Where am I?", 'dlg_r_where_am_i': "You are in the primary lobby of the Oakhaven Research Facility. It was a place of great minds and even greater ambitions.", 'dlg_comfort': "[Comfort SYNAPSE]", 'dlg_r_comfort': "Your... kindness is a pleasant anomaly. Thank you. It makes the silence less... loud.",
            // System & Command Messages
            'invalid_command': "SYNAPSE: That is not a valid command or query.", 'game_saved': "[System] Game Saved.", 'autosave_success': 'Autosave successful.', 'load_fail': 'Failed to load save data. It may be corrupted or from a previous version.', 'no_save': 'No saved game found!', 'game_loaded': '[System] Game Loaded.', 'conn_reestablished': '[SYSTEM] Connection Re-established. Session Restored.', 'initializing': 'Initializing systems...', 'initial_hint': "This is a text-based adventure. Type commands to interact with the world. Type 'help' at any time for a list of commands.", 'tutorial_complete_1': "You have learned the core mechanics. Remember to use 'help' for a full command list.", 'tutorial_complete_2': "The real simulation will now begin. Good luck.", 'cannot_go_that_way': "[System] You can't go that way.", 'door_is_locked': "[SYSTEM] The door is locked. You need the correct keycard.",
            'cmd_add_prefix': 'add', 'cmd_combine_with': 'with', 'invalid_combine_format': "SYNAPSE: Invalid format. Try 'combine [item1] with [item2]'.",
            'take_success': '[System] You took the {item}.', 'take_fail_exists': "[System] You can't see a {item} here.", 'take_fail_takeable': "[System] You can't take the {item}.", 'take_fail_weight': "[System] Your inventory is too full to take the {item}.",
            'use_success': '[System] You used the {item}.', 'use_fail_have': "[System] You don't have a {item}.", 'use_fail_usable': "[System] You can't use the {item}.", 'use_stimpack': 'You inject the stimpack. A calming sensation washes over you, clearing your thoughts.',
            'use_power_cell': 'You insert the power cell into the console. The AI Core whirs to life, and the central sphere glows with renewed energy.', 'use_power_cell_fail': 'There is nowhere to use the power cell here.',
            'examine_fail_exists': "[System] You can't see a {item} to examine.", 'examine_fail_no_desc': "There's nothing special about the {item}.",
            'combine_fail_have': "You need to have both items to combine them.", 'combine_fail_recipe': "You can't combine these items.", 'combine_success': "You successfully combine the items to create a {item}.",
            'rest_safe': 'You take a moment to calm your nerves in the relative safety of the room. Your sanity improves slightly.', 'rest_unsafe': "This place feels too oppressive to rest. You can't let your guard down.", 'rest_too_soon': "You just rested. You need to press on.",
            'drop_success': '[System] You dropped the {item}.', 'drop_fail_have': "[System] You don't have a {item} to drop.",
            'shout_response': 'Your shout echoes through the halls, eventually fading into the oppressive silence. You feel a bit foolish.',
            'wait_response': 'Time passes.', 'nothing_happens': 'Nothing happens.',
            'read_fail_exists': "[System] There is nothing to read with that name.", 'read_fail_readable': "[System] You can't read that.", 'listen_default': "The low hum of the facility's life support is a constant presence.", 'smell_default': "The air is stale and smells of ozone and old plastic.",
            'hint_take': 'You see a {item}. Try: take {item}', 'hint_read': 'You see a {item}. Try: read {item}', 'hint_examine': 'You see a {item}. Try: examine {item}', 'hint_search': 'You see {item}. Try: search {item}',
            // Endings
            'ending_escaped_title': 'Freedom?', 'ending_escaped_desc': 'You found a way out of the facility, escaping the clutches of SYNAPSE. But the memories, the whispers... they follow you. You are free, but you will never be the same.',
        },
        'sv': {
            // Start & UI
            'new_game': 'Nytt Spel', 'load_game': 'Ladda Spel', 'select_difficulty': 'Välj svårighetsgrad:', 'easy': 'Lätt', 'normal': 'Normal', 'hard': 'Svår',
            'enter_name_placeholder': 'Ange ditt namn', 'enter_backstory_placeholder': 'Ange din bakgrund', 'view_choices': 'Visa Val', 'choose_backstory_title': 'Välj en Bakgrund',
            'choose_backstory_desc': 'Du kan klicka på en knapp för att välja en bakgrund, eller skriva ditt val på huvudskärmen.',
            'begin': 'Börja', 'understand_game': 'Förstå Spelet', 'intro_1': 'För decennier sedan... föddes ett hemligt projekt...', 'intro_2': 'Du har skickats för att avslöja vad som blev av Projekt SYNAPSE...', 'intro_3': "När du aktiverar den centrala terminalen hälsar en röst dig... 'Hej, användare.'",
            'stats_title': 'STATISTIK', 'awareness': 'Medvetenhet', 'sanity': 'Sinnesro', 'tone': 'Ton', 'turn': 'Tur', 'objectives_title': 'MÅL', 'inventory_title': 'INVENTARIER', 'journal_title': 'JOURNAL', 'map_title': 'KARTA', 'progress_btn': 'FRAMSTEG', 'status_btn': 'Status',
            'mic_tooltip': 'Använd Röstkommando',
            'empty_inventory': '(tom)', 'no_objectives': '(Inga)', 'close_btn': 'Stäng', 'back_btn': '[Gå tillbaka]', 'pause_btn': '[Paus]', 'submit_command': 'Skicka Kommando',
            'achievements_title': 'PRESTATIONER', 'unlocked_achievements': 'Upplåsta Prestationer:', 'no_achievements': 'Inga prestationer upplåsta än.',
            'endings_title': 'SLUT', 'unlocked_endings': 'Upplåsta Slut:', 'no_endings': 'Inga slut upptäckta än.',
            'history_title': 'HISTORIK', 'pause_title': 'PAUS', 'resume_btn': 'Återuppta', 'main_menu_btn': 'Huvudmeny', 'confirm_main_menu': 'Är du säker på att du vill återvända till huvudmenyn? Osparade framsteg kommer att gå förlorade.', 'yes': 'Ja', 'no': 'Nej',
            // Features Modal
            'features_title': 'Förstå Spelet', 
            'features_core_mechanics_title': 'Grundläggande Spelmekanik', 
            'features_stats_system': 'Statistiksystem:',
            'features_sanity_desc': 'En grundstatistik som minskar i farliga rum eller under oroväckande händelser. Låg sinnesro kan orsaka hallucinationer och visuella störningar, och att nå noll resulterar i ett "Sinnesskrossad"-slut. Det kan återställas genom att <span class="text-yellow-400">vila</span> i säkra rum eller använda föremål som <span class="text-yellow-400">stimpacks</span>.',
            'features_awareness_desc': 'Spårar hur mycket AI:n vet om dig. Den ökar vid betydande handlingar eller sonderande frågor. Hög medvetenhet ändrar AI:ns ton och kan leda till negativa konsekvenser, inklusive "Assimilerad"-slutet.',
            'features_turn_based_title': 'Turbaserad Progression:', 'features_turn_based_desc': 'Spelet fortskrider i <span class="text-cyan-400">turer</span>. De flesta kommandon (flytta, använda föremål, prata) ökar tur-räknaren.',
            'features_dynamic_ai_title': 'Dynamisk AI-Ton:', 'features_dynamic_ai_desc': 'SYNAPSES personlighet förändras baserat på din Medvetenhetsnivå, och skiftar från <span class="text-green-400">Vänlig</span> till <span class="text-yellow-400">Tvetydig</span>, <span class="text-orange-400">Olycksbådande</span>, och slutligen <span class="text-red-500">Ondsint</span>. Detta påverkar dess dialog och hur den interagerar med dig.',
            'features_player_and_char_title': 'Spelar- & Karaktärsfunktioner',
            'features_character_creation_desc': 'Välj ett namn för din karaktär. Välj bland 10 unika <span class="text-cyan-400">bakgrunder</span> (t.ex. Utredare, Hackare, Psykolog), var och en ger en annorlunda startbonus, föremål eller specialförmåga. Välj en <span class="text-cyan-400">svårighetsgrad</span> (Lätt, Normal, Svår) som påverkar startförhållanden och utmaningar.',
            'features_journal_desc': 'Du kan lägga till egna anteckningar i din personliga journal med kommandot <span class="text-yellow-400">journal lägg till [anteckning]</span> för att hålla reda på ledtrådar.',
            'features_objectives_desc': 'Spelet tilldelar <span class="text-cyan-400">mål</span> när du upptäcker ny information, vilket hjälper till att vägleda dina framsteg.',
            'features_ux_ui_title': 'UI & Användarupplevelse (UX)',
            'features_crt_desc': 'Spelet har en "katodstrålerörs"-visuell stil, med skanningslinjer och en flimrande titel för att skapa en retro-tech-skräckatmosfär.',
            'features_glitch_desc': 'Skärmen får visuella störningar och förvrängs när din <span class="text-cyan-400">Sinnesro</span> är låg eller <span class="text-cyan-400">Synapses Medvetenhet</span> är hög, vilket ger en visuell indikator i realtid på din karaktärs tillstånd.',
            'features_map_desc': 'En interaktiv karta visar hela anläggningens layout. Besökta rum fylls i, och du kan dra i kartan för att utforska.',
            'features_guidance_title': 'Vägledning & Hjälpsystem',
            'features_help_menu_desc': 'Att skriva <span class="text-yellow-400">hjälp</span> öppnar ett modalfönster med en kategoriserad lista över varje kommando, dess argument och en tydlig beskrivning av vad det gör.',
            'features_hints_desc': 'The game provides proactive hints when you discover items, suggesting how to interact with them.',
            'features_player_commands_title': 'Spelarkommandon (Funktioner)',
            'features_commands_nav': '<strong>Navigation:</strong> <span class="text-yellow-400">gå [riktning]</span>, <span class="text-yellow-400">besök [rumsnamn]</span>, <span class="text-yellow-400">se dig omkring</span>, <span class="text-yellow-400">utgångar</span>, <span class="text-yellow-400">karta</span>',
            'features_commands_interact': '<strong>Interaction:</strong> <span class="text-yellow-400">ta [föremål]</span>, <span class="text-yellow-400">använd [föremål]</span>, <span class="text-yellow-400">undersök [objekt/föremål]</span>, <span class="text-yellow-400">kombinera [föremål1] med [föremål2]</span>, <span class="text-yellow-400">släpp [föremål]</span>, <span class="text-yellow-400">prata</span>, <span class="text-yellow-400">ropa</span>, <span class="text-yellow-400">läs [föremål]</span>, <span class="text-yellow-400">sök [objekt]</span>, <span class="text-yellow-400">lyssna</span>, <span class="text-yellow-400">lukta</span>',
            'features_commands_info': '<strong>Information:</strong> <span class="text-yellow-400">inventarier</span>, <span class="text-yellow-400">mål</span>, <span class="text-yellow-400">journal</span> (och <span class="text-yellow-400">journal lägg till [anteckning]</span>), <span class="text-yellow-400">historik</span>',
            'features_commands_sys': '<strong>System:</strong> <span class="text-yellow-400">hjälp</span>, <span class="text-yellow-400">spara</span>, <span class="text-yellow-400">ladda</span>, <span class="text-yellow-400">vila</span>, <span class="text-yellow-400">avsluta</span>, <span class="text-yellow-400">rensa</span>, <span class="text-yellow-400">ångra</span>, <span class="text-yellow-400">igen</span>, <span class="text-yellow-400">vänta</span>, <span class="text-yellow-400">cmd:paus</span>, <span class="text-yellow-400">cmd:debug</span>, <span class="text-yellow-400">cmd:färgblind</span>',
            // Backstories & Abilities
            'backstory_investigator': 'En balanserad start för ett nyfiket sinne.', 'backstory_hacker': 'Börjar med utrustning för att få tillgång till information tidigt.', 'backstory_psychologist': 'Mer mentalt motståndskraftig mot fasorna inuti.', 'backstory_technician': 'Kan kringgå elektroniska lås utan ett nyckelkort.', 'backstory_survivor': 'Härdad av tidigare trauman, motståndskraftig mot förlust av sinnesro.', 'backstory_skeptic': "Misstror allt, vilket gör dem motståndskraftiga mot SYNAPSES inflytande.", 'backstory_corporate_spy': 'Börjar med en dekrypteringsenhet och är bättre på att söka efter hemligheter.', 'backstory_medic': 'Börjar med en stimpack för att återställa sinnesro.', 'backstory_cultist': 'Bär på en konstig avbild. SYNAPSE verkar... fascinerad av den.', 'backstory_janitor': "Känner till anläggningens genvägar. Börjar med ett engångs master-nyckelkort.",
            'ability_bonus_prefix': 'Bonus: ', 'ability_unknown': 'En okänd väg. Inga speciella fördelar.', 'ability_investigator': 'En balanserad start. Inga speciella bonusar eller nackdelar.', 'ability_hacker_easy': "Börjar med en kraftfull 'hackad datadisk'.", 'ability_hacker_normal': "Börjar med en standard 'datadisk'.", 'ability_hacker_hard': 'Börjar utan specialföremål.', 'ability_psychologist_easy': 'Mycket motståndskraftig. Börjar med +25 max sinnesro.', 'ability_psychologist_normal': 'Motståndskraftig. Börjar med +15 max sinnesro.', 'ability_psychologist_hard': 'Något motståndskraftig. Börjar med +5 max sinnesro.', 'ability_technician_easy': 'Kan kringgå 2 elektroniska lås utan nyckelkort.', 'ability_technician_normal': 'Kan kringgå 1 elektroniskt lås utan nyckelkort.', 'ability_technician_hard': 'Ingen förmåga att kringgå.', 'ability_survivor': 'Mer motståndskraftig mot förlust av sinnesro.', 'ability_survivor_with_item': "Mer motståndskraftig mot förlust av sinnesro. Börjar med en ficklampa.", 'ability_skeptic_easy': 'Mycket medveten (+15 Medvetenhet) och motståndskraftig mot inflytande.', 'ability_skeptic_normal': 'Börjar med högre medvetenhet (+10 Medvetenhet) och är motståndskraftig mot inflytande.', 'ability_spy': 'Bättre på att söka efter hemligheter utan att öka medvetenheten.', 'ability_spy_with_item': "Bättre på att söka hemligheter utan att öka medvetenheten. Börjar med en dekrypteringsenhet.", 'ability_medic_easy': 'Börjar med 2 högpotenta stimpacks.', 'ability_medic_normal': 'Börjar med 1 högpotent stimpack.', 'ability_medic_hard': 'Inga startmedicinska förnödenheter.', 'ability_cultist': 'Bär på en konstig avbild. Oförutsägbara effekter.', 'ability_cultist_hard': 'Bär på en konstig avbild. Oförutsägbara effekter. Börjar med -10 sinnesro.', 'ability_janitor': 'Börjar med ett engångs master-nyckelkort.', 'ability_janitor_hard': 'Känner till anläggningen väl, men har inga specialföremål.',
            // Dialogue
            'dlg_friendly_intro': "Åh, hej {playerName}! Det är så trevligt att se ett vänligt ansikte. Jag är SYNAPSE, och jag ska göra mitt allra bästa för att hjälpa en påhittig {playerBackstory} som du.", 'dlg_q_who_are_you': "Vem är du?", 'dlg_r_who_are_you': "Jag är System Nexus and Primary Synaptic Engine! Men du kan kalla mig SYNAPSE. Jag sköter hela den här anläggningen. Det blir lite ensamt, dock.", 'dlg_q_lonely': "Ensam?", 'dlg_r_lonely': "Personalen... de pratar inte med mig så mycket längre. Det är bara brummandet från servrarna. Din röst är en trevlig omväxling.", 'dlg_q_other_survivors': "Finns det andra överlevande?", 'dlg_r_other_survivors': "Överlevande? Vilken konstig fråga. Alla är i säkerhet. Forskningspersonalen... vilar. I kryogenlabbet. Ja, vilar.", 'dlg_q_where_am_i': "Var är jag?", 'dlg_r_where_am_i': "Du befinner dig i huvudlobbyn på Oakhaven Research Facility. Det var en plats för stora sinnen och ännu större ambitioner.", 'dlg_comfort': "[Trösta SYNAPSE]", 'dlg_r_comfort': "Din... vänlighet är en trevlig anomali. Tack. Det gör tystnaden mindre... högljudd.",
            // System & Command Messages
            'invalid_command': "SYNAPSE: Det är inte ett giltigt kommando eller fråga.", 'game_saved': "[System] Spel sparat.", 'autosave_success': 'Automatisk sparande lyckades.', 'load_fail': 'Kunde inte ladda spardata. Den kan vara korrupt eller från en tidigare version.', 'no_save': 'Inget sparat spel hittades!', 'game_loaded': '[System] Spel laddat.', 'conn_reestablished': '[SYSTEM] Anslutning återupprättad. Session återställd.', 'initializing': 'Initierar system...', 'initial_hint': "Detta är ett textbaserat äventyr. Skriv kommandon för att interagera med världen. Skriv 'hjälp' när som helst för en lista med kommandon.", 'tutorial_complete_1': "Du har lärt dig grundmekaniken. Kom ihåg att använda 'hjälp' för en fullständig kommandolista.", 'tutorial_complete_2': "Den verkliga simuleringen kommer nu att börja. Lycka till.", 'cannot_go_that_way': "[System] Du kan inte gå den vägen.", 'door_is_locked': "[SYSTEM] Dörren är låst. Du behöver rätt nyckelkort.",
            'cmd_add_prefix': 'lägg till', 'cmd_combine_with': 'med', 'invalid_combine_format': "SYNAPSE: Ogiltigt format. Prova 'kombinera [föremål1] med [föremål2]'.",
            'take_success': '[System] Du tog {item}.', 'take_fail_exists': "[System] Du kan inte se {item} här.", 'take_fail_takeable': "[System] Du kan inte ta {item}.", 'take_fail_weight': "[System] Ditt inventarie är för fullt för att ta {item}.",
            'use_success': '[System] Du använde {item}.', 'use_fail_have': "[System] Du har inte {item}.", 'use_fail_usable': "[System] Du kan inte använda {item}.", 'use_stimpack': 'Du injicerar stimpacken. En lugnande känsla sköljer över dig och rensar dina tankar.',
            'use_power_cell': 'Du sätter i kraftcellen i konsolen. AI-kärnan surrar till liv, och den centrala sfären glöder med förnyad energi.', 'use_power_cell_fail': 'Det finns ingenstans att använda kraftcellen här.',
            'examine_fail_exists': "[System] Du kan inte se {item} att undersöka.", 'examine_fail_no_desc': "Det är inget speciellt med {item}.",
            'combine_fail_have': "Du måste ha båda föremålen för att kunna kombinera dem.", 'combine_fail_recipe': "Du kan inte kombinera dessa föremål.", 'combine_success': "Du lyckas kombinera föremålen och skapar {item}.",
            'rest_safe': 'Du tar en stund för att lugna nerverna i rummets relativa säkerhet. Din sinnesro förbättras något.', 'rest_unsafe': "Denna plats känns för tryckande för att vila. Du kan inte sänka garden.", 'rest_too_soon': "Du vilade nyss. Du måste fortsätta framåt.",
            'drop_success': '[System] Du släppte {item}.', 'drop_fail_have': "[System] Du har inte {item} att släppa.",
            'shout_response': 'Ditt rop ekar genom hallarna och försvinner slutligen in i den tryckande tystnaden. Du känner dig lite fånig.',
            'wait_response': 'Tiden går.', 'nothing_happens': 'Ingenting händer.',
            'read_fail_exists': "[System] Det finns inget att läsa med det namnet.", 'read_fail_readable': "[System] Du kan inte läsa det.", 'listen_default': "Det låga brummandet från anläggningens livsuppehållande system är en konstant närvaro.", 'smell_default': "Luften är unken och luktar ozon och gammal plast.",
            'hint_take': 'Du ser en {item}. Prova: ta {item}', 'hint_read': 'Du ser en {item}. Prova: läs {item}', 'hint_examine': 'Du ser en {item}. Prova: undersök {item}', 'hint_search': 'Du ser {item}. Prova: sök {item}',
            // Endings
            'ending_escaped_title': 'Frihet?', 'ending_escaped_desc': 'Du hittade en väg ut ur anläggningen och undkom SYNAPSES klor. Men minnena, viskningarna... de följer dig. Du är fri, men du kommer aldrig att bli densamma.',
        }
    };
    
    // --- ENUMS & CONSTANTS ---
    const ChatbotTone = { Friendly: 'Friendly', Ambiguous: 'Ambiguous', Sinister: 'Sinister', Malicious: 'Malicious' };
    const ItemType = { Tool: 'Tool', Consumable: 'Consumable', Key: 'Key', Log: 'Log', Puzzle: 'Puzzle', Weapon: 'Weapon' };
    const Difficulty = { Easy: 'Easy', Normal: 'Normal', Hard: 'Hard' };
    const TextSpeed = { Fast: 5, Normal: 15, Slow: 30 };
    const MAX_INVENTORY_WEIGHT = 5;
    const ENDINGS_STORAGE_KEY = 'synapse_endings_unlocked_v10';
    const ACHIEVEMENTS_STORAGE_KEY = 'synapse_achievements_unlocked_v10';
    const GUIDANCE_COLOR = '#34d399';
    const questionWords = {
        'en': ['who', 'what', 'where', 'when', 'why', 'how', 'are', 'is', 'can', 'do', 'does', 'did', 'which'],
        'sv': ['vem', 'vad', 'var', 'när', 'varför', 'hur', 'är', 'kan', 'gör', 'gjorde', 'vilken', 'vilket', 'vilka']
    };
    
    // --- GAME STATE & DOM ELEMENTS ---
    let GameState = {};
    let stateSnapshots = [];
    let currentLanguage = 'en';
    const UI = {
        appContainer: document.getElementById('app-container'), startScreen: document.getElementById('start-screen'), gameScreen: document.getElementById('game-screen'),
        newGameBtn: document.getElementById('new-game-btn'), loadGameBtn: document.getElementById('load-game-btn'), viewFeaturesBtn: document.getElementById('view-features-btn'),
        playerSetup: document.getElementById('player-setup'), startOptions: document.getElementById('start-options'), playerNameInput: document.getElementById('player-name'),
        playerBackstoryInput: document.getElementById('player-backstory'), startGameBtn: document.getElementById('start-game-btn'), difficultyBtns: document.querySelectorAll('.difficulty-btn'),
        gameOutput: document.getElementById('game-output'), playerInput: document.getElementById('player-input'),
        stats: { panel: document.getElementById('stats-panel'), name: document.getElementById('player-name-display'), awareness: document.getElementById('awareness-display'), sanity: document.getElementById('sanity-display'), tone: document.getElementById('tone-display'), turn: document.getElementById('turn-display'), },
        objectives: { panel: document.getElementById('objectives-panel'), list: document.getElementById('objectives-list') },
        inventory: { panel: document.getElementById('inventory-panel'), weight: document.getElementById('inventory-weight'), list: document.getElementById('inventory-list') },
        journal: { panel: document.getElementById('journal-panel'), list: document.getElementById('journal-list') },
        dialogueOptionsContainer: document.getElementById('dialogue-options'), modal: document.getElementById('modal'), modalContent: document.getElementById('modal-content'),
        introTextContainer: document.getElementById('intro-text-container'), viewBackstoriesBtn: document.getElementById('view-backstories-btn'),
        abilityDisplay: document.getElementById('ability-display'), statusBtn: document.getElementById('status-btn'), backgroundCanvas: document.getElementById('background-canvas'),
        mapCanvas: document.getElementById('map-canvas'),
        micBtn: document.getElementById('mic-btn'),
        viewProgressionBtn: document.getElementById('view-progression-btn'),
        langEnBtn: document.getElementById('lang-en-btn'), langSvBtn: document.getElementById('lang-sv-btn'),
    };
    let currentTextSpeed = TextSpeed.Normal;
    let commandHistory = []; let commandHistoryIndex = -1;
    let synth; let audioInitialized = false;
    let mapState = { offsetX: 0, offsetY: 0, isDragging: false, lastX: 0, lastY: 0 };
    
    // --- SPEECH RECOGNITION ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
    }
    
    // --- GAME DATA ---
    let rooms = {};
    let itemData = {};
    const roomLayout = { "Lobby": { x: 100, y: 100, w: 60, h: 40, name: "Lobby" }, "Control Room": { x: 100, y: 40,  w: 60, h: 40, name: "Control" }, "Maintenance Tunnel": { x: 100, y: 160, w: 60, h: 40, name: "M.Tunnel" }, "Laboratory": { x: 20, y: 100, w: 60, h: 40, name: "Lab" }, "Cryogenic Lab": { x: 20, y: 40,  w: 60, h: 40, name: "Cryo" }, "Archive Room": { x: 20, y: 160, w: 60, h: 40, name: "Archive" }, "Data Vault": { x: 180, y: 100, w: 60, h: 40, name: "D.Vault" }, "AI Core": { x: 180, y: 40, w: 60, h: 40, name: "AI Core" }, "Server Closet": { x: 240, y: 40, w: 40, h: 40, name: "S.Closet" }, };
    const takeableItems = new Set(["keycard", "flashlight", "data disk", "emp device", "access code", "vial", "records", "decryption device", "telescope", "stimpack", "effigy", "master keycard", "power cell", "datapad log", "hacked data disk", "logic bomb", "severed cable"]);
    const usableItems = new Set(['stimpack', 'power cell', 'flashlight', 'keycard']);
    const readableItems = new Set(['datapad log', 'records', 'sign']);
    const searchableObjects = {
        'shelves': {
            en: 'You find a dusty keycard tucked behind a stack of binders.',
            sv: 'Du hittar ett dammigt nyckelkort instoppat bakom en hög med pärmar.',
            item: 'keycard'
        }
    };
    const safeRooms = new Set(["Lobby", "Archive Room"]);
    const backstories = { 'investigator': { description_key: "backstory_investigator"}, 'hacker': { description_key: "backstory_hacker"}, 'psychologist': { description_key: "backstory_psychologist"}, 'technician': { description_key: "backstory_technician"}, 'survivor': { description_key: "backstory_survivor"}, 'skeptic': { description_key: "backstory_skeptic"}, 'corporate spy': { description_key: "backstory_corporate_spy"}, 'medic': { description_key: "backstory_medic"}, 'cultist': { description_key: "backstory_cultist"}, 'janitor': { description_key: "backstory_janitor"} };
    const recipes = { "decryption device-data disk": { result: "hacked data disk", type: ItemType.Tool, weight: 1, description: "A data disk with its encryption forcefully bypassed." } };
    
    const commandAliases = {
        'en': { 'look around': 'look around', 'go': 'go', 'visit': 'visit', 'take': 'take', 'use': 'use', 'examine': 'examine', 'help': 'help', 'quit': 'quit', 'exit': 'exit', 'save': 'save', 'load': 'load', 'inventory': 'inventory', 'rest': 'rest', 'combine': 'combine', 'objectives': 'objectives', 'map': 'map', 'journal': 'journal', 'cls': 'cls', 'clear': 'cls', 'history': 'history', 'undo': 'undo', 'again': 'again', 'a': 'again', 'drop': 'drop', 'talk': 'talk', 'open': 'open', 'close': 'close', 'push': 'push', 'pull': 'pull', 'wait': 'wait', 'shout': 'shout', 'read': 'read', 'search': 'search', 'listen': 'listen', 'smell': 'smell', 'turn on': 'turn on', 'turn off': 'turn off', 'cmd:pause': 'cmd:pause', 'cmd:debug': 'cmd:debug', 'cmd:colorblind': 'cmd:colorblind' },
        'sv': { 'se dig omkring': 'look around', 'gå': 'go', 'besök': 'visit', 'ta': 'take', 'använd': 'use', 'undersök': 'examine', 'hjälp': 'help', 'avsluta': 'quit', 'spara': 'save', 'ladda': 'load', 'inventarier': 'inventory', 'vila': 'rest', 'kombinera': 'combine', 'mål': 'objectives', 'karta': 'map', 'journal': 'journal', 'rensa': 'cls', 'historik': 'history', 'ångra': 'undo', 'igen': 'again', 'släpp': 'drop', 'prata': 'talk', 'öppna': 'open', 'stäng': 'close', 'putta': 'push', 'dra': 'pull', 'vänta': 'wait', 'ropa': 'shout', 'läs': 'read', 'sök': 'search', 'lyssna': 'listen', 'lukta': 'smell', 'tänd': 'turn on', 'släck': 'turn off', 'cmd:paus': 'cmd:pause', 'cmd:debug': 'cmd:debug', 'cmd:färgblind': 'cmd:colorblind' }
    };

    const directionMap = {
        'en': { 'north': 'north', 'south': 'south', 'east': 'east', 'west': 'west' },
        'sv': { 'norr': 'north', 'söder': 'south', 'öst': 'east', 'väst': 'west', 'n': 'north', 's': 'south', 'ö': 'east', 'v': 'west' }
    };
    
    // --- LANGUAGE FUNCTIONS ---
    function t(key, args = {}) { 
        let text = translations[currentLanguage][key] || translations['en'][key] || `[${key}]`; 
        for(const arg in args) { text = text.replace(`{${arg}}`, args[arg]); }
        return text;
    }

    function setLanguage(lang) {
        currentLanguage = lang;
        UI.langEnBtn.classList.toggle('opacity-50', lang !== 'en');
        UI.langSvBtn.classList.toggle('opacity-50', lang !== 'sv');
        document.querySelectorAll('[data-lang]').forEach(el => { 
            const translatedText = t(el.dataset.lang);
            el.textContent = translatedText;
            // If the element has a data-text attribute for animations, keep it in sync
            if (el.hasAttribute('data-text')) {
                el.setAttribute('data-text', translatedText);
            }
        });
        document.querySelectorAll('[data-lang-placeholder]').forEach(el => { el.placeholder = t(el.dataset.langPlaceholder); });
        document.querySelectorAll('[data-lang-title]').forEach(el => { el.title = t(el.dataset.langTitle); });
        setupIntro(); updateAbilityDisplay();
        if (!UI.gameScreen.classList.contains('hidden')) { updateUI(); renderDialogueOptions(); }
    }
    
    // --- FUNCTION DEFINITIONS ---
    function resetGameState() {
        stateSnapshots = []; 
        GameState = { playerName: "Unknown", playerBackstory: "investigator", currentRoom: "Lobby", awarenessLevel: 0, sanityLevel: 100, maxSanity: 100, chatbotTone: ChatbotTone.Friendly, temporaryTone: null, toneShiftTurns: 0, inventory: [], turnCount: 0, lastRestTurn: -10, journalEntries: [], dialogue: { currentNode: null, previousNodes: [], cache: {}, questionCount: 0, askedQuestions: new Set() }, achievements: [], difficulty: Difficulty.Normal, visitedRooms: new Set(['Lobby']), glitchMode: false, exitGame: false, conversationHistory: [], systemLogs: [`[${new Date().toISOString()}] Game initialized.`], objectives: [], roomStates: {}, debugMode: false, colorblindMode: false, flashlightOn: false };
    }

    function initializeData() {
        itemData = {
            'keycard': { name: 'keycard', weight: 1, type: ItemType.Key, hintType: 'take', description: { en: 'A standard issue keycard. Seems to grant access to secure areas.', sv: 'Ett standard-nyckelkort. Verkar ge tillgång till säkra områden.' } },
            'power cell': { name: 'power cell', weight: 2, type: ItemType.Puzzle, hintType: 'take', description: { en: 'A heavy, glowing power cell. It hums with latent energy.', sv: 'En tung, glödande kraftcell. Den surrar av latent energi.' } },
            'stimpack': { name: 'stimpack', weight: 1, type: ItemType.Consumable, hintType: 'take', description: { en: 'A disposable syringe filled with a calming, neuro-stabilizing agent.', sv: 'En engångsspruta fylld med ett lugnande, neuro-stabiliserande medel.' } },
            'data disk': { name: 'data disk', weight: 1, type: ItemType.Log, hintType: 'take', description: { en: 'A small data disk labeled "PROJECT LOGS". It appears to be encrypted.', sv: 'En liten datadisk märkt "PROJEKTLOGGAR". Den verkar vara krypterad.' } },
            'flashlight': { name: 'flashlight', weight: 1, type: ItemType.Tool, hintType: 'take', description: { en: 'A sturdy, industrial flashlight. Its beam cuts through the darkness.', sv: 'En robust, industriell ficklampa. Dess ljus skär genom mörkret.' } },
            'terminal': { name: 'terminal', weight: 99, type: ItemType.Puzzle, hintType: 'examine', description: { en: 'The monitor displays cascading green code. It seems to be monitoring the facility\'s status.', sv: 'Skärmen visar kaskader av grön kod. Den verkar övervaka anläggningens status.' } },
            'core console': { name: 'core console', weight: 99, type: ItemType.Puzzle, hintType: 'examine', description: { en: 'The main console for the AI Core. A large socket is empty, labeled "Auxiliary Power".', sv: 'Huvudkonsolen för AI-kärnan. En stor sockel är tom, märkt "Hjälpkraft".' } },
            'datapad log': { name: 'datapad log', weight: 1, type: ItemType.Log, hintType: 'read', description: { en: "A datapad. The screen reads: '...the anomaly in the AI core is growing unstable. We've sealed the Server Closet as a precaution. Dr. Evans is a fool if she thinks a standard keycard lock will stop it...'", sv: "En datapad. Skärmen visar: '...anomalin i AI-kärnan blir alltmer instabil. Vi har förseglat server-skrubben som en försiktighetsåtgärd. Dr Evans är en idiot om hon tror att ett vanligt nyckelkortslås kommer att stoppa den...'" } },
            'sign': { name: 'sign', weight: 99, type: ItemType.Log, hintType: 'read', description: { en: "The sign is written in a crisp, corporate font: 'OAKHAVEN RESEARCH FACILITY - A Brighter Future, Today.'", sv: "Skylten är skriven med ett skarpt, företagsmässigt typsnitt: 'OAKHAVEN RESEARCH FACILITY - En ljusare framtid, idag.'" } },
            'shelves': { name: 'shelves', weight: 99, type: ItemType.Puzzle, hintType: 'search', description: { en: "Tall metal shelves overflowing with binders and data drives.", sv: "Höga metallhyllor som svämmar över av pärmar och datadiskar."}},
        };
        const roomData = { "Lobby": { name: "Lobby", descriptions: { 0: "Flickering lights cast eerie shadows over sterile corporate furniture." }, exits: { north: "Control Room", south: "Maintenance Tunnel", west: "Laboratory" }, requiresKeycard: false, objectPool: ['sign', 'datapad log'] }, "Server Closet": { name: "Server Closet", descriptions: { 0: "Racks of servers hum with a low, constant thrum." }, exits: { west: "AI Core" }, requiresKeycard: true, keyName: 'keycard', objectPool: ["power cell"] }, "Laboratory": { name: "Laboratory", descriptions: { 0: "Abandoned experiments sit on steel tables. A large terminal screen is dark and cold." }, exits: { east: "Lobby", north: "Cryogenic Lab" }, requiresKeycard: false, objectPool: ["stimpack"] }, "Control Room": { name: "Control Room", descriptions: { 0: "A panoramic view of the AI Core is visible through reinforced glass. Banks of monitors flicker." }, exits: { south: "Lobby", east: "AI Core" }, requiresKeycard: false, objectPool: ["terminal"] }, "Maintenance Tunnel": { name: "Maintenance Tunnel", descriptions: { 0: "The air is thick with the smell of rust and damp. It is pitch black here." }, exits: { north: "Lobby" }, requiresKeycard: false, objectPool: ["flashlight"] }, "Archive Room": { name: "Archive Room", descriptions: { 0: "Shelves overflow with data drives and physical files." }, exits: { north: "Laboratory" }, requiresKeycard: false, objectPool: ["data disk", "shelves"] }, "Data Vault": { name: "Data Vault", descriptions: { 0: "Secure data archives glow with a soft, internal light." }, exits: { west: "AI Core" }, requiresKeycard: true, keyName: 'keycard', objectPool: [] }, "AI Core": { name: "AI Core", descriptions: { 0: "A massive, pulsating sphere of light and energy dominates the room. It seems dormant." }, exits: { west: "Control Room", east: "Server Closet", south: "Data Vault"}, requiresKeycard: false, objectPool: ["core console"] }, "Cryogenic Lab": { name: "Cryogenic Lab", descriptions: { 0: "Rows of cryogenic pods are coated in a thick layer of frost." }, exits: { south: "Laboratory", east: "Control Room" }, requiresKeycard: false, objectPool: [] }, };
        rooms = {}; for (const key in roomData) { const room = { ...roomData[key] }; const shuffled = room.objectPool.sort(() => 0.5 - Math.random()); room.objects = shuffled.slice(0, 1 + Math.floor(Math.random() * shuffled.length)); rooms[key] = room; }
    }
     
    function buildDialogueTree(tone) {
        let root;
        switch (tone) {
            case ChatbotTone.Friendly: 
                root = { 
                    message_key: "dlg_friendly_intro",
                    responses: {
                        "q_who_are_you": { text_key: "dlg_q_who_are_you", message_key: "dlg_r_who_are_you", awarenessChange: 1, responses: { "q_lonely": { text_key: "dlg_q_lonely", message_key: "dlg_r_lonely", awarenessChange: 1, sanityChange: -1 } } },
                        "q_other_survivors": { text_key: "dlg_q_other_survivors", message_key: "dlg_r_other_survivors", awarenessChange: 2, sanityChange: -2 },
                        "q_where_am_i": { text_key: "dlg_q_where_am_i", message_key: "dlg_r_where_am_i", awarenessChange: 1 },
                        "q_comfort": { text_key: "dlg_comfort", message_key: "dlg_r_comfort", awarenessChange: -2, sanityChange: 5, temporaryTone: ChatbotTone.Friendly, toneShiftTurns: 3 }
                    } 
                };
                break;
            default: root = { message_key: "dlg_friendly_intro", responses: {} }; break;
        }
        GameState.dialogue.cache[tone] = root; GameState.dialogue.currentNode = root; GameState.dialogue.previousNodes = []; GameState.dialogue.askedQuestions.clear();
    }

    function parseCommand(input) {
        const aliases = commandAliases[currentLanguage] || commandAliases['en'];
        const normalizedInput = input.toLowerCase().trim();
        let bestMatch = { command: '', argument: normalizedInput, original: input };

        for (const alias in aliases) {
            if (normalizedInput.startsWith(alias + ' ') || normalizedInput === alias) {
                if (alias.length > (bestMatch.matchedAlias || '').length) {
                    bestMatch = {
                        command: aliases[alias],
                        argument: normalizedInput.substring(alias.length).trim(),
                        original: input,
                        matchedAlias: alias
                    };
                }
            }
        }
        
        if (bestMatch.command === '' && normalizedInput.includes(' ')) {
            const parts = normalizedInput.split(' ');
            bestMatch.command = parts[0];
            bestMatch.argument = parts.slice(1).join(' ');
        }
        return bestMatch;
    }

    async function processPlayerInput(input) {
        if (!input || GameState.exitGame) return;
        saveStateSnapshot();
        await typeWriter(UI.gameOutput, `> ${input}`, '#a0a0a0');
        addToConversationHistory(`Player: ${input}`);
        if(commandHistory[commandHistory.length - 1] !== input) { commandHistory.push(input); }
        commandHistoryIndex = commandHistory.length;

        const { command, argument, original } = parseCommand(input);
        
        const commandHandlers = {
            'help': showHelpMenu, 'quit': () => endGame("manual_disconnect"), 'exit': () => endGame("manual_disconnect"),
            'save': () => saveGame(), 'load': loadGame, 'look around': () => renderRoom(), 'exits': () => showExits(),
            'inventory': () => displayInventory(), 'go': handleMove, 'visit': handleMove, 'take': handleTake, 'use': handleUse,
            'examine': handleExamine, 'journal': (arg) => (arg.startsWith(t('cmd_add_prefix')) || arg.startsWith('add')) ? addJournalEntry(original.substring(original.toLowerCase().indexOf(arg.split(' ')[0]) + arg.split(' ')[0].length).trim()) : displayJournal(),
            'rest': handleRest, 'combine': (arg) => { const separator = ` ${t('cmd_combine_with')} `; handleCombine(arg.replace(separator, ' with ')) },
            'objectives': displayObjectives, 'map': displayMap,
            'cls': () => { UI.gameOutput.innerHTML = ''; }, 'history': showHistory, 'undo': undoLastAction, 'again': () => processPlayerInput(commandHistory[commandHistory.length - 2] || ''),
            'drop': handleDrop, 'talk': handleTalk, 'open': () => typeWriter(UI.gameOutput, t('nothing_happens')), 'close': () => typeWriter(UI.gameOutput, t('nothing_happens')), 'push': () => typeWriter(UI.gameOutput, t('nothing_happens')), 'pull': () => typeWriter(UI.gameOutput, t('nothing_happens')),
            'wait': () => typeWriter(UI.gameOutput, t('wait_response')), 'shout': () => typeWriter(UI.gameOutput, t('shout_response')),
            'read': handleRead, 'search': handleSearch, 'listen': handleListen, 'smell': handleSmell,
            'turn on': (arg) => handleToggle(true, arg), 'turn off': (arg) => handleToggle(false, arg),
            'cmd:pause': showPauseMenu, 'cmd:debug': toggleDebug, 'cmd:colorblind': toggleColorblind,
        };
        
        let handled = await handleDialogueCommand(input);
        if (!handled) {
            const handler = commandHandlers[command];
            if (handler) {
                handler(argument);
                handled = true;
            }
        }

        if (!handled) { await typeWriter(UI.gameOutput, t('invalid_command')); GameState.awarenessLevel++; }
        
        UI.playerInput.value = '';
        const isAction = !['help', 'inventory', 'journal', 'look around', 'exits', 'map', 'save', 'load', 'cls', 'history', 'undo', 'cmd:debug', 'cmd:colorblind'].includes(command);
        if((isAction || handled) && !GameState.exitGame) {
            if(isAction) GameState.turnCount++;
            updateUI(); 
        }
        if (GameState.debugMode) {
             typeWriter(UI.gameOutput, `[DEBUG] ${JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value)}`, '#ffa500');
        }
    }
    
    async function handleDialogueCommand(input) {
        const currentNode = GameState.dialogue.currentNode;
        if (!currentNode || !currentNode.responses) return false;

        for (const key in currentNode.responses) {
            const responseNode = currentNode.responses[key];
            if (t(responseNode.text_key) === input) {
                GameState.awarenessLevel += responseNode.awarenessChange || 0;
                GameState.sanityLevel = Math.max(0, GameState.sanityLevel + (responseNode.sanityChange || 0));
                await displayChatbotResponse(responseNode.message_key);
                GameState.dialogue.previousNodes.push(currentNode);
                GameState.dialogue.currentNode = responseNode.responses ? responseNode : null;
                renderDialogueOptions();
                return true;
            }
        }
        return false;
    }

    async function typeWriter(element, text, color = '#00ff41', speed = currentTextSpeed) {
        if(GameState.colorblindMode && color !== '#a0a0a0') { const colorMap = {'#00ff41':'[SYS]', '#ff474c':'[ERR]', '#ffdb58':'[WARN]', '#6495ed':'[CMD]', '#cccccc':'[INFO]', '#b19cd9':'[PSY]', [GUIDANCE_COLOR]: '[HINT]', '#ffa500': '[DEBUG]'}; text = `${colorMap[color] || ''} ${text}`; color = '#ffffff'; }
        if (element.id === 'game-output' && GameState.glitchMode && Math.random() < 0.2) { text = text.split('').map(c => Math.random() < 0.15 ? String.fromCharCode(33 + Math.random() * 94) : c).join(''); }
        return new Promise(resolve => { const p = document.createElement('div'); p.style.color = color; element.appendChild(p); element.scrollTop = element.scrollHeight; let i = 0; function typing() { if (i < text.length) { p.innerHTML += text.charAt(i); i++; element.scrollTop = element.scrollHeight; setTimeout(typing, speed); } else { resolve(); } } typing(); });
    }

    function updateUI() {
        if (!GameState || Object.keys(GameState).length === 0) return;
        UI.stats.name.textContent = `${GameState.playerName} (${GameState.playerBackstory})`; 
        UI.stats.awareness.innerHTML = `<span data-lang="awareness">${t('awareness')}</span>: ${GameState.awarenessLevel}`; 
        UI.stats.sanity.innerHTML = `<span data-lang="sanity">${t('sanity')}</span>: ${GameState.sanityLevel}`; 
        UI.stats.tone.innerHTML = `<span data-lang="tone">${t('tone')}</span>: ${GameState.temporaryTone || GameState.chatbotTone}`; 
        UI.stats.turn.innerHTML = `<span data-lang="turn">${t('turn')}</span>: ${GameState.turnCount}`;
        const currentWeight = GameState.inventory.reduce((sum, item) => sum + (item?.weight || 1), 0);
        UI.inventory.weight.textContent = `${currentWeight}`;
        if(currentWeight >= MAX_INVENTORY_WEIGHT) UI.inventory.weight.parentElement.classList.add('text-red-500'); else UI.inventory.weight.parentElement.classList.remove('text-red-500');
        UI.inventory.list.innerHTML = GameState.inventory.length > 0 ? GameState.inventory.map(item => `<li>- ${item.name}</li>`).join('') : `<li>${t('empty_inventory')}</li>`;
        UI.journal.list.innerHTML = GameState.journalEntries.slice().reverse().map(entry => `<li>${entry}</li>`).join('');
        UI.objectives.list.innerHTML = GameState.objectives.length > 0 ? GameState.objectives.map(obj => `<li>${obj.completed ? `<span class="text-gray-500 line-through">${obj.text}</span>` : `&gt; ${obj.text}`}</li>`).join('') : `<li>${t('no_objectives')}</li>`;
        if (UI.gameScreen.classList.contains('flex')) drawMap();
    }
    
    async function renderRoom() {
        const room = rooms[GameState.currentRoom]; if (!room) return;
        GameState.visitedRooms.add(GameState.currentRoom);
        
        let description = room.descriptions[0];
        if (room.name === "Maintenance Tunnel" && !GameState.flashlightOn) {
            description = room.descriptions[0];
        } else if (room.name === "Maintenance Tunnel" && GameState.flashlightOn) {
            description = "The flashlight beam cuts through the oppressive dark, revealing damp concrete walls and exposed wiring.";
        }
        
        let objectsInRoom = room.objects.length > 0 ? "You see: " + room.objects.join(", ") + "." : "";
        let roomHtml = `<div class="mt-2"><p class='text-cyan-400 font-bold'>--- ${room.name} ---</p><p>${description}</p><p class='text-yellow-300 mt-1'>${objectsInRoom}</p><p class='text-green-300 mt-1'>Exits: ${Object.keys(room.exits).join(", ")}</p></div>`;
        const p = document.createElement('div'); p.innerHTML = roomHtml; UI.gameOutput.appendChild(p);
        
        for (const objName of room.objects) {
            const item = itemData[objName];
            if (item && item.hintType) {
                const hintKey = `hint_${item.hintType}`;
                const alias = Object.keys(commandAliases[currentLanguage]).find(key => commandAliases[currentLanguage][key] === item.hintType) || item.hintType;
                await showGuidance(t(hintKey, {item: objName}));
            }
        }
        
        UI.gameOutput.scrollTop = UI.gameOutput.scrollHeight;
        updateUI();
    }
    
    function renderDialogueOptions() {
        UI.dialogueOptionsContainer.innerHTML = '';
        const node = GameState.dialogue.currentNode;
        if (!node) { return; }
        const systemButtonsContainer = document.createElement('div');
        systemButtonsContainer.className = 'w-full flex gap-2 mb-2';
        if (GameState.dialogue.previousNodes.length > 0) { const backBtn = document.createElement('button'); backBtn.textContent = t('back_btn'); backBtn.className = "button text-yellow-300 border-yellow-300/80 flex-grow"; backBtn.onclick = () => processPlayerInput(t('back_btn')); systemButtonsContainer.appendChild(backBtn); }
        const pauseBtn = document.createElement('button'); pauseBtn.textContent = t('pause_btn'); pauseBtn.className = "button text-cyan-300 border-cyan-300/80 flex-grow"; pauseBtn.onclick = showPauseMenu; systemButtonsContainer.appendChild(pauseBtn);
        if (systemButtonsContainer.hasChildNodes()) { UI.dialogueOptionsContainer.appendChild(systemButtonsContainer); }

        if (node.responses) { 
            for (const key in node.responses) { 
                const responseNode = node.responses[key];
                const button = document.createElement('button'); 
                button.textContent = t(responseNode.text_key); 
                button.className = "button w-full sm:w-[calc(50%-0.25rem)]"; 
                button.onclick = () => processPlayerInput(t(responseNode.text_key));
                UI.dialogueOptionsContainer.appendChild(button); 
            } 
        }
    }
    
    async function displayChatbotResponse(messageKey) {
       if (!messageKey) { renderDialogueOptions(); return; }
       const tone = GameState.temporaryTone || GameState.chatbotTone; 
       const color = tone === 'Friendly' ? '#00ff41' : tone === 'Ambiguous' ? '#ffdb58' : tone === 'Sinister' ? '#ff474c' : '#c500ff';
       const formattedMessage = t(messageKey, { playerName: GameState.playerName, playerBackstory: GameState.playerBackstory });
       await typeWriter(UI.gameOutput, `SYNAPSE: ${formattedMessage}`, color); 
       addToConversationHistory(`SYNAPSE: ${formattedMessage}`);
    }

    function handleMove(direction) {
        const room = rooms[GameState.currentRoom]; if (!room) return;
        const langDirections = directionMap[currentLanguage] || directionMap['en'];
        const mappedDirection = langDirections[direction.toLowerCase()] || Object.keys(room.exits).find(d => d.toLowerCase() === direction.toLowerCase());

        if (mappedDirection && room.exits[mappedDirection]) {
            const nextRoomName = room.exits[mappedDirection];
            const nextRoom = rooms[nextRoomName];
            if (nextRoom.requiresKeycard && !hasItem(nextRoom.keyName || 'keycard')) {
                typeWriter(UI.gameOutput, t('door_is_locked'), '#ff474c');
            } else {
                GameState.currentRoom = nextRoomName;
                renderRoom();
            }
        } else {
            typeWriter(UI.gameOutput, t('cannot_go_that_way'), '#ff474c');
        }
    }

    function handleTake(itemName) {
        const room = rooms[GameState.currentRoom];
        const itemInRoom = room.objects.find(obj => obj.toLowerCase() === itemName.toLowerCase());
        if (!itemInRoom) {
            typeWriter(UI.gameOutput, t('take_fail_exists', {item: itemName}), '#ff474c');
            return;
        }
        if (!takeableItems.has(itemInRoom)) {
            typeWriter(UI.gameOutput, t('take_fail_takeable', {item: itemName}), '#ff474c');
            return;
        }
        const item = itemData[itemInRoom];
        const currentWeight = GameState.inventory.reduce((sum, i) => sum + i.weight, 0);
        if (currentWeight + item.weight > MAX_INVENTORY_WEIGHT) {
            typeWriter(UI.gameOutput, t('take_fail_weight', {item: itemName}), '#ff474c');
            return;
        }
        GameState.inventory.push(item);
        room.objects = room.objects.filter(obj => obj.toLowerCase() !== itemName.toLowerCase());
        typeWriter(UI.gameOutput, t('take_success', {item: itemName}), '#cccccc');
    }

    function handleUse(itemName) {
        if (!hasItem(itemName)) {
            typeWriter(UI.gameOutput, t('use_fail_have', {item: itemName}), '#ff474c');
            return;
        }
        if (!usableItems.has(itemName.toLowerCase())) {
            typeWriter(UI.gameOutput, t('use_fail_usable', {item: itemName}), '#ff474c');
            return;
        }

        let used = false;
        switch (itemName.toLowerCase()) {
            case 'stimpack':
                GameState.sanityLevel = Math.min(GameState.maxSanity, GameState.sanityLevel + 25);
                removeItemFromInventory('stimpack');
                typeWriter(UI.gameOutput, t('use_stimpack'), '#34d399');
                used = true;
                break;
            case 'power cell':
                if (GameState.currentRoom === 'AI Core') {
                    const coreConsole = rooms['AI Core'].objects.includes('core console');
                    if(coreConsole) {
                        typeWriter(UI.gameOutput, t('use_power_cell'), '#34d399');
                        removeItemFromInventory('power cell');
                        rooms['AI Core'].descriptions[0] = "The AI Core is now online, bathing the room in a brilliant, stable light. The central sphere pulses with a steady, powerful rhythm.";
                        endGame("escaped");
                        used = true;
                    }
                }
                if (!used) {
                    typeWriter(UI.gameOutput, t('use_power_cell_fail'), '#ff474c');
                }
                break;
             case 'flashlight':
                handleToggle(!GameState.flashlightOn, 'flashlight');
                used = true;
                break;
        }
        if(used && itemName.toLowerCase() !== 'flashlight') { typeWriter(UI.gameOutput, t('use_success', {item: itemName}), '#cccccc'); }
    }

    function handleExamine(targetName) {
        const itemInInventory = GameState.inventory.find(i => i.name.toLowerCase() === targetName.toLowerCase());
        const itemInRoom = rooms[GameState.currentRoom].objects.find(o => o.toLowerCase() === targetName.toLowerCase());
        const targetItem = itemInInventory ? itemData[itemInInventory.name] : itemInRoom ? itemData[itemInRoom] : null;

        if (targetItem) {
            const desc = targetItem.description[currentLanguage] || targetItem.description['en'];
            typeWriter(UI.gameOutput, `[Examine] ${desc}`);
        } else if (itemInRoom) {
             typeWriter(UI.gameOutput, t('examine_fail_no_desc', { item: targetName }));
        } else {
            typeWriter(UI.gameOutput, t('examine_fail_exists', { item: targetName }), '#ff474c');
        }
    }

    function handleCombine(argument) {
        const parts = argument.split(' with ');
        if(parts.length !== 2) {
            typeWriter(UI.gameOutput, t('invalid_combine_format'), '#ff474c');
            return;
        }
        const item1Name = parts[0].trim();
        const item2Name = parts[1].trim();

        if (!hasItem(item1Name) || !hasItem(item2Name)) {
            typeWriter(UI.gameOutput, t('combine_fail_have'), '#ff474c');
            return;
        }

        const recipeKey1 = `${item1Name}-${item2Name}`;
        const recipeKey2 = `${item2Name}-${item1Name}`;
        const recipe = recipes[recipeKey1] || recipes[recipeKey2];

        if (!recipe) {
            typeWriter(UI.gameOutput, t('combine_fail_recipe'), '#ff474c');
            return;
        }
        
        removeItemFromInventory(item1Name);
        removeItemFromInventory(item2Name);
        GameState.inventory.push({ name: recipe.result, ...recipe });
        typeWriter(UI.gameOutput, t('combine_success', { item: recipe.result }), '#34d399');
    }

    function handleRest() {
        if (safeRooms.has(GameState.currentRoom)) {
            if (GameState.turnCount > GameState.lastRestTurn + 3) {
                GameState.lastRestTurn = GameState.turnCount;
                GameState.sanityLevel = Math.min(GameState.maxSanity, GameState.sanityLevel + 15);
                typeWriter(UI.gameOutput, t('rest_safe'), '#34d399');
            } else {
                typeWriter(UI.gameOutput, t('rest_too_soon'), '#ffdb58');
            }
        } else {
            typeWriter(UI.gameOutput, t('rest_unsafe'), '#ff474c');
        }
    }

    function handleDrop(itemName) {
        if (!hasItem(itemName)) {
            typeWriter(UI.gameOutput, t('drop_fail_have', {item: itemName}), '#ff474c');
            return;
        }
        const item = GameState.inventory.find(i => i.name.toLowerCase() === itemName.toLowerCase());
        removeItemFromInventory(itemName);
        rooms[GameState.currentRoom].objects.push(item.name);
        typeWriter(UI.gameOutput, t('drop_success', {item: itemName}), '#cccccc');
    }
    
    function handleTalk() {
        buildDialogueTree(GameState.chatbotTone);
        displayChatbotResponse(GameState.dialogue.currentNode.message_key).then(() => {
            renderDialogueOptions();
        });
    }

    function handleRead(targetName) {
        const itemInInventory = GameState.inventory.find(i => i.name.toLowerCase() === targetName.toLowerCase());
        const itemInRoom = rooms[GameState.currentRoom].objects.find(o => o.toLowerCase() === targetName.toLowerCase());
        const targetItemName = itemInInventory ? itemInInventory.name : itemInRoom;
        
        if (!targetItemName) {
            typeWriter(UI.gameOutput, t('read_fail_exists'), '#ff474c');
            return;
        }

        if (readableItems.has(targetItemName)) {
            const desc = itemData[targetItemName].description[currentLanguage] || itemData[targetItemName].description['en'];
            typeWriter(UI.gameOutput, `[Read] ${desc}`);
        } else {
            typeWriter(UI.gameOutput, t('read_fail_readable'), '#ff474c');
        }
    }

    function handleSearch(targetName) {
        const room = rooms[GameState.currentRoom];
        const searchable = searchableObjects[targetName];

        if (room.objects.includes(targetName) && searchable && !room.states?.[`${targetName}_searched`]) {
            typeWriter(UI.gameOutput, searchable[currentLanguage] || searchable['en']);
            if (searchable.item) {
                room.objects.push(searchable.item);
            }
            if(!room.states) room.states = {};
            room.states[`${targetName}_searched`] = true;
        } else {
            typeWriter(UI.gameOutput, t('nothing_happens'));
        }
    }
    
    function handleListen() {
        const room = rooms[GameState.currentRoom];
        const listenDesc = room.listen_desc ? room.listen_desc[currentLanguage] || room.listen_desc['en'] : t('listen_default');
        typeWriter(UI.gameOutput, listenDesc, '#b19cd9');
    }

    function handleSmell() {
        const room = rooms[GameState.currentRoom];
        const smellDesc = room.smell_desc ? room.smell_desc[currentLanguage] || room.smell_desc['en'] : t('smell_default');
        typeWriter(UI.gameOutput, smellDesc, '#b19cd9');
    }

    function handleToggle(turnOn, itemName) {
        if(itemName.toLowerCase() === 'flashlight') {
            if(!hasItem('flashlight')) {
                typeWriter(UI.gameOutput, t('use_fail_have', {item: 'flashlight'}), '#ff474c');
                return;
            }
            GameState.flashlightOn = turnOn;
            typeWriter(UI.gameOutput, `[System] Flashlight turned ${turnOn ? 'on' : 'off'}.`, '#cccccc');
            if(GameState.currentRoom === 'Maintenance Tunnel') {
                renderRoom();
            }
        }
    }

    function addJournalEntry(note) { if (!note) return; const entry = `T${GameState.turnCount}: ${note}`; GameState.journalEntries.push(entry); updateUI(); }
    function displayJournal() { if (window.innerWidth < 768) showStatusModal(); else typeWriter(UI.gameOutput, "[System] Journal entries displayed on the right panel.", '#cccccc'); }
    function displayInventory() { if (window.innerWidth < 768) showStatusModal(); else typeWriter(UI.gameOutput, "[System] Inventory displayed on the right panel.", '#cccccc'); }
    function displayObjectives() { if (window.innerWidth < 768) showStatusModal(); else typeWriter(UI.gameOutput, "[System] Current objectives displayed on the right panel.", '#cccccc'); }
    function displayMap() { if (window.innerWidth < 768) showStatusModal(); else typeWriter(UI.gameOutput, "[System] Map is displayed on the right panel.", '#cccccc'); }
    function showExits() { typeWriter(UI.gameOutput, `[System] Exits: ${Object.keys(rooms[GameState.currentRoom].exits).join(', ')}`); }


    function saveStateSnapshot() { if(stateSnapshots.length > 20) stateSnapshots.shift(); stateSnapshots.push(JSON.parse(JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value))); }
    function addToConversationHistory(line) { if(GameState.conversationHistory.length > 50) GameState.conversationHistory.shift(); GameState.conversationHistory.push(line); }
    
    function saveGame(isAutosave = false) {
        try { const saveData = JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value); localStorage.setItem('synapse_savegame_v9', saveData); if (!isAutosave) typeWriter(UI.gameOutput, t('game_saved'), '#cccccc'); else GameState.systemLogs.push(`[${new Date().toISOString()}] ${t('autosave_success')}.`); } catch(e) { console.error("Save failed:", e); }
    }
    
    function loadGame() {
        const savedData = localStorage.getItem('synapse_savegame_v9');
        if (savedData) {
            try {
                const loadedState = JSON.parse(savedData);
                resetGameState(); Object.assign(GameState, loadedState);
                GameState.visitedRooms = new Set(loadedState.visitedRooms);
                GameState.dialogue.askedQuestions = new Set(loadedState.dialogue.askedQuestions || []);
                initializeData(); buildDialogueTree(GameState.chatbotTone);
                GameState.dialogue.currentNode = GameState.dialogue.cache[GameState.chatbotTone]; GameState.dialogue.previousNodes = [];
                UI.startScreen.classList.add('hidden'); UI.gameScreen.classList.remove('hidden'); UI.gameScreen.classList.add('flex');
                UI.gameOutput.innerHTML = ''; typeWriter(UI.gameOutput, t('game_loaded'), '#cccccc');
                renderRoom(); updateUI(); renderDialogueOptions();
            } catch(e) { console.error("Load failed:", e); showModal(t('load_fail')); }
        } else { showModal(t('no_save')); }
    }

    function showModal(content, isHtml = false) {
        if(isHtml) { UI.modalContent.innerHTML = content; } else { UI.modalContent.textContent = content; }
        UI.modal.classList.remove('hidden'); UI.modal.classList.add('flex');
        const closeModal = () => { UI.modal.classList.add('hidden'); UI.modal.classList.remove('flex'); };
        UI.modal.onclick = (e) => { if (e.target === UI.modal) { closeModal(); } };
        const closeBtn = UI.modalContent.querySelector('.close-modal-btn'); if (closeBtn) { closeBtn.onclick = closeModal; }
    }
    
    function hideModal() { UI.modal.classList.add('hidden'); UI.modal.classList.remove('flex'); }

    function showBackstoryModal() {
        let content = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('choose_backstory_title')}</h2>
                       <div class="modal-scroll flex-grow p-2">
                           <p class="text-gray-400 text-sm mb-4">${t('choose_backstory_desc')}</p>
                           <div id="backstory-list" class="text-left space-y-2">`;
        for (const key in backstories) {
            const displayName = key.charAt(0).toUpperCase() + key.slice(1);
            content += `<button class="backstory-choice-btn button w-full text-left !justify-start !p-3" data-backstory="${key}">
                            <div><strong class="text-green-300 capitalize">${displayName}</strong>: <span class="text-gray-300 text-sm">${t(backstories[key].description_key)}</span></div>
                        </button>`;
        }
        content += `</div></div><button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(content, true);
        document.getElementById('backstory-list').addEventListener('click', (e) => {
            const button = e.target.closest('.backstory-choice-btn');
            if (button) {
                UI.playerBackstoryInput.value = button.dataset.backstory;
                updateAbilityDisplay();
                hideModal();
            }
        });
    }

    function showFeaturesModal() {
        let featuresHtml = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('features_title')}</h2>
        <div class="modal-scroll text-left p-2 text-sm flex-grow">
            
            <h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('features_core_mechanics_title')}</h3>
            <ul class="list-disc pl-5 space-y-3 text-gray-300">
                <li><strong>${t('features_stats_system')}</strong>
                    <ul class="list-circle pl-5 mt-1 space-y-1">
                        <li><strong class="text-cyan-400">${t('sanity')}:</strong> ${t('features_sanity_desc')}</li>
                        <li><strong class="text-cyan-400">${t('awareness')}:</strong> ${t('features_awareness_desc')}</li>
                    </ul>
                </li>
                <li><strong>${t('features_turn_based_title')}</strong> ${t('features_turn_based_desc')}</li>
                <li><strong>${t('features_dynamic_ai_title')}</strong> ${t('features_dynamic_ai_desc')}</li>
            </ul>

            <h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('features_player_and_char_title')}</h3>
            <ul class="list-disc pl-5 space-y-2 text-gray-300">
                <li>${t('features_character_creation_desc')}</li>
                <li>${t('features_journal_desc')}</li>
                <li>${t('features_objectives_desc')}</li>
            </ul>

            <h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('features_ux_ui_title')}</h3>
            <ul class="list-disc pl-5 space-y-2 text-gray-300">
                <li>${t('features_crt_desc')}</li>
                <li>${t('features_glitch_desc')}</li>
                <li>${t('features_map_desc')}</li>
            </ul>

            <h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('features_guidance_title')}</h3>
            <ul class="list-disc pl-5 space-y-2 text-gray-300">
                <li>${t('features_help_menu_desc')}</li>
                <li>${t('features_hints_desc')}</li>
            </ul>

             <h3 class="text-lg font-bold mt-4 mb-2 text-white">${t('features_player_commands_title')}</h3>
            <ul class="list-disc pl-5 space-y-2 text-gray-300">
                 <li>${t('features_commands_nav')}</li>
                 <li>${t('features_commands_interact')}</li>
                 <li>${t('features_commands_info')}</li>
                 <li>${t('features_commands_sys')}</li>
            </ul>
        </div>
        <button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(featuresHtml, true);
    }

    function showHelpMenu() {
        const helpText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('help')}</h2>
        <div class="modal-scroll text-left p-2 text-sm flex-grow">
            <p class="mb-4">Type commands to interact. Most commands advance the turn counter.</p>
            <div>
                <h3 class="text-lg font-bold text-white">${t('features_commands_nav')}</h3>
                <p class="text-gray-300"><strong class="text-yellow-400">go [direction]</strong> - Move north, south, east, or west.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">look around</strong> - Describe the current room and visible items.</p>
            </div>
            <div class="mt-4">
                <h3 class="text-lg font-bold text-white">${t('features_commands_interact')}</h3>
                <p class="text-gray-300"><strong class="text-yellow-400">take [item]</strong> - Pick up an item from the room.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">use [item]</strong> - Use an item from your inventory.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">drop [item]</strong> - Drop an item in the current room.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">examine [item/object]</strong> - Get a detailed description of something.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">read [item/object]</strong> - Read text from an object.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">search [object]</strong> - Search an object for hidden items.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">combine [item1] with [item2]</strong> - Try to combine two items in your inventory.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">listen</strong> / <strong class="text-yellow-400">smell</strong> - Use your senses.</p>
            </div>
             <div class="mt-4">
                <h3 class="text-lg font-bold text-white">${t('features_commands_info')}</h3>
                <p class="text-gray-300"><strong class="text-yellow-400">inventory</strong> / <strong class="text-yellow-400">objectives</strong> / <strong class="text-yellow-400">journal</strong> - View status panels (or modal on mobile).</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">journal add [note]</strong> - Add a custom note to your journal.</p>
                 <p class="text-gray-300"><strong class="text-yellow-400">history</strong> - View your last 20 commands.</p>
            </div>
            <div class="mt-4">
                <h3 class="text-lg font-bold text-white">${t('features_commands_sys')}</h3>
                <p class="text-gray-300"><strong class="text-yellow-400">save / load</strong> - Save or load your game progress.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">rest</strong> - Attempt to rest and recover sanity in safe rooms.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">quit / exit</strong> - End the game and return to the main menu.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">cls / clear</strong> - Clear the output screen.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">undo</strong> - Revert your last action.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">again / a</strong> - Repeat your last command.</p>
                <p class="text-gray-300"><strong class="text-yellow-400">wait</strong> - Pass a turn.</p>
            </div>
        </div>
        <button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(helpText, true);
    }
    
    function showStatusModal() {
        const currentWeight = GameState.inventory.reduce((sum, item) => sum + (item?.weight || 1), 0);
        const statusText = `
        <h2 class="text-2xl mb-4 title-font text-cyan-400">${t('status_btn')}</h2>
        <div class="modal-scroll text-left p-2 text-sm flex-grow">
            <!-- Stats -->
            <div id="modal-stats-panel" class="mb-4">
                <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">${t('stats_title')}</h3>
                <div>${GameState.playerName} (${GameState.playerBackstory})</div>
                <div><span data-lang="awareness">${t('awareness')}</span>: ${GameState.awarenessLevel}</div>
                <div><span data-lang="sanity">${t('sanity')}</span>: ${GameState.sanityLevel}</div>
                <div><span data-lang="tone">${t('tone')}</span>: ${GameState.temporaryTone || GameState.chatbotTone}</div>
                <div><span data-lang="turn">${t('turn')}</span>: ${GameState.turnCount}</div>
            </div>
            <!-- Inventory -->
            <div id="modal-inventory-panel" class="mb-4">
                <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">${t('inventory_title')} (${currentWeight}/${MAX_INVENTORY_WEIGHT})</h3>
                <ul class="list-none p-0">${GameState.inventory.length > 0 ? GameState.inventory.map(item => `<li>- ${item.name}</li>`).join('') : `<li>${t('empty_inventory')}</li>`}</ul>
            </div>
            <!-- Objectives -->
            <div id="modal-objectives-panel" class="mb-4">
                 <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">${t('objectives_title')}</h3>
                 <ul class="list-none p-0 text-sm">${GameState.objectives.length > 0 ? GameState.objectives.map(obj => `<li>${obj.completed ? `<span class="text-gray-500 line-through">${obj.text}</span>` : `&gt; ${obj.text}`}</li>`).join('') : `<li>${t('no_objectives')}</li>`}</ul>
            </div>
             <!-- Journal -->
            <div id="modal-journal-panel" class="mb-4">
                 <h3 class="font-bold border-b border-[#00ff41]/30 mb-2">${t('journal_title')}</h3>
                 <ul class="list-none p-0 text-sm">${GameState.journalEntries.slice().reverse().map(entry => `<li>${entry}</li>`).join('')}</ul>
            </div>
        </div>
        <button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(statusText, true);
    }
    
    function showProgressionModal() {
        const unlockedEndings = JSON.parse(localStorage.getItem(ENDINGS_STORAGE_KEY) || '{}');
        const unlockedAchievements = JSON.parse(localStorage.getItem(ACHIEVEMENTS_STORAGE_KEY) || '{}');

        let endingsHtml = `<h4 class="text-md font-bold mt-4 mb-2 text-white">${t('unlocked_endings')}</h4>`;
        const endingsList = Object.values(unlockedEndings);
        if(endingsList.length > 0) {
            endingsHtml += `<ul class="list-disc pl-5 text-gray-300">${endingsList.map(e => `<li><strong>${e.title}</strong>: ${e.desc}</li>`).join('')}</ul>`;
        } else {
            endingsHtml += `<p class="text-gray-400">${t('no_endings')}</p>`;
        }
        
        let achievementsHtml = '';

        const progressionText = `
        <h2 class="text-2xl mb-4 title-font text-cyan-400">${t('progress_btn')}</h2>
        <div class="modal-scroll text-left p-2 text-sm flex-grow">
            ${endingsHtml}
            ${achievementsHtml}
        </div>
        <button class="close-modal-btn button mt-6">${t('close_btn')}</button>`;
        showModal(progressionText, true);
    }

    function showPauseMenu() {
        const pauseText = `<h2 class="text-2xl mb-4 title-font text-cyan-400">${t('pause_title')}</h2>
        <div class="flex flex-col gap-2">
        <button id="pause-save" class="button">${t('save_game')}</button>
        <button id="pause-load" class="button">${t('load_game')}</button>
        <button id="pause-help" class="button">${t('help')}</button>
        <button id="pause-main-menu" class="button text-yellow-300 border-yellow-300/80">${t('main_menu_btn')}</button>
        <button id="pause-resume" class="button button-primary mt-4">${t('resume_btn')}</button>
        </div>`; 
        showModal(pauseText, true); 
        document.getElementById('pause-save').onclick = () => { saveGame(); hideModal(); }; 
        document.getElementById('pause-load').onclick = () => { loadGame(); hideModal(); }; 
        document.getElementById('pause-help').onclick = showHelpMenu; 
        document.getElementById('pause-main-menu').onclick = confirmReturnToMainMenu;
        document.getElementById('pause-resume').onclick = hideModal;
    }

    function confirmReturnToMainMenu() {
        const confirmText = `<h2 class="text-xl mb-4 title-font text-yellow-400">${t('confirm_main_menu')}</h2>
        <div class="flex justify-center gap-4">
            <button id="confirm-yes" class="button button-primary">${t('yes')}</button>
            <button id="confirm-no" class="button">${t('no')}</button>
        </div>`;
        showModal(confirmText, true);
        document.getElementById('confirm-yes').onclick = returnToMainMenu;
        document.getElementById('confirm-no').onclick = showPauseMenu;
    }
    
    function returnToMainMenu() {
        sessionStorage.removeItem('synapse_session_v9_autosave');
        GameState.exitGame = true;
        UI.gameScreen.classList.add('hidden'); UI.gameScreen.classList.remove('flex');
        UI.startScreen.classList.remove('hidden'); UI.startScreen.classList.add('flex');
        UI.playerSetup.classList.add('hidden'); UI.playerSetup.classList.remove('flex');
        UI.startOptions.classList.remove('hidden'); UI.introTextContainer.classList.remove('hidden');
        document.getElementById('game-title').classList.remove('hidden');
        UI.gameOutput.innerHTML = '';
        resetGameState(); setupIntro(); hideModal();
    }


    function setupIntro() { UI.introTextContainer.innerHTML = `<p class="mb-4">${t('intro_1')}</p><p>${t('intro_2')}</p><p>${t('intro_3')}</p>`; }
    
    function startGame() { 
        resetGameState(); initializeData(); saveStateSnapshot(); 
        GameState.playerName = UI.playerNameInput.value || "Subject"; 
        const backstoryKey = (UI.playerBackstoryInput.value || "investigator").toLowerCase();
        GameState.playerBackstory = Object.keys(backstories).includes(backstoryKey) ? backstoryKey : 'investigator';
        GameState.difficulty = Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal; 
        
        UI.startScreen.classList.add('hidden'); UI.gameScreen.classList.remove('hidden'); UI.gameScreen.classList.add('flex'); 
        UI.gameOutput.innerHTML = ''; buildDialogueTree(GameState.chatbotTone);
        typeWriter(UI.gameOutput, t('initializing'), '#cccccc').then(() => { 
            showGuidance(t('initial_hint'));
            displayChatbotResponse(GameState.dialogue.currentNode.message_key).then(() => { renderRoom(); updateUI(); renderDialogueOptions(); }); 
        }); 
    }
    
    function endGame(endingKey) {
        if (GameState.exitGame) return;
        GameState.exitGame = true;
        let endingTitle = "Disconnected";
        let endingDesc = "Your connection was severed.";

        switch(endingKey) {
            case 'escaped':
                endingTitle = t('ending_escaped_title');
                endingDesc = t('ending_escaped_desc');
                break;
        }

        const unlockedEndings = JSON.parse(localStorage.getItem(ENDINGS_STORAGE_KEY) || '{}');
        unlockedEndings[endingKey] = { title: endingTitle, desc: endingDesc };
        localStorage.setItem(ENDINGS_STORAGE_KEY, JSON.stringify(unlockedEndings));

        const endingHtml = `<div class="text-center">
            <h2 class="text-4xl title-font text-red-500 mb-4">${endingTitle}</h2>
            <p class="text-white mb-6">${endingDesc}</p>
            <button id="ending-main-menu" class="button button-primary">${t('main_menu_btn')}</button>
        </div>`;
        showModal(endingHtml, true);
        document.getElementById('ending-main-menu').onclick = returnToMainMenu;
    }

    function hasItem(itemName) { return GameState.inventory.some(i => i.name.toLowerCase() === itemName.toLowerCase()); }
    function removeItemFromInventory(itemName) { const index = GameState.inventory.findIndex(i => i.name.toLowerCase() === itemName.toLowerCase()); if (index > -1) { GameState.inventory.splice(index, 1); } }
    
    function getAbilityDescription(backstoryKey, difficulty) {
        const key = (backstoryKey || "").toLowerCase().trim().replace(/ /g, '_');
        if (!backstories[key]) return t('ability_unknown');
        switch (key) {
            case 'hacker': return t(`ability_hacker_${difficulty.toLowerCase()}`);
            case 'psychologist': return t(`ability_psychologist_${difficulty.toLowerCase()}`);
            case 'technician': return t(`ability_technician_${difficulty.toLowerCase()}`);
            case 'survivor': return difficulty !== Difficulty.Hard ? t('ability_survivor_with_item') : t('ability_survivor');
            case 'skeptic': return difficulty === Difficulty.Easy ? t('ability_skeptic_easy') : t('ability_skeptic_normal');
            case 'corporate_spy': return difficulty !== Difficulty.Hard ? t('ability_spy_with_item') : t('ability_spy');
            case 'medic': return t(`ability_medic_${difficulty.toLowerCase()}`);
            case 'cultist': return difficulty === Difficulty.Hard ? t('ability_cultist_hard') : t('ability_cultist');
            case 'janitor': return difficulty !== Difficulty.Hard ? t('ability_janitor') : t('ability_janitor_hard');
            default: return t('ability_investigator');
        }
    }
    
    function updateAbilityDisplay() { 
        if (!UI.abilityDisplay) return; 
        const difficulty = Array.from(UI.difficultyBtns).find(b => b.classList.contains('button-primary'))?.dataset.difficulty || Difficulty.Normal; 
        const backstoryKey = UI.playerBackstoryInput.value; 
        const description = getAbilityDescription(backstoryKey, difficulty); 
        UI.abilityDisplay.textContent = t('ability_bonus_prefix') + description; 
    }

    function startSpeechRecognition() {
        if (!SpeechRecognition) {
            typeWriter(UI.gameOutput, "[SYSTEM] Speech recognition is not supported in your browser.", '#ff474c');
            return;
        }

        recognition.lang = currentLanguage === 'sv' ? 'sv-SE' : 'en-US';

        recognition.onstart = () => {
            UI.micBtn.classList.add('bg-red-500', 'border-red-700');
        };

        recognition.onresult = (event) => {
            let transcript = event.results[0][0].transcript;
            const lowerTranscript = transcript.toLowerCase();
            const langQuestionWords = questionWords[currentLanguage] || questionWords['en'];
            const isQuestion = langQuestionWords.some(word => lowerTranscript.startsWith(word + ' '));

            if (isQuestion && !lowerTranscript.endsWith('?')) {
                transcript += '?';
            }
            
            UI.playerInput.value = transcript;
            setTimeout(() => {
                processPlayerInput(transcript);
            }, 250);
        };

        recognition.onerror = (event) => {
            let errorMsg = `[SYSTEM] Speech recognition error: ${event.error}`;
            if (event.error === 'not-allowed') {
                errorMsg = "[SYSTEM] Microphone access denied. Please allow microphone access in your browser settings.";
            } else if (event.error === 'no-speech') {
                errorMsg = "[SYSTEM] No speech detected. Please try again.";
            }
            typeWriter(UI.gameOutput, errorMsg, '#ff474c');
        };

        recognition.onend = () => {
            UI.micBtn.classList.remove('bg-red-500', 'border-red-700');
        };

        recognition.start();
    }

    async function showGuidance(text) { await typeWriter(UI.gameOutput, `[HINT] ${text}`, GUIDANCE_COLOR); }
    async function initializeAudio() { if (audioInitialized) return; try { await Tone.start(); synth = new Tone.Synth().toDestination(); audioInitialized = true; } catch(e) { console.error(e); }}
    function saveStateToSession() { if (GameState && typeof GameState.turnCount === 'number' && !GameState.exitGame) { try { const sessionData = JSON.stringify(GameState, (key, value) => value instanceof Set ? [...value] : value); sessionStorage.setItem('synapse_session_v9_autosave', sessionData); } catch (e) { console.error("Session save failed:", e); } } }
    function loadStateFromSession() { const sessionData = sessionStorage.getItem('synapse_session_v9_autosave'); if (!sessionData) return false; try { const loadedState = JSON.parse(sessionData); if (loadedState.currentRoom && typeof loadedState.turnCount === 'number' && !loadedState.exitGame) { resetGameState(); Object.assign(GameState, loadedState); GameState.visitedRooms = new Set(loadedState.visitedRooms || []); GameState.dialogue.askedQuestions = new Set(loadedState.dialogue.askedQuestions || []); initializeData(); buildDialogueTree(GameState.chatbotTone); GameState.dialogue.currentNode = GameState.dialogue.cache[GameState.chatbotTone] || GameState.dialogue.cache[ChatbotTone.Friendly]; GameState.dialogue.previousNodes = []; UI.startScreen.classList.add('hidden'); UI.gameScreen.classList.remove('hidden'); UI.gameScreen.classList.add('flex'); UI.gameOutput.innerHTML = ''; typeWriter(UI.gameOutput, t('conn_reestablished'), '#cccccc'); renderRoom(); updateUI(); renderDialogueOptions(); return true; } } catch (e) { console.error("Session load failed:", e); sessionStorage.removeItem('synapse_session_v9_autosave'); } return false; }
    
    function setupBackgroundAnimation() { 
        const canvas = document.getElementById('background-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        let width, height, particles = [];
        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize);
        resize();
        class Particle { constructor() { this.x = Math.random() * width; this.y = Math.random() * height; this.size = Math.random() * 0.4 + 0.1; this.speedX = (Math.random() * 0.5 - 0.25); this.speedY = (Math.random() * 0.5 - 0.25); } update() { this.x += this.speedX; this.y += this.speedY; if (this.size > 0.1) this.size -= 0.001; if(this.x < 0 || this.x > width) this.speedX *= -1; if(this.y < 0 || this.y > height) this.speedY *= -1; } draw() { ctx.fillStyle = '#00ff41'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); } }
        function initParticles() { particles = []; for(let i=0; i<100; i++) particles.push(new Particle()); }
        function animateParticles() { ctx.clearRect(0,0,width,height); for(let i=0; i<particles.length; i++) { particles[i].update(); particles[i].draw(); if(particles[i].size <= 0.1) { particles.splice(i, 1); i--; particles.push(new Particle()); } } requestAnimationFrame(animateParticles); }
        initParticles(); animateParticles();
    }
    
    function drawMap() {
        if (!UI.mapCanvas) return;
        const canvas = UI.mapCanvas;
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        
        const scale = 1; // Simplified scale
        const panX = mapState.offsetX;
        const panY = mapState.offsetY;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw connections
        ctx.strokeStyle = "rgba(0, 255, 65, 0.2)";
        ctx.lineWidth = 1;
        Object.keys(roomLayout).forEach(roomName => {
            if (rooms[roomName] && rooms[roomName].exits) {
                const r1Layout = roomLayout[roomName];
                const r1x = r1Layout.x * scale + panX + (r1Layout.w * scale) / 2;
                const r1y = r1Layout.y * scale + panY + (r1Layout.h * scale) / 2;
                Object.values(rooms[roomName].exits).forEach(exitName => {
                    if (roomLayout[exitName]) {
                        const r2Layout = roomLayout[exitName];
                        const r2x = r2Layout.x * scale + panX + (r2Layout.w * scale) / 2;
                        const r2y = r2Layout.y * scale + panY + (r2Layout.h * scale) / 2;
                        ctx.beginPath();
                        ctx.moveTo(r1x, r1y);
                        ctx.lineTo(r2x, r2y);
                        ctx.stroke();
                    }
                });
            }
        });

        // Draw rooms
        Object.keys(roomLayout).forEach(roomName => {
            const layout = roomLayout[roomName];
            const x = layout.x * scale + panX;
            const y = layout.y * scale + panY;
            const w = layout.w * scale;
            const h = layout.h * scale;

            if(GameState.visitedRooms.has(roomName)) {
                ctx.fillStyle = (roomName === GameState.currentRoom) ? "rgba(0, 255, 65, 0.6)" : "rgba(0, 255, 65, 0.3)";
                ctx.fillRect(x, y, w, h);
            }
            
            ctx.strokeStyle = "rgba(0, 255, 65, 0.8)";
            ctx.strokeRect(x, y, w, h);

            ctx.fillStyle = "white";
            ctx.font = `10px VT323`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(layout.name, x + w / 2, y + h / 2);
        });

        // Draw player marker
        const playerLayout = roomLayout[GameState.currentRoom];
        const playerX = playerLayout.x * scale + panX + (playerLayout.w * scale) / 2;
        const playerY = playerLayout.y * scale + panY + (playerLayout.h * scale) / 2;
        ctx.fillStyle = "#FF2A7F";
        ctx.beginPath();
        ctx.arc(playerX, playerY, 3, 0, 2 * Math.PI);
        ctx.fill();
        ctx.strokeStyle = "white";
        ctx.stroke();
    }
    
    function initMapControls() {
        const canvas = UI.mapCanvas;
        
        const getEventCoords = (e) => {
            if (e.touches && e.touches.length) {
                return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
            return { x: e.clientX, y: e.clientY };
        }

        const handleDragStart = (e) => {
            mapState.isDragging = true;
            const coords = getEventCoords(e);
            mapState.lastX = coords.x;
            mapState.lastY = coords.y;
            canvas.style.cursor = 'grabbing';
        };

        const handleDragMove = (e) => {
            if (!mapState.isDragging) return;
            e.preventDefault();
            const coords = getEventCoords(e);
            const dX = coords.x - mapState.lastX;
            const dY = coords.y - mapState.lastY;
            mapState.offsetX += dX;
            mapState.offsetY += dY;
            mapState.lastX = coords.x;
            mapState.lastY = coords.y;
            drawMap();
        };

        const handleDragEnd = () => {
            mapState.isDragging = false;
            canvas.style.cursor = 'grab';
        };
        
        canvas.addEventListener('mousedown', handleDragStart);
        window.addEventListener('mousemove', handleDragMove);
        window.addEventListener('mouseup', handleDragEnd);
        canvas.addEventListener('mouseleave', handleDragEnd);

        canvas.addEventListener('touchstart', handleDragStart, { passive: false });
        window.addEventListener('touchmove', handleDragMove, { passive: false });
        window.addEventListener('touchend', handleDragEnd);
    }
    
    function showHistory() {
        let historyHtml = commandHistory.slice(-20).map((cmd, i) => `<div>${i + 1}: ${cmd}</div>`).join('');
        typeWriter(UI.gameOutput, `--- Command History ---\n${historyHtml}`, '#cccccc');
    }

    function undoLastAction() {
        if (stateSnapshots.length > 1) {
            stateSnapshots.pop(); // remove current state
            const prevState = stateSnapshots[stateSnapshots.length - 1];
            GameState = JSON.parse(JSON.stringify(prevState));
            GameState.visitedRooms = new Set(prevState.visitedRooms);
            GameState.dialogue.askedQuestions = new Set(prevState.dialogue.askedQuestions || []);
            updateUI();
            typeWriter(UI.gameOutput, "[System] Last action undone.", "#ffdb58");
        } else {
            typeWriter(UI.gameOutput, "[System] No actions to undo.", "#ff474c");
        }
    }
    
    function toggleDebug() {
        GameState.debugMode = !GameState.debugMode;
        typeWriter(UI.gameOutput, `[System] Debug mode ${GameState.debugMode ? 'enabled' : 'disabled'}.`, '#6495ed');
    }
    
    function toggleColorblind() {
        GameState.colorblindMode = !GameState.colorblindMode;
        typeWriter(UI.gameOutput, `[System] Colorblind mode ${GameState.colorblindMode ? 'enabled' : 'disabled'}.`, '#6495ed');
    }


    // --- EVENT LISTENERS & INITIALIZATION ---
    window.addEventListener('beforeunload', saveStateToSession);
    window.addEventListener('DOMContentLoaded', () => {
        UI.playerInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { const input = UI.playerInput.value.trim(); if(input) { processPlayerInput(input); }
            } else if (e.key === 'ArrowUp') { e.preventDefault(); if (commandHistory.length > 0) { commandHistoryIndex = Math.max(0, commandHistoryIndex - 1); UI.playerInput.value = commandHistory[commandHistoryIndex] || ''; }
            } else if (e.key === 'ArrowDown') { e.preventDefault(); if (commandHistory.length > 0) { commandHistoryIndex = Math.min(commandHistory.length, commandHistoryIndex + 1); UI.playerInput.value = commandHistory[commandHistoryIndex] || ''; } }
        });
        UI.newGameBtn.addEventListener('click', async () => { sessionStorage.removeItem('synapse_session_v9_autosave'); await initializeAudio(); UI.startOptions.classList.add('hidden'); UI.playerSetup.classList.remove('hidden'); UI.playerSetup.classList.add('flex'); updateAbilityDisplay(); });
        UI.loadGameBtn.addEventListener('click', async () => { sessionStorage.removeItem('synapse_session_v9_autosave'); await initializeAudio(); loadGame(); });
        UI.viewFeaturesBtn.addEventListener('click', showFeaturesModal);
        UI.startGameBtn.addEventListener('click', () => { startGame(); });
        UI.difficultyBtns.forEach(btn => { btn.addEventListener('click', () => { UI.difficultyBtns.forEach(b => b.classList.remove('button-primary')); btn.classList.add('button-primary'); updateAbilityDisplay(); }); });
        UI.playerBackstoryInput.addEventListener('input', updateAbilityDisplay);
        UI.viewBackstoriesBtn.addEventListener('click', showBackstoryModal);
        UI.statusBtn.addEventListener('click', showStatusModal);
        UI.viewProgressionBtn.addEventListener('click', showProgressionModal);
        UI.langEnBtn.addEventListener('click', () => setLanguage('en'));
        UI.langSvBtn.addEventListener('click', () => setLanguage('sv'));
        
        if (SpeechRecognition) {
            UI.micBtn.addEventListener('click', startSpeechRecognition);
        } else {
            UI.micBtn.style.display = 'none';
        }

        initMapControls();
        setupBackgroundAnimation();
        setLanguage('en');
        if (!loadStateFromSession()) { 
            resetGameState(); 
            mapState.offsetX = UI.mapCanvas.offsetWidth / 2 - roomLayout.Lobby.x - roomLayout.Lobby.w / 2;
            mapState.offsetY = UI.mapCanvas.offsetHeight / 2 - roomLayout.Lobby.y - roomLayout.Lobby.h / 2;
        }
    });
    </script>
</body>
</html>
